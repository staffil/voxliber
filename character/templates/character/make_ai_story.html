{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% if story %}ìŠ¤í† ë¦¬ í¸ì§‘{% else %}ìƒˆ ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°{% endif %} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/character/make_ai_story.css' %}">
{% endblock %}

{% block content %}
<br><br><br><br>

<main class="story-create-container">
    <div class="story-create-header">
        <h1 class="page-title">
            <span class="title-icon">ğŸ“–</span>
            {% if story %}ìŠ¤í† ë¦¬ í¸ì§‘{% else %}ìƒˆ ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°{% endif %}
        </h1>
        <p class="page-subtitle">AI ìºë¦­í„°ë“¤ì´ í™œë™í•  ì„¸ê³„ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
    </div>

    <form method="POST" action="" enctype="multipart/form-data" class="story-form">
        {% csrf_token %}
        {% if story_uuid %}
            <input type="hidden" name="story_uuid" value="{{ story_uuid }}" >
        {% endif %}

        <div class="form-section">
            <!-- ì œëª© -->
            <div class="form-group">
                <label for="title" class="form-label">
                    <span class="label-icon">âœ¨</span>
                    ìŠ¤í† ë¦¬ ì œëª©
                </label>
                <input
                    type="text"
                    name="title"
                    id="title"
                    class="form-input"
                    value="{{ story.title|default_if_none:'' }}"
                    placeholder="ì˜ˆ: í™©í˜¼ì˜ ê²€ê°, ë³„ì´ ì§€ëŠ” ë°¤"
                    required
                    maxlength="200" data-login-required
                >
            </div>

            <!-- ì„¤ëª… -->
            <div class="form-group">
                <label for="description" class="form-label">
                    <span class="label-icon">ğŸ“</span>
                    ìŠ¤í† ë¦¬ ì„¤ëª… (ì„ íƒ)
                </label>
                <textarea
                    name="description"
                    id="description"
                    class="form-textarea"
                    rows="5"
                    placeholder="ì´ ìŠ¤í† ë¦¬ì˜ ë°°ê²½, ë¶„ìœ„ê¸°, ì£¼ìš” í…Œë§ˆ ë“±ì„ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”." data-login-required
                >{{ story.description|default_if_none:'' }}</textarea>
            </div>

            <!-- í‘œì§€ ì´ë¯¸ì§€ -->
<!-- í†µí•© ë¯¸ë””ì–´ ì—…ë¡œë“œ (ì´ë¯¸ì§€ + ì˜ìƒ) -->
<!-- í†µí•© ë¯¸ë””ì–´ ì—…ë¡œë“œ (ì´ë¯¸ì§€ + ì˜ìƒ) -->
<div class="form-group">
    <label class="form-label">
        <span class="label-icon">ğŸ–¼ï¸ğŸ¥</span>
        í‘œì§€ ë¯¸ë””ì–´ (ì´ë¯¸ì§€ ë˜ëŠ” ì˜ìƒ ì„ íƒ)
    </label>
    <div class="image-upload-area" id="media-upload-area">
        <!-- ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ (ì €ì¥ëœ ê°’ ìˆìœ¼ë©´ ë³´ì´ê²Œ) -->
        <div id="media-preview-container" style="display: {% if story.cover_image or story.story_desc_video %}block{% else %}none{% endif %};">
            <!-- ì €ì¥ëœ ì˜ìƒ ìš°ì„  í‘œì‹œ -->
            {% if story.story_desc_video %}
                <video id="media-preview-video" class="media-preview" controls loop muted style="max-height: 220px;">
                    <source src="{{ story.story_desc_video.url }}" type="video/mp4">
                </video>
            {% endif %}

            <!-- ì €ì¥ëœ ì´ë¯¸ì§€ë§Œ ìˆëŠ” ê²½ìš° -->
            {% if story.cover_image and not story.story_desc_video %}
                <img id="media-preview-image" src="{{ story.cover_image.url }}" alt="í‘œì§€ ë¯¸ë¦¬ë³´ê¸°" class="media-preview" style="max-height: 220px;">
            {% endif %}
        </div>

        <!-- í”Œë ˆì´ìŠ¤í™€ë” (ì•„ë¬´ê²ƒë„ ì—†ì„ ë•Œ) -->
        <div class="upload-placeholder" id="media-placeholder" style="display: {% if not story.cover_image and not story.story_desc_video %}block{% else %}none{% endif %}">
            <span class="upload-icon">ğŸ–¼ï¸ğŸ¥</span>
            <span class="upload-text">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ë˜ëŠ” ì˜ìƒ ì„ íƒ</span>
        </div>

        <!-- íŒŒì¼ ì…ë ¥ -->
        <input type="file" name="cover_media" accept="image/*,video/mp4,video/webm" id="cover_media_input" class="file-input-hidden" data-login-required>
    </div>
    <span class="form-hint">ì´ë¯¸ì§€(JPG/PNG) ë˜ëŠ” ì§§ì€ ì˜ìƒ(MP4/WebM)ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. ìµœëŒ€ 10MB ì¶”ì²œ.</span>
</div>


<div class="form-group">
    <label class="form-label">
        <span class="label-icon">ğŸ–¼ï¸</span>
        ì„¤ëª… ì´ë¯¸ì§€(ì„ íƒ)
    </label>
    <div class="image-upload-area" id="desc-upload-area">
        <!-- ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ -->
        <img 
            src="{% if story and story.desc_img %}{{ story.desc_img.url }}{% else %}{% static 'images/default-placeholder.jpg' %}{% endif %}" 
            alt="ì„¤ëª… ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" 
            class="cover-preview" 
            id="desc-preview"
            {% if not story or not story.desc_img %}style="display:none;"{% endif %}
        >

        <!-- í”Œë ˆì´ìŠ¤í™€ë” (ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ) -->
        <div class="upload-placeholder" id="desc-placeholder"
             {% if story and story.desc_img %}style="display:none;"{% endif %}>
            <span class="upload-icon">ğŸ“</span>
            <span class="upload-text">AI ì†Œì„¤ì„ ê¾¸ë°€ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</span>
        </div>

        <!-- ì‹¤ì œ íŒŒì¼ ì…ë ¥ -->
        <input type="file" name="desc_img" accept="image/*" id="desc-image-input" class="file-input-hidden" data-login-required>
    </div>
</div>


        <div class="form-section">
            <!-- ì¥ë¥´ ì„ íƒ -->
            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ­</span>
                    ì¥ë¥´ ì„ íƒ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)
                </label>
                <div class="genre-grid">
                    {% for genre in genre_list %}
                    <label class="genre-option">
                        <input type="checkbox" name="genres" value="{{ genre.id }}"
                            {% if genre.id in initial_genres %}checked{% endif %} data-login-required>
                        <span class="genre-box" style="--genre-color: {{ genre.genres_color|default:'#6366f1' }}">
                            {{ genre.name }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- íƒœê·¸ ì„ íƒ -->
            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ·ï¸</span>
                    íƒœê·¸ ì„ íƒ
                </label>

                <!-- íƒœê·¸ ê²€ìƒ‰/ì¶”ê°€ ì…ë ¥ -->
                <div class="tag-input-wrapper">
                    <input type="text" id="tag-search" class="tag-search-input" placeholder="íƒœê·¸ ê²€ìƒ‰ ë˜ëŠ” ì¶”ê°€..." data-login-required>
                    <button type="button" id="add-tag-btn" class="add-tag-btn" data-login-required>ì¶”ê°€</button>
                </div>

                <!-- ì„ íƒëœ íƒœê·¸ í‘œì‹œ ì˜ì—­ -->
                <div class="selected-tags" id="selected-tags">
                    {% if story %}
                        {% for tag in story.tags.all %}
                        <input type="hidden" name="tags" value="{{ tag.id }}" data-login-required>
                        <span class="selected-tag" data-tag-id="{{ tag.id }}">#{{ tag.name }} <button type="button" class="remove-tag-btn" data-login-required>&times;</button></span>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- íƒœê·¸ ëª©ë¡ -->
                <div class="tag-list-wrapper">
                    <div class="tag-grid" id="tag-grid">
                        {% for tag in tag_list %}
                        <label class="tag-option">
                            <input type="checkbox" class="tag-checkbox" value="{{ tag.id }}"
                                {% if tag.id in initial_tags %}checked{% endif %} data-login-required>
                            <span class="tag-box">#{{ tag.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <!-- TTS ë‚˜ë ˆì´ì…˜ ëª©ì†Œë¦¬ -->
            <div class="form-group">
                <label for="voice_id" class="form-label">
                    <span class="label-icon">ğŸ™ï¸</span>
                    TTS ë‚˜ë ˆì´ì…˜ ëª©ì†Œë¦¬
                </label>
                <select name="voice_id" id="voice_id" class="form-select" data-login-required>
                    <option value="" >ì„ íƒ ì—†ìŒ (ê¸°ë³¸ ëª©ì†Œë¦¬)</option>
                    {% for voice in voice_list %}
                    <option value="{{ voice.voice_id }}" {% if voice.voice_id == initial_voice_id %}selected{% endif %}>
                        {{ voice.voice_name }}
                    </option>
                    {% endfor %}
                </select>
                <span class="form-hint">ìŠ¤í† ë¦¬ ë‚´ë ˆì´ì…˜ì— ì‚¬ìš©ë  ëª©ì†Œë¦¬ì…ë‹ˆë‹¤</span>
            </div>
        </div>
        <div class="form-section">

                                <div class="terms-checkbox-wrapper">
                                <label class="custom-checkbox">
<input type="checkbox"
       id="adult_choice"
       name="adult_choice"
       value="on"
       {% if story and story.adult_choice %}checked{% endif %} data-login-required>
       
                                    <span class="checkbox-icon"></span>
                                    <span class="checkbox-text">
                                    <a href="/terms/of/service/" class="terms-link" target="_blank" data-login-required>ì”ì¸ì„±, ì„ ì •ì„±ì´ ìˆëŠ” ì‘í’ˆ</a>ì´ë©´ ë™ì˜ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                                    </span>
                                </label>
                                </div>
        </div>

        <!-- ì œì¶œ ë²„íŠ¼ -->
        <div class="form-actions">
            <button type="submit" class="submit-btn">
                {% if story %}
                    <span>ğŸ’¾</span> ìŠ¤í† ë¦¬ ì €ì¥
                {% else %}
                    <span>ğŸš€</span> ìŠ¤í† ë¦¬ ë§Œë“¤ê³  ìºë¦­í„° ì¶”ê°€í•˜ê¸°
                {% endif %}
            </button>
        </div>
    </form>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
const mediaUploadArea = document.getElementById('media-upload-area');
    const mediaFileInput = document.getElementById('cover_media_input');
    const previewContainer = document.getElementById('media-preview-container');
    const previewImage = document.getElementById('media-preview-image');
    const previewVideo = document.getElementById('media-preview-video');
    const placeholder = document.getElementById('media-placeholder');

    if (mediaUploadArea && mediaFileInput) {
        mediaUploadArea.addEventListener('click', () => mediaFileInput.click());

        mediaFileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (!file) return;

            console.log('[MEDIA] íŒŒì¼ ì„ íƒë¨:', file.name, file.type); // ë””ë²„ê¹…ìš©

            const url = URL.createObjectURL(file);
            placeholder.style.display = 'none';
            previewContainer.style.display = 'block';

            // ê¸°ì¡´ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
            previewImage.style.display = 'none';
            previewVideo.style.display = 'none';

            if (file.type.startsWith('image/')) {
                previewImage.src = url;
                previewImage.style.display = 'block';
            } else if (file.type.startsWith('video/')) {
                previewVideo.src = url;
                previewVideo.style.display = 'block';
                previewVideo.muted = true;
                previewVideo.loop = true;
                previewVideo.play().catch(err => {
                    console.log('[MEDIA] ìë™ ì¬ìƒ ì‹¤íŒ¨:', err);
                });
            } else {
                console.warn('[MEDIA] ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹:', file.type);
                alert('ì´ë¯¸ì§€ ë˜ëŠ” MP4/WebM ì˜ìƒë§Œ ì§€ì›í•©ë‹ˆë‹¤.');
            }
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        mediaUploadArea.addEventListener('dragover', e => {
            e.preventDefault();
            mediaUploadArea.classList.add('dragover');
        });

        mediaUploadArea.addEventListener('dragleave', () => {
            mediaUploadArea.classList.remove('dragover');
        });

        mediaUploadArea.addEventListener('drop', e => {
            e.preventDefault();
            mediaUploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && (file.type.startsWith('image/') || file.type.startsWith('video/'))) {
                mediaFileInput.files = e.dataTransfer.files;
                mediaFileInput.dispatchEvent(new Event('change'));
            }
        });
    }

    if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });
    }

    // ì¥ë¥´ ì„ íƒ ì‹œê°ì  í”¼ë“œë°±
    document.querySelectorAll('.genre-option input').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            this.closest('label').classList.toggle('selected', this.checked);
        });

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        if (checkbox.checked) {
            checkbox.closest('label').classList.add('selected');
        }
    });

    // ========================================
    // íƒœê·¸ ê²€ìƒ‰/ì¶”ê°€ ê¸°ëŠ¥
    // ========================================
    const tagSearchInput = document.getElementById('tag-search');
    const selectedTagsContainer = document.getElementById('selected-tags');
    const tagGrid = document.getElementById('tag-grid');
    const addTagBtn = document.getElementById('add-tag-btn');

    // ì„ íƒëœ íƒœê·¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateSelectedTags() {
        const checkboxes = document.querySelectorAll('.tag-checkbox:checked');
        selectedTagsContainer.innerHTML = '';

        checkboxes.forEach(checkbox => {
            const tagName = checkbox.parentElement.querySelector('.tag-box').textContent;
            const tagId = checkbox.value;

            // hidden input ì¶”ê°€
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'tags';
            input.value = tagId;
            selectedTagsContainer.appendChild(input);

            // ì„ íƒëœ íƒœê·¸ í‘œì‹œ
            const span = document.createElement('span');
            span.className = 'selected-tag';
            span.dataset.tagId = tagId;
            span.innerHTML = `${tagName} <button type="button" class="remove-tag-btn">&times;</button>`;
            selectedTagsContainer.appendChild(span);
        });
    }

    // íƒœê·¸ ì œê±° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    selectedTagsContainer?.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-tag-btn')) {
            const tagSpan = e.target.closest('.selected-tag');
            const tagId = tagSpan.dataset.tagId;

            // ì²´í¬ë°•ìŠ¤ í•´ì œ
            const checkbox = document.querySelector(`.tag-checkbox[value="${tagId}"]`);
            if (checkbox) {
                checkbox.checked = false;
                checkbox.closest('label').classList.remove('selected');
            }

            updateSelectedTags();
        }
    });

    // íƒœê·¸ ì²´í¬ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸
    tagGrid?.addEventListener('change', function(e) {
        if (e.target.classList.contains('tag-checkbox')) {
            e.target.closest('label').classList.toggle('selected', e.target.checked);
            updateSelectedTags();
        }
    });

    // íƒœê·¸ ê²€ìƒ‰ ê¸°ëŠ¥
    tagSearchInput?.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const tagOptions = document.querySelectorAll('.tag-option');

        tagOptions.forEach(option => {
            const tagName = option.querySelector('.tag-box').textContent.toLowerCase();
            if (tagName.includes(searchTerm) || searchTerm === '') {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });
    });

    // ì¿ í‚¤ ê°€ì ¸ì˜¤ê¸°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // íƒœê·¸ ì¶”ê°€ ë²„íŠ¼
    addTagBtn?.addEventListener('click', async function() {
        const name = tagSearchInput.value.trim();
        if (!name) {
            alert('íƒœê·¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            const res = await fetch('/book/tags/add/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `name=${encodeURIComponent(name)}`
            });

            if (!res.ok) {
                throw new Error('íƒœê·¸ ì¶”ê°€ ì‹¤íŒ¨');
            }

            const tag = await res.json();

            // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒœê·¸ì¸ì§€ í™•ì¸
            const existingCheckbox = document.querySelector(`.tag-checkbox[value="${tag.id}"]`);
            if (existingCheckbox) {
                existingCheckbox.checked = true;
                existingCheckbox.closest('label').classList.add('selected');
            } else {
                // ìƒˆ íƒœê·¸ë¥¼ íƒœê·¸ ê·¸ë¦¬ë“œì— ì¶”ê°€
                const label = document.createElement('label');
                label.className = 'tag-option selected';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'tag-checkbox';
                checkbox.value = tag.id;
                checkbox.checked = true;

                const span = document.createElement('span');
                span.className = 'tag-box';
                span.textContent = '#' + tag.name;

                label.appendChild(checkbox);
                label.appendChild(span);
                tagGrid.appendChild(label);
            }

            // ì„ íƒëœ íƒœê·¸ ì—…ë°ì´íŠ¸
            updateSelectedTags();

            tagSearchInput.value = '';

            // ê²€ìƒ‰ í•„í„° ì´ˆê¸°í™”
            document.querySelectorAll('.tag-option').forEach(option => {
                option.style.display = '';
            });

            if (tag.created) {
                alert(`ìƒˆ íƒœê·¸ "#${tag.name}"ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('íƒœê·¸ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });

    // Enter í‚¤ë¡œ íƒœê·¸ ì¶”ê°€
    tagSearchInput?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addTagBtn.click();
        }
    });

    // ì´ˆê¸° ì„ íƒëœ íƒœê·¸ í‘œì‹œ
    updateSelectedTags();
});

document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('desc-upload-area');
    const fileInput = document.getElementById('desc-image-input');
    const preview = document.getElementById('desc-preview');
    const placeholder = document.getElementById('desc-placeholder');

    // í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒì°½ ì—´ê¸°
    if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());

        // íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì§€ì› (ì˜µì…˜, í¸ì˜ì„± â†‘)
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover'); // CSSë¡œ hover íš¨ê³¼ ì£¼ê¸°
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });
    }
});

</script>
{% endblock %}
