{% extends "base.html" %}
{% load static i18n %}

{% block title %}{{ llm.name }} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/character/chat.css' %}?v=3">

{% endblock %}

{% block content %}
<br><br><br>
<!-- ë°°ê²½ ì´ë¯¸ì§€ ë·°ì–´ (í† ê¸€) -->
<div class="background-viewer" id="background-viewer">
    <img src="{% if sub_images_data %}{{ sub_images_data.0.image_url }}{% elif llm.llm_image %}{{ llm.llm_image.url }}{% endif %}"
         alt="{{ llm.name }}"
         class="background-viewer-image"
         id="background-viewer-image">
    <button class="background-viewer-close" id="close-viewer-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
        <span>ì±„íŒ…ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
    </button>
</div>

<div class="chat-container" id="chat-container">
    <!-- ì‚¬ì´ë“œ í”„ë¡œí•„ íŒ¨ë„ -->
    <aside class="profile-panel">


        
        <!-- âœ… í•´ê¸ˆëœ ì„œë¸Œ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ -->
        <div class="unlocked-gallery">
            <div class="gallery-header">
                <span class="gallery-title">í•´ê¸ˆëœ ì¥ë©´</span>
                <span class="gallery-count" id="gallery-count">0 / 0</span>
            </div>

            <div class="gallery-viewer" id="gallery-viewer">
                <img src="" alt="" class="gallery-viewer-img" id="gallery-viewer-img">

                <div class="gallery-locked-msg" id="gallery-locked-msg" style="display:none;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="1.5" opacity="0.5">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <span>ì•„ì§ í•´ê¸ˆëœ ì¥ë©´ì´ ì—†ì–´ìš”</span>
                </div>

                <div class="gallery-caption" id="gallery-caption"></div>

                <button class="gallery-nav prev" id="gallery-prev">&#8249;</button>
                <button class="gallery-nav next" id="gallery-next">&#8250;</button>
            </div>

            <div class="gallery-dots" id="gallery-dots"></div>
        </div>
        <!-- <div class="profile-image-wrapper">
            {% if llm.llm_image %}
            <img src="{{ llm.llm_image.url }}" alt="{{ llm.name }}" class="profile-image" id="profile-image">
            {% else %}
            <div class="profile-image-placeholder">
                <span>{{ llm.name|slice:":1" }}</span>
            </div>
            {% endif %}
            <div class="profile-gradient-overlay"></div>
        </div> -->

        <div class="profile-info">
            <h2 class="profile-name">{{ llm.name }}</h2>
            <div class="profile-status">
                <span class="status-dot"></span>
                <span>ì˜¨ë¼ì¸</span>
            </div>
        </div>

        <!-- HP ë°” -->
        <div class="hp-section">
            <div class="hp-header">
                <span class="hp-label">í˜¸ê°ë„</span>
                <span class="hp-value" id="hp-value">{{ current_hp|default:100 }} / {{ max_hp|default:100 }}</span>
            </div>
            <div class="hp-bar">
                <div class="hp-fill" id="hp-bar"></div>
            </div>
        </div>


        <!-- ë°°ê²½ ë³´ê¸° ë²„íŠ¼ (ë°ìŠ¤í¬íƒ‘) -->
        <button class="view-background-btn" id="desktop-toggle-background-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
            <span>ë°°ê²½ ì´ë¯¸ì§€ ë³´ê¸°</span>
        </button>

        {% if not  last_ward_exists %}
        <a class="view-background-btn" href="{% url 'character:last_ward' llm.public_uuid %}" style="background-color: rgb(223, 74, 131);">ë§ˆì§€ë§‰ ìŠ¤í† ë¦¬ ë³´ê¸°</a>
        {% endif %}

        <div class="lore-hint-box">
            <div class="lore-hint-title">
                ğŸ’¡ ë°˜ì‘í•˜ëŠ” ë‹¨ì–´
            </div>
            <div class="lore-hint-desc">
                ì´ ë‹¨ì–´ë“¤ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•˜ë©´<br>
                í˜¸ê°ë„ê°€ ë” ì‰½ê²Œ ì˜¬ë¼ê°ˆì§€ë„ ëª°ë¼ìš”.
            </div>
            <div class="lore-hint-tags">
                {% for ward in loarbook_list %}
                    <span class="lore-tag">{{ ward.keys }}</span>
                {% empty %}
                    <span class="lore-empty">ì•„ì§ ë°œê²¬ëœ ë‹¨ì„œê°€ ì—†ìŠµë‹ˆë‹¤</span>
                {% endfor %}
            </div>
        </div>

        <a href="javascript:history.back()" class="back-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            <span>ëŒì•„ê°€ê¸°</span>
        </a>
    </aside>

    <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <main class="chat-main">
        <!-- ëª¨ë°”ì¼ í—¤ë” -->
        <header class="mobile-header">
            <a href="javascript:history.back()" class="mobile-back-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <div class="mobile-profile">
                {% if llm.llm_image %}
                <img src="{{ llm.llm_image.url }}" alt="{{ llm.name }}" class="mobile-avatar">
                {% endif %}
                <div class="mobile-info">
                    <span class="mobile-name">{{ llm.name }}</span>
                    <span class="mobile-status">ì˜¨ë¼ì¸</span>
                </div>
            </div>
            <div class="mobile-header-actions">
                <button class="header-icon-btn" id="toggle-background-btn" title="ë°°ê²½ ì´ë¯¸ì§€ ë³´ê¸°">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
                <button class="mobile-menu-btn" id="toggle-profile-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="messages-container" id="message-area">
            {% if not messages %}
            <div class="message ai-message">
                <div class="message-avatar">
                    {% if llm.llm_image %}
                    <img src="{{ llm.llm_image.url }}" alt="{{ llm.name }}">
                    {% else %}
                    <span>{{ llm.name|slice:":1" }}</span>
                    {% endif %}
                </div>
                
                <div class="message-body">
                    <div class="message-bubble">
                        {% if llm.description %}
                        <p class="narration">{{ llm.description }}</p>
                        {% endif %}
                        {% if llm.first_sentence %}

                        <p class="text-dialogue">{{ llm.first_sentence }}</p>
                        {% else %}
                        <p class="text-dialogue">ì•ˆë…•í•˜ì„¸ìš”!</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% for msg in messages %}
            <div class="message {% if msg.role == 'assistant' %}ai-message{% else %}user-message{% endif %}" data-msg-id="{{ msg.id }}">
                {% if msg.role == 'assistant' %}
                <div class="message-avatar">
                    {% if llm.llm_image %}
                    <img src="{{ llm.llm_image.url }}" alt="{{ llm.name }}">
                    {% else %}
                    <span>{{ llm.name|slice:":1" }}</span>
                    {% endif %}
                </div>
                {% endif %}
                <div class="message-body">
                    <div class="message-bubble">
                        <p>{{ msg.content|linebreaksbr|safe }}</p>
                    </div>
                    {% if msg.role == 'assistant' %}
                    <div class="message-actions">
                        {% if msg.audio %}
                        <button class="audio-btn has-audio" data-audio-url="{{ msg.audio.url }}" title="ìŒì„± ì¬ìƒ">
                            <svg class="icon-play" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <svg class="icon-pause" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                                <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
                            </svg>
                        </button>
                        {% else %}
                        <button class="tts-btn" data-msg-id="{{ msg.id }}" title="ìŒì„± ìƒì„±">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            </svg>
                            <span>ìŒì„± ìƒì„±</span>
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="input-container">
            <div class="input-wrapper">
                <input type="text"
                       id="text-input"
                       class="message-input"
                       placeholder="{{ llm.name }}ì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°..."
                       autocomplete="off"
                       data-login-required>
                <button class="send-btn" id="send-btn" title="ì „ì†¡">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </main>
</div>


<!-- ìˆ¨ê²¨ì§„ ì˜¤ë””ì˜¤ ìš”ì†Œ -->
<audio id="global-audio" style="display:none;"></audio>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/character/chat.js' %}"></script>

<script>
// HP 100 ì´ìƒì´ë©´ ìµœì¢… ì˜¤ë²„ë ˆì´ í‘œì‹œ

</script>

<script>
// ====================================
// ê¸°ë³¸ ì„¤ì •
// ====================================
const aiImage  = '{% if llm.llm_image %}{{ llm.llm_image.url }}{% endif %}';
const aiName   = '{{ llm.name|escapejs }}';
const llmUuid  = '{{ llm.public_uuid }}';
const ttsUrl   = '{% url "character:chat-tts" llm.public_uuid %}';
const chatUrl  = '{% url "character:chat-logic" llm.public_uuid %}';
const csrfToken = '{{ csrf_token }}';

let currentHp = {{ current_hp|default:0 }};
let maxHp     = {{ max_hp|default:100 }};

const subImages = [
    {% for sub in sub_images_data %}
    { image: '{{ sub.image_url }}', minHp: {{ sub.min_hp }}, maxHp: {{ sub.max_hp }}, title: '{{ sub.title|escapejs|default:"" }}' }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// ====================================
// ì˜¤ë””ì˜¤ ê´€ë¦¬ (ë‹¨ì¼ ì¬ìƒ)
// ====================================
const globalAudio = document.getElementById('global-audio');
let currentPlayingBtn = null;

function stopAllAudio() {
    if (globalAudio) {
        globalAudio.pause();
        globalAudio.currentTime = 0;
    }
    if (currentPlayingBtn) {
        currentPlayingBtn.classList.remove('playing');
        const playIcon  = currentPlayingBtn.querySelector('.icon-play');
        const pauseIcon = currentPlayingBtn.querySelector('.icon-pause');
        if (playIcon)  playIcon.style.display  = '';
        if (pauseIcon) pauseIcon.style.display = 'none';
        currentPlayingBtn = null;
    }
    document.querySelectorAll('.audio-btn').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('disabled');
    });
}

function playAudio(audioUrl, btn) {
    if (currentPlayingBtn === btn && !globalAudio.paused) {
        globalAudio.pause();
        btn.classList.remove('playing');
        const playIcon  = btn.querySelector('.icon-play');
        const pauseIcon = btn.querySelector('.icon-pause');
        if (playIcon)  playIcon.style.display  = '';
        if (pauseIcon) pauseIcon.style.display = 'none';
        document.querySelectorAll('.audio-btn').forEach(b => {
            b.disabled = false;
            b.classList.remove('disabled');
        });
        currentPlayingBtn = null;
        return;
    }
    stopAllAudio();
    globalAudio.src = audioUrl;
    globalAudio.play();
    currentPlayingBtn = btn;
    btn.classList.add('playing');
    const playIcon  = btn.querySelector('.icon-play');
    const pauseIcon = btn.querySelector('.icon-pause');
    if (playIcon)  playIcon.style.display  = 'none';
    if (pauseIcon) pauseIcon.style.display = '';
    document.querySelectorAll('.audio-btn').forEach(b => {
        if (b !== btn) { b.disabled = true; b.classList.add('disabled'); }
    });
}

globalAudio.addEventListener('ended', stopAllAudio);
globalAudio.addEventListener('error', stopAllAudio);

// ====================================
// HP ì—…ë°ì´íŠ¸
// ====================================
function updateHp(newHp) {
    currentHp = Math.max(0, Math.min(newHp, maxHp));
    const percentage = (currentHp / maxHp) * 100;

    const hpBar   = document.getElementById('hp-bar');
    const hpValue = document.getElementById('hp-value');

    if (hpBar) {
        hpBar.style.width = percentage + '%';
        if (percentage > 70)      hpBar.className = 'hp-fill hp-high';
        else if (percentage > 30) hpBar.className = 'hp-fill hp-medium';
        else                      hpBar.className = 'hp-fill hp-low';
    }
    if (hpValue) {
        hpValue.textContent = `${currentHp} / ${maxHp}`;
    }

    updateProfileImage(currentHp);

    // ê°¤ëŸ¬ë¦¬ë„ ê°±ì‹ 
    if (typeof renderGallery === 'function') renderGallery();
}

function updateProfileImage(hp) {
    const profileImg = document.getElementById('profile-image');
    if (!profileImg) return;
    const matchingImage = subImages.find(sub => hp >= sub.minHp && hp <= sub.maxHp);
    const nextSrc = (matchingImage && matchingImage.image) ? matchingImage.image : aiImage;
    if (!nextSrc || profileImg.src.includes(nextSrc)) return;
    profileImg.style.opacity = '0';
    setTimeout(() => {
        profileImg.src = nextSrc;
        profileImg.style.opacity = '1';
    }, 300);
}

// ====================================
// í…ìŠ¤íŠ¸ í¬ë§·íŒ… (ë‚˜ë ˆì´ì…˜/ëŒ€ì‚¬ ë¶„ë¦¬)
// ====================================
function formatAIText(text) {
    let result = '';
    const parts = [];
    let lastIndex = 0;
    const dialogueRegex = /"([^"]+)"/g;
    let match;

    while ((match = dialogueRegex.exec(text)) !== null) {
        if (match.index > lastIndex) {
            const narration = text.substring(lastIndex, match.index).trim();
            if (narration) parts.push({ type: 'narration', text: narration });
        }
        parts.push({ type: 'dialogue', text: match[1] });
        lastIndex = match.index + match[0].length;
    }
    if (lastIndex < text.length) {
        const remaining = text.substring(lastIndex).trim();
        if (remaining) parts.push({ type: 'narration', text: remaining });
    }
    if (parts.length === 0) parts.push({ type: 'dialogue', text: text });

    parts.forEach(part => {
        let content = part.text
            .replace(/\n/g, '<br>')
            .replace(/\*([^*]+)\*/g, '<em>$1</em>')
            .replace(/\[([^\]]+)\]/g, '<span class="text-emotion">$1</span>');
        if (part.type === 'narration') {
            result += `<span class="text-narration">${content}</span>`;
        } else {
            result += `<span class="text-dialogue">"${content}"</span>`;
        }
    });
    return result;
}

// ====================================
// ë©”ì‹œì§€ ì¶”ê°€
// ====================================
function addMessage(text, isAi = true, messageId = null) {
    const area   = document.getElementById('message-area');
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${isAi ? 'ai-message' : 'user-message'}`;
    if (messageId) msgDiv.dataset.msgId = messageId;

    if (isAi) {
        const formattedText = formatAIText(text);
        msgDiv.innerHTML = `
            <div class="message-avatar">
                ${aiImage ? `<img src="${aiImage}" alt="${aiName}">` : `<span>${aiName.charAt(0)}</span>`}
            </div>
            <div class="message-body">
                <div class="message-bubble">${formattedText}</div>
                <div class="message-actions">
                    <button class="tts-btn" data-msg-id="${messageId || ''}" title="ìŒì„± ìƒì„±">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                        <span>ìŒì„± ìƒì„±</span>
                    </button>
                </div>
            </div>`;
    } else {
        msgDiv.innerHTML = `
            <div class="message-body">
                <div class="message-bubble"><p>${text.replace(/\n/g, '<br>')}</p></div>
            </div>`;
    }


    area.appendChild(msgDiv);
    area.scrollTop = area.scrollHeight;
    return msgDiv;
}

// ====================================
// íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
// ====================================
function showTypingIndicator() {
    const area      = document.getElementById('message-area');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message typing-indicator';
    typingDiv.id        = 'typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-avatar">
            ${aiImage ? `<img src="${aiImage}" alt="${aiName}">` : `<span>${aiName.charAt(0)}</span>`}
        </div>
        <div class="message-body">
            <div class="message-bubble typing-bubble">
                <div class="typing-dots"><span></span><span></span><span></span></div>
            </div>
        </div>`;
    area.appendChild(typingDiv);
    area.scrollTop = area.scrollHeight;
}

function hideTypingIndicator() {
    const typing = document.getElementById('typing-indicator');
    if (typing) typing.remove();
}

// ====================================
// í•´ê¸ˆ ê°¤ëŸ¬ë¦¬
// ====================================
let galleryIndex = 0;

function getUnlocked() {
    return subImages.filter(sub => currentHp >= sub.minHp);
}

function renderGalleryDots(unlocked) {
    const dotsEl = document.getElementById('gallery-dots');
    if (!dotsEl) return;
    dotsEl.innerHTML = '';
    subImages.forEach((sub, i) => {
        const isUnlocked = currentHp >= sub.minHp;
        const isActive   = isUnlocked && unlocked.indexOf(sub) === galleryIndex;
        const dot = document.createElement('span');
        dot.className = 'gallery-dot' +
            (!isUnlocked ? ' locked' : '') +
            (isActive    ? ' active'  : '');
        if (isUnlocked) {
            const capturedIdx = unlocked.indexOf(sub);
            if (capturedIdx !== -1) {
                dot.addEventListener('click', () => {
                    galleryIndex = capturedIdx;
                    renderGallery();
                });
            }
        }
        dotsEl.appendChild(dot);
    });
}

function renderGallery() {
    const viewerImg  = document.getElementById('gallery-viewer-img');
    const lockedMsg  = document.getElementById('gallery-locked-msg');
    const caption    = document.getElementById('gallery-caption');
    const countEl   = document.getElementById('gallery-count');
    const prevBtn    = document.getElementById('gallery-prev');
    const nextBtn    = document.getElementById('gallery-next');
    if (!viewerImg) return;

    const unlocked    = getUnlocked();
    const unlockCount = unlocked.length;
    const total       = subImages.length;

    countEl.textContent = `${unlockCount} / ${total}`;

    if (unlockCount === 0) {
        viewerImg.style.display  = 'none';
        lockedMsg.style.display  = 'flex';
        caption.style.display    = 'none';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        renderGalleryDots([]);
        return;
    }

    if (galleryIndex >= unlockCount) galleryIndex = unlockCount - 1;

    const current = unlocked[galleryIndex];

    viewerImg.style.opacity = '0';
    setTimeout(() => {
        viewerImg.src           = current.image;
        viewerImg.alt           = current.title || '';
        viewerImg.style.display = 'block';
        viewerImg.style.opacity = '1';
    }, 180);

    lockedMsg.style.display = 'none';

    if (current.title) {
        caption.textContent   = current.title;
        caption.style.display = 'block';
    } else {
        caption.style.display = 'none';
    }

    prevBtn.disabled = (galleryIndex === 0);
    nextBtn.disabled = (galleryIndex === unlockCount - 1);

    renderGalleryDots(unlocked);
}

// ====================================
// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
// ====================================
document.addEventListener('DOMContentLoaded', function() {
    updateHp(currentHp);

    // ê°¤ëŸ¬ë¦¬ ì´ì „/ë‹¤ìŒ ë²„íŠ¼
    document.getElementById('gallery-prev')?.addEventListener('click', () => {
        if (galleryIndex > 0) { galleryIndex--; renderGallery(); }
    });
    document.getElementById('gallery-next')?.addEventListener('click', () => {
        const unlocked = getUnlocked();
        if (galleryIndex < unlocked.length - 1) { galleryIndex++; renderGallery(); }
    });

    // ê¸°ì¡´ AI ë©”ì‹œì§€ í¬ë§·íŒ…
    document.querySelectorAll('.ai-message .message-bubble').forEach(bubble => {
        const p = bubble.querySelector('p');
        if (p && !bubble.querySelector('.text-dialogue') && !bubble.querySelector('.text-narration')) {
            const originalText = p.innerText;
            if (originalText) bubble.innerHTML = formatAIText(originalText);
        }
    });

    const area = document.getElementById('message-area');
    if (area) area.scrollTop = area.scrollHeight;

    const input = document.getElementById('text-input');
    if (input) {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendTextMessage();
            }
        });
    }

    const sendBtn = document.getElementById('send-btn');
    if (sendBtn) sendBtn.addEventListener('click', sendTextMessage);

    // ëª¨ë°”ì¼ í”„ë¡œí•„ í† ê¸€
    const toggleProfileBtn = document.getElementById('toggle-profile-btn');
    const profilePanel     = document.querySelector('.profile-panel');
    if (toggleProfileBtn && profilePanel) {
        toggleProfileBtn.addEventListener('click', () => profilePanel.classList.toggle('show'));
    }

    // ë°°ê²½ ì´ë¯¸ì§€ ë·°ì–´ í† ê¸€
    const backgroundViewer  = document.getElementById('background-viewer');
    const chatContainer     = document.getElementById('chat-container');
    const toggleBgBtn       = document.getElementById('toggle-background-btn');
    const desktopToggleBgBtn = document.getElementById('desktop-toggle-background-btn');
    const closeViewerBtn    = document.getElementById('close-viewer-btn');
    const bgViewerImage     = document.getElementById('background-viewer-image');

    function showBackgroundViewer() {
        const matchingImage = subImages.find(sub => currentHp >= sub.minHp && currentHp <= sub.maxHp);
        const imgSrc = (matchingImage && matchingImage.image) ? matchingImage.image : aiImage;
        if (bgViewerImage && imgSrc) bgViewerImage.src = imgSrc;
        backgroundViewer.classList.add('show');
        chatContainer.classList.add('hidden');
    }

    function hideBackgroundViewer() {
        backgroundViewer.classList.remove('show');
        chatContainer.classList.remove('hidden');
    }

    if (toggleBgBtn)       toggleBgBtn.addEventListener('click', showBackgroundViewer);
    if (desktopToggleBgBtn) desktopToggleBgBtn.addEventListener('click', showBackgroundViewer);
    if (closeViewerBtn)    closeViewerBtn.addEventListener('click', hideBackgroundViewer);

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && backgroundViewer.classList.contains('show')) hideBackgroundViewer();
    });
});

// ì´ë²¤íŠ¸ ìœ„ì„ - TTS / ì˜¤ë””ì˜¤ ë²„íŠ¼
document.addEventListener('click', function(e) {
    const ttsBtn = e.target.closest('.tts-btn');
    if (ttsBtn && !ttsBtn.disabled) {
        generateTTS(ttsBtn, ttsBtn.dataset.msgId);
        return;
    }
    const audioBtn = e.target.closest('.audio-btn');
    if (audioBtn && !audioBtn.disabled) {
        const audioUrl = audioBtn.dataset.audioUrl;
        if (audioUrl) playAudio(audioUrl, audioBtn);
    }
});
</script>
{% endblock %}