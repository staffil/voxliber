{% extends "base.html" %}
{% load static i18n %}

{% block title %}{{ llm.name }} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/character/chat.css' %}?v=3">
{% endblock %}

{% block content %}
<br><br><br>
<!-- ë°°ê²½ ì´ë¯¸ì§€ ë·°ì–´ (í† ê¸€) -->
<div class="background-viewer" id="background-viewer">
    <img src="{% if sub_images_data %}{{ sub_images_data.0.image_url }}{% elif llm.llm_image %}{{ llm.llm_image.url }}{% endif %}"
         alt="{{ llm.name }}"
         class="background-viewer-image"
         id="background-viewer-image">
    <button class="background-viewer-close" id="close-viewer-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
        <span>ì±„íŒ…ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
    </button>
</div>

<div class="chat-container" id="chat-container">
    <!-- ì‚¬ì´ë“œ í”„ë¡œí•„ íŒ¨ë„ -->
    <aside class="profile-panel">
        <div class="profile-image-wrapper">
            {% if llm.llm_image %}
            <img src="{{ llm.llm_image.url }}" alt="{{ llm.name }}" class="profile-image" id="profile-image">
            {% else %}
            <div class="profile-image-placeholder">
                <span>{{ llm.name|slice:":1" }}</span>
            </div>
            {% endif %}
            <div class="profile-gradient-overlay"></div>
        </div>

        <div class="profile-info">
            <h2 class="profile-name">{{ llm.name }}</h2>
            <div class="profile-status">
                <span class="status-dot"></span>
                <span>ì˜¨ë¼ì¸</span>
            </div>
        </div>

        <!-- HP ë°” -->
        <div class="hp-section">
            <div class="hp-header">
                <span class="hp-label">í˜¸ê°ë„</span>
                <span class="hp-value" id="hp-value">{{ current_hp|default:100 }} / {{ max_hp|default:100 }}</span>
            </div>
            <div class="hp-bar">
                <div class="hp-fill" id="hp-bar"></div>
            </div>
        </div>

        <!-- ë°°ê²½ ë³´ê¸° ë²„íŠ¼ (ë°ìŠ¤í¬íƒ‘) -->
        <button class="view-background-btn" id="desktop-toggle-background-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
            <span>ë°°ê²½ ì´ë¯¸ì§€ ë³´ê¸°</span>
        </button>
<div class="lore-hint-box">
    <div class="lore-hint-title">
        ğŸ’¡ ë°˜ì‘í•˜ëŠ” ë‹¨ì–´
    </div>

    <div class="lore-hint-desc">
        ì´ ë‹¨ì–´ë“¤ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•˜ë©´<br>
        í˜¸ê°ë„ê°€ ë” ì‰½ê²Œ ì˜¬ë¼ê°ˆì§€ë„ ëª°ë¼ìš”.
    </div>

    <div class="lore-hint-tags">
        {% for ward in loarbook_list %}
            <span class="lore-tag">{{ ward.keys }}</span>
        {% empty %}
            <span class="lore-empty">ì•„ì§ ë°œê²¬ëœ ë‹¨ì„œê°€ ì—†ìŠµë‹ˆë‹¤</span>
        {% endfor %}
    </div>
</div>

        <a href="javascript:history.back()" class="back-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            <span>ëŒì•„ê°€ê¸°</span>
        </a>
    </aside>

    <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <main class="chat-main">
        <!-- ëª¨ë°”ì¼ í—¤ë” -->
        <header class="mobile-header">
            <a href="javascript:history.back()" class="mobile-back-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <div class="mobile-profile">
                {% if llm.llm_image %}
                <img src="{{ llm.llm_image.url }}" alt="{{ llm.name }}" class="mobile-avatar">
                {% endif %}
                <div class="mobile-info">
                    <span class="mobile-name">{{ llm.name }}</span>
                    <span class="mobile-status">ì˜¨ë¼ì¸</span>
                </div>
            </div>
            <div class="mobile-header-actions">
                <!-- ë°°ê²½ ë³´ê¸° ë²„íŠ¼ -->
                <button class="header-icon-btn" id="toggle-background-btn" title="ë°°ê²½ ì´ë¯¸ì§€ ë³´ê¸°">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
                <button class="mobile-menu-btn" id="toggle-profile-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="messages-container" id="message-area">
            {% if not messages %}
            <!-- ì²« ì¸ì‚¬ ë©”ì‹œì§€ -->
            <div class="message ai-message">
                <div class="message-avatar">
                    {% if llm.llm_image %}
                    <img src="{{ llm.llm_image.url }}" alt="{{ llm.name }}">
                    {% else %}
                    <span>{{ llm.name|slice:":1" }}</span>
                    {% endif %}
                </div>
                <div class="message-body">
                    <div class="message-bubble">
                        {% if llm.description %}
                        <p class="narration">{{ llm.description }}</p>
                        {% endif %}
                        <p class="dialogue">{% if llm.first_sentence %}{{ llm.first_sentence }}{% else %}ì•ˆë…•í•˜ì„¸ìš”!{% endif %}</p>
                    </div>
                </div>
            </div>
            {% endif %}

            {% for msg in messages %}
            <div class="message {% if msg.role == 'assistant' %}ai-message{% else %}user-message{% endif %}" data-msg-id="{{ msg.id }}">
                {% if msg.role == 'assistant' %}
                <div class="message-avatar">
                    {% if llm.llm_image %}
                    <img src="{{ llm.llm_image.url }}" alt="{{ llm.name }}">
                    {% else %}
                    <span>{{ llm.name|slice:":1" }}</span>
                    {% endif %}
                </div>
                {% endif %}
                <div class="message-body">
                    <div class="message-bubble">
                        <p>{{ msg.content|linebreaksbr|safe }}</p>
                    </div>
                    {% if msg.role == 'assistant' %}
                    <div class="message-actions">
                        {% if msg.audio %}
                        <button class="audio-btn has-audio" data-audio-url="{{ msg.audio.url }}" title="ìŒì„± ì¬ìƒ">
                            <svg class="icon-play" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <svg class="icon-pause" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                                <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
                            </svg>
                        </button>
                        {% else %}
                        <button class="tts-btn" data-msg-id="{{ msg.id }}" title="ìŒì„± ìƒì„±">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            </svg>
                            <span>ìŒì„± ìƒì„±</span>
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="input-container">
            <div class="input-wrapper">
                <input type="text"
                       id="text-input"
                       class="message-input"
                       placeholder="{{ llm.name }}ì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°..."
                       autocomplete="off"
                       data-login-required>
                <button class="send-btn" id="send-btn" title="ì „ì†¡">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- ìˆ¨ê²¨ì§„ ì˜¤ë””ì˜¤ ìš”ì†Œ -->
<audio id="global-audio" style="display:none;"></audio>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/character/chat.js' %}"></script>
<script>
// ====================================
// ê¸°ë³¸ ì„¤ì •
// ====================================
const aiImage = '{% if llm.llm_image %}{{ llm.llm_image.url }}{% endif %}';
const aiName = '{{ llm.name|escapejs }}';
const llmUuid = '{{ llm.public_uuid }}';
const ttsUrl = '{% url "character:chat-tts" llm.public_uuid %}';
const chatUrl = '{% url "character:chat-logic" llm.public_uuid %}';
const csrfToken = '{{ csrf_token }}';

// HP ì„¤ì •
let currentHp = {{ current_hp|default:0 }};
let maxHp = {{ max_hp|default:100 }};

// ì„œë¸Œ ì´ë¯¸ì§€
const subImages = [
    {% for sub in sub_images_data %}
    { image: '{{ sub.image_url }}', minHp: {{ sub.min_hp }}, maxHp: {{ sub.max_hp }}, title: '{{ sub.title|escapejs|default:"" }}' }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// ====================================
// ì˜¤ë””ì˜¤ ê´€ë¦¬ (ë‹¨ì¼ ì¬ìƒ)
// ====================================
const globalAudio = document.getElementById('global-audio');
let currentPlayingBtn = null;

function stopAllAudio() {
    if (globalAudio) {
        globalAudio.pause();
        globalAudio.currentTime = 0;
    }
    if (currentPlayingBtn) {
        currentPlayingBtn.classList.remove('playing');
        const playIcon = currentPlayingBtn.querySelector('.icon-play');
        const pauseIcon = currentPlayingBtn.querySelector('.icon-pause');
        if (playIcon) playIcon.style.display = '';
        if (pauseIcon) pauseIcon.style.display = 'none';
        currentPlayingBtn = null;
    }
    // ëª¨ë“  ë²„íŠ¼ í™œì„±í™”
    document.querySelectorAll('.audio-btn').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('disabled');
    });
}

function playAudio(audioUrl, btn) {
    if (currentPlayingBtn === btn && !globalAudio.paused) {
        // í˜„ì¬ ì¬ìƒ ì¤‘ì´ë©´ ì¼ì‹œì •ì§€
        globalAudio.pause();
        btn.classList.remove('playing');
        const playIcon = btn.querySelector('.icon-play');
        const pauseIcon = btn.querySelector('.icon-pause');
        if (playIcon) playIcon.style.display = '';
        if (pauseIcon) pauseIcon.style.display = 'none';

        // ë‹¤ë¥¸ ë²„íŠ¼ë“¤ í™œì„±í™”
        document.querySelectorAll('.audio-btn').forEach(b => {
            b.disabled = false;
            b.classList.remove('disabled');
        });
        currentPlayingBtn = null;
        return;
    }

    // ë‹¤ë¥¸ ì˜¤ë””ì˜¤ ì¤‘ì§€
    stopAllAudio();

    // ìƒˆ ì˜¤ë””ì˜¤ ì¬ìƒ
    globalAudio.src = audioUrl;
    globalAudio.play();
    currentPlayingBtn = btn;
    btn.classList.add('playing');

    const playIcon = btn.querySelector('.icon-play');
    const pauseIcon = btn.querySelector('.icon-pause');
    if (playIcon) playIcon.style.display = 'none';
    if (pauseIcon) pauseIcon.style.display = '';

    // ë‹¤ë¥¸ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
    document.querySelectorAll('.audio-btn').forEach(b => {
        if (b !== btn) {
            b.disabled = true;
            b.classList.add('disabled');
        }
    });
}

globalAudio.addEventListener('ended', () => {
    stopAllAudio();
});

globalAudio.addEventListener('error', () => {
    stopAllAudio();
});

// ====================================
// HP ì—…ë°ì´íŠ¸
// ====================================
function updateHp(newHp) {
    currentHp = Math.max(0, Math.min(newHp, maxHp));
    const percentage = (currentHp / maxHp) * 100;

    const hpBar = document.getElementById('hp-bar');
    const hpValue = document.getElementById('hp-value');

    if (hpBar) {
        hpBar.style.width = percentage + '%';

        // HPì— ë”°ë¥¸ ìƒ‰ìƒ
        if (percentage > 70) {
            hpBar.className = 'hp-fill hp-high';
        } else if (percentage > 30) {
            hpBar.className = 'hp-fill hp-medium';
        } else {
            hpBar.className = 'hp-fill hp-low';
        }
    }

    if (hpValue) {
        hpValue.textContent = `${currentHp} / ${maxHp}`;
    }

    updateProfileImage(currentHp);
}

function updateProfileImage(hp) {
    const profileImg = document.getElementById('profile-image');
    if (!profileImg) return;

    const matchingImage = subImages.find(sub => hp >= sub.minHp && hp <= sub.maxHp);
    const nextSrc = (matchingImage && matchingImage.image) ? matchingImage.image : aiImage;

    if (!nextSrc || profileImg.src.includes(nextSrc)) return;

    profileImg.style.opacity = '0';
    setTimeout(() => {
        profileImg.src = nextSrc;
        profileImg.style.opacity = '1';
    }, 300);
}

// ====================================
// í…ìŠ¤íŠ¸ í¬ë§·íŒ… (ë‚˜ë ˆì´ì…˜/ëŒ€ì‚¬ ë¶„ë¦¬)
// ====================================
function formatAIText(text) {
    let result = '';
    let remaining = text;

    // íŒ¨í„´ 1: *ë‚˜ë ˆì´ì…˜* í˜•ì‹
    // íŒ¨í„´ 2: "ëŒ€ì‚¬" í˜•ì‹
    // íŒ¨í„´ 3: [ê°ì •] í˜•ì‹

    // ì •ê·œì‹ìœ¼ë¡œ íŒŒì‹±
    const parts = [];
    let lastIndex = 0;

    // "ëŒ€ì‚¬" ì°¾ê¸°
    const dialogueRegex = /"([^"]+)"/g;
    let match;

    while ((match = dialogueRegex.exec(text)) !== null) {
        // ëŒ€ì‚¬ ì• ë¶€ë¶„ (ë‚˜ë ˆì´ì…˜)
        if (match.index > lastIndex) {
            const narration = text.substring(lastIndex, match.index).trim();
            if (narration) {
                parts.push({ type: 'narration', text: narration });
            }
        }

        // ëŒ€ì‚¬
        parts.push({ type: 'dialogue', text: match[1] });
        lastIndex = match.index + match[0].length;
    }

    // ë‚¨ì€ ë¶€ë¶„ (ë‚˜ë ˆì´ì…˜)
    if (lastIndex < text.length) {
        const remaining = text.substring(lastIndex).trim();
        if (remaining) {
            parts.push({ type: 'narration', text: remaining });
        }
    }

    // íŒŒì‹± ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì „ì²´ë¥¼ ëŒ€ì‚¬ë¡œ ì²˜ë¦¬
    if (parts.length === 0) {
        parts.push({ type: 'dialogue', text: text });
    }

    // HTML ìƒì„±
    parts.forEach(part => {
        let content = part.text
            .replace(/\n/g, '<br>')
            .replace(/\*([^*]+)\*/g, '<em>$1</em>') // *ì´íƒ¤ë¦­*
            .replace(/\[([^\]]+)\]/g, '<span class="text-emotion">$1</span>'); // [ê°ì •]

        if (part.type === 'narration') {
            result += `<span class="text-narration">${content}</span>`;
        } else {
            result += `<span class="text-dialogue">"${content}"</span>`;
        }
    });

    return result;
}

// ====================================
// ë©”ì‹œì§€ ì¶”ê°€
// ====================================
function addMessage(text, isAi = true, messageId = null) {
    const area = document.getElementById('message-area');
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${isAi ? 'ai-message' : 'user-message'}`;
    if (messageId) {
        msgDiv.dataset.msgId = messageId;
    }

    if (isAi) {
        const formattedText = formatAIText(text);
        msgDiv.innerHTML = `
            <div class="message-avatar">
                ${aiImage ? `<img src="${aiImage}" alt="${aiName}">` : `<span>${aiName.charAt(0)}</span>`}
            </div>
            <div class="message-body">
                <div class="message-bubble">
                    ${formattedText}
                </div>
                <div class="message-actions">
                    <button class="tts-btn" data-msg-id="${messageId || ''}" title="ìŒì„± ìƒì„±">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                        <span>ìŒì„± ìƒì„±</span>
                    </button>
                </div>
            </div>
        `;
    } else {
        const formattedText = text.replace(/\n/g, '<br>');
        msgDiv.innerHTML = `
            <div class="message-body">
                <div class="message-bubble">
                    <p>${formattedText}</p>
                </div>
            </div>
        `;
    }

    area.appendChild(msgDiv);
    area.scrollTop = area.scrollHeight;
    return msgDiv;
}

// ====================================
// íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
// ====================================
function showTypingIndicator() {
    const area = document.getElementById('message-area');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message typing-indicator';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-avatar">
            ${aiImage ? `<img src="${aiImage}" alt="${aiName}">` : `<span>${aiName.charAt(0)}</span>`}
        </div>
        <div class="message-body">
            <div class="message-bubble typing-bubble">
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>
    `;
    area.appendChild(typingDiv);
    area.scrollTop = area.scrollHeight;
}

function hideTypingIndicator() {
    const typing = document.getElementById('typing-indicator');
    if (typing) typing.remove();
}

// ====================================
// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
// ====================================
document.addEventListener('DOMContentLoaded', function() {
    // HP ì´ˆê¸°í™”
    updateHp(currentHp);

    // ê¸°ì¡´ AI ë©”ì‹œì§€ í¬ë§·íŒ…
    document.querySelectorAll('.ai-message .message-bubble').forEach(bubble => {
        const p = bubble.querySelector('p');
        if (p && !bubble.querySelector('.text-dialogue') && !bubble.querySelector('.text-narration')) {
            const originalText = p.innerText;
            if (originalText) {
                bubble.innerHTML = formatAIText(originalText);
            }
        }
    });

    // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
    const area = document.getElementById('message-area');
    if (area) area.scrollTop = area.scrollHeight;

    // ì…ë ¥ í•„ë“œ ì—”í„° í‚¤
    const input = document.getElementById('text-input');
    if (input) {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendTextMessage();
            }
        });
    }

    // ì „ì†¡ ë²„íŠ¼
    const sendBtn = document.getElementById('send-btn');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendTextMessage);
    }

    // ëª¨ë°”ì¼ í”„ë¡œí•„ í† ê¸€
    const toggleProfileBtn = document.getElementById('toggle-profile-btn');
    const profilePanel = document.querySelector('.profile-panel');
    if (toggleProfileBtn && profilePanel) {
        toggleProfileBtn.addEventListener('click', function() {
            profilePanel.classList.toggle('show');
        });
    }

    // ë°°ê²½ ì´ë¯¸ì§€ ë·°ì–´ í† ê¸€
    const backgroundViewer = document.getElementById('background-viewer');
    const chatContainer = document.getElementById('chat-container');
    const toggleBgBtn = document.getElementById('toggle-background-btn');
    const desktopToggleBgBtn = document.getElementById('desktop-toggle-background-btn');
    const closeViewerBtn = document.getElementById('close-viewer-btn');
    const bgViewerImage = document.getElementById('background-viewer-image');

    function showBackgroundViewer() {
        // HPì— ë”°ë¥¸ ë°°ê²½ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
        const matchingImage = subImages.find(sub => currentHp >= sub.minHp && currentHp <= sub.maxHp);
        const imgSrc = (matchingImage && matchingImage.image) ? matchingImage.image : aiImage;
        if (bgViewerImage && imgSrc) {
            bgViewerImage.src = imgSrc;
        }
        backgroundViewer.classList.add('show');
        chatContainer.classList.add('hidden');
    }

    function hideBackgroundViewer() {
        backgroundViewer.classList.remove('show');
        chatContainer.classList.remove('hidden');
    }

    if (toggleBgBtn) {
        toggleBgBtn.addEventListener('click', showBackgroundViewer);
    }
    if (desktopToggleBgBtn) {
        desktopToggleBgBtn.addEventListener('click', showBackgroundViewer);
    }
    if (closeViewerBtn) {
        closeViewerBtn.addEventListener('click', hideBackgroundViewer);
    }

    // ESC í‚¤ë¡œ ë°°ê²½ ë·°ì–´ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && backgroundViewer.classList.contains('show')) {
            hideBackgroundViewer();
        }
    });
});

// ì´ë²¤íŠ¸ ìœ„ì„ - TTS ë²„íŠ¼ ë° ì˜¤ë””ì˜¤ ë²„íŠ¼
document.addEventListener('click', function(e) {
    // TTS ìƒì„± ë²„íŠ¼
    const ttsBtn = e.target.closest('.tts-btn');
    if (ttsBtn && !ttsBtn.disabled) {
        const msgId = ttsBtn.dataset.msgId;
        generateTTS(ttsBtn, msgId);
        return;
    }

    // ì˜¤ë””ì˜¤ ì¬ìƒ ë²„íŠ¼
    const audioBtn = e.target.closest('.audio-btn');
    if (audioBtn && !audioBtn.disabled) {
        const audioUrl = audioBtn.dataset.audioUrl;
        if (audioUrl) {
            playAudio(audioUrl, audioBtn);
        }
        return;
    }
});
</script>
{% endblock %}
