{% extends "base.html" %}
{% load static %}

{% block title %}ê´‘ê³  - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/advertisment/photo.css' %}">

{% endblock %}

{% block content %}
<br><br><br>
<div class="container">

    {% if ad.image %}
        <img class="ad-image" src="{{ ad.image.url }}" alt="{{ ad.title }}">
    {% endif %}

    {% if ad.link_url %}
    <a class="link-btn" href="{{ ad.link_url }}" target="_blank" onclick="recordClick()">
        <div class="btn-icon">ğŸ”—</div>
        <div class="btn-label">ë°”ë¡œê°€ê¸°</div>
    </a>
    {% endif %}

    <button class="skip-btn" id="skipBtn" onclick="skipAd()">
        <span id="skipLabel">5ì´ˆ í›„ ìŠ¤í‚µ</span> â­
    </button>

    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    const skipBtn      = document.getElementById('skipBtn');
    const skipLabel    = document.getElementById('skipLabel');
    const progressFill = document.getElementById('progressFill');

    const TOTAL = 5000;
    const start = Date.now();
    let skipReady = false;

    const ticker = setInterval(() => {
        const elapsed = Date.now() - start;
        progressFill.style.width = Math.min(elapsed / TOTAL * 100, 100) + '%';

        const left = Math.max(5 - Math.floor(elapsed / 1000), 0);
        skipLabel.textContent = elapsed >= TOTAL ? 'ìŠ¤í‚µ' : `${left}ì´ˆ í›„ ìŠ¤í‚µ`;

        if (elapsed >= TOTAL) {
            clearInterval(ticker);
            skipReady = true;
            skipBtn.classList.add('active');
        }
    }, 100);

    const nextUrl = "{{ next_url|default:'/' }}";

    function skipAd() {
        if (!skipReady) return;
        fetch("{% url 'book:ad_skip' ad.public_uuid %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ watched_seconds: 5 })
        }).finally(() => window.location.href = nextUrl);
    }

    function recordClick() {
        fetch("{% url 'book:ad_click' ad.public_uuid %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        });
    }
</script>
{% endblock %}