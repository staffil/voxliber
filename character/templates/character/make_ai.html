{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% if is_edit_mode %}AI ìºë¦­í„° í¸ì§‘{% else %}AI ìºë¦­í„° ë§Œë“¤ê¸°{% endif %} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/character/make_ai.css' %}">
{% endblock %}

{% block content %}
<br><br><br><br>

<main class="ai-create-container">
    <div class="ai-create-header">
        <h1 class="ai-create-title">
            <span class="title-icon">ğŸ¤–</span>
            {% if is_edit_mode %}AI ìºë¦­í„° í¸ì§‘{% else %}AI ìºë¦­í„° ë§Œë“¤ê¸°{% endif %}
        </h1>
        <p class="ai-create-subtitle">{% if is_edit_mode %}{{ llm.name }}ì˜ ì„¤ì •ì„ ìˆ˜ì •í•˜ì„¸ìš”{% else %}ë‚˜ë§Œì˜ AI ìºë¦­í„°ë¥¼ ìƒì„±í•˜ì„¸ìš”{% endif %}</p>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tab-navigation">
        <button type="button" class="tab-btn active" data-tab="tab-name">
            <span class="tab-icon">âœï¸</span>
            <span class="tab-text">ê¸°ë³¸ ì •ë³´</span>
        </button>
        <button type="button" class="tab-btn" data-tab="tab-voice">
            <span class="tab-icon">ğŸ™ï¸</span>
            <span class="tab-text">ëª©ì†Œë¦¬ ì„¤ì •</span>
        </button>
        <button type="button" class="tab-btn" data-tab="tab-lore">
            <span class="tab-icon">ğŸ“–</span>
            <span class="tab-text">ë¡œì–´ë¶</span>
        </button>
        <button type="button" class="tab-btn" data-tab="tab-image">
            <span class="tab-icon">ğŸ–¼ï¸</span>
            <span class="tab-text">ì„œë¸Œ ì´ë¯¸ì§€</span>
        </button>
<button type="button" class="tab-btn" data-tab="tab-extra-last-image">
    <span class="tab-icon">ğŸ–Œï¸</span>
    <span class="tab-text">ë§ˆì§€ë§‰ ì´ë¯¸ì§€ ì¶”ê°€</span>
</button>

    </div>

    <!-- ì§„í–‰ í‘œì‹œ ë°” -->
    <div class="progress-bar">
        <div class="progress-fill" style="width: 25%;"></div>
    </div>

    <form method="POST" action="{% if is_edit_mode %}{% url 'character:make_ai_update' llm.public_uuid %}{% elif story_uuid %}{% url 'character:make_ai_with_story' story_uuid %}{% else %}{% url 'character:make_ai' %}{% endif %}" enctype="multipart/form-data" id="ai-create-form">
        {% csrf_token %}

        <!-- íƒ­ 1: ê¸°ë³¸ ì •ë³´ -->
        <div class="tab-content active" id="tab-name">
            <div class="tab-panel">
                <div class="panel-header">
                    <h2>ê¸°ë³¸ ì •ë³´</h2>
                    <p>AI ìºë¦­í„°ì˜ ì´ë¦„ê³¼ ì„±ê²©ì„ ì„¤ì •í•˜ì„¸ìš”</p>
                </div>

                <div class="form-group">
                    <label for="ai_name" class="form-label">
                        <span class="label-icon">ğŸ‘¤</span>
                        AI ì´ë¦„
                    </label>
                    <input type="text" name="ai_name" id="ai_name" class="form-input" placeholder="AI ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value="{{ llm.name|default:'' }}" required>
                    <span class="form-hint">ìºë¦­í„°ì˜ ê³ ìœ í•œ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”</span>
                </div>

                <div class="form-group">
                    <label for="prompt" class="form-label">
                        <span class="label-icon">ğŸ’¬</span>
                        í”„ë¡¬í”„íŠ¸
                    </label>
                    <textarea
                        name="prompt"
                        id="prompt"
                        class="form-textarea"
                        placeholder="AIì˜ ì„±ê²©, ë§íˆ¬, ë°°ê²½ ìŠ¤í† ë¦¬ ë“±ì„ ìì„¸íˆ ì‘ì„±í•˜ì„¸ìš”..."
                        rows="6"
                        maxlength="500"
                        required
                    >{{ llm.prompt|default:'' }}</textarea>
                    <div class="textarea-counter">
                        <span id="prompt-count">{{ llm.prompt|length|default:0 }}</span>/700ì
                    </div>
                    <span class="form-hint">ìƒì„¸í• ìˆ˜ë¡ ë” ì •í™•í•œ ìºë¦­í„°ê°€ ìƒì„±ë©ë‹ˆë‹¤</span>
                </div>

                <div class="form-group">
                    <label for="first_sentence" class="form-label">
                        <span class="label-icon">ğŸ’­</span>
                        ì²« ë§ˆë””
                    </label>
                    <input type="text" name="first_sentence" id="first_sentence" class="form-input" placeholder="AIê°€ ëŒ€í™”ë¥¼ ì‹œì‘í•  ë•Œ í•  ë§" value="{{ llm.first_sentence|default:'' }}" maxlength="200">
                    <span class="form-hint">ì‚¬ìš©ìì™€ ì²˜ìŒ ëŒ€í™”ë¥¼ ì‹œì‘í•  ë•Œ AIê°€ í•  ì¸ì‚¬ë§</span>
                </div>

                

                <div class="form-group">
                    <label for="distribute" class="form-label">
                        <span class="label-icon">ğŸ“</span>
                        ì„¤ëª…
                    </label>
                    <textarea
                        name="description"
                        id="distribute"
                        class="form-textarea"
                        placeholder="ì´ AIì˜ íŠ¹ì§•ì„ ê°„ë‹¨íˆ ì„¤ëª…í•˜ì„¸ìš”. ì˜ˆ: ì¹œê·¼í•˜ê³  ìœ ë¨¸ëŸ¬ìŠ¤í•œ ëŒ€í™” ìƒëŒ€..."
                        rows="3"
                    >{{ llm.description|default:'' }}</textarea>
                    <span class="form-hint">ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì§ˆ AI ì†Œê°œê¸€</span>
                </div>

                <!-- AI í”„ë¡œí•„ ì´ë¯¸ì§€ (ê¸°ë³¸ ì •ë³´ì—ì„œ ë¹ ë¥´ê²Œ ì„¤ì •) -->
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ“·</span>
                        í”„ë¡œí•„ ì´ë¯¸ì§€
                    </label>
                    <div class="profile-image-quick">
                        <div class="profile-upload-mini" id="profile-upload-mini">
                            <input type="file" name="llm_image" accept="image/*" id="llm_image" class="file-input-hidden">
                            {% if llm.llm_image %}
                                <div class="upload-mini-placeholder" id="upload-mini-placeholder" style="display: none;">
                                    <span class="upload-mini-icon">ğŸ“</span>
                                    <span class="upload-mini-text">ì´ë¯¸ì§€ ì„ íƒ</span>
                                </div>
                                <img id="preview-image-mini" class="preview-image-mini" src="{{ llm.llm_image.url }}" alt="ë¯¸ë¦¬ë³´ê¸°" style="display: block;">
                            {% else %}
                                <div class="upload-mini-placeholder" id="upload-mini-placeholder">
                                    <span class="upload-mini-icon">ğŸ“</span>
                                    <span class="upload-mini-text">ì´ë¯¸ì§€ ì„ íƒ</span>
                                </div>
                                <img id="preview-image-mini" class="preview-image-mini" alt="ë¯¸ë¦¬ë³´ê¸°" style="display: none;">
                            {% endif %}
                        </div>
                        <div class="profile-upload-hint">
                            <span class="form-hint">ëŒ€í™” ì¤‘ í‘œì‹œë  AI ìºë¦­í„°ì˜ ì–¼êµ´ ì´ë¯¸ì§€</span>
                            <span class="form-hint">ì´ë¯¸ì§€ íƒ­ì—ì„œ ë” ìƒì„¸í•œ ì„¤ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒ­ 2: ëª©ì†Œë¦¬ ì„¤ì • -->
        <div class="tab-content" id="tab-voice">
            <div class="tab-panel">
                <div class="panel-header">
                    <h2>ëª©ì†Œë¦¬ ì„¤ì •</h2>
                    <p>AIì˜ ì–¸ì–´ì™€ ìŒì„±ì„ ì„ íƒí•˜ì„¸ìš”</p>
                </div>

                <div class="form-group">
                    <label for="language" class="form-label">
                        <span class="label-icon">ğŸŒ</span>
                        ì–¸ì–´
                    </label>
                    <select name="language" id="language" class="form-select" required>
                        <option value="ko" {% if llm.language == 'ko' or not llm %}selected{% endif %}>ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                        <option value="en" {% if llm.language == 'en' %}selected{% endif %}>ğŸ‡ºğŸ‡¸ English</option>
                        <option value="ja" {% if llm.language == 'ja' %}selected{% endif %}>ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                        <option value="zh" {% if llm.language == 'zh' %}selected{% endif %}>ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                        <option value="es" {% if llm.language == 'es' %}selected{% endif %}>ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                        <option value="fr" {% if llm.language == 'fr' %}selected{% endif %}>ğŸ‡«ğŸ‡· FranÃ§ais</option>
                        <option value="de" {% if llm.language == 'de' %}selected{% endif %}>ğŸ‡©ğŸ‡ª Deutsch</option>
                        <option value="ru" {% if llm.language == 'ru' %}selected{% endif %}>ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="pt" {% if llm.language == 'pt' %}selected{% endif %}>ğŸ‡§ğŸ‡· PortuguÃªs</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="model" class="form-label">
                        <span class="label-icon">ğŸ§ </span>
                        AI ëª¨ë¸
                    </label>
                    <select name="model" id="model" class="form-select" required>
                        <option value="gpt-4o-mini" {% if llm.model == 'gpt-4o-mini' or not llm %}selected{% endif %}>GPT-4o-mini (ë¹ ë¥¸ ì‘ë‹µ)</option>
                        <option value="grok-3-mini" {% if llm.model == 'grok-3-mini' %}selected{% endif %}>Grok-3-mini (ì°½ì˜ì  ëŒ€í™”)</option>
                    </select>
                    <span class="form-hint">Grok-3-miniëŠ” ì‘ë‹µì´ ëŠë¦¬ì§€ë§Œ ìê·¹ì ì¸ ëŒ€í™”ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤..</span>
                </div>

                <!-- ìˆ¨ê²¨ì§„ voice_id ì…ë ¥ í•„ë“œ -->
                <input type="hidden" name="voice_id" id="voice_id" value="{{ initial_voice_id|default:'' }}">

                <div class="voice-selection">
                    <label class="form-label">
                        <span class="label-icon">ğŸ”Š</span>
                        ëª©ì†Œë¦¬ ì„ íƒ
                    </label>

                    <!-- ëª©ì†Œë¦¬ ê²€ìƒ‰ -->
                    <div class="voice-search-wrapper">
                        <input type="text" id="voice-search" class="form-input" placeholder="ğŸ” ëª©ì†Œë¦¬ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰...">
                    </div>

                    <!-- ëª©ì†Œë¦¬ íƒ€ì… í•„í„° -->
                    <div class="voice-type-filters" id="voice-type-filters">
                        {% for vtype in voice_types %}
                        <button type="button" class="voice-type-btn" data-type-id="{{ vtype.id }}" data-type-name="{{ vtype.name }}">
                            {{ vtype.name }}
                        </button>
                        {% endfor %}
                    </div>

                    <!-- ì„ íƒëœ ëª©ì†Œë¦¬ í‘œì‹œ -->
                    <div class="selected-voice-display" id="selected-voice-display" style="display: none;">
                        <div class="selected-voice-info">
                            <img id="selected-voice-img" src="" alt="ì„ íƒëœ ëª©ì†Œë¦¬">
                            <div class="selected-voice-text">
                                <span class="selected-voice-name" id="selected-voice-name"></span>
                                <button type="button" class="btn-clear-voice" id="clear-voice-btn">âœ• ì„ íƒ í•´ì œ</button>
                            </div>
                        </div>
                    </div>

                    <p class="voice-hint">ì›í•˜ëŠ” ëª©ì†Œë¦¬ë¥¼ í´ë¦­í•˜ê³  ìƒ˜í”Œì„ ë“¤ì–´ë³´ì„¸ìš”</p>

                    <div class="voice-grid" id="voice-grid">
                        {% for voice in voice_list %}
                        <div class="voice-card {% if voice.voice_id == initial_voice_id %}selected{% endif %}"
                             data-voice-id="{{ voice.voice_id }}"
                             data-voice-name="{{ voice.voice_name }}"
                             data-voice-types="{% for t in voice.types.all %}{{ t.id }}{% if not forloop.last %},{% endif %}{% endfor %}"
                             data-voice-image="{% if voice.voice_image %}{{ voice.voice_image.url }}{% endif %}"
                             data-sample-audio="{% if voice.sample_audio %}{{ voice.sample_audio.url }}{% endif %}">
                            <div class="voice-card-image">
                                {% if voice.voice_image %}
                                    <img src="{{ voice.voice_image.url }}" alt="{{ voice.voice_name }}">
                                {% else %}
                                    <div class="voice-card-placeholder">ğŸ¤</div>
                                {% endif %}
                            </div>
                            <div class="voice-card-info">
                                <span class="voice-name">{{ voice.voice_name }}</span>
                                <!-- {% if voice.voice_description %}
                                    <span class="voice-desc">{{ voice.voice_description|truncatewords:5 }}</span>
                                {% endif %} -->
                            </div>
                            {% if voice.sample_audio %}
                            <button type="button" class="btn-play-sample" data-audio="{{ voice.sample_audio.url }}">
                                <span class="play-icon">â–¶</span>
                            </button>
                            {% endif %}
                        </div>
                        {% empty %}
                        <p class="no-voice">ë“±ë¡ëœ ëª©ì†Œë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        {% endfor %}
                    </div>

                    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ (ìˆ¨ê¹€) -->
                    <audio id="voice-sample-player" style="display: none;"></audio>
                </div>

                </div>
            </div>
        </div>

        <!-- íƒ­ 3: ë¡œì–´ë¶ -->
        <div class="tab-content" id="tab-lore">
            <div class="tab-panel">
                <div class="panel-header">
                    <h2>ë¡œì–´ë¶</h2>
                    <p>í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ AIì—ê²Œ ì£¼ì…í•  ì„¤ì •ì„ ì¶”ê°€í•˜ì„¸ìš”</p>
                </div>

                <div class="lore-info">
                    <span class="info-icon">ğŸ’¡</span>
                    <p>ëŒ€í™” ì¤‘ íŠ¹ì • í‚¤ì›Œë“œê°€ ë‚˜ì˜¤ë©´ í•´ë‹¹ ë‚´ìš©ì´ AIì—ê²Œ ìë™ìœ¼ë¡œ ì£¼ì…ë©ë‹ˆë‹¤</p>
                </div>

                <div id="lore-entries-container">
                    {% if is_edit_mode and lore_entries %}
                        <!-- ê¸°ì¡´ ë¡œì–´ë¶ í•­ëª©ë“¤ -->
                        {% for entry in lore_entries %}
                        <div class="lore-entry">
                            <div class="lore-entry-header">
                                <span class="lore-number">{{ forloop.counter }}</span>
                                <button type="button" class="remove-lore-entry">
                                    <span>âœ•</span>
                                </button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">í™œì„±í™” í‚¤ì›Œë“œ</label>
                                <textarea
                                    name="lore_keys[]"
                                    class="form-textarea"
                                    rows="2"
                                    placeholder="ì‰¼í‘œ(,) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ (ì˜ˆ: ë§ˆì„, ì™•ê¶, ì €ì£¼ë°›ì€ ê²€)"
                                >{{ entry.keys }}</textarea>
                                <span class="form-hint">ì´ í‚¤ì›Œë“œê°€ ëŒ€í™”ì— ë‚˜ì˜¤ë©´ ì•„ë˜ ë‚´ìš©ì´ ì£¼ì…ë©ë‹ˆë‹¤</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ì£¼ì…ë  ë‚´ìš©</label>
                                <textarea
                                    name="lore_content[]"
                                    class="form-textarea"
                                    rows="4"
                                    placeholder="AIì—ê²Œ ì£¼ì…í•  ì„¤ëª…, ì‚¬ì‹¤, ì„¤ì • ë“±ì„ ìì„¸íˆ ì‘ì„±í•˜ì„¸ìš”"
                                >{{ entry.content }}</textarea>
                            </div>

                            <div class="lore-options">
                                <div class="form-group form-group-inline">
                                    <label class="form-label">ìš°ì„ ìˆœìœ„</label>
                                    <input type="number" name="lore_priority[]" class="form-input-small" value="{{ entry.priority|default:0 }}" min="0">
                                    <span class="form-hint">ë†’ì„ìˆ˜ë¡ ë¨¼ì € ì£¼ì…</span>
                                </div>

                                <div class="form-group form-group-inline">
                                    <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                                    <select name="lore_category[]" class="form-select-small">
                                        <option value="" {% if not entry.category %}selected{% endif %}>ì„ íƒ ì•ˆ í•¨</option>
                                        <option value="personality" {% if entry.category == 'personality' %}selected{% endif %}>ì„±ê²©</option>
                                        <option value="world" {% if entry.category == 'world' %}selected{% endif %}>ì„¸ê³„ê´€</option>
                                        <option value="relationship" {% if entry.category == 'relationship' %}selected{% endif %}>ê´€ê³„</option>
                                    </select>
                                </div>

                                <div class="form-group form-group-checkbox">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="lore_always_active[]" value="true" {% if entry.always_active %}checked{% endif %}>
                                        <span class="checkbox-custom"></span>
                                        <span>í•­ìƒ í¬í•¨</span>
                                    </label>
                                    <span class="form-hint">ì£¼ì˜: í† í° ì†Œëª¨ ì¦ê°€</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <!-- ê¸°ë³¸ ë¡œì–´ë¶ í•­ëª© (ìƒˆë¡œ ë§Œë“¤ê¸° ëª¨ë“œ) -->
                        <div class="lore-entry">
                            <div class="lore-entry-header">
                                <span class="lore-number">1</span>
                                <button type="button" class="remove-lore-entry">
                                    <span>âœ•</span>
                                </button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">í™œì„±í™” í‚¤ì›Œë“œ</label>
                                <textarea
                                    name="lore_keys[]"
                                    class="form-textarea"
                                    rows="2"
                                    placeholder="ì‰¼í‘œ(,) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ (ì˜ˆ: ë§ˆì„, ì™•ê¶, ì €ì£¼ë°›ì€ ê²€)"
                                ></textarea>
                                <span class="form-hint">ì´ í‚¤ì›Œë“œê°€ ëŒ€í™”ì— ë‚˜ì˜¤ë©´ ì•„ë˜ ë‚´ìš©ì´ ì£¼ì…ë©ë‹ˆë‹¤</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ì£¼ì…ë  ë‚´ìš©</label>
                                <textarea
                                    name="lore_content[]"
                                    class="form-textarea"
                                    rows="4"
                                    placeholder="AIì—ê²Œ ì£¼ì…í•  ì„¤ëª…, ì‚¬ì‹¤, ì„¤ì • ë“±ì„ ìì„¸íˆ ì‘ì„±í•˜ì„¸ìš”"
                                ></textarea>
                            </div>

                            <div class="lore-options">
                                <div class="form-group form-group-inline">
                                    <label class="form-label">ìš°ì„ ìˆœìœ„</label>
                                    <input type="number" name="lore_priority[]" class="form-input-small" value="0" min="0">
                                    <span class="form-hint">ë†’ì„ìˆ˜ë¡ ë¨¼ì € ì£¼ì…</span>
                                </div>

                                <div class="form-group form-group-inline">
                                    <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                                    <select name="lore_category[]" class="form-select-small">
                                        <option value="">ì„ íƒ ì•ˆ í•¨</option>
                                        <option value="personality">ì„±ê²©</option>
                                        <option value="world">ì„¸ê³„ê´€</option>
                                        <option value="relationship">ê´€ê³„</option>
                                    </select>
                                </div>

                                <div class="form-group form-group-checkbox">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="lore_always_active[]" value="true">
                                        <span class="checkbox-custom"></span>
                                        <span>í•­ìƒ í¬í•¨</span>
                                    </label>
                                    <span class="form-hint">ì£¼ì˜: í† í° ì†Œëª¨ ì¦ê°€</span>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <button type="button" id="add-lore-entry" class="add-btn">
                    <span>+</span> ë¡œì–´ë¶ í•­ëª© ì¶”ê°€
                </button>
            </div>
        </div>

        <!-- íƒ­ 4: ì´ë¯¸ì§€ -->
        <div class="tab-content" id="tab-image">
            <div class="tab-panel">
                <div class="panel-header">
                    <h2>ì´ë¯¸ì§€</h2>
                    <p>AI ìºë¦­í„°ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•˜ì„¸ìš”</p>
                </div>

                <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ“·</span>
                        í”„ë¡œí•„ ì´ë¯¸ì§€
                    </label>
                    <div class="image-upload-area" id="profile-upload-area">
                        <input type="file" name="user_image" accept="image/*" id="user_image" class="file-input-hidden">
                        {% if llm.llm_image %}
                            <div class="upload-placeholder" id="upload-placeholder" style="display: none;">
                                <span class="upload-icon">ğŸ“</span>
                                <span class="upload-text">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</span>
                                <span class="upload-hint">ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</span>
                            </div>
                            <img id="preview-image" class="preview-image" src="{{ llm.llm_image.url }}" alt="ë¯¸ë¦¬ë³´ê¸°" style="display: block;">
                        {% else %}
                            <div class="upload-placeholder" id="upload-placeholder">
                                <span class="upload-icon">ğŸ“</span>
                                <span class="upload-text">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</span>
                                <span class="upload-hint">ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</span>
                            </div>
                            <img id="preview-image" class="preview-image" alt="ë¯¸ë¦¬ë³´ê¸°" style="display: none;">
                        {% endif %}
                    </div>
                </div>

                <!-- ì„œë¸Œ ì´ë¯¸ì§€ -->
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ–¼ï¸</span>
                        ì„œë¸Œ ì´ë¯¸ì§€ (ì„ íƒ)
                    </label>
                    <p class="form-hint">HP ë²”ìœ„ëŠ” 0~100ê¹Œì§€ ì…ë‹ˆë‹¤. êµ¬ê°„ì„ ë‚˜ëˆ ì„œ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ë©´ í•´ë‹¹ HPì— ë”°ë¼ ì´ë¯¸ì§€ê°€ ë³€í•©ë‹ˆë‹¤.</p>

                    <div id="sub-images-container">
                        {% if is_edit_mode and sub_images_with_hp %}
                            <!-- ê¸°ì¡´ ì„œë¸Œ ì´ë¯¸ì§€ í•­ëª©ë“¤ -->
                            {% for item in sub_images_with_hp %}
                            <div class="sub-image-entry">
                                <div class="sub-image-header">
                                    <span class="sub-image-number">{{ forloop.counter }}</span>
                                    <button type="button" class="remove-sub-image">
                                        <span>âœ•</span>
                                    </button>
                                </div>

                                <div class="sub-image-content">
                                    <div class="sub-image-upload">
                                        <input type="file" name="sub_images" accept="image/*" class="sub-image-file">
                                        {% if item.sub_image.image %}
                                        <div class="existing-image-preview">
                                            <img src="{{ item.sub_image.image.url }}" alt="ì„œë¸Œ ì´ë¯¸ì§€" style="max-width: 100px; max-height: 100px; border-radius: 8px;">
                                            <span class="existing-label">í˜„ì¬ ì´ë¯¸ì§€</span>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="sub-image-options">
                                        <div class="hp-range">
                                            <label>HP ë²”ìœ„</label>
                                            <div class="hp-inputs">
                                                <input type="number" name="min_hp[]" placeholder="ìµœì†Œ" min="0" class="form-input-small" value="{{ item.min_hp|default:'' }}" data-login-required>
                                                <span class="hp-separator">~</span>
                                                <input type="number" name="max_hp[]" placeholder="ìµœëŒ€" min="0" class="form-input-small" value="{{ item.max_hp|default:'' }}" data-login-required>
                                            </div>
                                        </div>

                                        <div class="sub-image-title">
                                            <label>ì œëª©/ë©”ëª¨</label>
                                            <textarea type="text" name="sub_image_title[]" placeholder="í˜„ì¬ ìƒí™©ì— ë§ëŠ” ìŠ¤í† ë¦¬ë¥¼ ì ì–´ì£¼ì„¸ìš”.(400ì)" maxlength="400" class="form-input" value="{{ item.sub_image.title|default:'' }}" style="max-width: 500px; max-height: 300px;" data-login-required></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <!-- ê¸°ë³¸ ì„œë¸Œ ì´ë¯¸ì§€ í•­ëª© (ìƒˆë¡œ ë§Œë“¤ê¸° ëª¨ë“œ) -->
                            <div class="sub-image-entry">
                                <div class="sub-image-header">
                                    <span class="sub-image-number">1</span>
                                    <button type="button" class="remove-sub-image" data-login-required>
                                        <span>âœ•</span>
                                    </button>
                                </div>

                                <div class="sub-image-content">
                                    <div class="sub-image-upload">
                                        <input type="file" name="sub_images" accept="image/*" class="sub-image-file">
                                    </div>

                                    <div class="sub-image-options">
<div class="hp-range">
        <label>HP ë²”ìœ„</label>
        <div class="hp-inputs">
            <!-- ìµœì†Œ HP: 0 ~ 100 ì‚¬ì´, ê¸°ë³¸ 0 -->
            <input type="number" 
                   name="min_hp[]" 
                   placeholder="ìµœì†Œ" 
                   min="0" 
                   max="100" 
                   class="form-input-small" 
                   value="0" 
                   required 
                   readonly
                   oninput="this.value = Math.max(0, Math.min(100, this.value || 0)); validateHpRange(this)">
            
            <span class="hp-separator">~</span>
            
            <!-- ìµœëŒ€ HP: 0 ~ 100 ì‚¬ì´, minë³´ë‹¤ ì»¤ì•¼ í•¨ -->
            <input type="number" 
                   name="max_hp[]" 
                   placeholder="ìµœëŒ€" 
                   min="0" 
                   max="100" 
                   class="form-input-small" 
                   required 
                   oninput="this.value = Math.max(0, Math.min(100, this.value || 0)); validateHpRange(this)">
        </div>
    </div>
                                        <div class="sub-image-title">
                                            <label>ì œëª©/ë©”ëª¨</label>
                                            <textarea type="text" name="sub_image_title[]" placeholder="í˜„ì¬ ìƒí™©ì— ë§ëŠ” ìŠ¤í† ë¦¬ë¥¼ ì ì–´ì£¼ì„¸ìš”.(400ì)" maxlength="400" class="form-input" value="{{ item.sub_image.title|default:'' }}"  style="max-width: 500px; max-height: 300px;" data-login-required></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <div class="image-action-buttons">
                        <button type="button" id="add-sub-image-btn" class="add-btn" data-login-required>
                            <span>+</span> ì„œë¸Œ ì´ë¯¸ì§€ ì¶”ê°€
                        </button>
                        {% if is_edit_mode %}
                        <a href="{% url 'character:ai_preview' llm.public_uuid %}?preview=1" target="_blank" class="preview-btn" data-login-required>
                            <span>ğŸ‘ï¸</span> ë¯¸ë¦¬ë³´ê¸°
                        </a>
                        {% endif %}
                    </div>
                </div>







            </div>
        </div>

<div class="tab-content" id="tab-extra-last-image">
    <div class="tab-panel">
        <div class="panel-header">
            <h2>ë§ˆì§€ë§‰ ì´ë¯¸ì§€ ì¶”ê°€</h2>
            <p>AI ìºë¦­í„°ì˜ ë§ˆì§€ë§‰ ì´ë¯¸ì§€ë¥¼ ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œí•˜ê³  ì„¤ì •í•˜ì„¸ìš”</p>
        </div>

        <div id="extra-last-images-container">
            {% if is_edit_mode and extra_last_images %}
                {% for item in extra_last_images %}
                <div class="extra-last-image-entry">
                    <div class="extra-last-image-header">
                        <span class="extra-last-image-number">{{ forloop.counter }}</span>
                        <button type="button" class="remove-extra-last-image">
                            <span>âœ•</span>
                        </button>
                    </div>

                    <div class="extra-last-image-content">
                        <div class="extra-last-image-upload">
                            <input type="file" name="extra_last_images" accept="image/*" class="extra-last-image-file">
                            {% if item.image %}
                            <div class="existing-image-preview">
                                <img src="{{ item.image.url }}" alt="ë§ˆì§€ë§‰ ì´ë¯¸ì§€" style="max-width: 100px; max-height: 100px; border-radius: 8px;">
                                <span class="existing-label">í˜„ì¬ ì´ë¯¸ì§€</span>
                            </div>
                            {% endif %}
                        </div>

                        <div class="extra-last-image-title">
                            <label>ì œëª©/ë©”ëª¨</label>
                            <textarea name="extra_last_image_title[]" placeholder="ìƒí™©ì— ë§ëŠ” ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”." maxlength="400" class="form-input" style="max-width: 500px; max-height: 300px;"></textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- ê¸°ë³¸ ì²« ë²ˆì§¸ í•­ëª© -->
                <div class="extra-last-image-entry">
                    <div class="extra-last-image-header">
                        <span class="extra-last-image-number">1</span>
                        <button type="button" class="remove-extra-last-image">
                            <span>âœ•</span>
                        </button>
                    </div>

                    <div class="extra-last-image-content">
                        <div class="extra-last-image-upload">
                            <input type="file" name="extra_last_images" accept="image/*" class="extra-last-image-file">
                        </div>

                        <div class="extra-last-image-title">
                            <label>ì œëª©/ë©”ëª¨</label>
                            <textarea name="extra_last_image_title[]" placeholder="ìƒí™©ì— ë§ëŠ” ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”." maxlength="400" class="form-input" style="max-width: 500px; max-height: 300px;"></textarea>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <button type="button" id="add-extra-last-image-btn" class="add-btn">
            <span>+</span> ë§ˆì§€ë§‰ ì´ë¯¸ì§€ ì¶”ê°€
        </button>
    </div>
</div>


        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
        <div class="form-navigation">
            <button type="button" class="nav-btn nav-prev" id="prev-btn" style="display: none;" data-login-required>
                <span>â†</span> ì´ì „
            </button>
            <button type="button" class="nav-btn nav-next" id="next-btn" data-login-required>
                ë‹¤ìŒ <span>â†’</span>
            </button>
            <button type="submit" class="nav-btn nav-submit" id="submit-btn" style="display: none;" data-login-required>
                {% if is_edit_mode %}ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥{% else %}ğŸš€ AI ìºë¦­í„° ìƒì„±{% endif %}
            </button>
        </div>
    </form>

</main>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/character/make_ai_page.js' %}"></script>
<script src="{% static 'js/character/make_ai.js' %}"></script>
<script>
    document.getElementById('add-extra-last-image-btn').addEventListener('click', function() {
    const container = document.getElementById('extra-last-images-container');
    const index = container.children.length + 1;

    const newEntry = document.createElement('div');
    newEntry.classList.add('extra-last-image-entry');
    newEntry.innerHTML = `
        <div class="extra-last-image-header">
            <span class="extra-last-image-number">${index}</span>
            <button type="button" class="remove-extra-last-image"><span>âœ•</span></button>
        </div>
        <div class="extra-last-image-content">
            <div class="extra-last-image-upload">
                <input type="file" name="extra_last_images" accept="image/*" class="extra-last-image-file">
            </div>
            <div class="extra-last-image-title">
                <label>ì œëª©/ë©”ëª¨</label>
                <textarea name="extra_last_image_title[]" placeholder="ìƒí™©ì— ë§ëŠ” ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”." maxlength="400" class="form-input" style="max-width: 500px; max-height: 300px;"></textarea>
            </div>
        </div>
    `;
    container.appendChild(newEntry);
});

// ì‚­ì œ
document.addEventListener('click', function(e) {
    if(e.target.closest('.remove-extra-last-image')){
        e.target.closest('.extra-last-image-entry').remove();
        // ë²ˆí˜¸ ë‹¤ì‹œ ë§¤ê¸°ê¸°
        document.querySelectorAll('#extra-last-images-container .extra-last-image-entry').forEach((entry, i) => {
            entry.querySelector('.extra-last-image-number').textContent = i + 1;
        });
    }
});

</script>
{% endblock %}
