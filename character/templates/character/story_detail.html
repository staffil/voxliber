{% extends "base.html" %}
{% load static i18n %}

{% block title %}{{ story.title }} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/character/story_detail.css' %}">
{% endblock %}

{% block content %}
<br><br><br><br>

<main class="story-detail-container">
    <!-- ìŠ¤í† ë¦¬ í—¤ë” -->
    <div class="story-header">
<div class="story-cover-wrapper">
    {% if story.story_desc_video %}
        <video             controls  
 loop muted playsinline class="story-cover-video">
            <source src="{{ story.story_desc_video.url }}" type="video/mp4">
        </video>
    {% elif story.cover_image %}
        <img src="{{ story.cover_image.url }}" alt="{{ story.title }}" class="story-cover">
    {% else %}
        <div class="story-cover-placeholder">
            <span class="cover-icon">ğŸ“–</span>
        </div>
    {% endif %}
</div>


        <div class="story-info">
            <h1 class="story-title">{{ story.title }}</h1>
            {% if story.description %}
                <p class="story-description">{{ story.description }}</p>
            {% endif %}

            <div class="story-meta">
                <span class="meta-item">
                    <span class="meta-icon">ğŸ‘¥</span>
                    ìºë¦­í„° {{ characters.count }}ëª…
                </span>
                <span class="meta-item">
                    <span class="meta-icon">ğŸ“…</span>
                    {{ story.created_at|date:"Y.m.d" }}
                </span>
                {% if story.is_public %}
                    <span class="meta-item status-public">
                        <span class="meta-icon">ğŸŒ</span>
                        ì¶œì‹œë¨
                    </span>
                {% else %}
                    <span class="meta-item status-draft">
                        <span class="meta-icon">ğŸ“</span>
                        ì‘ì—…ì¤‘
                    </span>
                {% endif %}
            </div>

    <div class="story-buttons">
        {% for s in story_list %}
        <a href="{% url 'character:edit_ai_story' s.public_uuid %}" class="btn-edit-story" data-login-required>
            âœï¸ ìŠ¤í† ë¦¬ í¸ì§‘
        </a>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<form method="POST" action="{% url 'character:delete_story' story.public_uuid %}" class="delete-form">
    {% csrf_token %}
    <button type="button" class="delete-btn" onclick="confirmDelete(this.form)">
        ğŸ—‘ï¸ ì‚­ì œ
    </button>
</form>

                {% endfor %}

    </div>


        </div>
    </div>

    <!-- ìºë¦­í„° ì„¹ì…˜ -->
    <section class="characters-section">
        <div class="section-header">
            <h2>
                <span class="section-icon">ğŸ¤–</span>
                ìºë¦­í„° ëª©ë¡
            </h2>
            <a href="{% url 'character:make_ai_with_story' story.public_uuid %}" class="btn-add-character" data-login-required>
                <span>+</span> ìƒˆ ìºë¦­í„° ì¶”ê°€
            </a>
        </div>

        <div class="character-grid">
            {% for char in characters %}
            <div class="character-card">
                <div class="character-avatar">
                    {% if char.llm_image %}
                        <img src="{{ char.llm_image.url }}" alt="{{ char.name }}">
                    {% else %}
                        <div class="avatar-placeholder">
                            <span>ğŸ¤–</span>
                        </div>
                    {% endif %}
                </div>

                <div class="character-info">
                    <h3 class="character-name">{{ char.name }}</h3>
                    <p class="character-desc">{{ char.description|truncatewords:20|default:"ì„¤ëª… ì—†ìŒ" }}</p>
                </div>

                <div class="character-actions">
                    <!-- <a href="{% url 'character:chat-view' char.public_uuid %}" class="btn-chat" data-login-required>
                        <span>ğŸ’¬</span> ëŒ€í™”í•˜ê¸°
                    </a> -->
                    <a href="{% url 'character:make_ai_update' char.public_uuid %}" class="btn-edit" data-login-required>
                        <span>âœï¸</span> í¸ì§‘
                    </a>
    <form method="POST" action="{% url 'character:delete_llm' char.public_uuid %}" class="delete-form">
        {% csrf_token %}
        <button type="button" class="delete-btn" onclick="confirmDelete(this.form)">
            ğŸ—‘ï¸ ì‚­ì œ
        </button>
    </form>
</div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ­</div>
                <h3>ì•„ì§ ìºë¦­í„°ê°€ ì—†ì–´ìš”</h3>
                <p>ì²« ë²ˆì§¸ AI ìºë¦­í„°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                <a href="{% url 'character:make_ai_with_story' story.public_uuid %}" class="btn-create-first" data-login-required>
                    + ì²« ìºë¦­í„° ë§Œë“¤ê¸°
                </a>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- ì¶œì‹œ ì„¹ì…˜ -->
    <section class="publish-section">
        {% if can_publish %}
            {% if not story.is_public %}
            <div class="publish-ready">
                <h3>ëª¨ë“  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆì–´ìš”!</h3>
                <p>ìŠ¤í† ë¦¬ë¥¼ ì¶œì‹œí•˜ë©´ ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ë„ ì¦ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                <form method="POST" action="">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="publish">
                    <button type="submit" class="btn-publish" data-login-required>
                        <span>ğŸš€</span> ìŠ¤í† ë¦¬ ì¶œì‹œí•˜ê¸°
                    </button>
                </form>
            </div>
            {% else %}
            <div class="publish-done">
                <span class="publish-icon">ğŸ‰</span>
                <h3>ì´ë¯¸ ì¶œì‹œëœ ìŠ¤í† ë¦¬ì…ë‹ˆë‹¤</h3>
                <p>ì‚¬ìš©ìë“¤ì´ ìŠ¤í† ë¦¬ë¥¼ ì¦ê¸°ê³  ìˆì–´ìš”!</p>
            </div>
            {% endif %}
        {% else %}
            <div class="publish-not-ready">
                <span class="warning-icon">âš ï¸</span>
                <p>ìµœì†Œ 1ê°œ ì´ìƒì˜ ìºë¦­í„°ë¥¼ ë§Œë“¤ì–´ì•¼ ì¶œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
            </div>
        {% endif %}
    </section>
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/character/story_detail.js' %}"></script>
<script>
    function confirmDelete(form) {
    Swal.fire({
        title: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        text: "ì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'ì‚­ì œ',
        cancelButtonText: 'ì·¨ì†Œ'
    }).then((result) => {
        if (result.isConfirmed) {
            form.submit();
        }
    });
}


function confirmDelete(form) {
    Swal.fire({
        title: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        text: "ì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'ì‚­ì œ',
        cancelButtonText: 'ì·¨ì†Œ'
    }).then((result) => {
        if (result.isConfirmed) {
            form.submit();
        }
    });
}
</script>
{% endblock %}
