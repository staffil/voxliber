<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI ë‚˜ë˜ì´ì…˜ + ì‚¬ìš´ë“œ í¸ì§‘ê¸°</title>
<style>
body { font-family:sans-serif; margin:20px; background:#fafafa; }
h2 { margin-bottom:15px; }
.timeline { 
  border:2px solid #ccc; 
  padding:10px; 
  width:90%;
  background:white;
  border-radius:10px;
}
.track { 
  position:relative; 
  height:70px; 
  border-bottom:1px solid #ddd;
  margin-bottom:5px;
}
.track:last-child { border-bottom:none; }
.track-label {
  position:absolute; left:-110px; top:20px;
  font-weight:bold; color:#444;
}
.block {
  position:absolute; 
  top:10px; 
  height:50px; 
  background:#4f46e5; 
  color:white; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  border-radius:8px; 
  cursor:move;
  user-select:none;
}
.block .delete {
  position:absolute; top:2px; right:4px;
  background:red; color:white;
  font-size:10px; border:none; border-radius:4px;
  cursor:pointer;
}
.volume-slider {
  position:absolute; bottom:-18px; left:5px;
  width:80%;
}
.controls { margin-top:20px; }
button { margin-right:5px; }
textarea { width:60%; height:40px; margin-right:5px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
</head>
<body>

<h2>ğŸ§ ë‚˜ë˜ì´ì…˜ + ì‚¬ìš´ë“œ ë¸”ë¡ í¸ì§‘ê¸°</h2>

<div class="timeline">
  <div class="track" id="tts-track">
    <span class="track-label">ğŸ™ï¸ ë‚˜ë˜ì´ì…˜</span>
  </div>
  <div class="track" id="sound-track">
    <span class="track-label">ğŸµ íš¨ê³¼ìŒ</span>
  </div>
</div>

<div class="controls">
  <button id="addTTS">ë‚˜ë˜ì´ì…˜ ì¶”ê°€</button>
  <textarea id="soundText" placeholder="íš¨ê³¼ìŒ ë‚´ìš© (ì˜ˆ: ì²œë‘¥ ì†Œë¦¬)"></textarea>
  <button id="addSound">ì‚¬ìš´ë“œ ì¶”ê°€</button>
  <button id="playAll">â–¶ ì „ì²´ ì¬ìƒ</button>
</div>

<script>
// ------------------------------
// ìƒíƒœ ê´€ë¦¬
// ------------------------------
let blocks = []; // {id, type, start, duration, audio, volume}

// ------------------------------
// ìœ í‹¸
// ------------------------------
function randomColor() {
  const colors = ['#4f46e5','#16a34a','#dc2626','#f59e0b','#0891b2'];
  return colors[Math.floor(Math.random()*colors.length)];
}

function createAudioBlock(type, text, audioUrl) {
  const track = document.getElementById(type === 'tts' ? 'tts-track' : 'sound-track');
  const block = document.createElement('div');
  const id = Date.now() + Math.random().toString(36).substr(2,5);

  block.className = 'block';
  block.style.background = randomColor();
  block.style.left = '0px';
  block.style.width = '150px';
  block.dataset.id = id;
  block.innerHTML = `${text}
    <button class="delete">X</button>
    <input type="range" min="0" max="1" step="0.1" value="1" class="volume-slider" />
  `;
  track.appendChild(block);

  const audio = new Audio(audioUrl);
  audio.volume = 1;

  blocks.push({
    id,
    type,
    start: 0,
    duration: 3,
    audio,
    volume: 1
  });

  // ë¸”ë¡ ì‚­ì œ
  block.querySelector('.delete').addEventListener('click', () => {
    track.removeChild(block);
    blocks = blocks.filter(b => b.id !== id);
  });

  // ë³¼ë¥¨ ì¡°ì ˆ
  block.querySelector('.volume-slider').addEventListener('input', (e) => {
    const vol = parseFloat(e.target.value);
    const b = blocks.find(b => b.id === id);
    if (b) b.volume = vol;
    audio.volume = vol;
  });

  makeInteractive(block, id);
}

// ------------------------------
// ë“œë˜ê·¸ & ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥
// ------------------------------
function makeInteractive(block, id) {
  interact(block)
    .draggable({
      listeners: {
        move(event) {
          const x = (parseFloat(block.getAttribute('data-x')) || 0) + event.dx;
          block.style.transform = `translateX(${x}px)`;
          block.setAttribute('data-x', x);
          const start = x / 10; // 10px = 1s
          const b = blocks.find(b => b.id === id);
          if (b) b.start = Math.max(0, start);
        }
      }
    })
    .resizable({
      edges: { left: true, right: true },
      listeners: {
        move(event) {
          let { x } = event.target.dataset;
          x = parseFloat(x) || 0;
          block.style.width = `${event.rect.width}px`;
          const dur = event.rect.width / 50; // 50px = 1s
          const b = blocks.find(b => b.id === id);
          if (b) b.duration = Math.max(0.5, dur);
        }
      }
    });
}

// ------------------------------
// ì„œë²„ ì—°ë™ (TTS / ì‚¬ìš´ë“œ ìƒì„±)
// ------------------------------
async function fetchAudio(url, body) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
    body: JSON.stringify(body)
  });
  const blob = await res.blob();
  return URL.createObjectURL(blob);
}

// CSRF
function getCookie(name) {
  const cookies = document.cookie.split(';').map(c => c.trim());
  for (const cookie of cookies) {
    if (cookie.startsWith(name + '=')) return decodeURIComponent(cookie.split('=')[1]);
  }
  return null;
}

// ------------------------------
// ë²„íŠ¼ ì´ë²¤íŠ¸
// ------------------------------
document.getElementById('addTTS').addEventListener('click', async () => {
  const text = prompt('TTS ë¬¸ì¥ ì…ë ¥:');
  if (!text) return;
  const url = await fetchAudio('/test_tts/', { text });
  createAudioBlock('tts', text, url);
});

document.getElementById('addSound').addEventListener('click', async () => {
  const text = document.getElementById('soundText').value.trim();
  if (!text) return alert('ì‚¬ìš´ë“œ í…ìŠ¤íŠ¸ ì…ë ¥');
  const url = await fetchAudio('/soundpg/', { soundText: text });
  createAudioBlock('sound', text, url);
});

// ------------------------------
// ì „ì²´ ì¬ìƒ
// ------------------------------
document.getElementById('playAll').addEventListener('click', () => {
  const sorted = [...blocks].sort((a,b)=>a.start-b.start);
  const startTime = Date.now();
  sorted.forEach(b => {
    setTimeout(() => {
      b.audio.currentTime = 0;
      b.audio.volume = b.volume;
      b.audio.play();
    }, b.start * 1000);
  });
});
</script>

</body>
</html>
