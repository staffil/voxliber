{% extends "base.html" %}
{% load static %}

{% block title %}보이스 라이브러리 | VoxLiber{% endblock %}

{% block content %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/voice/voice_list.css' %}">
<link rel="stylesheet" href="{% static 'css/book/onboarding.css' %}">
{% endblock %}

<!-- 페이지 헤더 -->
<div class="page-header" style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
    <div>
        <h1 class="page-title">🎤 보이스 라이브러리</h1>
        <p class="page-subtitle">나만의 오디오북을 위한 완벽한 목소리를 찾아보세요</p>
    </div>
    <button class="vox-voice-guide-btn" onclick="document.getElementById('voxGuidePanelOverlay').style.display='flex'" aria-label="가이드 열기">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        가이드북
    </button>
</div>

<!-- 검색 & 필터 섹션 -->
<div class="search-filter-section">
    <!-- AI 목소리 추천 검색 -->
    <div class="ai-voice-search-section">
        <div class="ai-search-box">
            <span class="ai-search-icon">✨</span>
            <input type="text" id="ai-voice-input" class="ai-voice-input"
                   placeholder="AI에게 원하는 목소리를 설명해보세요... (예: 차분하고 깊은 남성 목소리, 밝고 에너지 넘치는 여성)"
                   data-login-required>
            <button id="ai-search-btn" class="ai-search-btn" onclick="runAiVoiceSearch()">AI 추천</button>
        </div>
        <div id="ai-search-result" class="ai-search-result" style="display:none;">
            <span id="ai-result-text"></span>
            <button onclick="clearAiFilter()" class="ai-clear-btn">✕ 필터 해제</button>
        </div>
    </div>

    <!-- 일반 검색창 -->
    <div class="voice-search-box">
        <input type="text" id="voice-search" class="voice-search-input" placeholder="🔍 목소리 이름으로 검색..." data-login-required>
    </div>

    <!-- 타입 필터 -->
    <div class="filter-buttons">
        {% for voice_type in voice_types %}
        <button
            type="button"
            class="filter-btn"
            data-id="{{ voice_type.id }}"
        >
            {{ voice_type.name }}
        </button>
        {% endfor %}
    </div>
</div>

<!-- 메인 레이아웃: 왼쪽(내 보이스) + 오른쪽(전체 목록) -->
<div class="main-layout">
    <!-- 왼쪽: 내 보이스 - 🔥 가로 스크롤 컨테이너 -->
    <div class="my-voices-section"> 
        <div class="section-header">💾 내 보이스 컬렉션</div>

        <!-- 🔥 가로 스크롤 래퍼 추가 -->
        <div class="myvoice-scroll-wrapper">
            {% if my_voices %}
                {% for item in my_voices %}
                <div class="myvoice-card-small">
                    <div class="myvoice-header">
                        {% if item.voice.voice_image %}
                        <img src="{{ item.voice.voice_image.url }}" class="myvoice-img-small" alt="{{ item.alias_name }}" loading="lazy">
                        {% else %}
                        <img src="{% static 'default_voice.png' %}" class="myvoice-img-small" alt="{{ item.alias_name }}" loading="lazy">
                        {% endif %}

                        <div class="myvoice-info-small">
                            <div class="myvoice-name-small">{{ item.alias_name }}</div>
                            <div class="myvoice-alias-small">{{ item.voice.voice_name }}</div>
                        </div>

                        <button class="favorite-btn-small" onclick="toggleFavorite({{ item.id }}, this)" data-favorite="{{ item.is_favorite|lower }}" data-login-required>
                            {% if item.is_favorite %}⭐{% else %}☆{% endif %}
                        </button>
                    </div>

                    <!-- 책 선택 -->
                    <select name="book_id" onchange="selectBook({{ item.id }}, this.value)" class="book-select-small" data-login-required>
                        <option value="">📚 전체 작품</option>
                        {% for book in books %}
                        <option value="{{ book.id }}" {% if item.book and book.id == item.book.id %}selected{% endif %}>
                            {{ book.name }}
                        </option>
                        {% endfor %}
                    </select>

                    <!-- 오디오 플레이어 -->
                    {% if item.voice.sample_audio %}
                    <div class="audio-player-small">
                        <button onclick="togglePlaySmall(this)" data-login-required>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                        <div class="progress-bar-small">
                            <div class="progress-small"></div>
                        </div>
                        <span class="time-small">0:00 / 0:00</span>
                        <audio src="{{ item.voice.sample_audio.url }}" preload="metadata" loading="lazy"></audio>
                    </div>
                    {% endif %}

                    <!-- 삭제 버튼 -->
                    <button type="button" class="delete-btn-small" onclick="deleteVoice({{ item.id }}, this)" data-login-required>🗑️ 삭제</button>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-myvoice-small">
                    <div class="no-myvoice-icon-small">🎙️</div>
                    <p style="font-size: 14px; margin-bottom: 0;">저장된 보이스가 없습니다</p>
                    <p style="font-size: 12px; color: var(--text-secondary);">오른쪽에서 목소리를 선택하세요</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- 오른쪽: 전체 보이스 목록 -->
    <div class="voice-list-section">
        <div class="section-header">🎵 전체 보이스 목록</div>

        <div class="voice-container">
            {% if voice_lists %}
                {% for voice in voice_lists %}
                <div class="voice-card"
                     data-voice-id="{{ voice.id }}"
                     data-voice-name="{{ voice.voice_name }}"
                     data-voice-types="{% for t in voice.types.all %}{{ t.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                    {% if voice.voice_image %}
                    <img src="{{ voice.voice_image.url }}" alt="{{ voice.voice_name }}" class="voice-image" loading="lazy">
                    {% else %}
                    <img src="{% static 'default_voice.png' %}" alt="{{ voice.voice_name }}" class="voice-image" loading="lazy">
                    {% endif %}

                    <div class="voice-name">{{ voice.voice_name }}</div>

                    {% if voice.types.all %}
                    <div class="voice-types">
                        {% for type in voice.types.all %}
                        <span class="type-badge">{{ type.name }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if voice.sample_audio %}
                    <div class="voice-audio-player">
                        <button class="play-btn" onclick="toggleVoicePlay(this)" data-login-required>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                        <div class="audio-progress">
                            <div class="audio-progress-bar"></div>
                        </div>
                        <span class="audio-time">0:00 / 0:00</span>
                        <audio src="{{ voice.sample_audio.url }}" preload="metadata" loading="lazy"></audio>
                    </div>
                    {% endif %}

                    <button class="select-voice-btn" onclick="selectVoice('{{ voice.id }}')" data-login-required>선택</button>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-voices">
                    <div class="no-voices-icon">🎙️</div>
                    <h2 class="no-voices-title">
                        {% if selected_type_ids %}
                        해당 타입의 목소리가 없습니다
                        {% else %}
                        등록된 보이스가 없습니다
                        {% endif %}
                    </h2>
                    <p class="no-voices-text">
                        {% if selected_type_ids %}
                        다른 타입을 선택해보세요
                        {% else %}
                        새로운 보이스가 곧 추가될 예정입니다
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
</div>

<div id="voice_name" style="display: none;"></div>
<div class="desktop-only"></div>

<!-- 보이스 라이브러리 가이드 패널 -->
<div id="voxGuidePanelOverlay" style="display:none;" class="vox-guide-panel-overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="vox-guide-panel">
        <div class="vox-guide-panel-header">
            <span class="vox-guide-panel-title">보이스 라이브러리 가이드</span>
            <button class="vox-guide-panel-close" onclick="document.getElementById('voxGuidePanelOverlay').style.display='none'" aria-label="닫기">&times;</button>
        </div>
        <div class="vox-guide-panel-body">
            <div class="ui-tour-label" style="margin-bottom:12px;">✨ 단계를 클릭하면 해당 위치를 안내합니다 (다음 버튼으로 순서대로 이동)</div>
            <div class="ui-tour-steps">
                <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_VOICE_STEPS, 0)">
                    <span class="ui-tour-step-num">1</span>
                    <span class="ui-tour-step-text">AI 목소리 추천 검색</span>
                    <span class="ui-tour-step-arrow">›</span>
                </button>
                <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_VOICE_STEPS, 1)">
                    <span class="ui-tour-step-num">2</span>
                    <span class="ui-tour-step-text">음성 태그 선택</span>
                    <span class="ui-tour-step-arrow">›</span>
                </button>
                <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_VOICE_STEPS, 2)">
                    <span class="ui-tour-step-num">3</span>
                    <span class="ui-tour-step-text">보이스 선택 &amp; 별칭</span>
                    <span class="ui-tour-step-arrow">›</span>
                </button>
                <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_VOICE_STEPS, 3)">
                    <span class="ui-tour-step-num">4</span>
                    <span class="ui-tour-step-text">내 보이스 컬렉션</span>
                    <span class="ui-tour-step-arrow">›</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- <script>
// 페이지 접근 제한 - 메인으로 리다이렉트
(function() {
    window.location.href = '/';
})();
</script> -->
<script src="{% static 'js/book/onboarding.js' %}"></script>
<script>
/* ── 첫 방문 시 자동 가이드 열기 ── */
document.addEventListener('DOMContentLoaded', function () {
    if (!localStorage.getItem('vox_guide_seen_voice')) {
        document.getElementById('voxGuidePanelOverlay').style.display = 'flex';
        localStorage.setItem('vox_guide_seen_voice', '1');
    }
});

/* ── 보이스 라이브러리 투어 단계 ── */
var VOX_VOICE_STEPS = [
    {
        sel: '.ai-voice-search-section',
        title: 'AI 목소리 추천 검색',
        desc: '원하는 목소리를 직접 글로 설명하면 AI가 어울리는 보이스를 추천해 드립니다.<br><br>예시:<br>· <i>"차분하고 깊은 남성 목소리"</i><br>· <i>"밝고 에너지 넘치는 여성 목소리"</i><br>· <i>"노인 남성, 중후한 느낌"</i><br><br>설명을 입력한 뒤 <b>AI 추천</b> 버튼을 클릭하면 해당 설명에 맞는 보이스만 필터링됩니다.'
    },
    {
        sel: '.filter-buttons',
        title: '음성 태그 선택',
        desc: '태그 버튼으로 카테고리별 목소리를 빠르게 찾을 수 있습니다.<br><br>태그를 선택하면 해당 유형의 보이스만 표시됩니다. AI 추천과 함께 사용하면 더 정확한 목소리를 찾을 수 있습니다.'
    },
    {
        sel: '.voice-list-section',
        title: '보이스 선택 & 별칭',
        desc: '마음에 드는 목소리 아래의 <b>선택</b> 버튼을 누릅니다.<br><br>별칭을 입력하면 왼쪽 내 보이스 컬렉션에 저장됩니다.<br>이후 집필 중인 책을 해당 보이스에 지정하고, 자주 사용할 보이스는 별(★) 버튼으로 즐겨찾기에 등록하세요.'
    },
    {
        sel: '.my-voices-section',
        title: '내 보이스 컬렉션',
        desc: '저장한 보이스는 이 컬렉션에서 확인할 수 있습니다.<br><br>마이페이지에서 집필 중인 책에 보이스를 연결할 수 있으며, 오른쪽에 있는 재생 버튼으로 저장된 목소리를 미리 들어볼 수 있습니다.'
    }
];
</script>
<script src="{% static 'js/voice/voice_list.js' %}"></script>
<script>
// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// 목소리 검색 및 타입 필터 (클라이언트 사이드)
const voiceCards = document.querySelectorAll('.voice-card');
const voiceSearch = document.getElementById('voice-search');
const filterBtns = document.querySelectorAll('.filter-btn');
let selectedTypes = new Set();
let aiFilteredIds = null; // null = 필터 없음, Set = AI 추천 결과

// 필터 적용 함수
function applyVoiceFilters() {
    const searchTerm = voiceSearch ? voiceSearch.value.toLowerCase().trim() : '';
    let visibleCount = 0;

    voiceCards.forEach(card => {
        const voiceName = (card.dataset.voiceName || '').toLowerCase();
        const voiceTypes = (card.dataset.voiceTypes || '').split(',').filter(t => t);
        const voiceId = String(card.dataset.voiceId || '');

        const matchesSearch = searchTerm === '' || voiceName.includes(searchTerm);
        const matchesType = selectedTypes.size === 0 ||
            [...selectedTypes].some(typeId => voiceTypes.includes(typeId));
        const matchesAi = aiFilteredIds === null || aiFilteredIds.has(voiceId);

        const visible = matchesSearch && matchesType && matchesAi;
        card.style.display = visible ? '' : 'none';

        // AI 필터 활성화 시 매칭 카드에 하이라이트
        if (aiFilteredIds !== null) {
            card.classList.toggle('ai-matched', matchesAi && visible);
        } else {
            card.classList.remove('ai-matched');
        }

        if (visible) visibleCount++;
    });

    const noVoices = document.querySelector('.no-voices');
    if (noVoices) {
        noVoices.style.display = visibleCount === 0 ? 'flex' : 'none';
    }
}

// AI 목소리 추천 검색
async function runAiVoiceSearch() {
    const input = document.getElementById('ai-voice-input');
    const query = (input.value || '').trim();
    if (!query) {
        input.focus();
        return;
    }

    const btn = document.getElementById('ai-search-btn');
    btn.textContent = '검색 중...';
    btn.disabled = true;

    try {
        const res = await fetch('/voice/voice/ai-search/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ query })
        });

        const data = await res.json();

        if (data.error) {
            alert('AI 검색 오류: ' + data.error);
            return;
        }

        aiFilteredIds = new Set((data.matched_ids || []).map(String));

        const resultDiv = document.getElementById('ai-search-result');
        const resultText = document.getElementById('ai-result-text');
        const count = data.matched_ids ? data.matched_ids.length : 0;
        resultText.textContent = `✨ "${query}"에 맞는 목소리 ${count}개를 찾았습니다`;
        resultDiv.style.display = 'flex';

        applyVoiceFilters();

        // 첫 매칭 카드로 스크롤
        const firstMatch = document.querySelector('.voice-card.ai-matched');
        if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    } catch (e) {
        console.error('AI 검색 오류:', e);
        alert('AI 검색에 실패했습니다.');
    } finally {
        btn.textContent = 'AI 추천';
        btn.disabled = false;
    }
}

function clearAiFilter() {
    aiFilteredIds = null;
    document.getElementById('ai-search-result').style.display = 'none';
    document.getElementById('ai-voice-input').value = '';
    applyVoiceFilters();
}

// Enter 키로 AI 검색
document.getElementById('ai-voice-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') runAiVoiceSearch();
});

// 타입 버튼 클릭 (중복 선택 가능, 페이지 새로고침 없음)
filterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
        const typeId = this.dataset.id;

        if (selectedTypes.has(typeId)) {
            selectedTypes.delete(typeId);
            this.classList.remove('active');
        } else {
            selectedTypes.add(typeId);
            this.classList.add('active');
        }

        applyVoiceFilters();
    });
});

// 검색 입력
if (voiceSearch) {
    voiceSearch.addEventListener('input', applyVoiceFilters);
}

// 즐겨찾기 토글 (페이지 새로고침 없음)
function toggleFavorite(voiceId, button) {
    fetch(`/mypage/toggle_myvoice_favorite/${voiceId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 버튼 아이콘 변경
            button.textContent = data.is_favorite ? '⭐' : '☆';
            button.dataset.favorite = data.is_favorite;
            console.log('✅', data.message);
        }
    })
    .catch(error => {
        console.error('❌ 즐겨찾기 토글 오류:', error);
        alert('즐겨찾기 업데이트에 실패했습니다.');
    });
}

// 책 선택 (페이지 새로고침 없음)
function selectBook(voiceId, bookId) {
    const formData = new FormData();
    formData.append('book_id', bookId);

    fetch(`/mypage/select_book/${voiceId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅', data.message, '-', data.book_name);
        }
    })
    .catch(error => {
        console.error('❌ 책 선택 오류:', error);
        alert('책 선택에 실패했습니다.');
    });
}

// 목소리 삭제 (페이지 새로고침 없음)
function deleteVoice(voiceId, button) {
    if (!confirm('정말로 삭제하시겠습니까?')) {
        return;
    }

    fetch(`/mypage/delete/${voiceId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 카드 전체를 DOM에서 제거 (부드러운 페이드아웃 효과)
            const card = button.closest('.myvoice-card-small');
            card.style.transition = 'opacity 0.3s ease';
            card.style.opacity = '0';
            setTimeout(() => {
                card.remove();

                // 모든 카드가 삭제되었는지 확인
                const remainingCards = document.querySelectorAll('.myvoice-card-small');
                if (remainingCards.length === 0) {
                    // 빈 상태 메시지 표시
                    const myVoicesSection = document.querySelector('.my-voices-section');
                    myVoicesSection.innerHTML = `
                        <div class="section-header">💾 내 보이스 컬렉션</div>
                        <div class="no-myvoice-small">
                            <div class="no-myvoice-icon-small">🎙️</div>
                            <p style="font-size: 14px; margin-bottom: 0;">저장된 보이스가 없습니다</p>
                            <p style="font-size: 12px; color: var(--text-secondary);">오른쪽에서 목소리를 선택하세요</p>
                        </div>
                    `;
                }
            }, 300);
            console.log('✅', data.message);
        }
    })
    .catch(error => {
        console.error('❌ 삭제 오류:', error);
        alert('삭제에 실패했습니다.');
    });
}
</script>
{% endblock %}
