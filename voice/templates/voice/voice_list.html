{% extends "base.html" %}
{% load static %}

{% block title %}ë³´ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ | VoxLiber{% endblock %}

{% block content %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/voice/voice_list.css' %}">
{% endblock %}

<!-- í˜ì´ì§€ í—¤ë” -->
<div class="page-header">
    <h1 class="page-title">ğŸ¤ ë³´ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬</h1>
    <p class="page-subtitle">ë‚˜ë§Œì˜ ì˜¤ë””ì˜¤ë¶ì„ ìœ„í•œ ì™„ë²½í•œ ëª©ì†Œë¦¬ë¥¼ ì°¾ì•„ë³´ì„¸ìš”</p>
</div>

<!-- ê²€ìƒ‰ & í•„í„° ì„¹ì…˜ -->
<div class="search-filter-section">
    <!-- AI ëª©ì†Œë¦¬ ì¶”ì²œ ê²€ìƒ‰ -->
    <div class="ai-voice-search-section">
        <div class="ai-search-box">
            <span class="ai-search-icon">âœ¨</span>
            <input type="text" id="ai-voice-input" class="ai-voice-input"
                   placeholder="AIì—ê²Œ ì›í•˜ëŠ” ëª©ì†Œë¦¬ë¥¼ ì„¤ëª…í•´ë³´ì„¸ìš”... (ì˜ˆ: ì°¨ë¶„í•˜ê³  ê¹Šì€ ë‚¨ì„± ëª©ì†Œë¦¬, ë°ê³  ì—ë„ˆì§€ ë„˜ì¹˜ëŠ” ì—¬ì„±)"
                   data-login-required>
            <button id="ai-search-btn" class="ai-search-btn" onclick="runAiVoiceSearch()">AI ì¶”ì²œ</button>
        </div>
        <div id="ai-search-result" class="ai-search-result" style="display:none;">
            <span id="ai-result-text"></span>
            <button onclick="clearAiFilter()" class="ai-clear-btn">âœ• í•„í„° í•´ì œ</button>
        </div>
    </div>

    <!-- ì¼ë°˜ ê²€ìƒ‰ì°½ -->
    <div class="voice-search-box">
        <input type="text" id="voice-search" class="voice-search-input" placeholder="ğŸ” ëª©ì†Œë¦¬ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." data-login-required>
    </div>

    <!-- íƒ€ì… í•„í„° -->
    <div class="filter-buttons">
        {% for voice_type in voice_types %}
        <button
            type="button"
            class="filter-btn"
            data-id="{{ voice_type.id }}"
        >
            {{ voice_type.name }}
        </button>
        {% endfor %}
    </div>
</div>

<!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ: ì™¼ìª½(ë‚´ ë³´ì´ìŠ¤) + ì˜¤ë¥¸ìª½(ì „ì²´ ëª©ë¡) -->
<div class="main-layout">
    <!-- ì™¼ìª½: ë‚´ ë³´ì´ìŠ¤ - ğŸ”¥ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ -->
    <div class="my-voices-section"> 
        <div class="section-header">ğŸ’¾ ë‚´ ë³´ì´ìŠ¤ ì»¬ë ‰ì…˜</div>

        <!-- ğŸ”¥ ê°€ë¡œ ìŠ¤í¬ë¡¤ ë˜í¼ ì¶”ê°€ -->
        <div class="myvoice-scroll-wrapper">
            {% if my_voices %}
                {% for item in my_voices %}
                <div class="myvoice-card-small">
                    <div class="myvoice-header">
                        {% if item.voice.voice_image %}
                        <img src="{{ item.voice.voice_image.url }}" class="myvoice-img-small" alt="{{ item.alias_name }}" loading="lazy">
                        {% else %}
                        <img src="{% static 'default_voice.png' %}" class="myvoice-img-small" alt="{{ item.alias_name }}" loading="lazy">
                        {% endif %}

                        <div class="myvoice-info-small">
                            <div class="myvoice-name-small">{{ item.alias_name }}</div>
                            <div class="myvoice-alias-small">{{ item.voice.voice_name }}</div>
                        </div>

                        <button class="favorite-btn-small" onclick="toggleFavorite({{ item.id }}, this)" data-favorite="{{ item.is_favorite|lower }}" data-login-required>
                            {% if item.is_favorite %}â­{% else %}â˜†{% endif %}
                        </button>
                    </div>

                    <!-- ì±… ì„ íƒ -->
                    <select name="book_id" onchange="selectBook({{ item.id }}, this.value)" class="book-select-small" data-login-required>
                        <option value="">ğŸ“š ì „ì²´ ì‘í’ˆ</option>
                        {% for book in books %}
                        <option value="{{ book.id }}" {% if item.book and book.id == item.book.id %}selected{% endif %}>
                            {{ book.name }}
                        </option>
                        {% endfor %}
                    </select>

                    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
                    {% if item.voice.sample_audio %}
                    <div class="audio-player-small">
                        <button onclick="togglePlaySmall(this)" data-login-required>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                        <div class="progress-bar-small">
                            <div class="progress-small"></div>
                        </div>
                        <span class="time-small">0:00 / 0:00</span>
                        <audio src="{{ item.voice.sample_audio.url }}" preload="metadata" loading="lazy"></audio>
                    </div>
                    {% endif %}

                    <!-- ì‚­ì œ ë²„íŠ¼ -->
                    <button type="button" class="delete-btn-small" onclick="deleteVoice({{ item.id }}, this)" data-login-required>ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-myvoice-small">
                    <div class="no-myvoice-icon-small">ğŸ™ï¸</div>
                    <p style="font-size: 14px; margin-bottom: 0;">ì €ì¥ëœ ë³´ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <p style="font-size: 12px; color: var(--text-secondary);">ì˜¤ë¥¸ìª½ì—ì„œ ëª©ì†Œë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì „ì²´ ë³´ì´ìŠ¤ ëª©ë¡ -->
    <div class="voice-list-section">
        <div class="section-header">ğŸµ ì „ì²´ ë³´ì´ìŠ¤ ëª©ë¡</div>

        <div class="voice-container">
            {% if voice_lists %}
                {% for voice in voice_lists %}
                <div class="voice-card"
                     data-voice-id="{{ voice.id }}"
                     data-voice-name="{{ voice.voice_name }}"
                     data-voice-types="{% for t in voice.types.all %}{{ t.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                    {% if voice.voice_image %}
                    <img src="{{ voice.voice_image.url }}" alt="{{ voice.voice_name }}" class="voice-image" loading="lazy">
                    {% else %}
                    <img src="{% static 'default_voice.png' %}" alt="{{ voice.voice_name }}" class="voice-image" loading="lazy">
                    {% endif %}

                    <div class="voice-name">{{ voice.voice_name }}</div>

                    {% if voice.types.all %}
                    <div class="voice-types">
                        {% for type in voice.types.all %}
                        <span class="type-badge">{{ type.name }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if voice.sample_audio %}
                    <div class="voice-audio-player">
                        <button class="play-btn" onclick="toggleVoicePlay(this)" data-login-required>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                        <div class="audio-progress">
                            <div class="audio-progress-bar"></div>
                        </div>
                        <span class="audio-time">0:00 / 0:00</span>
                        <audio src="{{ voice.sample_audio.url }}" preload="metadata" loading="lazy"></audio>
                    </div>
                    {% endif %}

                    <button class="select-voice-btn" onclick="selectVoice('{{ voice.id }}')" data-login-required>ì„ íƒ</button>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-voices">
                    <div class="no-voices-icon">ğŸ™ï¸</div>
                    <h2 class="no-voices-title">
                        {% if selected_type_ids %}
                        í•´ë‹¹ íƒ€ì…ì˜ ëª©ì†Œë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤
                        {% else %}
                        ë“±ë¡ëœ ë³´ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤
                        {% endif %}
                    </h2>
                    <p class="no-voices-text">
                        {% if selected_type_ids %}
                        ë‹¤ë¥¸ íƒ€ì…ì„ ì„ íƒí•´ë³´ì„¸ìš”
                        {% else %}
                        ìƒˆë¡œìš´ ë³´ì´ìŠ¤ê°€ ê³§ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
</div>

<div id="voice_name" style="display: none;"></div>
<div class="desktop-only">
    
</div>
{% endblock %}

{% block extra_js %}
<!-- <script>
// í˜ì´ì§€ ì ‘ê·¼ ì œí•œ - ë©”ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
(function() {
    window.location.href = '/';
})();
</script> -->
<script src="{% static 'js/voice/voice_list.js' %}"></script>
<script>
// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// ëª©ì†Œë¦¬ ê²€ìƒ‰ ë° íƒ€ì… í•„í„° (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)
const voiceCards = document.querySelectorAll('.voice-card');
const voiceSearch = document.getElementById('voice-search');
const filterBtns = document.querySelectorAll('.filter-btn');
let selectedTypes = new Set();
let aiFilteredIds = null; // null = í•„í„° ì—†ìŒ, Set = AI ì¶”ì²œ ê²°ê³¼

// í•„í„° ì ìš© í•¨ìˆ˜
function applyVoiceFilters() {
    const searchTerm = voiceSearch ? voiceSearch.value.toLowerCase().trim() : '';
    let visibleCount = 0;

    voiceCards.forEach(card => {
        const voiceName = (card.dataset.voiceName || '').toLowerCase();
        const voiceTypes = (card.dataset.voiceTypes || '').split(',').filter(t => t);
        const voiceId = String(card.dataset.voiceId || '');

        const matchesSearch = searchTerm === '' || voiceName.includes(searchTerm);
        const matchesType = selectedTypes.size === 0 ||
            [...selectedTypes].some(typeId => voiceTypes.includes(typeId));
        const matchesAi = aiFilteredIds === null || aiFilteredIds.has(voiceId);

        const visible = matchesSearch && matchesType && matchesAi;
        card.style.display = visible ? '' : 'none';

        // AI í•„í„° í™œì„±í™” ì‹œ ë§¤ì¹­ ì¹´ë“œì— í•˜ì´ë¼ì´íŠ¸
        if (aiFilteredIds !== null) {
            card.classList.toggle('ai-matched', matchesAi && visible);
        } else {
            card.classList.remove('ai-matched');
        }

        if (visible) visibleCount++;
    });

    const noVoices = document.querySelector('.no-voices');
    if (noVoices) {
        noVoices.style.display = visibleCount === 0 ? 'flex' : 'none';
    }
}

// AI ëª©ì†Œë¦¬ ì¶”ì²œ ê²€ìƒ‰
async function runAiVoiceSearch() {
    const input = document.getElementById('ai-voice-input');
    const query = (input.value || '').trim();
    if (!query) {
        input.focus();
        return;
    }

    const btn = document.getElementById('ai-search-btn');
    btn.textContent = 'ê²€ìƒ‰ ì¤‘...';
    btn.disabled = true;

    try {
        const res = await fetch('/voice/voice/ai-search/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ query })
        });

        const data = await res.json();

        if (data.error) {
            alert('AI ê²€ìƒ‰ ì˜¤ë¥˜: ' + data.error);
            return;
        }

        aiFilteredIds = new Set((data.matched_ids || []).map(String));

        const resultDiv = document.getElementById('ai-search-result');
        const resultText = document.getElementById('ai-result-text');
        const count = data.matched_ids ? data.matched_ids.length : 0;
        resultText.textContent = `âœ¨ "${query}"ì— ë§ëŠ” ëª©ì†Œë¦¬ ${count}ê°œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤`;
        resultDiv.style.display = 'flex';

        applyVoiceFilters();

        // ì²« ë§¤ì¹­ ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
        const firstMatch = document.querySelector('.voice-card.ai-matched');
        if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    } catch (e) {
        console.error('AI ê²€ìƒ‰ ì˜¤ë¥˜:', e);
        alert('AI ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
        btn.textContent = 'AI ì¶”ì²œ';
        btn.disabled = false;
    }
}

function clearAiFilter() {
    aiFilteredIds = null;
    document.getElementById('ai-search-result').style.display = 'none';
    document.getElementById('ai-voice-input').value = '';
    applyVoiceFilters();
}

// Enter í‚¤ë¡œ AI ê²€ìƒ‰
document.getElementById('ai-voice-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') runAiVoiceSearch();
});

// íƒ€ì… ë²„íŠ¼ í´ë¦­ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥, í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ìŒ)
filterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
        const typeId = this.dataset.id;

        if (selectedTypes.has(typeId)) {
            selectedTypes.delete(typeId);
            this.classList.remove('active');
        } else {
            selectedTypes.add(typeId);
            this.classList.add('active');
        }

        applyVoiceFilters();
    });
});

// ê²€ìƒ‰ ì…ë ¥
if (voiceSearch) {
    voiceSearch.addEventListener('input', applyVoiceFilters);
}

// ì¦ê²¨ì°¾ê¸° í† ê¸€ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ìŒ)
function toggleFavorite(voiceId, button) {
    fetch(`/mypage/toggle_myvoice_favorite/${voiceId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ë²„íŠ¼ ì•„ì´ì½˜ ë³€ê²½
            button.textContent = data.is_favorite ? 'â­' : 'â˜†';
            button.dataset.favorite = data.is_favorite;
            console.log('âœ…', data.message);
        }
    })
    .catch(error => {
        console.error('âŒ ì¦ê²¨ì°¾ê¸° í† ê¸€ ì˜¤ë¥˜:', error);
        alert('ì¦ê²¨ì°¾ê¸° ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì±… ì„ íƒ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ìŒ)
function selectBook(voiceId, bookId) {
    const formData = new FormData();
    formData.append('book_id', bookId);

    fetch(`/mypage/select_book/${voiceId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('âœ…', data.message, '-', data.book_name);
        }
    })
    .catch(error => {
        console.error('âŒ ì±… ì„ íƒ ì˜¤ë¥˜:', error);
        alert('ì±… ì„ íƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// ëª©ì†Œë¦¬ ì‚­ì œ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ìŒ)
function deleteVoice(voiceId, button) {
    if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    fetch(`/mypage/delete/${voiceId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ì¹´ë“œ ì „ì²´ë¥¼ DOMì—ì„œ ì œê±° (ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œì•„ì›ƒ íš¨ê³¼)
            const card = button.closest('.myvoice-card-small');
            card.style.transition = 'opacity 0.3s ease';
            card.style.opacity = '0';
            setTimeout(() => {
                card.remove();

                // ëª¨ë“  ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆëŠ”ì§€ í™•ì¸
                const remainingCards = document.querySelectorAll('.myvoice-card-small');
                if (remainingCards.length === 0) {
                    // ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
                    const myVoicesSection = document.querySelector('.my-voices-section');
                    myVoicesSection.innerHTML = `
                        <div class="section-header">ğŸ’¾ ë‚´ ë³´ì´ìŠ¤ ì»¬ë ‰ì…˜</div>
                        <div class="no-myvoice-small">
                            <div class="no-myvoice-icon-small">ğŸ™ï¸</div>
                            <p style="font-size: 14px; margin-bottom: 0;">ì €ì¥ëœ ë³´ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <p style="font-size: 12px; color: var(--text-secondary);">ì˜¤ë¥¸ìª½ì—ì„œ ëª©ì†Œë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                    `;
                }
            }, 300);
            console.log('âœ…', data.message);
        }
    })
    .catch(error => {
        console.error('âŒ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}
</script>
{% endblock %}
