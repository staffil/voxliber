{% extends "admin/base_site.html" %}
{% block title %}ì—í”¼ì†Œë“œ ì¸ê¸° ë­í‚¹{% endblock %}

{% block content %}
<style>
.ranking-wrap { max-width: 960px; }
.genre-form { display: flex; gap: 12px; align-items: center; margin-bottom: 28px; flex-wrap: wrap; }
.genre-form select {
  padding: 8px 14px; border-radius: 8px; border: 1px solid #c7d2fe;
  font-size: 0.95rem; min-width: 180px; color: #1e1b4b;
}
.genre-form button {
  padding: 8px 20px; background: #6366f1; color: #fff;
  border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
}
.genre-form button:hover { background: #4f46e5; }
.ranking-hint {
  background: #eff6ff; border-left: 4px solid #6366f1;
  padding: 10px 16px; border-radius: 0 8px 8px 0;
  font-size: 0.82rem; color: #3730a3; margin-bottom: 20px;
}
.score-formula {
  display: inline-flex; gap: 8px; align-items: center;
  flex-wrap: wrap; margin-top: 4px;
}
.score-formula .chip {
  padding: 2px 8px; border-radius: 12px; font-weight: 700; font-size: 0.78rem;
}
.ep-table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
.ep-table th {
  background: #f5f3ff; color: #4c1d95; font-weight: 700;
  padding: 10px 12px; text-align: left; border-bottom: 2px solid #e0e7ff;
  white-space: nowrap;
}
.ep-table td { padding: 10px 12px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
.ep-table tr:hover td { background: #fafafe; }
.rank-num {
  width: 32px; height: 32px; border-radius: 50%; display: inline-flex;
  align-items: center; justify-content: center;
  font-weight: 800; font-size: 0.85rem; color: #fff;
}
.rank-1 { background: #f59e0b; }
.rank-2 { background: #94a3b8; }
.rank-3 { background: #b45309; }
.rank-n { background: #e0e7ff; color: #6366f1; }
.cover-img { width: 36px; height: 50px; object-fit: cover; border-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.15); }
.cover-placeholder { width: 36px; height: 50px; background: #e0e0f0; border-radius: 4px; display:flex; align-items:center; justify-content:center; font-size:1rem; }
.ep-title { font-weight: 700; color: #111; }
.ep-book  { font-size: 0.78rem; color: #6366f1; font-weight: 600; margin-top: 2px; }
.ep-meta  { font-size: 0.73rem; color: #888; margin-top: 1px; }
.score-badge {
  padding: 3px 10px; border-radius: 12px;
  font-weight: 800; font-size: 0.85rem; color: #fff; white-space: nowrap;
}
.bar-wrap { display: flex; align-items: center; gap: 6px; }
.bar-bg { width: 60px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 3px; }
.no-data { text-align: center; padding: 40px; color: #aaa; font-size: 0.95rem; }
</style>

<div class="ranking-wrap">
  <h1 style="margin-bottom:6px;">ğŸ“Š ì—í”¼ì†Œë“œ ì¸ê¸° ë­í‚¹</h1>

  <div class="ranking-hint">
    <b>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íë ˆì´ì…˜ ì°¸ê³ ìš©</b> â€” ì–´ë–¤ ì—í”¼ì†Œë“œë¥¼ ë‹´ì„ì§€ ì ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.<br>
    <div class="score-formula">
      <span>ì¢…í•© ì ìˆ˜ =</span>
      <span class="chip" style="background:#3b82f622;color:#1d4ed8;">ì²­ì·¨ììˆ˜ 40%</span>
      <span>+</span>
      <span class="chip" style="background:#22c55e22;color:#15803d;">ì™„ë£Œìœ¨ 40%</span>
      <span>+</span>
      <span class="chip" style="background:#f59e0b22;color:#92400e;">ëŒ“ê¸€ìˆ˜ 20%</span>
    </div>
  </div>

  <!-- ì¥ë¥´ ì„ íƒ í¼ -->
  <form method="get" class="genre-form">
    <select name="genre">
      <option value="">-- ì¥ë¥´ ì„ íƒ --</option>
      {% for genre in genres %}
      <option value="{{ genre.id }}" {% if genre.id == genre_id %}selected{% endif %}>
        {{ genre.name }}
      </option>
      {% endfor %}
    </select>
    <button type="submit">ì¡°íšŒ</button>
    {% if genre_id %}
    <a href="?" style="color:#6366f1; font-size:0.85rem;">ì´ˆê¸°í™”</a>
    {% endif %}
  </form>

  <!-- ë­í‚¹ í…Œì´ë¸” -->
  {% if rows %}
  <table class="ep-table">
    <thead>
      <tr>
        <th style="width:44px;">ìˆœìœ„</th>
        <th style="width:44px;"></th>
        <th>ì—í”¼ì†Œë“œ / ì±…</th>
        <th style="width:80px; text-align:center;">â˜… ì ìˆ˜</th>
        <th style="width:90px;">ğŸ‘¥ ì²­ì·¨ì</th>
        <th style="width:120px;">â± ì™„ë£Œìœ¨</th>
        <th style="width:80px;">ğŸ’¬ ëŒ“ê¸€</th>
        <th style="width:80px;">ê¸¸ì´</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
      {% with c=row.content b=row.book %}
      <tr>
        <!-- ìˆœìœ„ -->
        <td>
          {% if forloop.counter == 1 %}
            <span class="rank-num rank-1">1</span>
          {% elif forloop.counter == 2 %}
            <span class="rank-num rank-2">2</span>
          {% elif forloop.counter == 3 %}
            <span class="rank-num rank-3">3</span>
          {% else %}
            <span class="rank-num rank-n">{{ forloop.counter }}</span>
          {% endif %}
        </td>

        <!-- ì»¤ë²„ -->
        <td>
          {% if b.cover_img %}
            <img src="{{ b.cover_img.url }}" class="cover-img" alt="{{ b.name }}">
          {% else %}
            <div class="cover-placeholder">ğŸ“–</div>
          {% endif %}
        </td>

        <!-- ì—í”¼ì†Œë“œ / ì±… -->
        <td>
          <div class="ep-title">{{ c.title }}</div>
          <div class="ep-book">ğŸ“– {{ b.name }}</div>
          <div class="ep-meta">{{ c.number }}í™”</div>
        </td>

        <!-- ì¢…í•© ì ìˆ˜ -->
        <td style="text-align:center;">
          {% if row.score >= 60 %}
            <span class="score-badge" style="background:#6366f1;">{{ row.score }}</span>
          {% elif row.score >= 30 %}
            <span class="score-badge" style="background:#f59e0b;">{{ row.score }}</span>
          {% else %}
            <span class="score-badge" style="background:#94a3b8;">{{ row.score }}</span>
          {% endif %}
        </td>

        <!-- ì²­ì·¨ì ìˆ˜ -->
        <td><b style="color:#1d4ed8;">{{ row.listeners }}ëª…</b></td>

        <!-- ì™„ë£Œìœ¨ + ë°” -->
        <td>
          <div class="bar-wrap">
            <b>{{ row.completion }}%</b>
            <div class="bar-bg">
              {% if row.completion >= 70 %}
                <div class="bar-fill" style="width:{{ row.completion }}%;background:#22c55e;"></div>
              {% elif row.completion >= 40 %}
                <div class="bar-fill" style="width:{{ row.completion }}%;background:#f59e0b;"></div>
              {% else %}
                <div class="bar-fill" style="width:{{ row.completion }}%;background:#ef4444;"></div>
              {% endif %}
            </div>
          </div>
        </td>

        <!-- ëŒ“ê¸€ -->
        <td><b style="color:#059669;">{{ row.comments }}ê°œ</b></td>

        <!-- ê¸¸ì´ -->
        <td style="color:#888;">{{ c.get_duration_formatted }}</td>

        <!-- ë§í¬ -->
        <td>
          <a href="/admin/book/content/{{ c.pk }}/change/" target="_blank"
             style="font-size:0.75rem;color:#6366f1;">â†— ìƒì„¸</a>
        </td>
      </tr>
      {% endwith %}
      {% endfor %}
    </tbody>
  </table>

  <p style="margin-top:12px; font-size:0.78rem; color:#aaa;">
    ì´ {{ rows|length }}ê°œ ì—í”¼ì†Œë“œ Â· ì ìˆ˜ ë†’ì€ ìˆœ ì •ë ¬
  </p>

  {% elif genre_id %}
  <div class="no-data">í•´ë‹¹ ì¥ë¥´ì— ì—í”¼ì†Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
  {% else %}
  <div class="no-data">ìœ„ì—ì„œ ì¥ë¥´ë¥¼ ì„ íƒí•˜ë©´ ë­í‚¹ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
  {% endif %}
</div>
{% endblock %}