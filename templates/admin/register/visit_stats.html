{% extends "admin/base_site.html" %}
{% block content %}

<style>
  .stat-wrap { background:#f4f6f9; padding:24px; border-radius:12px; }
  .stat-card { background:#fff; padding:20px; border-radius:8px; flex:1; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
  .stat-card h3 { margin:0 0 8px; color:#333; font-size:0.95rem; }
  .stat-card .val { font-size:2em; font-weight:bold; margin:0; color:#111; }
  .stat-table { width:100%; border-collapse:collapse; margin-bottom:30px; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
  .stat-table th { padding:10px 12px; background:#e9ecef; color:#222; text-align:left; font-size:0.88rem; border-bottom:2px solid #dee2e6; }
  .stat-table td { padding:9px 12px; color:#222; border-bottom:1px solid #eee; font-size:0.9rem; }
  .stat-table tr:last-child td { border-bottom:none; }
  .stat-table tr:hover td { background:#f8f9fa; }
  .section-title { color:#222; font-size:1.1rem; margin:24px 0 10px; font-weight:700; }
  .user-card { background:#fff; padding:20px; border-radius:8px; border:1px solid #dee2e6; margin-bottom:20px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
  .mini-card { background:#f0f4ff; padding:15px; border-radius:6px; min-width:130px; text-align:center; }
  .mini-card .label { margin:0; color:#555; font-size:12px; }
  .mini-card .num { margin:4px 0 0; font-size:1.8em; font-weight:bold; color:#1a1a2e; }
  .user-select-box { width:100%; max-width:500px; height:180px; border:1px solid #ced4da; border-radius:6px; font-size:14px; color:#111; background:#fff; padding:4px; }
  .user-select-box option:checked { background:#4e73df; color:#fff; }
  .chart-box { background:#fff; border-radius:8px; padding:20px; box-shadow:0 1px 4px rgba(0,0,0,0.08); margin-bottom:30px; }
  .cal-nav { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
  .cal-nav a { padding:5px 14px; background:#4e73df; color:#fff; border-radius:6px; text-decoration:none; font-size:13px; font-weight:600; }
  .cal-nav a.gray { background:#6c757d; }
  .cal-nav span { font-size:1.1rem; font-weight:700; color:#222; }
  .cal-table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,0.08); margin-bottom:30px; table-layout:fixed; }
  .cal-table th { padding:10px; background:#4e73df; color:#fff; text-align:center; font-size:0.85rem; }
  .cal-table td { padding:8px 6px; border:1px solid #eee; vertical-align:top; height:64px; }
  .cal-empty { background:#fafafa; }
  .cal-has-data { background:#eef3ff; }
  .cal-today { background:#fff8e1 !important; border:2px solid #ffc107 !important; }
  .cal-day-num { font-size:0.82rem; color:#666; margin-bottom:4px; font-weight:600; }
  .cal-day-num.is-today { color:#e74a3b; font-weight:800; }
  .cal-total { font-size:0.78rem; color:#4e73df; font-weight:700; }
  .cal-unique { font-size:0.75rem; color:#1cc88a; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<div class="stat-wrap">
<h2 style="color:#111; margin-top:0;">ğŸ“Š ë°©ë¬¸ì í†µê³„</h2>

<!-- ì˜¤ëŠ˜ ìš”ì•½ -->
<div style="display:flex; gap:16px; margin-bottom:28px;">
    <div class="stat-card" style="border-left:4px solid #007bff;">
        <h3>ì˜¤ëŠ˜ ì´ ë°©ë¬¸</h3>
        <p class="val">{{ today_total }}íšŒ</p>
    </div>
    <div class="stat-card" style="border-left:4px solid #28a745;">
        <h3>ì˜¤ëŠ˜ ìˆœ ë°©ë¬¸ì</h3>
        <p class="val">{{ today_unique }}ëª…</p>
    </div>
    <div class="stat-card" style="border-left:4px solid #ffc107;">
        <h3>ì˜¤ëŠ˜ ë‚ ì§œ</h3>
        <p class="val" style="font-size:1.4em;">{{ today }}</p>
    </div>
</div>

<!-- ì‹œê°„ëŒ€ë³„ ë§‰ëŒ€ê·¸ë˜í”„ -->
<p class="section-title">â° ì‹œê°„ëŒ€ë³„ ë°©ë¬¸ (ì˜¤ëŠ˜)</p>
<div class="chart-box">
    <canvas id="hourlyChart" height="80"></canvas>
</div>

<!-- ìµœê·¼ 7ì¼ ë¼ì¸ê·¸ë˜í”„ -->
<p class="section-title">ğŸ“… ìµœê·¼ 7ì¼ ë°©ë¬¸ ì¶”ì´</p>
<div class="chart-box">
    <canvas id="weeklyChart" height="80"></canvas>
</div>

<!-- ì›”ë³„ ìº˜ë¦°ë” -->
<hr style="border:none; border-top:2px solid #dee2e6; margin-bottom:24px;">
<p class="section-title">ğŸ—“ï¸ ì›”ë³„ ë°©ë¬¸ì ìº˜ë¦°ë”</p>
<p style="color:#555; font-size:13px; margin-bottom:12px;">
  <span style="color:#4e73df; font-weight:600;">íŒŒë€ ìˆ«ì</span> = ì´ ë°©ë¬¸ &nbsp;|&nbsp;
  <span style="color:#1cc88a; font-weight:600;">ì´ˆë¡ ìˆ«ì</span> = ìˆœ ë°©ë¬¸ì(IP ê¸°ì¤€)
</p>

<div class="cal-nav">
    <a href="?year={{ prev_year }}&month={{ prev_month }}{% for uid in selected_user_ids %}&users={{ uid }}{% endfor %}">â—€ ì´ì „ë‹¬</a>
    <span>{{ month_name }}</span>
    <a href="?year={{ next_year }}&month={{ next_month }}{% for uid in selected_user_ids %}&users={{ uid }}{% endfor %}">ë‹¤ìŒë‹¬ â–¶</a>
    <a href="?{% for uid in selected_user_ids %}users={{ uid }}&{% endfor %}" class="gray">ì´ë²ˆë‹¬</a>
</div>

<table class="cal-table">
    <tr>
        <th style="color:#ffb3b3;">ì¼</th>
        <th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th>
        <th style="color:#b3d4ff;">í† </th>
    </tr>
    {% for week in cal_weeks %}
    <tr>
        {% for day in week %}
        {% if day is None %}
            <td class="cal-empty"></td>
        {% else %}
            <td class="{% if day.total > 0 %}cal-has-data{% endif %} {% if day.is_today %}cal-today{% endif %}">
                <div class="cal-day-num {% if day.is_today %}is-today{% endif %}">{{ day.day }}</div>
                {% if day.total > 0 %}
                <div class="cal-total">ğŸ‘¥ {{ day.total }}íšŒ</div>
                <div class="cal-unique">ğŸ‘¤ {{ day.unique }}ëª…</div>
                {% endif %}
            </td>
        {% endif %}
        {% endfor %}
    </tr>
    {% endfor %}
</table>

<!-- ìœ ì € ì¬ë°©ë¬¸ìœ¨ ê²€ìƒ‰ -->
<hr style="border:none; border-top:2px solid #dee2e6; margin-bottom:24px;">
<p class="section-title">ğŸ” ìœ ì € ì¬ë°©ë¬¸ìœ¨ ì¡°íšŒ</p>

<form method="get" style="margin-bottom:24px;">
  <input type="hidden" name="year" value="{{ year }}">
  <input type="hidden" name="month" value="{{ month }}">
  <div style="display:flex; gap:10px; margin-bottom:10px;">
    <input type="text" id="user-search-input" placeholder="ì´ë¦„/ì´ë©”ì¼ë¡œ í•„í„°ë§..."
           style="padding:8px 14px; border:1px solid #ced4da; border-radius:6px; width:300px; font-size:14px; color:#111; background:#fff;">
    <span style="color:#555; font-size:13px; align-self:center;">Ctrl+í´ë¦­ìœ¼ë¡œ ì—¬ëŸ¬ ëª… ì„ íƒ</span>
  </div>
  <select name="users" multiple class="user-select-box" id="user-select">
    {% for user in all_users %}
    <option value="{{ user.user_id }}"
      {% if user.user_id|stringformat:"s" in selected_user_ids %}selected{% endif %}>
      {{ user.nickname }} ({{ user.email }})
    </option>
    {% endfor %}
  </select>
  <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
    <button type="submit" style="padding:8px 22px; background:#4e73df; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">
      ğŸ“Š í†µê³„ ì¡°íšŒ
    </button>
    <a href="?year={{ year }}&month={{ month }}" style="padding:8px 16px; background:#6c757d; color:#fff; border-radius:6px; font-size:14px; text-decoration:none;">
      ì´ˆê¸°í™”
    </a>
    {% if selected_user_ids %}
    <span style="color:#555; font-size:13px;">{{ users_stats|length }}ëª… ì„ íƒë¨</span>
    {% endif %}
  </div>
</form>

{% for stat in users_stats %}
<div class="user-card">
    <h4 style="margin:0 0 16px; color:#111;">
        ğŸ‘¤ {{ stat.user.nickname }}
        <span style="color:#666; font-weight:400; font-size:0.9em;">({{ stat.user.email }})</span>
    </h4>
    <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:16px;">
        <div class="mini-card">
            <p class="label">ì´ ë°©ë¬¸ íšŸìˆ˜</p>
            <p class="num" style="color:#4e73df;">{{ stat.total_visits }}íšŒ</p>
        </div>
        <div class="mini-card">
            <p class="label">ë°©ë¬¸í•œ ë‚  ìˆ˜</p>
            <p class="num" style="color:#1cc88a;">{{ stat.total_days }}ì¼</p>
        </div>
        <div class="mini-card">
            <p class="label">ì¬ë°©ë¬¸ ë‚  ìˆ˜</p>
            <p class="num" style="color:#f6a31a;">{{ stat.revisit_days }}ì¼</p>
        </div>
        <div class="mini-card">
            <p class="label">ì¬ë°©ë¬¸ìœ¨</p>
            <p class="num" style="color:#e74a3b;">{{ stat.revisit_rate }}%</p>
        </div>
    </div>
    <p style="margin:0 0 14px; color:#555; font-size:13px;">
        ì²« ë°©ë¬¸: <strong style="color:#222;">{{ stat.first_visit|date:"Y-m-d H:i" }}</strong>
        &nbsp;|&nbsp;
        ë§ˆì§€ë§‰ ë°©ë¬¸: <strong style="color:#222;">{{ stat.last_visit|date:"Y-m-d H:i" }}</strong>
    </p>
    <table class="stat-table" style="margin-bottom:0;">
        <tr><th>ë‚ ì§œ</th><th>ë°©ë¬¸ ìˆ˜</th><th>ì¬ë°©ë¬¸</th></tr>
        {% for item in stat.daily_visits %}
        <tr>
            <td>{{ item.date }}</td>
            <td>{{ item.count }}íšŒ</td>
            <td>
                {% if item.count >= 2 %}
                    <span style="color:#1cc88a; font-weight:bold;">âœ… ì¬ë°©ë¬¸</span>
                {% else %}
                    <span style="color:#aaa;">-</span>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="3" style="text-align:center; color:#888;">ë°©ë¬¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
        {% endfor %}
    </table>
</div>
{% empty %}
{% if selected_user_ids %}
<p style="color:#888;">ì„ íƒëœ ìœ ì €ì˜ ë°©ë¬¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}
{% endfor %}

</div>

<script>
const hourlyLabels = [{% for item in hourly %}"{{ item.hour|date:'H' }}ì‹œ"{% if not forloop.last %},{% endif %}{% endfor %}];
const hourlyCounts = [{% for item in hourly %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}];

new Chart(document.getElementById('hourlyChart'), {
    type: 'bar',
    data: {
        labels: hourlyLabels.length ? hourlyLabels : ['ë°ì´í„° ì—†ìŒ'],
        datasets: [{ label: 'ë°©ë¬¸ ìˆ˜', data: hourlyCounts.length ? hourlyCounts : [0],
            backgroundColor: 'rgba(78,115,223,0.7)', borderColor: '#4e73df', borderWidth:1, borderRadius:4 }]
    },
    options: { responsive:true, plugins:{legend:{display:false}},
        scales:{ y:{beginAtZero:true,ticks:{stepSize:1,color:'#444'},grid:{color:'#eee'}}, x:{ticks:{color:'#444'},grid:{display:false}} } }
});

const weeklyLabels = [{% for item in weekly %}"{{ item.date }}"{% if not forloop.last %},{% endif %}{% endfor %}].reverse();
const weeklyCounts = [{% for item in weekly %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}].reverse();

new Chart(document.getElementById('weeklyChart'), {
    type: 'line',
    data: {
        labels: weeklyLabels.length ? weeklyLabels : ['ë°ì´í„° ì—†ìŒ'],
        datasets: [{ label: 'ë°©ë¬¸ ìˆ˜', data: weeklyCounts.length ? weeklyCounts : [0],
            borderColor:'#1cc88a', backgroundColor:'rgba(28,200,138,0.1)', borderWidth:2,
            pointBackgroundColor:'#1cc88a', pointRadius:5, fill:true, tension:0.3 }]
    },
    options: { responsive:true, plugins:{legend:{display:false}},
        scales:{ y:{beginAtZero:true,ticks:{stepSize:1,color:'#444'},grid:{color:'#eee'}}, x:{ticks:{color:'#444'},grid:{display:false}} } }
});

document.getElementById('user-search-input').addEventListener('input', function() {
    const keyword = this.value.toLowerCase();
    document.querySelectorAll('#user-select option').forEach(opt => {
        opt.style.display = opt.text.toLowerCase().includes(keyword) ? '' : 'none';
    });
});
</script>

{% endblock %}