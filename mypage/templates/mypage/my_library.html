{% extends "base.html" %}
{% load static %}

{% block title %}VOXLIBER - ë‚´ ì„œì¬{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mypage/my_library.css' %}?v=2">
{% endblock %}

{% block content %}
<div class="library-container">

  <!-- í—¤ë” -->
  <div class="library-header">
    <h1 class="library-title">ë‚´ ì„œì¬</h1>
    <p class="library-subtitle">ë‚˜ë§Œì˜ ë…ì„œ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”</p>
  </div>

  <!-- í†µê³„ -->
  <div class="stats-grid">
    <div class="stat-card"><div class="stat-label">ì „ì²´ ì±…</div><div class="stat-value">{{ stats.total }}</div></div>
    <div class="stat-card"><div class="stat-label">ì½ëŠ” ì¤‘</div><div class="stat-value">{{ stats.reading }}</div></div>
    <div class="stat-card"><div class="stat-label">ì™„ë…</div><div class="stat-value">{{ stats.completed }}</div></div>
    <div class="stat-card"><div class="stat-label">AI ìŠ¤í† ë¦¬</div><div class="stat-value">{{ stats.ai_stories }}</div></div>
    <div class="stat-card"><div class="stat-label">ëŒ€í™”í•œ AIë“¤</div><div class="stat-value">{{ stats.llms }}</div></div>
  </div>

  <!-- í•„í„° -->
  <div class="filter-tabs">
    <a href="?status=all" class="filter-tab {% if filter_status == 'all' %}active{% endif %}">ì „ì²´</a>
    <a href="?status=reading" class="filter-tab {% if filter_status == 'reading' %}active{% endif %}">ì½ëŠ” ì¤‘</a>
    <a href="?status=completed" class="filter-tab {% if filter_status == 'completed' %}active{% endif %}">ì™„ë…</a>
    <a href="?status=ai" class="filter-tab {% if filter_status == 'ai' %}active{% endif %}">AI ìŠ¤í† ë¦¬</a>
    <a href="?status=llms" class="filter-tab {% if filter_status == 'llms' %}active{% endif %}">ëŒ€í™”í•œ AIë“¤</a>
    <a href="{% url 'book:my_bookmarks' %}" class="filter-tab">ë¶ë§ˆí¬ â†’</a>
  </div>


  <!-- ========================= -->
  <!-- ğŸ“š ì±… ëª©ë¡ -->
  <!-- ========================= -->
  {% if filter_status != 'ai' and filter_status != 'llms' %}

    {% if reading_progress_list %}
      <div class="books-grid">
        {% for progress in reading_progress_list %}
        <div class="book-progress-card">

          <div class="book-cover-section">
            {% if progress.book.cover_img %}
              <img src="{{ progress.book.cover_img.url }}" alt="{{ progress.book.name }}">
            {% else %}
              <div class="cover-placeholder">
                {{ progress.book.name|slice:":2" }}
              </div>
            {% endif %}

            <div class="book-status-badge status-{{ progress.status }}">
              {% if progress.status == 'reading' %}ì½ëŠ” ì¤‘
              {% elif progress.status == 'completed' %}ì™„ë…
              {% elif progress.status == 'paused' %}ì¼ì‹œì¤‘ì§€
              {% endif %}
            </div>
          </div>

          <div class="book-info-section">

            <h3 class="book-title">{{ progress.book.name }}</h3>

            <div class="book-meta">
              {% for genre in progress.book.genres.all|slice:":2" %}
                {{ genre.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </div>

            <div class="progress-section">
              <div class="progress-info">
                <span>{{ progress.last_read_content_number }}í™” / {{ progress.book.contents.count }}í™”</span>
                <span>{{ progress.get_progress_percentage }}%</span>
              </div>

              <div class="progress-bar-container">
                <div class="progress-bar" style="width: {{ progress.get_progress_percentage }}%"></div>
              </div>
            </div>

            <div class="book-actions">
              <a href="#" class="btn-action btn-continue" onclick="showAppInstallModal()">
                {% if progress.status == 'completed' %}ë‹¤ì‹œ ì½ê¸°{% else %}ì´ì–´ ì½ê¸°{% endif %}
              </a>
              <a href="{% url 'book:book_detail' progress.book.public_uuid %}" class="btn-action btn-secondary">
                ìƒì„¸ ì •ë³´
              </a>
            </div>

          </div>
        </div>
        {% endfor %}
      </div>

    {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“š</div>
        <h3>ì•„ì§ ì½ì€ ì±…ì´ ì—†ìŠµë‹ˆë‹¤</h3>
      </div>
    {% endif %}

  {% endif %}

  <!-- AI ìŠ¤í† ë¦¬ ëª©ë¡ -->
{% if filter_status == 'ai' or filter_status == 'all' %}
  {% if chatted_stories %}
  <div class="section-header">
    <h2 class="section-title">ğŸ¤– ëŒ€í™”í•œ AI ìŠ¤í† ë¦¬</h2>
  </div>
  <div class="ai-stories-grid">
   {% for story in chatted_stories %}
<div class="story-cover-section" style="height: 280px; position: relative;">

  <!-- ì „ì²´ ì¹´ë“œ ë§í¬ -->
  <a href="{% url 'character:story_intro' story.public_uuid %}"
     class="ai-story-card"
     style="text-decoration: none; display: block;">

    <!-- ì»¤ë²„ ì´ë¯¸ì§€ -->
        {% if story.cover_image %}
          <img src="{{ story.cover_image.url }}" alt="{{ story.title }}">
        
        {% elif story.story_desc_video %}
          <video
            src="{{ story.story_desc_video.url }}"
            autoplay
            muted
            loop
            playsinline
          ></video>

        {% else %}
          <div class="story-cover-placeholder">ğŸ¤–</div>
        {% endif %}

    <!-- ê·¸ë¼ë°ì´ì…˜ ì˜¤ë²„ë ˆì´ -->
    <div style="position: absolute; inset: 0;
                background: linear-gradient(to top,
                rgba(0,0,0,0.9) 0%,
                rgba(0,0,0,0.5) 40%,
                transparent 70%);">
    </div>

    <!-- ìƒì„¸ ë³´ê¸° ë²„íŠ¼ (a â†’ div) -->
<div class="detail-btn"
     title="ì´ì•¼ê¸° ìƒì„¸ ë³´ê¸°"
     onclick="event.preventDefault(); event.stopPropagation(); location.href='{% url 'mypage:ai_detail' story.public_uuid %}';">

      <svg xmlns="http://www.w3.org/2000/svg"
           width="18"
           height="18"
           viewBox="0 0 24 24"
           fill="none"
           stroke="currentColor"
           stroke-width="2"
           stroke-linecap="round"
           stroke-linejoin="round"
           aria-hidden="true">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
      </svg>
    </div>

    <!-- ì½˜í…ì¸  ì˜¤ë²„ë ˆì´ -->
    <div style="position: absolute; bottom: 0; left: 0; right: 0;
                padding: 16px; z-index: 1;">

      <h3 style="font-size: 16px; font-weight: 700; color: #fff;
                 margin: 0 0 6px 0; overflow: hidden;
                 text-overflow: ellipsis; white-space: nowrap;">
        {{ story.title }}
      </h3>

      <p style="font-size: 12px; color: rgba(255,255,255,0.7);
                margin: 0 0 10px 0;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                line-height: 1.4;">
        {{ story.description|truncatewords:12|default:"" }}
      </p>

      <div style="display: flex; flex-wrap: wrap; gap: 6px;">
        <span style="font-size: 11px; color: #a78bfa; font-weight: 600;">
          ğŸ‘¥ {{ story.characters.count }}ëª…
        </span>

        {% for genre in story.genres.all|slice:":2" %}
        <span style="padding: 2px 8px;
                     background: rgba(99, 102, 241, 0.3);
                     border-radius: 10px;
                     font-size: 10px;
                     color: #c4b5fd;">
          {{ genre.name }}
        </span>
        {% endfor %}
      </div>

    </div>
  </a>
</div>
{% endfor %}

  </div>
    {% elif filter_status == 'ai' %}
    <div class="empty-state">
      <div class="empty-state-icon">ğŸ¤–</div>
      <h3 class="empty-state-title">ì•„ì§ ëŒ€í™”í•œ AI ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      <p class="empty-state-text">AI ìºë¦­í„°ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
      <a href="{% url 'main:ai_novel_main' %}" class="btn-browse">AI ìŠ¤í† ë¦¬ ë‘˜ëŸ¬ë³´ê¸°</a>
    </div>
    {% endif %}
  {% endif %}

<!-- ========================= -->
<!-- ğŸ¤– LLM (ìŠ¤í† ë¦¬ ì¹´ë“œ ìŠ¤íƒ€ì¼) -->
<!-- ========================= -->
{% if filter_status == 'llms' or filter_status == 'all' %}

  {% if chatted_llms %}
    <div class="section-header">
      <h2 class="section-title">ğŸ¤– ëŒ€í™”í•œ AIë“¤</h2>
    </div>

    <div class="ai-stories-grid">
      {% for llm in chatted_llms %}

      <div class="story-cover-section" style="height: 260px; position: relative;">

        <a href="{% url 'character:ai_intro' llm.public_uuid %}"
           class="ai-story-card"
           style="display: block; text-decoration: none;">

          <!-- ì»¤ë²„ -->
          {% if llm.llm_image %}
            <img src="{{ llm.llm_image.url }}" alt="{{ llm.name }}">
          {% else %}
            <div class="story-cover-placeholder">
              <span>ğŸ¤–</span>
            </div>
          {% endif %}

          <!-- ê·¸ë¼ë°ì´ì…˜ -->
          <div style="
            position: absolute;
            inset: 0;
            background: linear-gradient(
              to top,
              rgba(0,0,0,0.9) 0%,
              rgba(0,0,0,0.55) 40%,
              transparent 70%
            );
          "></div>

          <!-- ì½˜í…ì¸  -->
          <div style="
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            z-index: 1;
          ">

            <h3 style="
              font-size: 16px;
              font-weight: 700;
              color: #fff;
              margin: 0 0 6px 0;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            ">
              {{ llm.name }}
            </h3>

            <p style="
              font-size: 12px;
              color: rgba(255,255,255,0.75);
              margin: 0;
              line-height: 1.4;
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              overflow: hidden;
            ">
              {{ llm.description|truncatewords:14 }}
            </p>

          </div>

        </a>
      </div>

      {% endfor %}
    </div>

  {% endif %}
{% endif %}


</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleBookmark(btn, storyUuid) {
    fetch(`/character/story/${storyUuid}/bookmark/toggle/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            btn.classList.toggle('active', data.bookmarked);
        }
    })
    .catch(error => console.error('ë¶ë§ˆí¬ ì˜¤ë¥˜:', error));
}
</script>
{% endblock %}
