{% extends "base.html" %}
{% load static %}

{% block title %}{{ novel.title }} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mypage/novel_result.css' %}?v=3">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;600;700&display=swap" rel="stylesheet">

{% endblock %}

{% block content %}
<br><br><br>
<div class="novel-container">

    <!-- ì œëª© -->
    <h1 class="novel-title">{{ novel.title }}</h1>

    <!-- í”„ë¡¤ë¡œê·¸ -->
    {% if novel.prologue %}
    <p class="novel-prologue">{{ novel.prologue|safe }}</p>
    {% endif %}

    <!-- ìˆœì°¨ ì¬ìƒ ì‹œì‘ ë²„íŠ¼ -->
    <button id="start-seq-btn">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        ìˆœì„œëŒ€ë¡œ ë“£ê¸°
    </button>

    <!-- ì±•í„° ëª©ë¡ -->
    {% for chapter in novel.chapters %}
    <section class="chapter">

        <!-- ì±•í„°ë³„ ì´ë¯¸ì§€ -->
        {% if chapter.image and chapter.image.image %}
        <div class="chapter-image">
            <img
                src="{{ chapter.image.image.url }}"
                alt="{{ chapter.image.title|default:'ì±•í„° ì´ë¯¸ì§€' }}"
                loading="lazy"
                onerror="this.parentElement.style.display='none';">
            {% if chapter.image.title %}
            <div class="chapter-image-title">{{ chapter.image.title }}</div>
            {% endif %}
        </div>
        {% endif %}

        <!-- ì±•í„° ì œëª© -->
        <h2 class="chapter-title">
            {{ chapter.title }}
            {% if chapter.hp_range %}
            <span class="hp-range">
                HP {{ chapter.hp_range.0 }}{% if chapter.hp_range.1 %} ~ {{ chapter.hp_range.1 }}{% endif %}
            </span>
            {% endif %}
        </h2>

        <!-- ëŒ€í™” ë‚´ìš© -->
        <div class="chapter-content">
            {% for msg in chapter.messages %}
            <div class="dialogue-block {% if msg.role == 'assistant' %}assistant{% else %}user{% endif %}" data-idx="{{ forloop.parentloop.counter0 }}-{{ forloop.counter0 }}">
                <p class="dialogue-text" data-role="{{ msg.role }}" data-speaker="{{ msg.speaker }}">
                    {% if msg.role == 'user' %}
                    <strong>{{ msg.speaker }}:</strong>
                    {% endif %}
                    <span class="content-text">{{ msg.content|safe }}</span>
                </p>

                {% if msg.audio %}
                <div class="audio-controls">
                    <button class="tts-btn" data-audio-id="audio-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                        <span class="btn-icon">&#9654;</span>
                        <span class="btn-text">ìŒì„± ë“£ê¸°</span>
                    </button>
                    <audio id="audio-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" src="{{ msg.audio }}" preload="none" class="seq-audio"></audio>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

    </section>
    {% empty %}
    <div class="no-chapters">
        <p>ì•„ì§ ì´ì•¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìºë¦­í„°ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.</p>
    </div>
    {% endfor %}

    <!-- ë§ˆì§€ë§‰ ë§ (HP 100 ë‹¬ì„± ì‹œ) -->
    {% if last_wards %}
    <section class="last-wards-section">
        <div class="last-wards-divider">
            <span class="divider-text">â€” HP 100 ë‹¬ì„± â€”</span>
        </div>

        {% for ward in last_wards %}
        <div class="last-ward-card">
            {% if ward.image %}
            <div class="last-ward-image">
                <img src="{{ ward.image.url }}" alt="ë§ˆì§€ë§‰ ì¥ë©´" loading="lazy">
                <div class="last-ward-overlay">
                    {% if ward.ward %}
                    <div class="last-ward-quote">
                        <div class="quote-mark">"</div>
                        <p class="ward-text">{{ ward.ward }}</p>
                        <div class="quote-mark closing">"</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if ward.description %}
            <div class="last-ward-description">
                <p>{{ ward.description|safe }}</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </section>
    {% endif %}

    <!-- ì—í•„ë¡œê·¸ -->
    {% if novel.epilogue %}
    <footer class="novel-epilogue">
        {{ novel.epilogue|safe }}
    </footer>
    {% endif %}

    <!-- ê³µìœ  ì„¤ì • (ë³¸ì¸ë§Œ) -->
    {% if conversation.user == request.user %}
    <form method="POST" action="">
        {% csrf_token %}
        <div class="share-consent-box">
            <button type="submit"
                    name="share_choice"
                    value="{% if conversation.is_public %}off{% else %}on{% endif %}"
                    class="share-btn">
                <span class="share-text {% if conversation.is_public %}share-off{% else %}share-on{% endif %}">
                    {% if conversation.is_public %}ê³µê°œ ì·¨ì†Œ{% else %}ì´ì•¼ê¸° ê³µìœ í•˜ê¸°{% endif %}
                </span>
            </button>
            <p class="share-note">
                {% if conversation.is_public %}
                í˜„ì¬ ì´ ì´ì•¼ê¸°ëŠ” ê³µê°œë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                {% else %}
                ì´ ì´ì•¼ê¸°ë¥¼ ê³µìœ í•˜ë©´ ë‹¤ë¥¸ ì‚¬ëŒë“¤ë„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                {% endif %}
            </p>
        </div>
    </form>

    <!-- ìƒì„±ëœ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
    {% if conversation.merged_audio %}
    <div id="merged-audio-card">
        <div class="mac-title-row">
            <div class="mac-icon">ğŸ™</div>
            <div class="mac-title-text">
                <div class="mac-label">ëŒ€í™” ì˜¤ë””ì˜¤</div>
                <div class="mac-name" id="mac-title-name">{{ conversation.merged_audio_title }}</div>
            </div>
        </div>

        <div class="mac-progress-wrap" id="mac-progress-wrap">
            <div class="mac-progress-track">
                <div class="mac-progress-fill" id="mac-fill"></div>
            </div>
            <div class="mac-time-row">
                <span id="mac-cur">0:00</span>
                <span id="mac-dur">--:--</span>
            </div>
        </div>

        <div class="mac-controls">
            <button class="mac-btn-skip" id="mac-back">&#9664;&#9664;</button>
            <button class="mac-btn-play" id="mac-play">&#9654;</button>
            <button class="mac-btn-skip" id="mac-fwd">&#9654;&#9654;</button>
        </div>

        <audio id="mac-audio" src="{{ conversation.merged_audio.url }}" preload="metadata"></audio>
    </div>
    {% endif %}

    <!-- ì˜¤ë””ì˜¤ ë³€í™˜ ë²„íŠ¼ -->
    <button id="export-ep-btn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2a3 3 0 0 1 3 3v7a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v3M8 22h8"/>
        </svg>
        ëŒ€í™” ì˜¤ë””ì˜¤ë¡œ ë³€í™˜
    </button>
    {% endif %}

</div>

<!-- ìˆœì°¨ ì¬ìƒ í”Œë¡œíŒ… ë°” -->
<div id="seq-player-bar">
    <button id="seq-play-btn">&#9654;</button>
    <div id="seq-progress-wrap">
        <div id="seq-label">ì¬ìƒ ì¤€ë¹„ ì¤‘...</div>
        <div id="seq-progress"><div id="seq-progress-fill"></div></div>
    </div>
    <button id="seq-stop-btn">&#10005;</button>
</div>

<!-- ì˜¤ë””ì˜¤ ë³€í™˜ ëª¨ë‹¬ -->
<div id="export-modal-overlay">
    <div id="export-modal">
        <h3>ëŒ€í™” ì˜¤ë””ì˜¤ë¡œ ë³€í™˜</h3>

        <div class="export-field">
            <label>ì˜¤ë””ì˜¤ ì œëª©</label>
            <input type="text" id="ep-title" placeholder="ì˜¤ë””ì˜¤ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                   value="{{ llm.name }}ì™€ì˜ ì´ì•¼ê¸°">
        </div>

        <div class="export-field">
            <label>ë°°ê²½ìŒì•… (ì„ íƒ)</label>
            <select id="ep-bgm">
                <option value="">â”€â”€ ë°°ê²½ìŒ ì—†ìŒ â”€â”€</option>
                {% for bgm in bgm_list %}
                <option value="{{ bgm.id }}">{{ bgm.music_name }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="export-status" class="export-status" style="display:none;"></div>

        <div class="export-modal-btns">
            <button id="export-cancel-btn">ì·¨ì†Œ</button>
            <button id="export-confirm-btn">ë³€í™˜ ì‹œì‘</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // â”€â”€ ë‚˜ë ˆì´ì…˜/ëŒ€ì‚¬ í¬ë§·íŒ… â”€â”€
    document.querySelectorAll('.dialogue-block.assistant .content-text').forEach(el => {
        let html = el.innerHTML;
        html = html.replace(/"([^"]+)"/g, '<q>$1</q>');
        html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
        html = html.replace(/\[([^\]]+)\]/g, '<span style="color:#a78bfa;font-size:0.85em;">[$1]</span>');
        el.innerHTML = html;
    });

    // â”€â”€ ê°œë³„ TTS ë²„íŠ¼ â”€â”€
    let currentAudio = null;
    let currentBtn = null;

    document.querySelectorAll('.tts-btn').forEach(button => {
        button.addEventListener('click', function() {
            const audioId = this.getAttribute('data-audio-id');
            const audio = document.getElementById(audioId);
            const btnText = this.querySelector('.btn-text');
            const btnIcon = this.querySelector('.btn-icon');
            if (!audio) return;

            if (currentAudio && currentAudio !== audio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                if (currentBtn) {
                    currentBtn.classList.remove('playing');
                    currentBtn.querySelector('.btn-text').textContent = 'ìŒì„± ë“£ê¸°';
                    currentBtn.querySelector('.btn-icon').innerHTML = '&#9654;';
                }
            }
            if (audio.paused) {
                audio.play();
                this.classList.add('playing');
                btnText.textContent = 'ì¼ì‹œì •ì§€';
                btnIcon.innerHTML = '&#10074;&#10074;';
                currentAudio = audio;
                currentBtn = this;
            } else {
                audio.pause();
                this.classList.remove('playing');
                btnText.textContent = 'ìŒì„± ë“£ê¸°';
                btnIcon.innerHTML = '&#9654;';
                currentAudio = null;
                currentBtn = null;
            }
        });
    });

    document.querySelectorAll('audio').forEach(audio => {
        audio.addEventListener('ended', function() {
            const btn = document.querySelector(`[data-audio-id="${audio.id}"]`);
            if (btn) {
                btn.classList.remove('playing');
                btn.querySelector('.btn-text').textContent = 'ìŒì„± ë“£ê¸°';
                btn.querySelector('.btn-icon').innerHTML = '&#9654;';
            }
            currentAudio = null;
            currentBtn = null;
        });
    });

    // â”€â”€ ìˆœì°¨ ì¬ìƒ â”€â”€
    const seqAudios = Array.from(document.querySelectorAll('audio.seq-audio'));
    const seqBar    = document.getElementById('seq-player-bar');
    const seqPlayBtn = document.getElementById('seq-play-btn');
    const seqStopBtn = document.getElementById('seq-stop-btn');
    const seqLabel  = document.getElementById('seq-label');
    const seqFill   = document.getElementById('seq-progress-fill');
    const startSeqBtn = document.getElementById('start-seq-btn');

    let seqIdx = 0;
    let seqPlaying = false;
    let seqPaused = false;

    function getBlockByAudio(audio) {
        return audio.closest('.dialogue-block');
    }

    function clearHighlight() {
        document.querySelectorAll('.dialogue-block.seq-playing').forEach(b => b.classList.remove('seq-playing'));
    }

    function updateProgress(audio) {
        if (!audio.duration) return;
        const pct = (audio.currentTime / audio.duration) * 100;
        seqFill.style.width = pct + '%';
    }

    function playSeqAt(idx) {
        if (idx >= seqAudios.length) {
            stopSeq();
            return;
        }
        clearHighlight();
        seqIdx = idx;
        const audio = seqAudios[idx];
        const block = getBlockByAudio(audio);
        if (block) {
            block.classList.add('seq-playing');
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const textEl = block.querySelector('.content-text');
            seqLabel.textContent = textEl ? textEl.textContent.slice(0, 40) : `${idx + 1} / ${seqAudios.length}`;
        }
        seqFill.style.width = '0%';
        audio.currentTime = 0;
        audio.play().catch(() => playSeqAt(idx + 1));
    }

    function stopSeq() {
        seqPlaying = false;
        seqPaused = false;
        clearHighlight();
        seqBar.classList.remove('active');
        seqPlayBtn.innerHTML = '&#9654;';
        seqLabel.textContent = 'ì¬ìƒ ì¤€ë¹„ ì¤‘...';
        seqFill.style.width = '0%';
        seqAudios.forEach(a => { a.pause(); a.currentTime = 0; });
        seqIdx = 0;
    }

    seqAudios.forEach((audio, idx) => {
        audio.addEventListener('timeupdate', () => { if (seqIdx === idx) updateProgress(audio); });
        audio.addEventListener('ended', () => {
            if (seqPlaying && !seqPaused) playSeqAt(idx + 1);
        });
    });

    if (startSeqBtn) {
        startSeqBtn.addEventListener('click', function() {
            if (seqAudios.length === 0) return;
            seqPlaying = true;
            seqPaused = false;
            seqBar.classList.add('active');
            seqPlayBtn.innerHTML = '&#10074;&#10074;';
            playSeqAt(0);
        });
    }

    seqPlayBtn.addEventListener('click', function() {
        if (!seqPlaying) return;
        const audio = seqAudios[seqIdx];
        if (!audio) return;
        if (seqPaused) {
            seqPaused = false;
            audio.play();
            seqPlayBtn.innerHTML = '&#10074;&#10074;';
        } else {
            seqPaused = true;
            audio.pause();
            seqPlayBtn.innerHTML = '&#9654;';
        }
    });

    seqStopBtn.addEventListener('click', stopSeq);

    // â”€â”€ ì—í”¼ì†Œë“œ ë³€í™˜ ëª¨ë‹¬ â”€â”€
    const exportBtn  = document.getElementById('export-ep-btn');
    const overlay    = document.getElementById('export-modal-overlay');
    const cancelBtn  = document.getElementById('export-cancel-btn');
    const confirmBtn = document.getElementById('export-confirm-btn');
    const statusDiv  = document.getElementById('export-status');

    if (exportBtn) {
        exportBtn.addEventListener('click', () => overlay.classList.add('open'));
    }
    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            overlay.classList.remove('open');
            statusDiv.style.display = 'none';
            statusDiv.textContent = '';
            confirmBtn.disabled = false;
        });
    }
    overlay && overlay.addEventListener('click', e => {
        if (e.target === overlay) {
            overlay.classList.remove('open');
        }
    });

    // â”€â”€ ì»¤ìŠ¤í…€ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ â”€â”€
    (function() {
        const audio = document.getElementById('mac-audio');
        if (!audio) return;
        const playBtn = document.getElementById('mac-play');
        const fill    = document.getElementById('mac-fill');
        const curEl   = document.getElementById('mac-cur');
        const durEl   = document.getElementById('mac-dur');
        const wrap    = document.getElementById('mac-progress-wrap');
        const backBtn = document.getElementById('mac-back');
        const fwdBtn  = document.getElementById('mac-fwd');

        function fmt(s) {
            s = Math.max(0, Math.floor(s));
            return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
        }
        audio.addEventListener('loadedmetadata', () => { durEl.textContent = fmt(audio.duration); });
        audio.addEventListener('timeupdate', () => {
            if (!audio.duration) return;
            fill.style.width = (audio.currentTime / audio.duration * 100) + '%';
            curEl.textContent = fmt(audio.currentTime);
        });
        audio.addEventListener('ended', () => { playBtn.innerHTML = '&#9654;'; });

        playBtn.addEventListener('click', () => {
            if (audio.paused) { audio.play(); playBtn.innerHTML = '&#10074;&#10074;'; }
            else              { audio.pause(); playBtn.innerHTML = '&#9654;'; }
        });
        backBtn.addEventListener('click', () => { audio.currentTime = Math.max(0, audio.currentTime - 10); });
        fwdBtn.addEventListener('click',  () => { audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 10); });

        wrap.addEventListener('click', e => {
            const rect = wrap.getBoundingClientRect();
            const ratio = (e.clientX - rect.left) / rect.width;
            if (audio.duration) audio.currentTime = ratio * audio.duration;
        });
    })();

    // â”€â”€ ë³€í™˜ ì¤‘ í™”ë©´ ì´íƒˆ ì°¨ë‹¨ â”€â”€
    let converting = false;
    const leaveMsg = 'ì˜¤ë””ì˜¤ ë³€í™˜ ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë– ë‚˜ë©´ ë³€í™˜ì´ ì¤‘ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    window.addEventListener('beforeunload', e => {
        if (converting) { e.preventDefault(); e.returnValue = leaveMsg; }
    });

    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            const title = document.getElementById('ep-title').value.trim();
            const bgmId = document.getElementById('ep-bgm').value;

            if (!title) { alert('ì˜¤ë””ì˜¤ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            converting = true;
            confirmBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'ë³€í™˜ ì¤‘ì…ë‹ˆë‹¤... (ìˆ˜ì‹­ ì´ˆ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)';

            const form = new FormData();
            form.append('llm_uuid', '{{ llm.public_uuid }}');
            form.append('audio_title', title);
            form.append('bgm_id', bgmId);
            form.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "mypage:chat_to_episode" %}', {
                method: 'POST',
                body: form,
            })
            .then(r => r.json())
            .then(data => {
                converting = false;
                if (data.success) {
                    statusDiv.textContent = data.message;
                    statusDiv.style.color = '#86efac';

                    let card = document.getElementById('merged-audio-card');
                    if (!card) {
                        card = document.createElement('div');
                        card.id = 'merged-audio-card';
                        document.getElementById('export-ep-btn').before(card);
                    }
                    card.innerHTML = `
                        <div class="mac-title-row">
                            <div class="mac-icon">ğŸ™</div>
                            <div class="mac-title-text">
                                <div class="mac-label">ëŒ€í™” ì˜¤ë””ì˜¤</div>
                                <div class="mac-name">${data.audio_title}</div>
                            </div>
                        </div>
                        <div class="mac-progress-wrap" id="mac-progress-wrap">
                            <div class="mac-progress-track"><div class="mac-progress-fill" id="mac-fill"></div></div>
                            <div class="mac-time-row"><span id="mac-cur">0:00</span><span id="mac-dur">--:--</span></div>
                        </div>
                        <div class="mac-controls">
                            <button class="mac-btn-skip" id="mac-back">&#9664;&#9664;</button>
                            <button class="mac-btn-play" id="mac-play">&#9654;</button>
                            <button class="mac-btn-skip" id="mac-fwd">&#9654;&#9654;</button>
                        </div>
                        <audio id="mac-audio" src="${data.audio_url}" preload="metadata"></audio>`;
                    const a2=document.getElementById('mac-audio'),p2=document.getElementById('mac-play'),
                          f2=document.getElementById('mac-fill'),c2=document.getElementById('mac-cur'),
                          d2=document.getElementById('mac-dur'),w2=document.getElementById('mac-progress-wrap');
                    function fmt2(s){s=Math.max(0,Math.floor(s));return`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;}
                    a2.addEventListener('loadedmetadata',()=>{d2.textContent=fmt2(a2.duration);});
                    a2.addEventListener('timeupdate',()=>{if(!a2.duration)return;f2.style.width=(a2.currentTime/a2.duration*100)+'%';c2.textContent=fmt2(a2.currentTime);});
                    a2.addEventListener('ended',()=>{p2.innerHTML='&#9654;';});
                    p2.addEventListener('click',()=>{if(a2.paused){a2.play();p2.innerHTML='&#10074;&#10074;';}else{a2.pause();p2.innerHTML='&#9654;';}});
                    document.getElementById('mac-back').addEventListener('click',()=>{a2.currentTime=Math.max(0,a2.currentTime-10);});
                    document.getElementById('mac-fwd').addEventListener('click',()=>{a2.currentTime=Math.min(a2.duration||0,a2.currentTime+10);});
                    w2.addEventListener('click',e=>{const r=w2.getBoundingClientRect();if(a2.duration)a2.currentTime=(e.clientX-r.left)/r.width*a2.duration;});

                    overlay.classList.remove('open');
                } else {
                    statusDiv.textContent = 'ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    statusDiv.style.color = '#fca5a5';
                    confirmBtn.disabled = false;
                }
            })
            .catch(() => {
                converting = false;
                statusDiv.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                statusDiv.style.color = '#fca5a5';
                confirmBtn.disabled = false;
            });
        });
    }
});
</script>
{% endblock %}
