{% extends "base.html" %}
{% load static %}

{% block title %}VOXLIBER - ë§ˆì´í˜ì´ì§€{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mypage/my_profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-wrapper">
    <div class="profile-container">

        <!-- í”„ë¡œí•„ í¸ì§‘ í¼ -->
        <form method="post" enctype="multipart/form-data" class="profile-form" id="profileForm">
            {% csrf_token %}
            <input type="hidden" name="remove_avatar" id="removeAvatarInput" value="false" data-login-required>
            <input type="hidden" name="remove_cover" id="removeCoverInput" value="false" data-login-required>

            {% if messages %}
            <div class="message-container">
                {% for message in messages %}
                <div class="message {{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- í”„ë¡œí•„ í—¤ë” -->
            <div class="profile-header">
                <div class="profile-cover" id="coverImageArea" {% if user.cover_img %}style="background-image: url('{{ user.cover_img.url }}');"{% endif %}>
                    <div class="cover-gradient"></div>
                </div>
                <div class="profile-info">
                    <div class="avatar-section">
                        <div class="avatar-wrapper">
                            {% if user.user_img %}
                                <img src="{{ user.user_img.url }}" alt="í”„ë¡œí•„" class="avatar-img" id="avatarPreview" loading="lazy">
                            {% else %}
                                <img src="{% static 'img/default-avatar.png' %}" alt="í”„ë¡œí•„" class="avatar-img" id="avatarPreview" loading="lazy">
                            {% endif %}
                            <label class="avatar-edit" for="avatarInput">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                            </label>
                            <input type="file" name="user_img" id="avatarInput" accept="image/*" style="display: none;" data-login-required>
                        </div>
                    </div>
                    <div class="user-details">
                        <a href="{% url 'main:user_info' user.public_uuid %}" style="color: inherit; text-decoration: none; transition: color 0.2s;">
                            <h1 class="user-nickname">{{ user.nickname|default:"ë‹‰ë„¤ì„ ì—†ìŒ" }}</h1>
                        </a>
                        <div class="user-stats">
                            <div class="stat-item">
                                <span class="stat-value">{{ user.follow_count|default:0 }}</span>
                                <span class="stat-label">íŒ”ë¡œì›Œ</span>
                            </div>
                            <div class="stat-divider"></div>
                            <div class="stat-item">
                                <span class="stat-value">{{ books_count|default:0 }}</span>
                                <span class="stat-label">ì‘í’ˆ</span>
                            </div>
                            <div class="stat-divider"></div>
                            <div class="stat-item">
                                <span class="stat-value">{{ user.created_at|date:"Y.m.d" }}</span>
                                <span class="stat-label">ê°€ì…ì¼</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        ê¸°ë³¸ ì •ë³´
                    </h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ë‹‰ë„¤ì„ <span class="required">*</span></label>
                        <input type="text" name="nickname" id="nickname" class="form-input"
                               value="{{ user.nickname|default:'' }}" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" required data-login-required>
                        <span class="input-counter"><span id="nicknameCount">{{ user.nickname|length|default:0 }}</span>/20</span>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">ì´ë©”ì¼</label>
                        <input type="email" class="form-input readonly" value="{{ user.email }}" readonly disabled>
                        <span class="input-hint">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                            ì´ë©”ì¼ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤
                        </span>
                    </div>
                </div>
            </div>

            <!-- ê°œì¸ ì •ë³´ -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="8.5" cy="7" r="4"/>
                            <line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
                        </svg>
                        ê°œì¸ ì •ë³´
                    </h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ì„±ë³„</label>
                        <div class="gender-options">
                            <label class="gender-option">
                                <input type="radio" name="gender" value="M" {% if user.gender == 'M' %}checked{% endif %} disabled>
                                <span class="gender-box">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="10" cy="14" r="5"/><line x1="19" y1="5" x2="13.6" y2="10.4"/>
                                        <polyline points="19 5 19 11"/><polyline points="19 5 13 5"/>
                                    </svg>
                                    ë‚¨ì„±
                                </span>
                            </label>
                            <label class="gender-option">
                                <input type="radio" name="gender" value="F" {% if user.gender == 'F' %}checked{% endif %} disabled>
                                <span class="gender-box">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="8" r="5"/><line x1="12" y1="13" x2="12" y2="21"/><line x1="9" y1="18" x2="15" y2="18"/>
                                    </svg>
                                    ì—¬ì„±
                                </span>
                            </label>
                            <label class="gender-option">
                                <input type="radio" name="gender" value="O" {% if user.gender == 'O' %}checked{% endif %} disabled>
                                <span class="gender-box">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/>
                                    </svg>
                                    ê¸°íƒ€
                                </span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ìƒë…„ì›”ì¼</label>
                        <input type="date" name="birthdate" class="form-input" value="{{ user.birthdate|date:'Y-m-d'|default:'' }}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë‚˜ì´</label>
                        <input type="number" name="age" class="form-input" value="{{ user.age|default:'' }}" placeholder="ë‚˜ì´" min="0" max="150" readonly>
                    </div>
                </div>
            </div>

            <!-- ê³„ì • ì •ë³´ -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        ê³„ì • ì •ë³´
                    </h2>
                </div>
                <div class="account-info">
                    <div class="info-row">
                        <span class="info-label">ë¡œê·¸ì¸ ë°©ì‹</span>
                        <span class="info-value">
                            {% if user.oauth_provider %}
                                <span class="oauth-badge {{ user.oauth_provider }}">{{ user.oauth_provider|title }}</span>
                            {% else %}
                                <span class="oauth-badge email">ì´ë©”ì¼</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ê³„ì • ìƒíƒœ</span>
                        <span class="info-value">
                            <span class="status-badge {{ user.status }}">
                                {% if user.status == 'active' %}í™œì„±{% elif user.status == 'inactive' %}ë¹„í™œì„±{% else %}ì •ì§€{% endif %}
                            </span>
                        </span>
                    </div>
                    <a href="{% url 'register:logout' %}" class="nav-item" style="background-color: rgb(167, 60, 60, 0.5);">ë¡œê·¸ì•„ì›ƒ</a>
                </div>
            </div>

            <!-- ì €ì¥ ë²„íŠ¼ -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" data-login-required>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                    </svg>
                    ë³€ê²½ì‚¬í•­ ì €ì¥
                </button>
            </div>
        </form>
        <!-- /form ë -->

        <!-- =====================================================
             í™œë™ í†µê³„ ê·¸ë˜í”„ (form ë°–)
             ===================================================== -->
        <div class="form-section stats-section" style="margin-top: 32px;">
            <div class="section-header stats-header">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    ë‚˜ì˜ í™œë™ í†µê³„
                </h2>

                <!-- ì¼/ì›”/ì—°ë„ íƒ­ -->
                <div class="chart-period-tabs">
                    <button class="chart-tab active" data-period="daily">ì¼ë³„</button>
                    <button class="chart-tab" data-period="monthly">ì›”ë³„</button>
                    <button class="chart-tab" data-period="yearly">ì—°ë„ë³„</button>
                </div>
            </div>

            <!-- ê¸°ê°„ ì„¤ëª… í…ìŠ¤íŠ¸ -->
            <p id="chartPeriodLabel" class="chart-period-label">ìµœê·¼ 30ì¼</p>

            <!-- ìš”ì•½ ì¹´ë“œ -->
            <div class="stats-summary">
                <div class="summary-card tts-card">
                    <span class="summary-icon">ğŸ“</span>
                    <div class="summary-text">
                        <div class="summary-value" id="ttsSummaryValue">0</div>
                        <div class="summary-label" id="ttsSummaryLabel">TTS ìƒì„± (ë¶„)</div>
                    </div>
                </div>
                <div class="summary-card listening-card">
                    <span class="summary-icon">ğŸ§</span>
                    <div class="summary-text">
                        <div class="summary-value" id="listeningSummaryValue">0</div>
                        <div class="summary-label" id="listeningSummaryLabel">ì²­ì·¨ ì‹œê°„ (ë¶„)</div>
                    </div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ ê·¸ë¦¬ë“œ -->
            <div class="charts-grid">
                <!-- TTS ì°¨íŠ¸ -->
                <div class="chart-box">
                    <p id="ttsLabel" class="chart-label">ğŸ“ TTS ìƒì„± (ë¶„)</p>
                    <canvas id="ttsChart" height="180"></canvas>
                </div>
                <!-- ì²­ì·¨ ì°¨íŠ¸ -->
                <div class="chart-box">
                    <p id="listeningLabel" class="chart-label">ğŸ§ ì²­ì·¨ ì‹œê°„ (ë¶„)</p>
                    <canvas id="listeningChart" height="180"></canvas>
                </div>
            </div>
        </div>

        <!-- ğŸš¨ Danger Zone -->
        <div class="form-section danger-zone" style="margin-top: 90px;">
            <h2 class="danger-title">âš ï¸ ê³„ì • ì‚­ì œ</h2>
            <p class="danger-text">
                ê³„ì •ì„ íƒˆí‡´í•˜ë©´ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ê²Œ ë˜ë©°,<br>
                ê³„ì • ë³µêµ¬ë¥¼ ì›í•˜ì‹œë©´ <strong>ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜</strong>í•´ì£¼ì„¸ìš”.
            </p>
            <a href="{% url 'mypage:delete_account' %}" class="btn btn-danger-outline">íšŒì› íƒˆí‡´</a>
        </div>

    </div>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <h3>ì‘í’ˆ ì‚­ì œ</h3>
        </div>
        <div class="modal-body">
            <p>ì •ë§ <strong id="deleteBookName"></strong>ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p class="warning-text">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ëª¨ë“  ì—í”¼ì†Œë“œê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" id="cancelDelete">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-danger" id="confirmDelete">ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// =====================================================
// ê¸°ë³¸ ê¸°ëŠ¥
// =====================================================
document.getElementById('avatarInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) { alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.'); this.value = ''; return; }
        const reader = new FileReader();
        reader.onload = function(e) { document.getElementById('avatarPreview').src = e.target.result; };
        reader.readAsDataURL(file);
        document.getElementById('removeAvatarInput').value = 'false';
    }
});

document.getElementById('nickname').addEventListener('input', function() {
    const count = this.value.length;
    document.getElementById('nicknameCount').textContent = count;
    if (count > 20) { this.value = this.value.substring(0, 20); document.getElementById('nicknameCount').textContent = 20; }
});

document.getElementById('profileForm').addEventListener('submit', function(e) {
    const nickname = document.getElementById('nickname').value.trim();
    if (!nickname) { e.preventDefault(); alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); document.getElementById('nickname').focus(); return false; }
});

const deleteModal = document.getElementById('deleteModal');
const deleteBookName = document.getElementById('deleteBookName');
const confirmDeleteBtn = document.getElementById('confirmDelete');
const cancelDeleteBtn = document.getElementById('cancelDelete');
let bookIdToDelete = null;

document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', function() {
        bookIdToDelete = this.dataset.bookId;
        deleteBookName.textContent = this.dataset.bookName;
        deleteModal.classList.add('active');
    });
});
cancelDeleteBtn.addEventListener('click', function() { deleteModal.classList.remove('active'); bookIdToDelete = null; });
deleteModal.addEventListener('click', function(e) { if (e.target === deleteModal) { deleteModal.classList.remove('active'); bookIdToDelete = null; } });
confirmDeleteBtn.addEventListener('click', async function() {
    if (!bookIdToDelete) return;
    try {
        const response = await fetch(`/book/delete/${bookIdToDelete}/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
        if (response.ok) { showNotification('ì‘í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); setTimeout(() => window.location.reload(), 1000); }
        else showNotification('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    } catch (error) { showNotification('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error'); }
    deleteModal.classList.remove('active'); bookIdToDelete = null;
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; }
        }
    }
    return cookieValue;
}

function showNotification(message, type = 'info') {
    const n = document.createElement('div');
    n.style.cssText = `position:fixed;top:100px;right:20px;padding:16px 24px;
        background:${type==='success'?'rgba(16,185,129,0.9)':type==='error'?'rgba(239,68,68,0.9)':'rgba(99,102,241,0.9)'};
        color:white;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);z-index:10000;
        animation:slideInRight 0.3s ease;font-size:14px;font-weight:500;`;
    n.textContent = message;
    document.body.appendChild(n);
    setTimeout(() => { n.style.animation = 'slideOutRight 0.3s ease'; setTimeout(() => n.remove(), 300); }, 3000);
}

const animStyle = document.createElement('style');
animStyle.textContent = `
    @keyframes slideInRight { from { transform:translateX(400px); opacity:0; } to { transform:translateX(0); opacity:1; } }
    @keyframes slideOutRight { from { transform:translateX(0); opacity:1; } to { transform:translateX(400px); opacity:0; } }
`;
document.head.appendChild(animStyle);


// =====================================================
// í™œë™ í†µê³„ ì°¨íŠ¸ (ì¼/ì›”/ì—°ë„ íƒ­)
// =====================================================
const ALL_DATA = {{ chart_data|safe }};

const PERIOD_META = {
    daily:   { label: 'ìµœê·¼ 30ì¼',   ttsUnit: 'ë¶„',  listeningUnit: 'ë¶„' },
    monthly: { label: 'ìµœê·¼ 12ê°œì›”', ttsUnit: 'ë¶„',  listeningUnit: 'ì‹œê°„' },
    yearly:  { label: 'ì „ì²´ ì—°ë„ë³„', ttsUnit: 'ì‹œê°„', listeningUnit: 'ì‹œê°„' },
};

const scaleOpts = {
    x: { grid: { color: 'rgba(255,255,255,0.07)' }, ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45, minRotation: 0 } },
    y: { grid: { color: 'rgba(255,255,255,0.07)' }, ticks: { color: 'rgba(255,255,255,0.5)' }, beginAtZero: true }
};

// ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const ttsChart = new Chart(document.getElementById('ttsChart'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'TTS', data: [], backgroundColor: 'rgba(99,102,241,0.7)', borderRadius: 6 }] },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: scaleOpts, animation: { duration: 300 } }
});

const listeningChart = new Chart(document.getElementById('listeningChart'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'ì²­ì·¨', data: [], backgroundColor: 'rgba(139,92,246,0.7)', borderRadius: 6 }] },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: scaleOpts, animation: { duration: 300 } }
});

function updateCharts(period) {
    const d = ALL_DATA[period];
    const meta = PERIOD_META[period];

    // ìš”ì•½ í•©ê³„
    const ttsTotal = d.tts.data.length ? d.tts.data.reduce((a, b) => a + b, 0).toFixed(1) : '0';
    const listenTotal = d.listening.data.length ? d.listening.data.reduce((a, b) => a + b, 0).toFixed(1) : '0';
    document.getElementById('ttsSummaryValue').textContent = ttsTotal;
    document.getElementById('ttsSummaryLabel').textContent = `TTS ìƒì„± (${meta.ttsUnit})`;
    document.getElementById('listeningSummaryValue').textContent = listenTotal;
    document.getElementById('listeningSummaryLabel').textContent = `ì²­ì·¨ ì‹œê°„ (${meta.listeningUnit})`;

    // TTS ì°¨íŠ¸
    ttsChart.data.labels = d.tts.labels;
    ttsChart.data.datasets[0].data = d.tts.data;
    ttsChart.update();
    document.getElementById('ttsLabel').textContent = `ğŸ“ TTS ìƒì„± (${meta.ttsUnit})`;

    // ì²­ì·¨ ì°¨íŠ¸
    listeningChart.data.labels = d.listening.labels;
    listeningChart.data.datasets[0].data = d.listening.data;
    listeningChart.update();
    document.getElementById('listeningLabel').textContent = `ğŸ§ ì²­ì·¨ ì‹œê°„ (${meta.listeningUnit})`;

    // ê¸°ê°„ ì„¤ëª…
    document.getElementById('chartPeriodLabel').textContent = meta.label;
}

// íƒ­ í´ë¦­ ì´ë²¤íŠ¸
document.querySelectorAll('.chart-tab').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.chart-tab').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        updateCharts(this.dataset.period);
    });
});

// ì´ˆê¸° ë Œë” (ì¼ë³„)
updateCharts('daily');
</script>
{% endblock %}