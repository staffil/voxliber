{% extends "base.html" %}
{% load static %}

{% block title %}ë¶ ìŠ¤ë‹ˆí« ì‘ì„± | VoxLiber{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/snippet/snippet_form.css' %}">
<link rel="stylesheet" href="{% static 'css/snippet/snippet_detail.css' %}">

{% endblock %}

{% block content %}
<div class="snippet-card">
    <h2>{{ snippet|default_if_none:"ìƒˆ ìŠ¤ë‹ˆí« ì‘ì„±" }}</h2>
<form method="post" enctype="multipart/form-data" class="snippet-form">
        {% csrf_token %}
    <input type="hidden" name="action" value="submit_poem">

        <!-- í•œ ë¬¸ì¥ ì…ë ¥ -->
        <label for="sentence" class="form-label">í•œ ë¬¸ì¥</label>
        <textarea id="sentence" name="sentence" rows="3" required class="form-textarea">{{ snippet.sentence }}</textarea>
        <div class="form-group">
            <label for="voice" class="form-label">ğŸ¤ ë‚´ ë³´ì´ìŠ¤ ì„ íƒ</label>
            <select id="voice" name="voice" class="form-textarea">
                {% for voice in my_voice_list %}
                <option value="{{ voice.voice.voice_id }}">{{ voice.alias_name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- TTS ìƒì„± ë²„íŠ¼ -->
        <button type="button" id="generateTTSSnippetBtn" class="btn-tts">ğŸ§ TTS ìƒì„±í•˜ê¸°</button>

        <!-- TTS ë¯¸ë¦¬ë“£ê¸° -->
            <div id="audioSnippetPreviewBox" class="audio-preview-box" 
                style="{% if snippet.audio_file %}display: block;{% else %}display: none;{% endif %}">
                <div class="audio-preview-title">ğŸ¶ ìƒì„±ëœ TTS ë¯¸ë¦¬ë“£ê¸°</div>
                <audio id="snippetTTS" controls class="audio-control"
                    {% if snippet.audio_file %} src="{{ snippet.audio_file.url }}"{% endif %}></audio>
            </div>


        <!-- ì œì¶œ ë²„íŠ¼ -->
        <button type="submit" class="btn-submit">{{ snippet|yesno:"ìˆ˜ì •,ì‘ì„±" }}</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById("generateTTSSnippetBtn").addEventListener("click", async function () {

    const sentence = document.getElementById("sentence").value.trim();
const voiceId = document.getElementById("voice").value;

    if (!sentence) {
        alert("ìŠ¤ë‹ˆí« ë¬¸ì¥ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    this.disabled = true;
    this.innerText = "ğŸ”„ ìƒì„± ì¤‘...";

    try {
        const response = await fetch("/book/tts/generate/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
            },
            body: JSON.stringify({
                text: sentence,
                language_code: "ko",
                speed_value: "1.0",
                voice_id: voiceId, 
            })
        });

        if (!response.ok) {
            throw new Error("TTS ìƒì„± ì‹¤íŒ¨");
        }

        const blob = await response.blob();
        const audioUrl = URL.createObjectURL(blob);

        // ì˜¤ë””ì˜¤ ë¯¸ë¦¬ë“£ê¸° í™œì„±í™”
        const audioBox = document.getElementById("audioSnippetPreviewBox");
        document.getElementById("snippetTTS").src = audioUrl;
        audioBox.style.display = "block";

    } catch (err) {
        console.error(err);
        alert("TTS ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        this.disabled = false;
        this.innerText = "ğŸ§ TTS ìƒì„±í•˜ê¸°";
    }
});
</script>
{% endblock %}
