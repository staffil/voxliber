{% extends "base.html" %}
{% load static %}

{% block title %}ì‹œ ì‘ì„±í•˜ê¸° - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mypage/poem/poem_create.css' %}">
<style>
    .audio-preview-box {
        margin-top: 20px;
        padding: 15px;
        border-radius: 10px;
        background: #f5f5f5;
        display: none;
    }
    .audio-preview-title {
        font-weight: bold;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}

<div class="poem-write-container">

    <h2 class="page-title">âœ’ ë‚˜ë§Œì˜ ì‹œ ì‘ì„±í•˜ê¸°</h2>
    <p class="page-description">ë‹¹ì‹ ì˜ ê°ì„±ì„ ëª©ì†Œë¦¬ë¡œ ë“¤ë ¤ì£¼ì„¸ìš”</p>

    <form id="poemForm" action="" method="POST" class="poem-form" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Title -->
        <div class="form-group">
            <label for="title">ğŸ“Œ ì‹œ ì œëª©</label>
            <input type="text" id="title" name="title" class="form-input"
                   placeholder="ì˜ˆ) ë‹¬ë¹› ì•„ë˜ í”¼ì–´ë‚˜ëŠ” ê·¸ë¦¬ì›€" required>
        </div>

        <!-- Content -->
        <div class="form-group">
            <label for="content">ğŸ“ ì‹œ ë‚´ìš©</label>
            <textarea id="content" name="content" class="form-textarea"
                      placeholder="ë‹¹ì‹ ì˜ ì‹œë¥¼ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..." required></textarea>
        </div>

        <!-- Voice Select -->
        <div class="form-group">
            <label for="voice">ğŸ¤ ë‚´ ë³´ì´ìŠ¤ ì„ íƒ</label>

            <select id="voice" name="voice" class="voice-select">
                {% for voice in my_voice_list %}
                <option value="{{ voice.voice.voice_id }}">
                    {{ voice.alias_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Public setting -->
        <div class="form-group checkbox-group">
            <input type="checkbox" id="is_public" name="is_public" checked>
            <label for="is_public">ê³µê°œ ì„¤ì •</label>
        </div>

        <!-- Buttons -->
        <div class="button-group">

            <!-- ğŸ§ TTS ìƒì„±í•˜ê¸° -->
            <button type="button" id="generateTTSBtn" class="btn-tts">
                ğŸ§ TTS ìƒì„±í•˜ê¸°
            </button>

            <!-- âœ¨ ì‹œ ì œì¶œí•˜ê¸° -->
            <button type="submit" name="action" value="submit_poem" class="btn-submit">
                âœ¨ ì‹œ ì œì¶œí•˜ê¸°
            </button>
            <div class="form-group">
                <label for="cover_image">ğŸ–¼ ì‹œ ì»¤ë²„ ì´ë¯¸ì§€</label>
                <input type="file" id="cover_image" name="cover_image" accept="image/*" class="form-input">
            </div>
        </div>

    </form>

    <!-- ì˜¤ë””ì˜¤ ë¯¸ë¦¬ë“£ê¸° -->
    <div id="audioPreviewBox" class="audio-preview-box">
        <div class="audio-preview-title">ğŸ¶ ìƒì„±ëœ TTS ë¯¸ë¦¬ë“£ê¸°</div>
        <audio id="ttsAudio" controls></audio>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById("generateTTSBtn").addEventListener("click", async function () {

    const content = document.getElementById("content").value.trim();
    const voiceId = document.getElementById("voice").value;

    if (!content) {
        alert("ì‹œ ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    this.disabled = true;
    this.innerText = "ğŸ”„ ìƒì„± ì¤‘...";

    try {
        const response = await fetch("/book/tts/generate/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
            },
            body: JSON.stringify({
                text: content,
                voice_id: voiceId,
                language_code: "ko",   // í•„ìš” ì‹œ ìˆ˜ì • ê°€ëŠ¥
                speed_value: "1.0"
            })
        });

        if (!response.ok) {
            throw new Error("TTS ìƒì„± ì‹¤íŒ¨");
        }

        const blob = await response.blob();
        const audioUrl = URL.createObjectURL(blob);

        // ì˜¤ë””ì˜¤ ë¯¸ë¦¬ë“£ê¸° í™œì„±í™”
        document.getElementById("ttsAudio").src = audioUrl;
        document.getElementById("audioPreviewBox").style.display = "block";

    } catch (err) {
        console.error(err);
        alert("TTS ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        this.disabled = false;
        this.innerText = "ğŸ§ TTS ìƒì„±í•˜ê¸°";
    }
});
</script>
{% endblock %}
