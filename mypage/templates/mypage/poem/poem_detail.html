{% extends "base.html" %}
{% load static %}

{% block title %}{{ poem.title }} | VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mypage/poem/poem_detail.css' %}">
<style>
    .edit-mode textarea {
        width: 100%;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
        min-height: 200px;
        font-size: 16px;
        line-height: 1.7;
    }

    .edit-btn-box {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }

    .edit-save {
        padding: 10px 16px;
        background: #4a73ff;
        color: #fff;
        border-radius: 8px;
    }

    .edit-cancel {
        padding: 10px 16px;
        background: #999;
        color: white;
        border-radius: 8px;
    }

    .poem-audio {
        margin-top: 20px;
        padding: 20px;
        border-radius: 12px;
        background: #f4f6fc;
    }
</style>
{% endblock %}

{% block content %}

<div class="poem-wrapper">

    <article class="poem-page">

        <!-- ì œëª© ì˜ì—­ -->
        <div class="poem-header">
            <h1 id="titleDisplay" class="poem-title">{{ poem.title }}</h1>
            <input id="titleInput" name="title" class="poem-title" type="text" 
                   value="{{ poem.title }}" style="display:none;">

            <div class="poem-meta">
                <span>ì‘ì„±ì¼ Â· {{ poem.created_at|date:"Y.m.d H:i" }}</span>
            </div>
        </div>

        <!-- ìˆ˜ì • í¼ -->
        <form id="editForm" method="POST" style="display:none;">
            {% csrf_token %}
            <textarea name="content">{{ poem.content }}</textarea>
            <input type="hidden" name="title" id="titleHidden">
        </form>

        <!-- ë³¸ë¬¸ -->
        <section id="contentDisplay" class="poem-content">
            {{ poem.content|linebreaks }}
        </section>

        <!-- íƒœê·¸ -->
        {% if poem.tags.exists %}
        <section class="poem-tags">
            {% for tag in poem.tags.all %}
            <span class="tag">#{{ tag.name }}</span>
            {% endfor %}
        </section>
        {% endif %}

        <!-- ğŸ”Š ì €ì¥ëœ ì˜¤ë””ì˜¤ í•­ìƒ í‘œì‹œ -->
        {% if poem.poem_audio %}
        <div class="poem-audio">
            <h3>ğŸ§ ìƒì„±ëœ ì˜¤ë””ì˜¤</h3>
            <audio controls src="{{ poem.poem_audio.url }}"></audio>
        </div>
        {% endif %}

        <!-- ë²„íŠ¼ -->
        <div class="poem-btn-box" id="btnViewMode">
            <a href="{% url 'mypage:poem_list' %}" class="poem-btn back">â† ëª©ë¡ìœ¼ë¡œ</a>
            <button class="poem-btn edit" id="editBtn" type="button">ìˆ˜ì •í•˜ê¸°</button>
            <a href="{% url 'mypage:poem_delete' poem.pk %}"
               class="poem-btn delete"
               onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</a>
        </div>

        <!-- ìˆ˜ì • ë²„íŠ¼ -->
        <div class="edit-btn-box" id="btnEditMode" style="display:none;">
            <button class="edit-save" type="submit" form="editForm">ì €ì¥í•˜ê¸°</button>
            <button class="edit-cancel" type="button" id="cancelBtn">ì·¨ì†Œ</button>
        </div>

    </article>

</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const editBtn = document.getElementById("editBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    const contentDisplay = document.getElementById("contentDisplay");
    const editForm = document.getElementById("editForm");

    const btnViewMode = document.getElementById("btnViewMode");
    const btnEditMode = document.getElementById("btnEditMode");

    const titleDisplay = document.getElementById("titleDisplay");
    const titleInput = document.getElementById("titleInput");
    const titleHidden = document.getElementById("titleHidden");

    // ìˆ˜ì • ëª¨ë“œ ON
    editBtn.addEventListener("click", () => {
        contentDisplay.style.display = "none";
        editForm.style.display = "block";

        titleDisplay.style.display = "none";
        titleInput.style.display = "block";

        btnViewMode.style.display = "none";
        btnEditMode.style.display = "flex";
    });

    // ì·¨ì†Œ â†’ ë³´ê¸° ëª¨ë“œ
    cancelBtn.addEventListener("click", () => {
        contentDisplay.style.display = "block";
        editForm.style.display = "none";

        titleDisplay.style.display = "block";
        titleInput.style.display = "none";

        btnViewMode.style.display = "flex";
        btnEditMode.style.display = "none";
    });

    // ì œëª© ì €ì¥ìš© hidden input ë™ê¸°í™”
    document.querySelector("form#editForm").addEventListener("submit", function() {
        titleHidden.value = titleInput.value;
    });
});
</script>
{% endblock %}
