{% extends "base.html" %}
{% load static %}

{% block title %}ë‚´ ë³´ì´ìŠ¤ ëª©ë¡ | VoxLiber{% endblock %}

{% block content %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/voice/my_voice.css' %}">
{% endblock %}

<!-- í˜ì´ì§€ í—¤ë” -->
<div class="page-header">
    <h1 class="page-title">ğŸ’¾ ë‚´ ë³´ì´ìŠ¤ ì»¬ë ‰ì…˜</h1>
    <p class="page-subtitle">ì €ì¥í•œ ë³´ì´ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê³  ì‘í’ˆë³„ë¡œ ì„¤ì •í•˜ì„¸ìš”</p>
</div>

<div class="myvoice-container">
    {% if my_voices %}
    <div class="myvoice-grid">
        {% for item in my_voices %}
        <div class="myvoice-card">
            <!-- ì¹´ë“œ í—¤ë” (ì´ë¯¸ì§€ + ì¦ê²¨ì°¾ê¸°) -->
            <div class="card-header">
                <form method="POST" action="{% url 'mypage:toggle_myvoice_favorite' item.id %}">
                    {% csrf_token %}
                    <button class="favorite-btn" type="submit">
                        {% if item.is_favorite %}â­{% else %}â˜†{% endif %}
                    </button>
                </form>

                {% if item.voice.voice_image %}
                <img src="{{ item.voice.voice_image.url }}" class="myvoice-img" alt="{{ item.alias_name }}" loading="lazy">
                {% else %}
                <img src="{% static 'default_voice.png' %}" class="myvoice-img" alt="{{ item.alias_name }}" loading="lazy">
                {% endif %}
            </div>

            <!-- ë³´ì´ìŠ¤ ì •ë³´ -->
            <div class="voice-info">
                <div class="myvoice-name">{{ item.alias_name }}</div>
                <div class="myvoice-alias">{{ item.voice.voice_name }}</div>
            </div>

            <!-- íƒ€ì… ë°°ì§€ -->
            {% if item.voice.types.all %}
            <div class="voice-types">
                {% for type in item.voice.types.all %}
                <span class="type-badge">{{ type.name }}</span>
                {% endfor %}
            </div>
            {% endif %}

            <!-- ì±… ì„ íƒ -->
            <div class="book-select-wrapper">
                <label class="book-select-label">ğŸ“š ì ìš©í•  ì‘í’ˆ</label>
                <form method="POST" action="{% url 'mypage:select_book' item.id %}">
                    {% csrf_token %}
                    <select name="book_id" onchange="this.form.submit()" class="book-select">
                        <option value="">ì „ì²´ ì‘í’ˆ</option>
                        {% for book in books %}
                        <option value="{{ book.id }}" {% if item.book and book.id == item.book.id %}selected{% endif %}>
                            {{ book.name }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>

            <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
            {% if item.voice.sample_audio %}
            <div class="audio-player">
                <button onclick="togglePlay(this)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </button>
                <div class="progress-bar">
                    <div class="progress"></div>
                </div>
                <span class="time">0:00 / 0:00</span>
                <audio src="{{ item.voice.sample_audio.url }}" loading="lazy"></audio>
            </div>
            {% endif %}

            <!-- ì‚­ì œ ë²„íŠ¼ -->
            <form method="POST" action="{% url 'mypage:delete_my_voice' item.id %}">
                {% csrf_token %}
                <button type="submit" class="delete-btn" onclick="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ğŸ—‘ï¸ ì‚­ì œí•˜ê¸°</button>
            </form>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <div class="myvoice-grid">
        <div class="no-myvoice">
            <div class="no-myvoice-icon">ğŸ™ï¸</div>
            <h2 class="no-myvoice-title">ì €ì¥ëœ ë³´ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</h2>
            <p class="no-myvoice-text">ë³´ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ë§ˆìŒì— ë“œëŠ” ëª©ì†Œë¦¬ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”</p>
            <a href="{% url 'voice:voice_list' %}" class="add-voice-btn">
                â• ë³´ì´ìŠ¤ ì¶”ê°€í•˜ê¸°
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
function togglePlay(btn) {
    const player = btn.parentElement.querySelector('audio');
    const allPlayers = document.querySelectorAll('.audio-player audio');
    const allButtons = document.querySelectorAll('.audio-player button');

    // ë‹¤ë¥¸ í”Œë ˆì´ì–´ ëª¨ë‘ ì •ì§€
    allPlayers.forEach((p, idx) => {
        if (p !== player && !p.paused) {
            p.pause();
            allButtons[idx].innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
        }
    });

    // í˜„ì¬ í”Œë ˆì´ì–´ í† ê¸€
    if (player.paused) {
        player.play();
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>';
    } else {
        player.pause();
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
    }

    // ì§„í–‰ë¥  ë° ì‹œê°„ ì—…ë°ì´íŠ¸
    player.ontimeupdate = function() {
        const progress = btn.parentElement.querySelector('.progress');
        const percentage = (player.currentTime / player.duration * 100) || 0;
        progress.style.width = percentage + '%';

        const time = btn.parentElement.querySelector('.time');
        const current = formatTime(player.currentTime);
        const total = formatTime(player.duration);
        time.textContent = `${current} / ${total}`;
    };

    // ì¬ìƒ ì¢…ë£Œ ì‹œ
    player.onended = function() {
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
        const progress = btn.parentElement.querySelector('.progress');
        progress.style.width = '0%';
    };
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}
</script>

{% endblock %}
