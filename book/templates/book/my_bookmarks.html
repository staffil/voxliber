{% extends "base.html" %}
{% load static %}

{% block title %}ë‚´ ë¶ë§ˆí¬ - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/my_books.css' %}">

{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 120px auto 40px; padding: 0 20px;">
    <div style="margin-bottom: 32px;">
        <h1 class="page-title" style="font-size: 32px; font-weight: 700; margin-bottom: 8px; color: #fff;">ğŸ“š ë‚´ ë¶ë§ˆí¬</h1>
        <p class="page-subtitle" style="color: rgba(255, 255, 255, 0.6);">ë‚˜ì¤‘ì— ì½ê³  ì‹¶ì€ ì±…ê³¼ AI ìŠ¤í† ë¦¬ë¥¼ ëª¨ì•„ë³´ì„¸ìš”</p>
    </div>

    <!-- AI ìŠ¤í† ë¦¬ ë¶ë§ˆí¬ ì„¹ì…˜ -->
    {% if story_bookmarks %}
    <div style="margin-bottom: 48px;">
        <h2 style="font-size: 20px; font-weight: 700; color: #434343; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
            AI ìŠ¤í† ë¦¬ ë¶ë§ˆí¬
            <span style="padding: 4px 12px; background: rgba(99, 102, 241, 0.15); border-radius: 20px; font-size: 14px; color: #a78bfa;">{{ story_bookmarks|length }}</span>
        </h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
            {% for sb in story_bookmarks %}
            <a href="{% url 'character:story_intro' sb.story.public_uuid %}" class="bookmark-item" style="flex-direction: column; padding: 0; overflow: hidden; text-decoration: none; display: block;" data-login-required>
                <div style="position: relative; width: 100%; height: 280px; overflow: hidden;">
                    <!-- ì»¤ë²„ ì´ë¯¸ì§€ -->
                    {% if sb.story.cover_image %}
                        <img src="{{ sb.story.cover_image.url }}" alt="{{ sb.story.title }}" style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                        <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 64px;">
                            
                        </div>
                    {% endif %}

                    <!-- ê·¸ë¼ë°ì´ì…˜ ì˜¤ë²„ë ˆì´ -->
                    <div style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 40%, transparent 70%);"></div>

                    <!-- ë¶ë§ˆí¬ ë²„íŠ¼ -->
                    <button onclick="event.preventDefault(); event.stopPropagation(); removeStoryBookmark('{{ sb.story.public_uuid }}')"
                            style="position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.6); border: none; color: #fbbf24; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 2;" data-login-required>
                        <i class="fas fa-bookmark"></i>
                    </button>

                    <!-- ì½˜í…ì¸  ì˜¤ë²„ë ˆì´ -->
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 16px; z-index: 1;">
                        <h3 style="font-size: 16px; font-weight: 700; color: #fff; margin: 0 0 6px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ sb.story.title }}</h3>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin: 0 0 10px 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4;">
                            {{ sb.story.description|truncatewords:12|default:"" }}
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                            <span style="font-size: 11px; color: #a78bfa; font-weight: 600;">ğŸ‘¥ {{ sb.story.characters.count }}ëª…</span>
                            {% for genre in sb.story.genres.all|slice:":2" %}
                            <span style="padding: 2px 8px; background: rgba(99, 102, 241, 0.3); border-radius: 10px; font-size: 10px; color: #c4b5fd;">{{ genre.name }}</span>
                            {% endfor %}
                        </div>
                        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.5);">
                            ì €ì¥ì¼: {{ sb.created_at|date:"Y.m.d" }}
                        </div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ì±… ë¶ë§ˆí¬ ì„¹ì…˜ -->
    {% if bookmarks %}
    <h2 style="font-size: 20px; font-weight: 700; color: #575757; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
        ì±… ë¶ë§ˆí¬
        <span style="padding: 4px 12px; background: rgba(99, 102, 241, 0.15); border-radius: 20px; font-size: 14px; color: #a78bfa;">{{ bookmarks.paginator.count }}</span>
    </h2>
        <div>
            {% for bookmark in bookmarks %}
            <div class="bookmark-item">
                <div class="bookmark-cover">
                    {% if bookmark.book.cover_img %}
                        <img src="{{ bookmark.book.cover_img.url }}" alt="{{ bookmark.book.name }}">
                    {% else %}
                        <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; color: white;">
                            {{ bookmark.book.name|slice:":2" }}
                        </div>
                    {% endif %}
                </div>

                <div class="bookmark-info">
                    <h3 class="bookmark-title">{{ bookmark.book.name }}</h3>
                    <div class="bookmark-author">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        {{ bookmark.book.user.nickname }}
                    </div>

                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 4px;">
                        {% for genre in bookmark.book.genres.all %}
                        <span style="padding: 3px 10px; background: rgba(99, 102, 241, 0.15); border-radius: 10px; font-size: 11px; color: #818cf8; font-weight: 500;">
                            {{ genre.name }}
                        </span>
                        {% endfor %}
                    </div>

                    {% if bookmark.note %}
                    <div class="bookmark-note">
                        <strong>ë©”ëª¨:</strong> {{ bookmark.note }}
                    </div>
                    {% endif %}
<!-- {% url 'book:book_detail' bookmark.book.public_uuid %} -->
                    <div class="bookmark-actions">
                        <a href="#" class="btn-primary" data-login-required   onclick="showAppInstallModal()">
                            ì±… ë³´ê¸°
                        </a>
                        <button onclick="removeBookmark({{ bookmark.book.public_uuid }})" class="btn-secondary" data-login-required>
                            ë¶ë§ˆí¬ ì œê±°
                        </button>
                    </div>

                    <div style="margin-top: 12px; font-size: 12px; color: rgba(255, 255, 255, 0.4);">
                        ì €ì¥ì¼: {{ bookmark.created_at|date:"Yë…„ mì›” dì¼" }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        {% if bookmarks.has_other_pages %}
        <div style="display: flex; justify-content: center; gap: 8px; margin-top: 32px;">
            {% if bookmarks.has_previous %}
                <a href="?page={{ bookmarks.previous_page_number }}" style="padding: 8px 16px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; color: white; text-decoration: none;" data-login-required>ì´ì „</a>
            {% endif %}

            <span style="padding: 8px 16px; color: rgba(255, 255, 255, 0.6);">
                {{ bookmarks.number }} / {{ bookmarks.paginator.num_pages }}
            </span>

            {% if bookmarks.has_next %}
                <a href="?page={{ bookmarks.next_page_number }}" style="padding: 8px 16px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; color: white; text-decoration: none;" data-login-required>ë‹¤ìŒ</a>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        {% if not story_bookmarks %}
        <div class="empty-state">
            <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
            <h2 style="font-size: 24px; margin-bottom: 12px;">ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤</h2>
            <p style="margin-bottom: 24px;">ë‚˜ì¤‘ì— ì½ê³  ì‹¶ì€ ì±…ì´ë‚˜ AI ìŠ¤í† ë¦¬ë¥¼ ë¶ë§ˆí¬í•´ë³´ì„¸ìš”!</p>
            <a href="{% url 'main:main' %}" style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; text-decoration: none; font-weight: 600;" data-login-required>
                ë‘˜ëŸ¬ë³´ê¸°
            </a>
        </div>
        {% endif %}
    {% endif %}
</div>

<script>
async function removeBookmark(bookId) {
    if (!confirm('ë¶ë§ˆí¬ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    try {
        const response = await fetch(`/book/bookmark/${bookId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        });

        if (response.ok) {
            alert('ë¶ë§ˆí¬ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
            location.reload();
        } else {
            throw new Error('ë¶ë§ˆí¬ ì œê±° ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('ë¶ë§ˆí¬ ì œê±° ì‹¤íŒ¨:', error);
        alert('ë¶ë§ˆí¬ ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
}

async function removeStoryBookmark(storyUuid) {
    if (!confirm('AI ìŠ¤í† ë¦¬ ë¶ë§ˆí¬ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    try {
        const response = await fetch(`/character/story/${storyUuid}/bookmark/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        });

        if (response.ok) {
            alert('ë¶ë§ˆí¬ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
            location.reload();
        } else {
            throw new Error('ë¶ë§ˆí¬ ì œê±° ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('ë¶ë§ˆí¬ ì œê±° ì‹¤íŒ¨:', error);
        alert('ë¶ë§ˆí¬ ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


</script>
{% endblock %}
