{% extends "base.html" %}
{% load static %}

{% block title %}VOXLIBER - ì†Œì„¤ ì œëª©{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/book_profile.css' %}">

<style>
/* ============================================================
   ì €ì¥ í›„ ì§‘í•„ ì‹œì‘ ë²„íŠ¼
   ============================================================ */
#open-mode-modal-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  padding: 17px 32px;
  margin-top: 28px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: #fff;
  font-family: 'Poppins', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  letter-spacing: -.01em;
  border: none;
  border-radius: 14px;
  cursor: pointer;
  box-shadow: 0 8px 28px rgba(99,102,241,.38);
  transition: transform .22s, box-shadow .22s, opacity .2s;
  position: relative;
  overflow: hidden;
}

/* ê´‘íƒ ë ˆì´ì–´ */
#open-mode-modal-btn::before {
  content: '';
  position: absolute;
  top: 0; left: -75%;
  width: 50%; height: 100%;
  background: linear-gradient(120deg, transparent, rgba(255,255,255,.18), transparent);
  transform: skewX(-20deg);
  transition: left .5s;
}
#open-mode-modal-btn:hover::before { left: 130%; }

#open-mode-modal-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 14px 36px rgba(99,102,241,.52);
}
#open-mode-modal-btn:active {
  transform: translateY(-1px);
  box-shadow: 0 6px 18px rgba(99,102,241,.38);
}

/* ë¼ì´íŠ¸ ëª¨ë“œ */
body.light-mode #open-mode-modal-btn {
  box-shadow: 0 8px 24px rgba(99,102,241,.28);
}

/* ============================================================
   ëª¨ë“œ ì„ íƒ ëª¨ë‹¬
   ============================================================ */
.mode-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.72);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s;
}
.mode-modal-overlay.open {
  opacity: 1;
  pointer-events: all;
}

.mode-modal {
  background: var(--bg-secondary, #1a1a2e);
  border: 1px solid rgba(255,255,255,.09);
  border-radius: 24px;
  padding: 40px 36px 36px;
  width: 100%;
  max-width: 600px;
  transform: translateY(18px) scale(.97);
  transition: transform .28s cubic-bezier(.34,1.56,.64,1);
  box-shadow: 0 32px 80px rgba(0,0,0,.55);
}
body.light-mode .mode-modal {
  background: #fff;
  border-color: rgba(0,0,0,.07);
  box-shadow: 0 24px 60px rgba(0,0,0,.14);
}
.mode-modal-overlay.open .mode-modal {
  transform: translateY(0) scale(1);
}

.mode-modal-title {
  font-size: 1.25rem;
  font-weight: 900;
  letter-spacing: -.03em;
  color: var(--text-primary, #fff);
  margin-bottom: 6px;
}
body.light-mode .mode-modal-title { color: #0f172a; }

.mode-modal-sub {
  font-size: .82rem;
  font-weight: 300;
  color: rgba(255,255,255,.42);
  margin-bottom: 28px;
  line-height: 1.6;
}
body.light-mode .mode-modal-sub { color: #64748b; }

/* â”€â”€ ì¹´ë“œ ê·¸ë¦¬ë“œ ê¸°ë³¸: 3ì—´ â”€â”€ */
.mode-cards {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
}

/* â”€â”€ 1200px ì´í•˜: ì „ë¬¸ê°€ ëª¨ë“œ ìˆ¨ê¹€ + 2ì—´ë¡œ ì „í™˜ â”€â”€ */
@media (max-width: 1200px) {
  .mode-card.expert {
    display: none;
  }
  .mode-cards {
    grid-template-columns: 1fr 1fr;
  }
}

/* â”€â”€ 560px ì´í•˜: 1ì—´ â”€â”€ */
@media (max-width: 560px) {
  .mode-modal { padding: 28px 20px 24px; }
  .mode-cards { grid-template-columns: 1fr; }
}

.mode-card {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 10px;
  padding: 20px 18px;
  border-radius: 16px;
  border: 1.5px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  cursor: pointer;
  text-decoration: none;
  transition: border-color .2s, background .2s, transform .2s;
  position: relative;
  overflow: hidden;
}
body.light-mode .mode-card {
  background: #f8f8ff;
  border-color: rgba(0,0,0,.07);
}
.mode-card:hover {
  transform: translateY(-3px);
}

/* ì´ˆë³´ì */
.mode-card.beginner { border-color: rgba(99,102,241,.22); }
.mode-card.beginner:hover { background: rgba(99,102,241,.08); border-color: rgba(99,102,241,.4); }

/* ì „ë¬¸ê°€ */
.mode-card.expert { border-color: rgba(245,158,11,.2); }
.mode-card.expert:hover { background: rgba(245,158,11,.07); border-color: rgba(245,158,11,.38); }

/* ë³´ì´ìŠ¤ */
.mode-card.voice { border-color: rgba(16,185,129,.2); }
.mode-card.voice:hover { background: rgba(16,185,129,.07); border-color: rgba(16,185,129,.38); }

.mode-card-icon {
  font-size: 1.7rem;
  line-height: 1;
}

.mode-card-label {
  font-size: .62rem;
  font-weight: 800;
  letter-spacing: .1em;
  text-transform: uppercase;
  padding: 3px 9px;
  border-radius: 99px;
}
.beginner .mode-card-label { background: rgba(99,102,241,.16); color: #a5b4fc; }
.expert   .mode-card-label { background: rgba(245,158,11,.16); color: #fbbf24; }
.voice    .mode-card-label { background: rgba(16,185,129,.16);  color: #6ee7b7; }
body.light-mode .beginner .mode-card-label { color: #6366f1; }
body.light-mode .expert   .mode-card-label { color: #d97706; }
body.light-mode .voice    .mode-card-label { color: #059669; }

.mode-card-name {
  font-size: .95rem;
  font-weight: 800;
  color: var(--text-primary, #fff);
  letter-spacing: -.02em;
  line-height: 1.2;
}
body.light-mode .mode-card-name { color: #0f172a; }

.mode-card-desc {
  font-size: .75rem;
  font-weight: 300;
  color: rgba(255,255,255,.4);
  line-height: 1.55;
}
body.light-mode .mode-card-desc { color: #64748b; }

.mode-card-arrow {
  margin-top: auto;
  font-size: .78rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 4px;
}
.beginner .mode-card-arrow { color: #818cf8; }
.expert   .mode-card-arrow { color: #fbbf24; }
.voice    .mode-card-arrow { color: #6ee7b7; }

/* ë³´ì´ìŠ¤ ì•ˆë‚´ */
.mode-voice-notice {
  display: flex;
  align-items: flex-start;
  gap: 9px;
  margin-top: 18px;
  padding: 13px 16px;
  background: rgba(16,185,129,.08);
  border: 1px solid rgba(16,185,129,.22);
  border-radius: 12px;
  font-size: .78rem;
  font-weight: 400;
  color: rgba(255,255,255,.55);
  line-height: 1.6;
}
body.light-mode .mode-voice-notice {
  background: rgba(16,185,129,.06);
  border-color: rgba(16,185,129,.2);
  color: #374151;
}
.mode-voice-notice svg { color: #6ee7b7; }
body.light-mode .mode-voice-notice svg { color: #059669; }
.mode-voice-notice strong {
  color: #6ee7b7;
  font-weight: 700;
}
body.light-mode .mode-voice-notice strong { color: #059669; }

/* ë‹«ê¸° */
.mode-modal-close {
  position: absolute;
  top: 16px; right: 18px;
  background: none;
  border: none;
  color: rgba(255,255,255,.28);
  font-size: 1.3rem;
  cursor: pointer;
  line-height: 1;
  padding: 4px;
  transition: color .18s;
}
.mode-modal-close:hover { color: rgba(255,255,255,.7); }
body.light-mode .mode-modal-close { color: rgba(0,0,0,.25); }
body.light-mode .mode-modal-close:hover { color: rgba(0,0,0,.6); }
</style>
{% endblock %}

{% block content %}
<div class="novel-title-wrapper" style="margin-top: 100px;">
    <div class="novel-title-container">
        {% if error %}
        <div class="error-msg">{{ error }}</div>
        {% endif %}

        <form action="" method="post" enctype="multipart/form-data" id="book_profile_form">
            {% csrf_token %}

            <!-- ì†Œì„¤ ì œëª© -->
            <div class="title-header">
                <input type="text" name="novel_title" class="section-title" placeholder="ğŸ“š ì†Œì„¤ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                    value="{{ book.name|default:'' }}" required data-login-required>
            </div>

            <div class="title-content">
                <!-- ì™¼ìª½: í‘œì§€ -->
                <div class="novel-cover-section">
                    <div class="cover-wrapper">
                        <div class="cover-image" id="cover-preview">
                            {% if book and book.cover_img %}
                                <img src="{{ book.cover_img.url }}" id="preview-cover" alt="ì†Œì„¤ í‘œì§€" loading="lazy">
                            {% else %}
                                <img src="{% static 'images/default-novel-cover.jpg' %}" id="preview-cover" alt="ì†Œì„¤ í‘œì§€" loading="lazy">
                            {% endif %}
                            <div class="cover-overlay">
                                <span>í‘œì§€ ì„ íƒ</span>
                                <p style="padding: 8px 12px;">
                                  í‘œì§€ë¥¼ ì—…ë¡œë“œí•˜ì§€ ì•Šìœ¼ë©´ ì œëª©ì˜ ì• ë‘ ê¸€ìë¥¼ ì‚¬ìš©í•œ ê¸°ë³¸ í‘œì§€ê°€ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.
                                  ë” ì¢‹ì€ ì‘í’ˆ ì¸ìƒì„ ìœ„í•´ í‘œì§€ ì—…ë¡œë“œë¥¼ ê¶Œì¥ë“œë ¤ìš”.
                                </p>
                            </div>
                        </div>
                        <input type="file" name="cover-image" id="book-cover-image" accept="image/*" style="display: none;" data-login-required>
                    </div>
                    <div style="display:flex; gap:16px; margin:12px 12px 0 12px;">
                        <div style="width:120px; position:relative; border-radius:8px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08);">
                            <span style="position:absolute; top:6px; left:6px; background:rgba(0,0,0,0.6); color:white; font-size:11px; padding:2px 6px; border-radius:4px;">ê¸°ë³¸ í‘œì§€1</span>
                            <img src="/static/img/cover/example.jpg" alt="" style="width:100%; display:block;">
                        </div>
                        <div style="width:120px; position:relative; border-radius:8px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08);">
                            <span style="position:absolute; top:6px; left:6px; background:#6366f1; color:white; font-size:11px; padding:2px 6px; border-radius:4px;">ê¸°ë³¸ í‘œì§€2</span>
                            <img src="/static/img/cover/example2.jpg" alt="" style="width:100%; display:block;">
                        </div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ì •ë³´ -->
                <div class="novel-info-section">
                    <div class="info-card">
                        <label class="info-label">ğŸ“– ì†Œì„¤ ì¤„ê±°ë¦¬</label>
                        <textarea name="novel_description" placeholder="ì†Œì„¤ ì¤„ê±°ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            rows="5" data-login-required>{{ book.description }}</textarea>
                    </div>

                    <div class="info-card">
                        <label class="info-label">ğŸ­ ì¥ë¥´ ì„ íƒ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</label>
                        <div class="genre-grid">
                            {% for genre in genres_list %}
                            <label class="genre-option">
                                <input type="checkbox" name="genres" value="{{ genre.id }}"
                                    {% if book and genre in book.genres.all %}checked{% endif %} data-login-required>
                                <span class="genre-box" style="background-color: {{ genre.genres_color|default:'#FFF' }}">
                                    {{ genre.name }}
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- íƒœê·¸ ê²€ìƒ‰/ì¶”ê°€ -->
                    <div class="info-card">
                        <label class="info-label">ğŸ·ï¸ íƒœê·¸ ì„ íƒ</label>
                        <div class="tag-input-wrapper">
                            <input type="text" id="tag-search" placeholder="íƒœê·¸ ê²€ìƒ‰ ë˜ëŠ” ì¶”ê°€..." data-login-required>
                            <button type="button" id="add-tag-btn">ì¶”ê°€</button>
                        </div>
                        <div class="selected-tags" id="selected-tags">
                            {% for tag in book.tags.all %}
                            <input type="hidden" name="tags" value="{{ tag.id }}" data-login-required>
                            <span class="selected-tag" data-login-required>{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                        <div class="tag-list-wrapper">
                            <div class="tag-grid" id="tag-grid">
                                {% for tag in tag_list %}
                                <label class="tag-option">
                                    <input type="checkbox" class="tag-checkbox" value="{{ tag.id }}"
                                        {% if book and tag in book.tags.all %}checked{% endif %} data-login-required>
                                    <span>{{ tag.name }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- ì—°ì¬ ì£¼ê¸° ì„ íƒ -->
                    <div class="info-card">
                        <label class="info-label">ğŸ“… ì—°ì¬ ì£¼ê¸°</label>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <select name="episode_interval_weeks" style="
                                padding:12px 16px;
                                background:var(--input-bg);
                                border:1px solid var(--border-color);
                                border-radius:8px;
                                color:var(--text-primary);
                                font-size:14px;
                                cursor:pointer;
                                transition:all var(--transition-base);
                            " data-login-required>
                                <option value="1" {% if book.episode_interval_weeks == 1 %}selected{% endif %}>ë§¤ì£¼ (1ì£¼ë§ˆë‹¤)</option>
                                <option value="2" {% if book.episode_interval_weeks == 2 %}selected{% endif %}>ê²©ì£¼ (2ì£¼ë§ˆë‹¤)</option>
                                <option value="3" {% if book.episode_interval_weeks == 3 %}selected{% endif %}>3ì£¼ë§ˆë‹¤</option>
                                <option value="4" {% if book.episode_interval_weeks == 4 %}selected{% endif %}>ë§¤ì›” (4ì£¼ë§ˆë‹¤)</option>
                            </select>
                            <div style="font-size:12px; color:var(--text-tertiary); padding:0 4px;">
                                ğŸ’¡ ì—í”¼ì†Œë“œë¥¼ ì–¼ë§ˆë‚˜ ìì£¼ ë“±ë¡í•  ê³„íšì¸ì§€ ì„ íƒí•˜ì„¸ìš”
                            </div>
                            <div class="terms-checkbox-wrapper">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="adult_choice" name="adult_choice" value="on"
                                        {% if book and book.adult_choice %}checked{% endif %} data-login-required>
                                    <span class="checkbox-icon"></span>
                                    <span class="checkbox-text">
                                        <a href="/terms/of/service/" class="terms-link" target="_blank">ì”ì¸ì„±, ì„ ì •ì„±ì´ ìˆëŠ” ì‘í’ˆ</a>ì´ë©´ ë™ì˜ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- ì €ì¥ ë²„íŠ¼ â†’ ëª¨ë‹¬ íŠ¸ë¦¬ê±° -->
            <button type="button" id="open-mode-modal-btn">ì €ì¥ í›„ ì§‘í•„ ì‹œì‘ â†’</button>

        </form>

    </div>
</div>


<!-- ============================================================
     ëª¨ë“œ ì„ íƒ ëª¨ë‹¬
     ============================================================ -->
<div class="mode-modal-overlay" id="modeModalOverlay">
  <div class="mode-modal">
    <button class="mode-modal-close" id="closeModeModal" aria-label="ë‹«ê¸°">âœ•</button>

    <div class="mode-modal-title">ì§‘í•„ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”</div>
    <p class="mode-modal-sub">ì €ì¥ í›„ ë°”ë¡œ ì§‘í•„ì„ ì‹œì‘í•©ë‹ˆë‹¤. ë‚˜ì¤‘ì— ë°©ì‹ì„ ë°”ê¿€ ìˆ˜ë„ ìˆì–´ìš”.</p>

    <div class="mode-cards">

      <!-- ë³´ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë§¨ ì™¼ìª½) -->
      <div class="mode-card voice" id="modeVoiceBtn">
        <div class="mode-card-icon">ğŸ™ï¸</div>
        <div class="mode-card-label">ë³´ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬</div>
        <div class="mode-card-name">ëª©ì†Œë¦¬ ë¨¼ì €<br>ê³¨ë¼ë³´ê¸°</div>
        <div class="mode-card-desc">ìˆ˜ì‹­ ê°€ì§€ ì„±ìš°<br>ì§ì ‘ ë¹„êµ ì²­ì·¨</div>
        <div class="mode-card-arrow">ë‘˜ëŸ¬ë³´ê¸° â†’</div>
      </div>

      <!-- ì´ˆë³´ì ëª¨ë“œ -->
      <div class="mode-card beginner" id="modeBeginnerBtn">
        <div class="mode-card-icon">ğŸ¬</div>
        <div class="mode-card-label">ì´ˆë³´ì ëª¨ë“œ</div>
        <div class="mode-card-name">ë¬¸ì¥ë§Œ ì¨ë„<br>AIê°€ ì—°ì¶œ</div>
        <div class="mode-card-desc">ë²ˆí˜¸ë§Œ ë¶™ì´ë©´<br>AIê°€ ìë™ ì™„ì„±</div>
        <div class="mode-card-arrow">ì‹œì‘í•˜ê¸° â†’</div>
      </div>

      <!-- ì „ë¬¸ê°€ ëª¨ë“œ â€” 1200px ì´ˆê³¼(ë°ìŠ¤í¬íƒ‘)ì—ì„œë§Œ í‘œì‹œ -->
      <div class="mode-card expert" id="modeExpertBtn">
        <div class="mode-card-icon">ğŸ› ï¸</div>
        <div class="mode-card-label">ì „ë¬¸ê°€ ëª¨ë“œ</div>
        <div class="mode-card-name">íš¨ê³¼ìŒÂ·ê°ì •<br>ì§ì ‘ ì„¤ê³„</div>
        <div class="mode-card-desc">í˜ì´ì§€ ë‹¨ìœ„<br>ì„¸ë°€í•œ ì œì‘</div>
        <div class="mode-card-arrow">ì‹œì‘í•˜ê¸° â†’</div>
      </div>

    </div>

    <!-- ë³´ì´ìŠ¤ ì•ˆë‚´ -->
    <div class="mode-voice-notice">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0; margin-top:1px;">
        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <span>
        <strong>ë³´ì´ìŠ¤ë¥¼ ì„ íƒí•´ì•¼ ì˜¤ë””ì˜¤ë¶ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong>
        ë³´ì´ìŠ¤ë¥¼ ì•„ì§ ì„ íƒí•˜ì§€ ì•Šìœ¼ì…¨ë‹¤ë©´ ì™¼ìª½ ë³´ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ë¨¼ì € ëª©ì†Œë¦¬ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”.
      </span>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/book/book_profile.js' %}"></script>
<script src="{% static 'js/register/login.js' %}"></script>

<script>
(function () {
  var form     = document.getElementById('book_profile_form');
  var openBtn  = document.getElementById('open-mode-modal-btn');
  var overlay  = document.getElementById('modeModalOverlay');
  var closeBtn = document.getElementById('closeModeModal');

  var btnBeginner = document.getElementById('modeBeginnerBtn');
  var btnExpert   = document.getElementById('modeExpertBtn');
  var btnVoice    = document.getElementById('modeVoiceBtn');

  // ì €ì¥ ë²„íŠ¼ í´ë¦­ â†’ í¼ ìœ íš¨ì„± ê²€ì‚¬ í›„ ëª¨ë‹¬ ì˜¤í”ˆ
  openBtn.addEventListener('click', function () {
    // HTML5 ê¸°ë³¸ ìœ íš¨ì„± ê²€ì‚¬ íŠ¸ë¦¬ê±°
    if (!form.reportValidity()) return;
    overlay.classList.add('open');
  });

  // ëª¨ë‹¬ ë‹«ê¸°
  closeBtn.addEventListener('click', function () { overlay.classList.remove('open'); });
  overlay.addEventListener('click', function (e) {
    if (e.target === overlay) overlay.classList.remove('open');
  });

  // í¼ ì œì¶œ + ë¦¬ë‹¤ì´ë ‰íŠ¸ ëª©ì ì§€ ì§€ì •
  function submitWithMode(mode) {
    // hidden inputìœ¼ë¡œ ëª¨ë“œ ì „ë‹¬
    var input = document.createElement('input');
    input.type  = 'hidden';
    input.name  = 'write_mode';
    input.value = mode;
    form.appendChild(input);
    form.submit();
  }

  btnBeginner.addEventListener('click', function () { submitWithMode('beginner'); });
  btnExpert.addEventListener('click',   function () { submitWithMode('expert');   });
  btnVoice.addEventListener('click',    function () { submitWithMode('voice');    });
})();
</script>
{% endblock %}