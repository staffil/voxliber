{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280">
    <title>{{ content.number }}화. {{ content.title }} — {{ book.name }}</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            width: 1280px;
            height: 720px;
            overflow: hidden;
            background: #04041a;
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        }

        /* ── 배경 레이어 ── */
        #listenModeBg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            transform: scale(1.1);
            transition: background-image 0.4s ease;
        }
        #listenModeBgColor {
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 50% 55%,
                rgba(8, 8, 28, 0.5) 0%,
                rgba(4, 4, 18, 0.92) 100%);
        }

        /* ── 배경 업로드 버튼 (썸네일 전용 UI) ── */
        #bgUploadBtn {
            position: absolute;
            bottom: 18px;
            right: 18px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.10);
            border: 1px solid rgba(255,255,255,0.22);
            border-radius: 22px;
            color: rgba(255,255,255,0.72);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            backdrop-filter: blur(6px);
            transition: background 0.2s, border-color 0.2s;
        }
        #bgUploadBtn:hover {
            background: rgba(102,126,234,0.28);
            border-color: rgba(102,126,234,0.55);
            color: #fff;
        }
        #bgFileInput { display: none; }

        /* ── 전체 오버레이 ── */
        #listenModeOverlay {
            position: fixed;
            inset: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        /* ── 메인 콘텐츠 영역 ── */
        .lm-content {
            position: relative;
            z-index: 5;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 520px;
            padding: 0 28px;
            padding-top: 144px;
            gap: 20px;
        }

        /* ── 커버 (애니메이션 없음) ── */
        .lm-cover {
            width: 170px;
            height: 270px;
    border-radius: 0px 10px 10px 0px;
            object-fit: cover;
            box-shadow: 0 28px 72px rgba(0,0,0,0.75), 0 0 0 1px rgba(255,255,255);
            /* float 없음 - 정적 */
        }
        .lm-cover-placeholder {
            width: 170px;
            height: 170px;
            border-radius: 18px;
            background: linear-gradient(135deg, #1c1c42 0%, #0c0c24 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 28px 72px rgba(0,0,0,0.75);
            color: rgba(255,255,255,0.18);
        }

        /* ── 트랙 정보 ── */
        .lm-track-info { text-align: center; }
        .lm-track-title {
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.01em;
            line-height: 1.35;
            margin-bottom: 5px;
        }
        .lm-track-book {
            color: rgba(255,255,255,0.48);
            font-size: 13px;
            letter-spacing: 0.04em;
        }

        /* ── 파형 캔버스 ── */
        #listenModeCanvas {
            width: 100%;
            height: 88px;
            border-radius: 10px;
            display: block;
        }

        /* ── 컨트롤 영역 (파형 아래 충분한 간격) ── */
        .lm-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
            width: 100%;
            margin-top: 18px; /* 파형과 간격 */
        }
        .lm-progress {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .lm-time {
            color: rgba(255,255,255,0.45);
            font-size: 11px;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
            min-width: 34px;
        }
        .lm-time.right { text-align: right; }

        .lm-progress-bar {
            flex: 1;
            position: relative;
            height: 4px;
            background: rgba(255,255,255,0.13);
            border-radius: 2px;
            cursor: pointer;
        }
        .lm-progress-fill {
            position: absolute;
            inset: 0;
            height: 100%;
            background: linear-gradient(90deg, #667eea, #a78bfa);
            border-radius: 2px;
            width: 0%;
            pointer-events: none;
        }
        #lmProgressSlider {
            position: absolute;
            inset: -10px 0;
            width: 100%;
            opacity: 0;
            cursor: pointer;
            height: 24px;
        }

        .lm-btn-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 8px; /* 재생버튼 추가 간격 */
        }
        .lm-play-btn {
            width: 58px;
            height: 58px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #a78bfa 100%);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(102,126,234,0.5);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .lm-play-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 14px 44px rgba(102,126,234,0.68);
        }
        .lm-play-btn:active { transform: scale(0.95); }

        .lm-skip-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.55);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0px;
            transition: color 0.2s, background 0.2s;
            font-size: 10px;
            font-weight: 600;
        }
        .lm-skip-btn:hover {
            color: #fff;
            background: rgba(255,255,255,0.07);
        }
        .lm-speed-btn {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.14);
            color: rgba(255,255,255,0.65);
            border-radius: 20px;
            padding: 5px 13px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: 0.02em;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }
        .lm-speed-btn:hover {
            background: rgba(102,126,234,0.28);
            border-color: rgba(102,126,234,0.5);
            color: #fff;
        }
    </style>
</head>
<body>

<!-- 배경 레이어 -->
<div id="listenModeBg"></div>
<div id="listenModeBgColor"></div>

<div id="listenModeOverlay">
    <div class="lm-content">

        <!-- 커버 이미지 -->
        {% if content.episode_image %}
            <img src="{{ content.episode_image.url }}" alt="{{ content.title }}"
                 class="lm-cover" id="lmCover" data-src="{{ content.episode_image.url }}">
        {% elif book.cover_img %}
            <img src="{{ book.cover_img.url }}" alt="{{ book.name }}"
                 class="lm-cover" id="lmCover" data-src="{{ book.cover_img.url }}">
        {% else %}
            <div class="lm-cover-placeholder" id="lmCover">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M9 18V5l12-2v13"/>
                    <circle cx="6" cy="18" r="3"/>
                    <circle cx="18" cy="16" r="3"/>
                </svg>
            </div>
        {% endif %}

        <!-- 트랙 정보 -->
        <div class="lm-track-info">
            <div class="lm-track-title">{{ content.number }}화. {{ content.title }}</div>
            <div class="lm-track-book">{{ book.name }}</div>
        </div>

        <!-- 파형 -->
        <canvas id="listenModeCanvas"></canvas>

        <!-- 컨트롤 (파형 아래, 충분한 간격) -->
        <div class="lm-controls">
            <div class="lm-progress">
                <span class="lm-time" id="lmCurrentTime">0:00</span>
                <div class="lm-progress-bar">
                    <div class="lm-progress-fill" id="lmProgressFill"></div>
                    <input type="range" id="lmProgressSlider" min="0" max="100" value="0" step="0.1">
                </div>
                <span class="lm-time right" id="lmTotalTime">0:00</span>
            </div>

            <div class="lm-btn-row">
                <button class="lm-skip-btn" id="lmSeekBack" title="-10초">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L3 8v6h6l-2.18-2.18C8.1 10.45 10.17 9.5 12.5 9.5c3.04 0 5.66 1.96 6.57 4.69l1.91-.63C19.73 10.04 16.41 8 12.5 8z"/>
                    </svg>
                    <span>10</span>
                </button>

                <button class="lm-play-btn" id="lmPlayBtn" aria-label="재생/일시정지">
                    <svg id="lmPlayIcon" width="26" height="26" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg id="lmPauseIcon" width="26" height="26" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                </button>

                <button class="lm-skip-btn" id="lmSeekFwd" title="+10초">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.5 8c2.65 0 5.05.99 6.9 2.6L21 8v6h-6l2.18-2.18C15.9 10.45 13.83 9.5 11.5 9.5c-3.04 0-5.66 1.96-6.57 4.69l-1.91-.63C4.27 10.04 7.59 8 11.5 8z"/>
                    </svg>
                    <span>10</span>
                </button>

                <button class="lm-speed-btn" id="lmSpeedBtn">1.0x</button>
            </div>
        </div>

    </div>
</div>

<!-- 배경 업로드 버튼 -->
<button id="bgUploadBtn">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <polyline points="21 15 16 10 5 21"/>
    </svg>
    배경 이미지
</button>
<input type="file" id="bgFileInput" accept="image/*">

{% if content.audio_file %}
<audio id="audioPlayer" style="display:none;">
    <source src="{{ content.audio_file.url }}" type="audio/mp3">
</audio>
{% endif %}

<script>
function formatTime(sec) {
    if (!isFinite(sec)) return "0:00";
    const m = Math.floor(sec / 60), s = Math.floor(sec % 60);
    return `${m}:${String(s).padStart(2, "0")}`;
}

document.addEventListener("DOMContentLoaded", function () {

    /* ── 배경 파일 업로드 ── */
    const bgUploadBtn = document.getElementById('bgUploadBtn');
    const bgFileInput = document.getElementById('bgFileInput');
    const bgEl        = document.getElementById('listenModeBg');

    bgUploadBtn.addEventListener('click', () => bgFileInput.click());
    bgFileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        bgEl.style.backgroundImage = `url('${url}')`;
    });

    /* ── 기본 배경: 커버 이미지로 ── */
    const lmCover = document.getElementById('lmCover');
    const coverSrc = lmCover?.dataset?.src ?? lmCover?.src ?? null;
    if (coverSrc && bgEl) bgEl.style.backgroundImage = `url('${coverSrc}')`;

    /* ── 오디오 ── */
    const audioPlayer = document.getElementById("audioPlayer");
    if (!audioPlayer) return;

    const speeds = [0.75, 1.0, 1.25, 1.5, 2.0];

    const lmPlayBtn        = document.getElementById('lmPlayBtn');
    const lmPlayIcon       = document.getElementById('lmPlayIcon');
    const lmPauseIcon      = document.getElementById('lmPauseIcon');
    const lmSeekBack       = document.getElementById('lmSeekBack');
    const lmSeekFwd        = document.getElementById('lmSeekFwd');
    const lmSpeedBtn       = document.getElementById('lmSpeedBtn');
    const lmProgressFill   = document.getElementById('lmProgressFill');
    const lmProgressSlider = document.getElementById('lmProgressSlider');
    const lmCurrentTime    = document.getElementById('lmCurrentTime');
    const lmTotalTime      = document.getElementById('lmTotalTime');
    const canvas           = document.getElementById('listenModeCanvas');

    lmPlayBtn.addEventListener('click', () => {
        audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
    });

    function syncState() {
        const playing = !audioPlayer.paused;
        lmPlayIcon.style.display  = playing ? 'none'  : 'block';
        lmPauseIcon.style.display = playing ? 'block' : 'none';
    }
    audioPlayer.addEventListener('play',  syncState);
    audioPlayer.addEventListener('pause', syncState);
    audioPlayer.addEventListener('ended', syncState);

    audioPlayer.addEventListener('loadedmetadata', () => {
        lmTotalTime.textContent = formatTime(audioPlayer.duration);
    });
    audioPlayer.addEventListener('timeupdate', () => {
        const cur = audioPlayer.currentTime, dur = audioPlayer.duration || 0;
        lmCurrentTime.textContent = formatTime(cur);
        if (dur) {
            const pct = (cur / dur) * 100;
            lmProgressFill.style.width = pct + '%';
            lmProgressSlider.value = pct;
        }
    });

    lmProgressSlider.addEventListener('input', () => {
        audioPlayer.currentTime = (lmProgressSlider.value / 100) * audioPlayer.duration;
    });
    lmSeekBack.addEventListener('click', () => { audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10); });
    lmSeekFwd.addEventListener('click',  () => { audioPlayer.currentTime = Math.min(audioPlayer.duration || 0, audioPlayer.currentTime + 10); });

    let lmSpeedIdx = 1;
    lmSpeedBtn.addEventListener('click', () => {
        lmSpeedIdx = (lmSpeedIdx + 1) % speeds.length;
        const s = speeds[lmSpeedIdx];
        audioPlayer.playbackRate = s;
        lmSpeedBtn.textContent = s + 'x';
    });

    /* ── Web Audio 파형 (content_detail 동일) ── */
    let audioCtx = null, analyser = null;

    function initAudioContext() {
        if (audioCtx) return;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 512;
            analyser.smoothingTimeConstant = 0.82;
            const src = audioCtx.createMediaElementSource(audioPlayer);
            src.connect(analyser);
            analyser.connect(audioCtx.destination);
            startVisualizer();
        } catch(e) { console.warn('Web Audio 초기화 실패:', e); }
    }

    function startVisualizer() {
        if (!canvas || !analyser) return;
        const ctx = canvas.getContext('2d');
        const bufLen = analyser.frequencyBinCount;
        const dataArr = new Uint8Array(bufLen);

        function resize() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width  = canvas.offsetWidth  * dpr;
            canvas.height = canvas.offsetHeight * dpr;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        resize();
        window.addEventListener('resize', resize);

        function draw() {
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArr);
            const W = canvas.offsetWidth, H = canvas.offsetHeight;
            ctx.clearRect(0, 0, W, H);

            const BAR_COUNT = 80, step = Math.floor(bufLen / BAR_COUNT);
            const gap = 2.5, barW = (W - gap * (BAR_COUNT - 1)) / BAR_COUNT;

            for (let i = 0; i < BAR_COUNT; i++) {
                const idx0 = i * step;
                const val  = ((dataArr[idx0]||0) + (dataArr[idx0+1]||0) + (dataArr[idx0+2]||0)) / 3 / 255;
                const barH = 3 + val * (H - 6) * 0.95;
                const x = i * (barW + gap), y = (H - barH) / 2;
                const hue = 220 + val * 60, alpha = 0.55 + val * 0.45;
                const grad = ctx.createLinearGradient(x, y + barH, x, y);
                grad.addColorStop(0,   `hsla(${hue},70%,60%,${alpha})`);
                grad.addColorStop(0.5, `hsla(${hue+20},75%,75%,${alpha})`);
                grad.addColorStop(1,   `hsla(${hue+40},80%,88%,${alpha*0.7})`);
                ctx.fillStyle = grad;
                const r = Math.min(barW / 2, 3);
                ctx.beginPath();
                if (ctx.roundRect) { ctx.roundRect(x, y, barW, barH, r); }
                else { ctx.rect(x, y, barW, barH); }
                ctx.fill();
                ctx.globalAlpha = 0.13;
                ctx.fillStyle = grad;
                if (ctx.roundRect) ctx.roundRect(x, y+barH+4, barW, barH*0.3, r);
                else ctx.rect(x, y+barH+4, barW, barH*0.3);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }
        draw();
    }

    audioPlayer.addEventListener('play', () => {
        if (!audioCtx) initAudioContext();
        else if (audioCtx.state === 'suspended') audioCtx.resume();
    }, { once: true });

});
</script>
</body>
</html>