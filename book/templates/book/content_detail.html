{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ content.title }} - {{ book.name }} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/content_detail.css' %}">
<style>
.page-block {
    display: block;
    padding: 10px 14px;
    margin: 4px 0;
    border-radius: 8px;
    border-left: 3px solid transparent;
    transition: background 0.3s, border-color 0.3s;
    line-height: 1.9;
}
.page-block:hover {
    background: rgba(102, 126, 234, 0.07);
}
.page-block.page-active {
    background: rgba(102, 126, 234, 0.15);
    border-left-color: #667eea;
}
</style>
{% endblock %}

{% block content %}
{{ content.audio_timestamps|json_script:"audio-timestamps-data" }}
<div class="content-detail-wrapper">
    <!-- í—¤ë” -->
<div class="episode-hero">
        {% if content.episode_image %}
            <img src="{{ content.episode_image.url }}" alt="{{ content.title }}" class="hero-image">
        {% else %}
            <div class="hero-image-placeholder"></div>
        {% endif %}
        
        <div class="hero-overlay">
            <nav class="bread-crumb">
                <a href="{% url 'main:main' %}">í™ˆ</a>
                <span class="sep">/</span>
                <a href="{% url 'book:book_detail' book.public_uuid %}">{{ book.name }}</a>
            </nav>
            <h1 class="content-title">{{ content.number }}í™”. {{ content.title }}</h1>
            <div class="content-meta">
                <span><i class="fas fa-user"></i> {{ book.user.nickname }}</span>
                <span class="meta-sep">|</span>
                <span><i class="fas fa-calendar-alt"></i> {{ content.created_at|date:"Y.m.d" }}</span>
            </div>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
    <div class="audio-player-section">
        {% if content.audio_file %}

        <!-- ì»¤ìŠ¤í…€ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
        <div class="custom-audio-player">
            <audio id="audioPlayer" data-content-id="{{ content.public_uuid }}" style="display: none;">
                <source src="{{ content.audio_file.url }}" type="audio/mp3">
            </audio>

            <div class="audio-player-header">
                <div class="audio-info">
                    <div class="audio-icon">ğŸ§</div>
                    <div>
                        <div class="audio-title">{{ content.number }}í™”. {{ content.title }}</div>
                        <div class="audio-subtitle">{{ book.name }}</div>
                    </div>
                </div>
            </div>

            <div class="audio-player-controls">
                <!-- ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ -->
                <button id="playPauseBtn" class="play-btn" data-login-required>
                    <svg id="playIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg id="pauseIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                </button>

                <!-- ì§„í–‰ ë°” -->
                <div class="progress-container">
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                        <input type="range" id="progressSlider" class="progress-slider" min="0" max="100" value="0" data-login-required>
                    </div>
                    <div class="time-display">
                        <span id="totalTime">0:00</span>
                    </div>
                </div>

                <!-- ì¬ìƒì†ë„ ë²„íŠ¼ -->
                <button id="playbackSpeedBtn" class="playback-speed-btn" data-login-required>1.0x</button>

                <!-- ë³¼ë¥¨ ì»¨íŠ¸ë¡¤ -->
                <div class="volume-control">
                    <button id="volumeBtn" class="volume-btn" data-login-required>
                        <svg id="volumeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                    </button>
                    <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="100">
                </div>
                <!-- ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ -->
                {% if user.is_authenticated and user == book.user %}
                <a href="{{ content.audio_file.url }}" download="{{ content.title }}.mp3"
                   class="download-btn" title="ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ" data-login-required>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </a>
                {% endif %}
            </div>
        </div>
        
        {% else %}
        <!-- ì˜¤ë””ì˜¤ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ë§Œ í‘œì‹œ -->
        <div style="padding: 20px; text-align: center; color: #888; background: #16213e; border-radius: 12px;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 12px; opacity: 0.5;">
                <path d="M9 18V5l12-2v13"/>
                <circle cx="6" cy="18" r="3"/>
                <circle cx="18" cy="16" r="3"/>
            </svg>
            <p style="margin: 0; font-size: 16px;">ì´ ì—í”¼ì†Œë“œëŠ” ì˜¤ë””ì˜¤ë¶ì´ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>
        {% endif %}
    </div>

    <!-- ë³¸ë¬¸ -->
<div class="content-text-section" id="contentText">
    {{ content.text|remove_brackets|linebreaks }}
</div>
    <!-- ì´ì „/ë‹¤ìŒ -->
    <div class="content-navigation">
        {% if prev_content %}
        <a href="{% url 'book:content_detail' prev_content.public_uuid %}" class="nav-button prev" data-login-required>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            <div>
                <div style="font-size: 12px; color: #888;">ì´ì „ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">{{ prev_content.number}}í™”. {{ prev_content.title }}</div>
            </div>
        </a>
        {% else %}
        <div class="nav-button" style="opacity: 0.3; cursor: not-allowed;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            <div>
                <div style="font-size: 12px; color: #888;">ì´ì „ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">ì—†ìŒ</div>
            </div>
        </div>
        {% endif %}

        {% if next_content %}
        <a href="{% url 'book:content_detail' next_content.public_uuid %}" class="nav-button next" data-login-required>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #888;">ë‹¤ìŒ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">{{ next_content.number }}í™”. {{ next_content.title }}</div>
            </div>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
            </svg>
        </a>
        {% else %}
        <div class="nav-button" style="opacity: 0.3; cursor: not-allowed;">
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #888;">ë‹¤ìŒ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">ì—†ìŒ</div>
            </div>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
            </svg>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
/* -----------------------------
   ìœ í‹¸ í•¨ìˆ˜
----------------------------- */
function escapeHtml(text) {
    if (!text) return "";
    return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
}

function convertMarkdownToHTML(text) {
    if (!text) return text;
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
    text = text.replace(/__(.+?)__/g, '<u>$1</u>');
    text = text.replace(/\+\+(.+?)\+\+/g, '<span style="font-size:1.2em;">$1</span>');
    text = text.replace(/--(.+?)--/g, '<small>$1</small>');
    text = text.replace(/~~(.+?)~~/g, '<s>$1</s>');
    text = text.replace(/==(.+?)==/g, '<mark style="background-color:#ffff00;padding:2px 4px;">$1</mark>');
    return text;
}

function showResumeNotification(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    const timeText = `${mins}:${String(secs).padStart(2, "0")}`;
    const el = document.createElement("div");
    el.style.cssText = `
        position:fixed; top:100px; left:50%; transform:translateX(-50%);
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        color:white; padding:16px 28px; border-radius:50px;
        font-size:15px; font-weight:600;
        box-shadow:0 8px 24px rgba(99,102,241,0.5);
        z-index:10000; display:flex; align-items:center; gap:10px;
    `;
    el.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        <span>ì´ì–´ë“£ê¸°: ${timeText}ë¶€í„° ì¬ìƒ</span>
    `;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

function showAutoMoveNotification(nextUrl) {
    let count = 3;
    const el = document.createElement("div");
    el.id = "autoMoveNotification";
    el.style.cssText = `
        position:fixed; bottom:40px; left:50%; transform:translateX(-50%);
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        color:white; padding:16px 28px; border-radius:50px;
        font-size:15px; font-weight:600;
        box-shadow:0 8px 24px rgba(99,102,241,0.5);
        z-index:10000; display:flex; align-items:center; gap:12px; cursor:pointer;
    `;
    el.innerHTML = `
        <span id="autoMoveText">${count}ì´ˆ í›„ ë‹¤ìŒ í™”ë¡œ ì´ë™í•©ë‹ˆë‹¤</span>
        <span style="opacity:0.7;font-size:12px;border:1px solid rgba(255,255,255,0.4);padding:2px 8px;border-radius:20px;">ì·¨ì†Œ</span>
    `;
    document.body.appendChild(el);

    const timer = setInterval(() => {
        count--;
        const textEl = document.getElementById("autoMoveText");
        if (textEl) textEl.textContent = `${count}ì´ˆ í›„ ë‹¤ìŒ í™”ë¡œ ì´ë™í•©ë‹ˆë‹¤`;
        if (count <= 0) {
            clearInterval(timer);
            sessionStorage.setItem("autoplayNext", "true");
            window.location.href = nextUrl;
        }
    }, 1000);

    // ì·¨ì†Œ í´ë¦­
    el.addEventListener("click", () => {
        clearInterval(timer);
        el.remove();
        sessionStorage.removeItem("autoplayNext");
    });

    return timer;
}

/* -----------------------------
   ë©”ì¸
----------------------------- */
document.addEventListener("DOMContentLoaded", function () {

    // ë§ˆí¬ë‹¤ìš´ ë³€í™˜
    const contentTextEl = document.getElementById('contentText');
    if (contentTextEl) {
        contentTextEl.innerHTML = convertMarkdownToHTML(contentTextEl.innerHTML);
    }

    const audioPlayer = document.getElementById("audioPlayer");
    if (!audioPlayer) return;

    /* â”€â”€ UI ìš”ì†Œ â”€â”€ */
    const playPauseBtn       = document.getElementById("playPauseBtn");
    const playIcon           = document.getElementById("playIcon");
    const pauseIcon          = document.getElementById("pauseIcon");
    const progressSlider     = document.getElementById("progressSlider");
    const progressFill       = document.getElementById("progressFill");
    const currentTimeDisplay = document.getElementById("currentTime");
    const totalTimeDisplay   = document.getElementById("totalTime");
    const volumeBtn          = document.getElementById("volumeBtn");
    const volumeSlider       = document.getElementById("volumeSlider");
    const playbackSpeedBtn   = document.getElementById("playbackSpeedBtn");

    /* â”€â”€ ì¬ìƒì†ë„ â”€â”€ */
    const speeds = [0.75, 1.0, 1.25, 1.5, 2.0];
    let speedIndex = 1;
    if (playbackSpeedBtn) {
        playbackSpeedBtn.addEventListener("click", function () {
            speedIndex = (speedIndex + 1) % speeds.length;
            const s = speeds[speedIndex];
            audioPlayer.playbackRate = s;
            playbackSpeedBtn.textContent = s + "x";
        });
    }

    /* â”€â”€ ì‹œê°„ í¬ë§· â”€â”€ */
    function formatTime(sec) {
        if (!isFinite(sec)) return "0:00";
        const m = Math.floor(sec / 60);
        const s = Math.floor(sec % 60);
        return `${m}:${String(s).padStart(2, "0")}`;
    }

    /* â”€â”€ ì²­ì·¨ ê¸°ë¡ â”€â”€ */
    let listeningStartTime = null;
    let totalListenedSeconds = 0;
    let isSending = false;

    async function saveListeningHistory(seconds) {
        if (isSending) return;
        isSending = true;
        try {
            const res = await fetch("{% url 'book:save_listening_history' content.public_uuid %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    listened_seconds: Math.floor(seconds),
                    last_position: audioPlayer.currentTime || 0
                })
            });
            const data = await res.json();
            if (data.success) totalListenedSeconds = 0;
        } finally {
            isSending = false;
        }
    }

    /* â”€â”€ ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ â”€â”€ */
    playPauseBtn.addEventListener("click", function () {
        if (audioPlayer.paused) {
            audioPlayer.play();
        } else {
            audioPlayer.pause();
        }
    });

    audioPlayer.addEventListener("play", function () {
        playIcon.style.display = "none";
        pauseIcon.style.display = "block";
        if (!listeningStartTime) listeningStartTime = Date.now();
    });

    audioPlayer.addEventListener("pause", function () {
        playIcon.style.display = "block";
        pauseIcon.style.display = "none";
        if (listeningStartTime) {
            totalListenedSeconds += (Date.now() - listeningStartTime) / 1000;
            listeningStartTime = null;
        }
    });

    /* â”€â”€ ended: ì²­ì·¨ê¸°ë¡ ì €ì¥ + ìë™ ë‹¤ìŒí™” ì´ë™ â”€â”€ */
    audioPlayer.addEventListener("ended", function () {
        if (listeningStartTime) {
            totalListenedSeconds += (Date.now() - listeningStartTime) / 1000;
            listeningStartTime = null;
        }
        saveListeningHistory(totalListenedSeconds);

        playIcon.style.display = "block";
        pauseIcon.style.display = "none";

        {% if next_content %}
        // ì¬ìƒ ë â†’ 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹¤ìŒ í™” ì´ë™
        // (viewì—ì„œ ê´‘ê³  redirectê°€ ë°œìƒí•˜ë©´ ì´ í˜ì´ì§€ ìì²´ê°€ ì•ˆ ëœ¨ë¯€ë¡œ ì¶©ëŒ ì—†ìŒ)
        showAutoMoveNotification("{% url 'book:content_detail' next_content.public_uuid %}");
        {% endif %}
    });

    /* â”€â”€ 30ì´ˆ ì£¼ê¸° ìë™ì €ì¥ â”€â”€ */
    setInterval(() => {
        if (!listeningStartTime) return;
        const elapsed = (Date.now() - listeningStartTime) / 1000;
        const total = totalListenedSeconds + elapsed;
        if (total >= 30) {
            totalListenedSeconds = total;
            listeningStartTime = Date.now();
            saveListeningHistory(totalListenedSeconds);
        }
    }, 30000);

    /* â”€â”€ í˜ì´ì§€ ì´íƒˆ ì‹œ ë™ê¸° ì €ì¥ â”€â”€ */
    function saveOnExit() {
        if (listeningStartTime) {
            totalListenedSeconds += (Date.now() - listeningStartTime) / 1000;
        }
        const pos = audioPlayer.currentTime || 0;
        if (pos >= 1) {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'book:save_listening_history' content.public_uuid %}", false);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.send(JSON.stringify({
                listened_seconds: Math.floor(totalListenedSeconds),
                last_position: pos
            }));
        }
    }
    window.addEventListener("beforeunload", saveOnExit);
    window.addEventListener("pagehide", saveOnExit);

    /* â”€â”€ ë©”íƒ€ë°ì´í„° ë¡œë“œ â”€â”€ */
    audioPlayer.addEventListener("loadedmetadata", function () {
        totalTimeDisplay.textContent = formatTime(audioPlayer.duration);
        progressSlider.max = audioPlayer.duration;
    });

    /* â”€â”€ ì´ì–´ë“£ê¸°: DB ê°’ ìš°ì„ , ì—†ìœ¼ë©´ sessionStorage â”€â”€ */
    const serverLastPosition = {{ last_position|default:0 }};
    let shouldResume = false;
    let resumeTime = 0;

    if (serverLastPosition > 5) {
        shouldResume = true;
        resumeTime = serverLastPosition;
    } else {
        const sessionPos = sessionStorage.getItem("resumePosition");
        if (sessionPos) {
            const pos = parseFloat(sessionPos);
            if (!isNaN(pos) && pos > 5) {
                shouldResume = true;
                resumeTime = pos;
            }
            sessionStorage.removeItem("resumePosition");
        }
    }

    /* â”€â”€ ìë™ì¬ìƒ (í˜ì´ì§€ ì§„ì… ì‹œ / ë‹¤ìŒí™” ìë™ì¬ìƒ í”Œë˜ê·¸) â”€â”€ */
    const shouldAutoplay = sessionStorage.getItem("autoplayNext") === "true";
    if (shouldAutoplay) sessionStorage.removeItem("autoplayNext");

    audioPlayer.addEventListener("canplay", function () {
        // ì´ì–´ë“£ê¸° ìœ„ì¹˜ ì„¤ì •
        if (shouldResume && resumeTime > 0) {
            audioPlayer.currentTime = resumeTime;
            progressSlider.value = resumeTime;
            progressFill.style.width = (resumeTime / audioPlayer.duration) * 100 + "%";
            currentTimeDisplay.textContent = formatTime(resumeTime);
            showResumeNotification(resumeTime);
            shouldResume = false;
        }
        // í•­ìƒ ìë™ì¬ìƒ ì‹œë„ (ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ)
        audioPlayer.play().catch(() => {
            // ìë™ì¬ìƒ ì°¨ë‹¨ ì‹œ ë²„íŠ¼ ëŒ€ê¸° - ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš”
        });
    }, { once: true });

    /* â”€â”€ timeupdate: ì§„í–‰ë°” ê°±ì‹  â”€â”€ */
    audioPlayer.addEventListener("timeupdate", function () {
        const cur = audioPlayer.currentTime;
        const dur = audioPlayer.duration;
        currentTimeDisplay.textContent = formatTime(cur);
        progressSlider.value = cur;
        if (dur) progressFill.style.width = (cur / dur) * 100 + "%";
    });

    /* â”€â”€ ì§„í–‰ë°” ìŠ¬ë¼ì´ë” â”€â”€ */
    progressSlider.addEventListener("input", function () {
        audioPlayer.currentTime = progressSlider.value;
    });

    /* â”€â”€ ë³¼ë¥¨ â”€â”€ */
    volumeSlider.addEventListener("input", function () {
        audioPlayer.volume = volumeSlider.value / 100;
    });
    volumeBtn.addEventListener("click", function () {
        if (audioPlayer.volume > 0) {
            audioPlayer.volume = 0;
            volumeSlider.value = 0;
        } else {
            audioPlayer.volume = 1;
            volumeSlider.value = 100;
        }
    });

    /* â”€â”€ í˜ì´ì§€ ê¸°ì¤€ í•˜ì´ë¼ì´íŠ¸ â”€â”€ */
    const timestampsData = document.getElementById('audio-timestamps-data');
    if (timestampsData) {
        const audioTimestamps = JSON.parse(timestampsData.textContent || '[]');
        const pages = audioTimestamps.filter(ts => ts.text && ts.text.trim() && ts.startTime !== undefined);

        if (pages.length > 0) {
            // content-text-sectionì„ í˜ì´ì§€ë³„ spanìœ¼ë¡œ êµì²´
            const contentTextEl = document.getElementById('contentText');
            if (contentTextEl) {
                contentTextEl.innerHTML = pages.map((pg, i) =>
                    `<span class="page-block" data-page="${i}">${escapeHtml(pg.text).replace(/\n/g, '<br>')}</span>`
                ).join('');
            }

            let currentPage = -1;

            function highlightPage(idx) {
                if (idx === currentPage) return;
                currentPage = idx;
                document.querySelectorAll('.page-block').forEach((el, i) => {
                    el.classList.toggle('page-active', i === idx);
                });
                // í˜„ì¬ í˜ì´ì§€ ìŠ¤í¬ë¡¤
                const activeEl = document.querySelector('.page-block.page-active');
                if (activeEl) {
                    activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }

            audioPlayer.addEventListener('timeupdate', () => {
                const ms = audioPlayer.currentTime * 1000;
                for (let i = 0; i < pages.length; i++) {
                    if (ms >= pages[i].startTime && ms < pages[i].endTime) {
                        highlightPage(i);
                        break;
                    }
                }
            });

            // í˜ì´ì§€ í´ë¦­ â†’ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
            document.querySelectorAll('.page-block').forEach((el, i) => {
                el.style.cursor = 'pointer';
                el.addEventListener('click', () => {
                    audioPlayer.currentTime = pages[i].startTime / 1000;
                    audioPlayer.play();
                });
            });
        }
    }

}); // DOMContentLoaded ë
</script>
{% endblock %}