{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ content.title }} - {{ book.name }} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/content_detail.css' %}">
<style>
/* â”€â”€ ê¸°ì¡´ í˜ì´ì§€ ë¸”ë¡ â”€â”€ */
.page-block {
    display: block;
    padding: 10px 14px;
    margin: 4px 0;
    border-radius: 8px;
    border-left: 3px solid transparent;
    transition: background 0.3s, border-color 0.3s;
    line-height: 1.9;
}
.page-block:hover { background: rgba(102, 126, 234, 0.07); }
.page-block.page-active {
    background: rgba(102, 126, 234, 0.15);
    border-left-color: #667eea;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ë“£ëŠ” ëª¨ë“œ ë²„íŠ¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.listen-mode-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-left: 12px;
    padding: 5px 14px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.22);
    border-radius: 20px;
    color: rgba(255,255,255,0.8);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    vertical-align: middle;
    transition: background 0.25s, transform 0.15s, border-color 0.25s, color 0.2s;
    letter-spacing: 0.03em;
    backdrop-filter: blur(4px);
    white-space: nowrap;
}
.listen-mode-btn:hover {
    background: rgba(102,126,234,0.32);
    border-color: rgba(102,126,234,0.6);
    transform: translateY(-1px);
    color: #fff;
}
.listen-mode-btn svg { flex-shrink: 0; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ë“£ëŠ” ëª¨ë“œ ì˜¤ë²„ë ˆì´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#listenModeOverlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.45s cubic-bezier(.4,0,.2,1);
    overflow: hidden;
}
#listenModeOverlay.open {
    opacity: 1;
    pointer-events: all;
}

/* ë¸”ëŸ¬ ë°°ê²½ */
#listenModeBg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(48px) brightness(0.3) saturate(1.5);
    transform: scale(1.1);
}
#listenModeBgColor {
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 50% 55%,
        rgba(8, 8, 28, 0.5) 0%,
        rgba(4, 4, 18, 0.92) 100%);
}
/* ë‹«ê¸° ë²„íŠ¼ */
#listenModeClose {
    position: absolute;
    top: 20px;
    right: 22px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 50%;
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #fff;
    backdrop-filter: blur(8px);
    transition: background 0.2s, transform 0.2s;
    z-index: 10;
}
#listenModeClose:hover {
    background: rgba(255,255,255,0.18);
    transform: rotate(90deg);
}

/* ì½˜í…ì¸  */
.lm-content {
    position: relative;
    z-index: 5;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 520px;
    padding: 0 28px;
    gap: 22px;
}

/* ì»¤ë²„ */
.lm-cover {
    width: 170px;
    height: 300px;
    border-radius: 18px;
    object-fit: cover;
    box-shadow: 0 28px 72px rgba(0,0,0,0.75), 0 0 0 1px rgba(255,255,255,0.07);
    transition: transform 0.4s ease;
}
.lm-cover.playing {
    animation: lmFloat 3.8s ease-in-out infinite;
}

.lm-cover-placeholder {
    width: 170px;
    height: 170px;
    border-radius: 18px;
    background: linear-gradient(135deg, #1c1c42 0%, #0c0c24 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 28px 72px rgba(0,0,0,0.75);
    color: rgba(255,255,255,0.18);
}

/* íŠ¸ë™ ì •ë³´ */
.lm-track-info { text-align: center; }
.lm-track-title {
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.01em;
    line-height: 1.35;
    margin-bottom: 5px;
}
.lm-track-book {
    color: rgba(255,255,255,0.48);
    font-size: 13px;
    letter-spacing: 0.04em;
}

/* íŒŒí˜• ìº”ë²„ìŠ¤ */
#listenModeCanvas {
    width: 100%;
    height: 88px;
    border-radius: 10px;
    display: block;
}

/* ì»¨íŠ¸ë¡¤ */
.lm-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    width: 100%;
}
.lm-progress {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
}
.lm-time {
    color: rgba(255,255,255,0.45);
    font-size: 11px;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
    min-width: 34px;
}
.lm-time.right { text-align: right; }

.lm-progress-bar {
    flex: 1;
    position: relative;
    height: 4px;
    background: rgba(255,255,255,0.13);
    border-radius: 2px;
    cursor: pointer;
}
.lm-progress-fill {
    position: absolute;
    inset: 0;
    height: 100%;
    background: linear-gradient(90deg, #667eea, #a78bfa);
    border-radius: 2px;
    width: 0%;
    pointer-events: none;
}
#lmProgressSlider {
    position: absolute;
    inset: -10px 0;
    width: 100%;
    opacity: 0;
    cursor: pointer;
    height: 24px;
}

.lm-btn-row {
    display: flex;
    align-items: center;
    gap: 20px;
}
.lm-play-btn {
    width: 58px;
    height: 58px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #a78bfa 100%);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    cursor: pointer;
    box-shadow: 0 8px 32px rgba(102,126,234,0.5);
    transition: transform 0.15s, box-shadow 0.15s;
}
.lm-play-btn:hover {
    transform: scale(1.08);
    box-shadow: 0 14px 44px rgba(102,126,234,0.68);
}
.lm-play-btn:active { transform: scale(0.95); }

.lm-skip-btn {
    background: none;
    border: none;
    color: rgba(255,255,255,0.55);
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0px;
    transition: color 0.2s, background 0.2s;
    font-size: 10px;
    font-weight: 600;
}
.lm-skip-btn:hover {
    color: #fff;
    background: rgba(255,255,255,0.07);
}
.lm-speed-btn {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.14);
    color: rgba(255,255,255,0.65);
    border-radius: 20px;
    padding: 5px 13px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    letter-spacing: 0.02em;
    transition: background 0.2s, color 0.2s, border-color 0.2s;
}
.lm-speed-btn:hover {
    background: rgba(102,126,234,0.28);
    border-color: rgba(102,126,234,0.5);
    color: #fff;
}
</style>
{% endblock %}

{% block content %}
{{ content.audio_timestamps|json_script:"audio-timestamps-data" }}
<div class="content-detail-wrapper">

    <!-- í—¤ë” -->
    <div class="episode-hero">
        {% if content.episode_image %}
            <img src="{{ content.episode_image.url }}" alt="{{ content.title }}" class="hero-image">
        {% else %}
            <div class="hero-image-placeholder"></div>
        {% endif %}

        <div class="hero-overlay">
            <nav class="bread-crumb">
                <a href="{% url 'main:main' %}">í™ˆ</a>
                <span class="sep">/</span>
                <a href="{% url 'book:book_detail' book.public_uuid %}">{{ book.name }}</a>
            </nav>

            <!-- ì œëª© + ë“£ëŠ” ëª¨ë“œ ë²„íŠ¼ -->
            <h1 class="content-title" style="display:flex; align-items:center; flex-wrap:wrap; gap:4px;">
                <span>{{ content.number }}í™”. {{ content.title }}</span>
                {% if content.audio_file %}
                <button class="listen-mode-btn" id="openListenMode" title="ë“£ëŠ” ëª¨ë“œë¡œ ì „í™˜">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
                        <path d="M3 18v-6a9 9 0 0 1 18 0v6"/>
                        <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3z"/>
                        <path d="M3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>
                    </svg>
                    ë“£ê¸° ëª¨ë“œ
                </button>
                {% endif %}
            </h1>

            <div class="content-meta">
                <span><i class="fas fa-user"></i> {{ book.user.nickname }}</span>
                <span class="meta-sep">|</span>
                <span><i class="fas fa-calendar-alt"></i> {{ content.created_at|date:"Y.m.d" }}</span>
            </div>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
    <div class="audio-player-section">
        {% if content.audio_file %}
        <div class="custom-audio-player">
            <audio id="audioPlayer" data-content-id="{{ content.public_uuid }}" style="display: none;">
                <source src="{{ content.audio_file.url }}" type="audio/mp3">
            </audio>

            <div class="audio-player-header">
                <div class="audio-info">
                    <div class="audio-icon">ğŸ§</div>
                    <div>
                        <div class="audio-title">{{ content.number }}í™”. {{ content.title }}</div>
                        <div class="audio-subtitle">{{ book.name }}</div>
                    </div>
                </div>
            </div>

            <div class="audio-player-controls">
                <button id="playPauseBtn" class="play-btn" data-login-required>
                    <svg id="playIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg id="pauseIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                </button>

                <div class="progress-container">
                    <div class="time-display"><span id="currentTime">0:00</span></div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                        <input type="range" id="progressSlider" class="progress-slider" min="0" max="100" value="0" data-login-required>
                    </div>
                    <div class="time-display"><span id="totalTime">0:00</span></div>
                </div>

                <button id="playbackSpeedBtn" class="playback-speed-btn" data-login-required>1.0x</button>

                <div class="volume-control">
                    <button id="volumeBtn" class="volume-btn" data-login-required>
                        <svg id="volumeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                    </button>
                    <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="100">
                </div>

                {% if user.is_authenticated and user == book.user %}
                <a href="{{ content.audio_file.url }}" download="{{ content.title }}.mp3"
                   class="download-btn" title="ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ" data-login-required>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </a>
                {% endif %}
            </div>
        </div>

        {% else %}
        <div style="padding: 20px; text-align: center; color: #888; background: #16213e; border-radius: 12px;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 12px; opacity: 0.5;">
                <path d="M9 18V5l12-2v13"/>
                <circle cx="6" cy="18" r="3"/>
                <circle cx="18" cy="16" r="3"/>
            </svg>
            <p style="margin: 0; font-size: 16px;">ì´ ì—í”¼ì†Œë“œëŠ” ì˜¤ë””ì˜¤ë¶ì´ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>
        {% endif %}
    </div>

    <!-- ë³¸ë¬¸ -->
    <div class="content-text-section" id="contentText">
        {{ content.text|remove_brackets|linebreaks }}
    </div>

    <!-- ì´ì „/ë‹¤ìŒ -->
    <div class="content-navigation">
        {% if prev_content %}
        <a href="{% url 'book:content_detail' prev_content.public_uuid %}" class="nav-button prev" data-login-required>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            <div>
                <div style="font-size: 12px; color: #888;">ì´ì „ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">{{ prev_content.number}}í™”. {{ prev_content.title }}</div>
            </div>
        </a>
        {% else %}
        <div class="nav-button" style="opacity: 0.3; cursor: not-allowed;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            <div>
                <div style="font-size: 12px; color: #888;">ì´ì „ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">ì—†ìŒ</div>
            </div>
        </div>
        {% endif %}

        {% if next_content %}
        <a href="{% url 'book:content_detail' next_content.public_uuid %}" class="nav-button next" data-login-required>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #888;">ë‹¤ìŒ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">{{ next_content.number }}í™”. {{ next_content.title }}</div>
            </div>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
            </svg>
        </a>
        {% else %}
        <div class="nav-button" style="opacity: 0.3; cursor: not-allowed;">
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #888;">ë‹¤ìŒ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">ì—†ìŒ</div>
            </div>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
            </svg>
        </div>
        {% endif %}
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ë“£ëŠ” ëª¨ë“œ ì˜¤ë²„ë ˆì´
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    {% if content.audio_file %}
    <div id="listenModeOverlay" role="dialog" aria-modal="true" aria-label="ë“£ëŠ” ëª¨ë“œ">
        <!-- ë°°ê²½ -->
        <div id="listenModeBg"></div>
        <div id="listenModeBgColor"></div>

        <!-- ë‹«ê¸° -->
        <button id="listenModeClose" aria-label="ë‹«ê¸°">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>

        <div class="lm-content">
            <!-- ì»¤ë²„ ì´ë¯¸ì§€: episode_image â†’ book.cover_image â†’ í”Œë ˆì´ìŠ¤í™€ë” -->
            {% if content.episode_image %}
                <img src="{{ content.episode_image.url }}" alt="{{ content.title }}"
                     class="lm-cover" id="lmCover" data-src="{{ content.episode_image.url }}">
            {% elif book.cover_img %}
                <img src="{{ book.cover_img.url }}" alt="{{ book.name }}"
                     class="lm-cover" id="lmCover" data-src="{{ book.cover_image.url }}">
            {% else %}
                <div class="lm-cover-placeholder" id="lmCover">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <path d="M9 18V5l12-2v13"/>
                        <circle cx="6" cy="18" r="3"/>
                        <circle cx="18" cy="16" r="3"/>
                    </svg>
                </div>
            {% endif %}

            <!-- íŠ¸ë™ ì •ë³´ -->
            <div class="lm-track-info">
                <div class="lm-track-title">{{ content.number }}í™”. {{ content.title }}</div>
                <div class="lm-track-book">{{ book.name }}</div>
            </div>

            <!-- íŒŒí˜• -->
            <canvas id="listenModeCanvas"></canvas>

            <!-- ì»¨íŠ¸ë¡¤ -->
            <div class="lm-controls">
                <div class="lm-progress">
                    <span class="lm-time" id="lmCurrentTime">0:00</span>
                    <div class="lm-progress-bar">
                        <div class="lm-progress-fill" id="lmProgressFill"></div>
                        <input type="range" id="lmProgressSlider" min="0" max="100" value="0" step="0.1">
                    </div>
                    <span class="lm-time right" id="lmTotalTime">0:00</span>
                </div>

                <div class="lm-btn-row">
                    <button class="lm-skip-btn" id="lmSeekBack" title="-10ì´ˆ">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L3 8v6h6l-2.18-2.18C8.1 10.45 10.17 9.5 12.5 9.5c3.04 0 5.66 1.96 6.57 4.69l1.91-.63C19.73 10.04 16.41 8 12.5 8z"/>
                        </svg>
                        <span>10</span>
                    </button>

                    <button class="lm-play-btn" id="lmPlayBtn" aria-label="ì¬ìƒ/ì¼ì‹œì •ì§€">
                        <svg id="lmPlayIcon" width="26" height="26" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg id="lmPauseIcon" width="26" height="26" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                        </svg>
                    </button>

                    <button class="lm-skip-btn" id="lmSeekFwd" title="+10ì´ˆ">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.5 8c2.65 0 5.05.99 6.9 2.6L21 8v6h-6l2.18-2.18C15.9 10.45 13.83 9.5 11.5 9.5c-3.04 0-5.66 1.96-6.57 4.69l-1.91-.63C4.27 10.04 7.59 8 11.5 8z"/>
                        </svg>
                        <span>10</span>
                    </button>

                    <button class="lm-speed-btn" id="lmSpeedBtn">1.0x</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div><!-- /content-detail-wrapper -->
{% endblock %}

{% block extra_js %}
<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ìœ í‹¸ í•¨ìˆ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function escapeHtml(text) {
    if (!text) return "";
    return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
}

function convertMarkdownToHTML(text) {
    if (!text) return text;
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.+?)\*/g,     '<em>$1</em>');
    text = text.replace(/__(.+?)__/g,     '<u>$1</u>');
    text = text.replace(/\+\+(.+?)\+\+/g,'<span style="font-size:1.2em;">$1</span>');
    text = text.replace(/--(.+?)--/g,     '<small>$1</small>');
    text = text.replace(/~~(.+?)~~/g,     '<s>$1</s>');
    text = text.replace(/==(.+?)==/g,     '<mark style="background-color:#ffff00;padding:2px 4px;">$1</mark>');
    return text;
}

function formatTime(sec) {
    if (!isFinite(sec)) return "0:00";
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${String(s).padStart(2, "0")}`;
}

function showResumeNotification(seconds) {
    const el = document.createElement("div");
    el.style.cssText = `
        position:fixed;top:100px;left:50%;transform:translateX(-50%);
        background:linear-gradient(135deg,#667eea,#764ba2);color:white;
        padding:16px 28px;border-radius:50px;font-size:15px;font-weight:600;
        box-shadow:0 8px 24px rgba(99,102,241,0.5);z-index:10000;
        display:flex;align-items:center;gap:10px;`;
    el.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        <span>ì´ì–´ë“£ê¸°: ${formatTime(seconds)}ë¶€í„° ì¬ìƒ</span>`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

function showAutoMoveNotification(nextUrl) {
    let count = 3;
    const el = document.createElement("div");
    el.id = "autoMoveNotification";
    el.style.cssText = `
        position:fixed;bottom:40px;left:50%;transform:translateX(-50%);
        background:linear-gradient(135deg,#667eea,#764ba2);color:white;
        padding:16px 28px;border-radius:50px;font-size:15px;font-weight:600;
        box-shadow:0 8px 24px rgba(99,102,241,0.5);z-index:10000;
        display:flex;align-items:center;gap:12px;cursor:pointer;`;
    el.innerHTML = `<span id="autoMoveText">${count}ì´ˆ í›„ ë‹¤ìŒ í™”ë¡œ ì´ë™í•©ë‹ˆë‹¤</span>
        <span style="opacity:.7;font-size:12px;border:1px solid rgba(255,255,255,.4);padding:2px 8px;border-radius:20px;">ì·¨ì†Œ</span>`;
    document.body.appendChild(el);
    const timer = setInterval(() => {
        count--;
        const t = document.getElementById("autoMoveText");
        if (t) t.textContent = `${count}ì´ˆ í›„ ë‹¤ìŒ í™”ë¡œ ì´ë™í•©ë‹ˆë‹¤`;
        if (count <= 0) {
            clearInterval(timer);
            sessionStorage.setItem("autoplayNext","true");
            window.location.href = nextUrl;
        }
    }, 1000);
    el.addEventListener("click", () => {
        clearInterval(timer);
        el.remove();
        sessionStorage.removeItem("autoplayNext");
    });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ë©”ì¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener("DOMContentLoaded", function () {

    /* ë§ˆí¬ë‹¤ìš´ ë³€í™˜ */
    const contentTextEl = document.getElementById('contentText');
    if (contentTextEl) contentTextEl.innerHTML = convertMarkdownToHTML(contentTextEl.innerHTML);

    const audioPlayer = document.getElementById("audioPlayer");
    if (!audioPlayer) return;

    /* â”€â”€ ê¸°ì¡´ í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ â”€â”€ */
    const playPauseBtn       = document.getElementById("playPauseBtn");
    const playIcon           = document.getElementById("playIcon");
    const pauseIcon          = document.getElementById("pauseIcon");
    const progressSlider     = document.getElementById("progressSlider");
    const progressFill       = document.getElementById("progressFill");
    const currentTimeDisplay = document.getElementById("currentTime");
    const totalTimeDisplay   = document.getElementById("totalTime");
    const volumeBtn          = document.getElementById("volumeBtn");
    const volumeSlider       = document.getElementById("volumeSlider");
    const playbackSpeedBtn   = document.getElementById("playbackSpeedBtn");

    const speeds = [0.75, 1.0, 1.25, 1.5, 2.0];
    let speedIndex = 1;
    if (playbackSpeedBtn) {
        playbackSpeedBtn.addEventListener("click", function () {
            speedIndex = (speedIndex + 1) % speeds.length;
            const s = speeds[speedIndex];
            audioPlayer.playbackRate = s;
            playbackSpeedBtn.textContent = s + "x";
        });
    }

    /* ì²­ì·¨ ê¸°ë¡ */
    let listeningStartTime = null, totalListenedSeconds = 0, isSending = false;
    async function saveListeningHistory(seconds) {
        if (isSending) return;
        isSending = true;
        try {
            const res = await fetch("{% url 'book:save_listening_history' content.public_uuid %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({ listened_seconds: Math.floor(seconds), last_position: audioPlayer.currentTime || 0 })
            });
            const data = await res.json();
            if (data.success) totalListenedSeconds = 0;
        } finally { isSending = false; }
    }

    playPauseBtn.addEventListener("click", () => {
        if (audioPlayer.paused) audioPlayer.play(); else audioPlayer.pause();
    });
    audioPlayer.addEventListener("play", () => {
        playIcon.style.display = "none"; pauseIcon.style.display = "block";
        if (!listeningStartTime) listeningStartTime = Date.now();
    });
    audioPlayer.addEventListener("pause", () => {
        playIcon.style.display = "block"; pauseIcon.style.display = "none";
        if (listeningStartTime) { totalListenedSeconds += (Date.now() - listeningStartTime) / 1000; listeningStartTime = null; }
    });
    audioPlayer.addEventListener("ended", () => {
        if (listeningStartTime) { totalListenedSeconds += (Date.now() - listeningStartTime) / 1000; listeningStartTime = null; }
        saveListeningHistory(totalListenedSeconds);
        playIcon.style.display = "block"; pauseIcon.style.display = "none";
        {% if next_content %}
        showAutoMoveNotification("{% url 'book:content_detail' next_content.public_uuid %}");
        {% endif %}
    });

    setInterval(() => {
        if (!listeningStartTime) return;
        const elapsed = (Date.now() - listeningStartTime) / 1000;
        const total = totalListenedSeconds + elapsed;
        if (total >= 30) { totalListenedSeconds = total; listeningStartTime = Date.now(); saveListeningHistory(totalListenedSeconds); }
    }, 30000);

    function saveOnExit() {
        if (listeningStartTime) totalListenedSeconds += (Date.now() - listeningStartTime) / 1000;
        const pos = audioPlayer.currentTime || 0;
        if (pos >= 1) {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'book:save_listening_history' content.public_uuid %}", false);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.send(JSON.stringify({ listened_seconds: Math.floor(totalListenedSeconds), last_position: pos }));
        }
    }
    window.addEventListener("beforeunload", saveOnExit);
    window.addEventListener("pagehide", saveOnExit);

    audioPlayer.addEventListener("loadedmetadata", () => { totalTimeDisplay.textContent = formatTime(audioPlayer.duration); progressSlider.max = audioPlayer.duration; });

    /* ì´ì–´ë“£ê¸° */
    const serverLastPosition = {{ last_position|default:0 }};
    let shouldResume = false, resumeTime = 0;
    if (serverLastPosition > 5) { shouldResume = true; resumeTime = serverLastPosition; }
    else {
        const sessionPos = sessionStorage.getItem("resumePosition");
        if (sessionPos) {
            const pos = parseFloat(sessionPos);
            if (!isNaN(pos) && pos > 5) { shouldResume = true; resumeTime = pos; }
            sessionStorage.removeItem("resumePosition");
        }
    }

    const shouldAutoplay = sessionStorage.getItem("autoplayNext") === "true";
    if (shouldAutoplay) sessionStorage.removeItem("autoplayNext");

    audioPlayer.addEventListener("canplay", function () {
        if (shouldResume && resumeTime > 0) {
            audioPlayer.currentTime = resumeTime;
            progressSlider.value = resumeTime;
            progressFill.style.width = (resumeTime / audioPlayer.duration) * 100 + "%";
            currentTimeDisplay.textContent = formatTime(resumeTime);
            showResumeNotification(resumeTime);
            shouldResume = false;
        }
        audioPlayer.play().catch(() => {});
    }, { once: true });

    audioPlayer.addEventListener("timeupdate", () => {
        const cur = audioPlayer.currentTime, dur = audioPlayer.duration;
        currentTimeDisplay.textContent = formatTime(cur);
        progressSlider.value = cur;
        if (dur) progressFill.style.width = (cur / dur) * 100 + "%";
    });
    progressSlider.addEventListener("input", () => { audioPlayer.currentTime = progressSlider.value; });
    volumeSlider.addEventListener("input",   () => { audioPlayer.volume = volumeSlider.value / 100; });
    volumeBtn.addEventListener("click",      () => {
        if (audioPlayer.volume > 0) { audioPlayer.volume = 0; volumeSlider.value = 0; }
        else { audioPlayer.volume = 1; volumeSlider.value = 100; }
    });

    /* í˜ì´ì§€ ê¸°ì¤€ í•˜ì´ë¼ì´íŠ¸ */
    const timestampsData = document.getElementById('audio-timestamps-data');
    if (timestampsData) {
        const audioTimestamps = JSON.parse(timestampsData.textContent || '[]');
        const pages = audioTimestamps.filter(ts => ts.text && ts.text.trim() && ts.startTime !== undefined);
        if (pages.length > 0) {
            const contentTextEl = document.getElementById('contentText');
            if (contentTextEl) {
                const cleanTag = t => t.replace(/\[[^\]]*\]/g, '').trim();
                contentTextEl.innerHTML = pages.map((pg, i) =>
                    `<span class="page-block" data-page="${i}">${escapeHtml(cleanTag(pg.text)).replace(/\n/g,'<br>')}</span>`
                ).join('');
            }
            let currentPage = -1;
            function highlightPage(idx) {
                if (idx === currentPage) return;
                currentPage = idx;
                document.querySelectorAll('.page-block').forEach((el, i) => el.classList.toggle('page-active', i === idx));
                const activeEl = document.querySelector('.page-block.page-active');
                if (activeEl) activeEl.scrollIntoView({ behavior:'smooth', block:'nearest' });
            }
            audioPlayer.addEventListener('timeupdate', () => {
                const ms = audioPlayer.currentTime * 1000;
                for (let i = 0; i < pages.length; i++) {
                    if (ms >= pages[i].startTime && ms < pages[i].endTime) { highlightPage(i); break; }
                }
            });
            document.querySelectorAll('.page-block').forEach((el, i) => {
                el.style.cursor = 'pointer';
                el.addEventListener('click', () => { audioPlayer.currentTime = pages[i].startTime / 1000; audioPlayer.play(); });
            });
        }
    }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë“£ëŠ” ëª¨ë“œ (Listen Mode)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const overlay  = document.getElementById('listenModeOverlay');
const openBtn  = document.getElementById('openListenMode');
const closeBtn = document.getElementById('listenModeClose');
const bgEl     = document.getElementById('listenModeBg');
const lmCover  = document.getElementById('lmCover');
const canvas   = document.getElementById('listenModeCanvas');

if (!overlay) return; // ì˜¤ë””ì˜¤ ì—†ìœ¼ë©´ skip

/* â”€â”€ ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì • â”€â”€ */
const coverSrc = lmCover?.dataset?.src || lmCover?.src || null;
if (coverSrc && bgEl) bgEl.style.backgroundImage = `url('${coverSrc}')`;

/* â”€â”€ Web Audio API ë³€ìˆ˜ (ìµœìƒë‹¨ ì„ ì–¸ í•„ìˆ˜) â”€â”€ */
let audioCtx = null;
let analyser  = null;
let rafId     = null;

/* â”€â”€ lm UI ìš”ì†Œ â”€â”€ */
const lmPlayBtn        = document.getElementById('lmPlayBtn');
const lmPlayIcon       = document.getElementById('lmPlayIcon');
const lmPauseIcon      = document.getElementById('lmPauseIcon');
const lmSeekBack       = document.getElementById('lmSeekBack');
const lmSeekFwd        = document.getElementById('lmSeekFwd');
const lmSpeedBtn       = document.getElementById('lmSpeedBtn');
const lmProgressFill   = document.getElementById('lmProgressFill');
const lmProgressSlider = document.getElementById('lmProgressSlider');
const lmCurrentTime    = document.getElementById('lmCurrentTime');
const lmTotalTime      = document.getElementById('lmTotalTime');

/* â”€â”€ ìƒíƒœ ë™ê¸°í™” â”€â”€ */
function syncLmState() {
    const playing = !audioPlayer.paused;
    if (lmPlayIcon)  lmPlayIcon.style.display  = playing ? 'none'  : 'block';
    if (lmPauseIcon) lmPauseIcon.style.display = playing ? 'block' : 'none';
    if (lmCover && lmCover.tagName === 'IMG') lmCover.classList.toggle('playing', playing);
}

/* â”€â”€ ì—´ê¸°/ë‹«ê¸° â”€â”€ */
function openOverlay() {
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';

    // AudioContext ì´ˆê¸°í™” (ì²« ë²ˆì§¸ ì—´ê¸°) ë˜ëŠ” resume (ë¸Œë¼ìš°ì € ì •ì±…)
    if (!audioCtx) {
        initAudioContext();
    } else if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }

    // RAFê°€ ë©ˆì¶°ìˆìœ¼ë©´ ì¬ì‹œì‘
    if (analyser && !rafId) {
        startVisualizer();
    }

    syncLmState();
    if (audioPlayer.duration) lmTotalTime.textContent = formatTime(audioPlayer.duration);
}

function closeOverlay() {
    overlay.classList.remove('open');
    document.body.style.overflow = '';
    // RAF ì •ì§€ (ë‹«í˜€ ìˆì„ ë•Œ ë¶ˆí•„ìš”í•œ ì—°ì‚° ë°©ì§€)
    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
}

if (openBtn)  openBtn.addEventListener('click', openOverlay);
if (closeBtn) closeBtn.addEventListener('click', closeOverlay);
overlay.addEventListener('click', e => { if (e.target === overlay) closeOverlay(); });
document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && overlay.classList.contains('open')) closeOverlay();
});

/* â”€â”€ ì¬ìƒ í† ê¸€ â”€â”€ */
if (lmPlayBtn) lmPlayBtn.addEventListener('click', () => {
    if (audioPlayer.paused) audioPlayer.play(); else audioPlayer.pause();
});

audioPlayer.addEventListener('play',  syncLmState);
audioPlayer.addEventListener('pause', syncLmState);
audioPlayer.addEventListener('ended', syncLmState);

/* â”€â”€ timeupdate â†’ lm ì§„í–‰ë°” â”€â”€ */
audioPlayer.addEventListener('timeupdate', () => {
    if (!overlay.classList.contains('open')) return;
    const cur = audioPlayer.currentTime;
    const dur = audioPlayer.duration || 0;
    if (lmCurrentTime) lmCurrentTime.textContent = formatTime(cur);
    if (dur && lmProgressFill && lmProgressSlider) {
        const pct = (cur / dur) * 100;
        lmProgressFill.style.width = pct + '%';
        lmProgressSlider.value = pct;
    }
});

audioPlayer.addEventListener('loadedmetadata', () => {
    if (lmTotalTime) lmTotalTime.textContent = formatTime(audioPlayer.duration);
});
if (audioPlayer.duration && lmTotalTime) {
    lmTotalTime.textContent = formatTime(audioPlayer.duration);
}

/* â”€â”€ lm ìŠ¬ë¼ì´ë” â”€â”€ */
if (lmProgressSlider) lmProgressSlider.addEventListener('input', () => {
    if (audioPlayer.duration) {
        audioPlayer.currentTime = (lmProgressSlider.value / 100) * audioPlayer.duration;
    }
});

/* â”€â”€ ìŠ¤í‚µ â”€â”€ */
if (lmSeekBack) lmSeekBack.addEventListener('click', () => {
    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
});
if (lmSeekFwd) lmSeekFwd.addEventListener('click', () => {
    audioPlayer.currentTime = Math.min(audioPlayer.duration || 0, audioPlayer.currentTime + 10);
});

/* â”€â”€ ì†ë„ (ê¸°ì¡´ í”Œë ˆì´ì–´ì™€ ë™ê¸°í™”) â”€â”€ */
let lmSpeedIdx = 1;
if (lmSpeedBtn) lmSpeedBtn.addEventListener('click', () => {
    lmSpeedIdx = (lmSpeedIdx + 1) % speeds.length;
    const s = speeds[lmSpeedIdx];
    audioPlayer.playbackRate = s;
    lmSpeedBtn.textContent = s + 'x';
    if (playbackSpeedBtn) playbackSpeedBtn.textContent = s + 'x';
    speedIndex = lmSpeedIdx; // ê¸°ì¡´ í”Œë ˆì´ì–´ ì¸ë±ìŠ¤ ë™ê¸°í™”
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Web Audio API â€” ì£¼íŒŒìˆ˜ íŒŒí˜• ì‹œê°í™”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initAudioContext() {
    if (audioCtx) return;
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 512;
        analyser.smoothingTimeConstant = 0.82;

        const src = audioCtx.createMediaElementSource(audioPlayer);
        src.connect(analyser);
        analyser.connect(audioCtx.destination);

        startVisualizer();
    } catch (e) {
        console.warn('Web Audio ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
    }
}

function startVisualizer() {
    if (!canvas || !analyser) return;

    const ctx    = canvas.getContext('2d');
    const bufLen = analyser.frequencyBinCount;
    const dataArr = new Uint8Array(bufLen);

    function resize() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width  = canvas.offsetWidth  * dpr;
        canvas.height = canvas.offsetHeight * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    resize();
    // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ì¤‘ë³µ ë“±ë¡ ë°©ì§€
    window.removeEventListener('resize', resize);
    window.addEventListener('resize', resize);

    const BAR_COUNT = 80;
    const gap = 2.5;

    function draw() {
        rafId = requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArr);

        const W = canvas.offsetWidth;
        const H = canvas.offsetHeight;
        ctx.clearRect(0, 0, W, H);

        const barW = (W - gap * (BAR_COUNT - 1)) / BAR_COUNT;

        for (let i = 0; i < BAR_COUNT; i++) {
            const idx0 = i * Math.floor(bufLen / BAR_COUNT);
            // ì¸ì ‘ 3ê°œ í‰ê· ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ
            const val = ((dataArr[idx0] || 0) + (dataArr[idx0 + 1] || 0) + (dataArr[idx0 + 2] || 0)) / 3 / 255;

            const minH = 3;
            const barH = minH + val * (H - minH * 2) * 0.95;
            const x = i * (barW + gap);
            const y = (H - barH) / 2;

            // ìŒëŸ‰ì— ë”°ë¼ íŒŒë‘(220) â†’ ë³´ë¼(280)
            const hue   = 220 + val * 60;
            const alpha = 0.55 + val * 0.45;

            const grad = ctx.createLinearGradient(x, y + barH, x, y);
            grad.addColorStop(0,   `hsla(${hue},      70%, 60%, ${alpha})`);
            grad.addColorStop(0.5, `hsla(${hue + 20}, 75%, 75%, ${alpha})`);
            grad.addColorStop(1,   `hsla(${hue + 40}, 80%, 88%, ${alpha * 0.7})`);

            ctx.fillStyle = grad;

            // ë‘¥ê·¼ ì‚¬ê°í˜•
            const r = Math.min(barW / 2, 3);
            ctx.beginPath();
            if (ctx.roundRect) {
                ctx.roundRect(x, y, barW, barH, r);
            } else {
                ctx.moveTo(x + r, y);
                ctx.lineTo(x + barW - r, y);
                ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
                ctx.lineTo(x + barW, y + barH - r);
                ctx.quadraticCurveTo(x + barW, y + barH, x + barW - r, y + barH);
                ctx.lineTo(x + r, y + barH);
                ctx.quadraticCurveTo(x, y + barH, x, y + barH - r);
                ctx.lineTo(x, y + r);
                ctx.quadraticCurveTo(x, y, x + r, y);
            }
            ctx.fill();

            // ì•„ë˜ ë°˜ì‚¬ íš¨ê³¼
            ctx.globalAlpha = 0.13;
            if (ctx.roundRect) {
                ctx.roundRect(x, y + barH + 4, barW, barH * 0.3, r);
            } else {
                ctx.rect(x, y + barH + 4, barW, barH * 0.3);
            }
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    draw();
}

}); // DOMContentLoaded ë
</script>
{% endblock %}