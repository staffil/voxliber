{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ content.title }} - {{ book.name }} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/content_detail.css' %}">
<style>

</style>
{% endblock %}

{% block content %}
{{ content.audio_timestamps|json_script:"audio-timestamps-data" }}
<div class="content-detail-wrapper">
    <!-- í—¤ë” -->
    <div class="content-header">
        <div class="bread-crumb">
            <a href="{% url 'main:main' %}">í™ˆ</a>
            <span>â€º</span>
            <a href="{% url 'book:book_detail' book.id %}">{{ book.name }}</a>
            <span>â€º</span>
            <span>{{ content.number }}í™”</span>
        </div>

        <h1 class="content-title">{{ content.number }}í™”. {{ content.title }}</h1>

        <div class="content-meta">
            <span>{{ book.user.nickname }}</span>
            <span>â€¢</span>
            <span>{{ content.created_at|date:"Yë…„ mì›” dì¼" }}</span>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
    <div class="audio-player-section">
        {% if content.audio_file %}

        <!-- ì»¤ìŠ¤í…€ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
        <div class="custom-audio-player">
            <audio id="audioPlayer" data-content-id="{{ content.id }}" style="display: none;">
                <source src="{{ content.audio_file.url }}" type="audio/mp3">
            </audio>

            <div class="audio-player-header">
                <div class="audio-info">
                    <div class="audio-icon">ğŸ§</div>
                    <div>
                        <div class="audio-title">{{ content.number }}í™”. {{ content.title }}</div>
                        <div class="audio-subtitle">{{ book.name }}</div>
                    </div>
                </div>
            </div>

            <div class="audio-player-controls">
                <!-- ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ -->
                <button id="playPauseBtn" class="play-btn">
                    <svg id="playIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg id="pauseIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                </button>

                <!-- ì§„í–‰ ë°” -->
                <div class="progress-container">
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                        <input type="range" id="progressSlider" class="progress-slider" min="0" max="100" value="0">
                    </div>
                    <div class="time-display">
                        <span id="totalTime">0:00</span>
                    </div>
                </div>

                <!-- ì¬ìƒì†ë„ ë²„íŠ¼ -->
                <button id="playbackSpeedBtn" class="playback-speed-btn">1.0x</button>

                <!-- ë³¼ë¥¨ ì»¨íŠ¸ë¡¤ -->
                <div class="volume-control">
                    <button id="volumeBtn" class="volume-btn">
                        <svg id="volumeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                    </button>
                    <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="100">
                </div>
                <!-- ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ -->
                {% if user.is_authenticated and user == book.user %}
                <a href="{{ content.audio_file.url }}" download="{{ content.title }}.mp3"
                   class="download-btn" title="ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </a>
                {% endif %}
            </div>
        </div>
        
        {% else %}
        <!-- ì˜¤ë””ì˜¤ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ë§Œ í‘œì‹œ -->
        <div style="padding: 20px; text-align: center; color: #888; background: #16213e; border-radius: 12px;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 12px; opacity: 0.5;">
                <path d="M9 18V5l12-2v13"/>
                <circle cx="6" cy="18" r="3"/>
                <circle cx="18" cy="16" r="3"/>
            </svg>
            <p style="margin: 0; font-size: 16px;">ì´ ì—í”¼ì†Œë“œëŠ” ì˜¤ë””ì˜¤ë¶ì´ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>
        {% endif %}
    </div>

    <!-- ëŒ€ì‚¬ í•˜ì´ë¼ì´íŠ¸ ì„¹ì…˜ (ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ ì œì™¸)
    {% if content.audio_file %}
    <div class="dialogue-highlight-section">
        <div class="dialogue-header">
            <h3>ğŸ“ ëŒ€ì‚¬ë³„ ë“£ê¸°</h3>
            <div class="dialogue-nav-buttons">
                <button id="prevDialogueBtn" class="dialogue-nav-btn" title="ì´ì „ ëŒ€ì‚¬">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                </button>
                <span id="dialogueCounter" style="font-size: 13px; color: #888;">-/-</span>
                <button id="nextDialogueBtn" class="dialogue-nav-btn" title="ë‹¤ìŒ ëŒ€ì‚¬">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </button>
            </div>
        </div>
        <div id="dialogueList" class="dialogue-list">
            ëŒ€ì‚¬ ëª©ë¡ì´ JavaScriptë¡œ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤
        </div>
    </div>
    {% endif %} -->

    <!-- ë³¸ë¬¸ -->
    <div class="content-text-section" id="contentText">
        {{ content.text|remove_brackets|linebreaks }}
    </div>

    <!-- ì´ì „/ë‹¤ìŒ -->
    <div class="content-navigation">
        {% if prev_content %}
        <a href="{% url 'book:content_detail' prev_content.id %}" class="nav-button prev">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            <div>
                <div style="font-size: 12px; color: #888;">ì´ì „ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">{{ prev_content.number}}í™”. {{ prev_content.title }}</div>
            </div>
        </a>
        {% else %}
        <div class="nav-button" style="opacity: 0.3; cursor: not-allowed;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            <div>
                <div style="font-size: 12px; color: #888;">ì´ì „ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">ì—†ìŒ</div>
            </div>
        </div>
        {% endif %}

        {% if next_content %}
        <a href="{% url 'book:content_detail' next_content.id %}" class="nav-button next">
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #888;">ë‹¤ìŒ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">{{ next_content.number }}í™”. {{ next_content.title }}</div>
            </div>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
            </svg>
        </a>
        {% else %}
        <div class="nav-button" style="opacity: 0.3; cursor: not-allowed;">
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #888;">ë‹¤ìŒ ì—í”¼ì†Œë“œ</div>
                <div style="font-weight: 600;">ì—†ìŒ</div>
            </div>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
            </svg>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* -----------------------------
   ë¬¸ë‹¨ ë¶„í•  / íƒ€ì„ìŠ¤íƒ¬í”„ ë§¤í•‘ í•¨ìˆ˜
----------------------------- */
function splitParagraphsForTimestamps(originalText, audioTimestamps) {
    const timestampCount = audioTimestamps.length;

    // ë¬¸ë‹¨ ê¸°ì¤€ ë¶„í• 
    let paragraphs = originalText
        .split(/\n\s*\n+/)
        .map(p => p.trim())
        .filter(Boolean);

    const paragraphCount = paragraphs.length;

    // ë¬¸ë‹¨ ìˆ˜ == íƒ€ì„ìŠ¤íƒ¬í”„ ìˆ˜ â†’ ê·¸ëŒ€ë¡œ
    if (paragraphCount === timestampCount) return paragraphs;

    // ê· ë“± ë³‘í•©
    const chunks = [];
    const perChunk = Math.ceil(paragraphCount / timestampCount);

    for (let i = 0; i < paragraphCount; i += perChunk) {
        chunks.push(paragraphs.slice(i, i + perChunk).join("\n\n"));
    }

    while (chunks.length < timestampCount) chunks.push("");
    while (chunks.length > timestampCount) {
        chunks[chunks.length - 2] += "\n\n" + chunks.pop();
    }

    return chunks;
}

/* -----------------------------
   HTML escape
----------------------------- */
function escapeHtml(text) {
    if (!text) return "";
    return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
}

/* -----------------------------
   ë©”ì¸ ì‹¤í–‰
----------------------------- */
document.addEventListener("DOMContentLoaded", function () {
    const audioPlayer = document.getElementById("audioPlayer");
    if (!audioPlayer) return;

    /* -----------------------------
       ì˜¤ë””ì˜¤ UI ì»¨íŠ¸ë¡¤
    ----------------------------- */
    const playPauseBtn = document.getElementById("playPauseBtn");
    const playIcon = document.getElementById("playIcon");
    const pauseIcon = document.getElementById("pauseIcon");
    const progressSlider = document.getElementById("progressSlider");
    const progressFill = document.getElementById("progressFill");
    const currentTimeDisplay = document.getElementById("currentTime");
    const totalTimeDisplay = document.getElementById("totalTime");
    const volumeBtn = document.getElementById("volumeBtn");
    const volumeSlider = document.getElementById("volumeSlider");

    function formatTime(sec) {
        if (!isFinite(sec)) return "0:00";
        const m = Math.floor(sec / 60);
        const s = Math.floor(sec % 60);
        return `${m}:${String(s).padStart(2, "0")}`;
    }

    // ì´ì–´ë“£ê¸° ì•Œë¦¼ í‘œì‹œ
    function showResumeNotification(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        const timeText = `${mins}:${String(secs).padStart(2, "0")}`;

        const notification = document.createElement("div");
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 28px;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 600;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease;
        `;
        notification.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
            </svg>
            <span>ì´ì–´ë“£ê¸°: ${timeText}ë¶€í„° ì¬ìƒ</span>
        `;

        document.body.appendChild(notification);

        // 3ì´ˆ í›„ ì œê±°
        setTimeout(() => {
            notification.style.animation = "slideUp 0.3s ease";
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    playPauseBtn.addEventListener("click", function () {
        if (audioPlayer.paused) {
            audioPlayer.play();
            playIcon.style.display = "none";
            pauseIcon.style.display = "block";
        } else {
            audioPlayer.pause();
            playIcon.style.display = "block";
            pauseIcon.style.display = "none";
        }
    });

    // ì¬ìƒ ì‹œì‘ ì‹œ ì²­ì·¨ ì‹œì‘ ì‹œê°„ ê¸°ë¡
    audioPlayer.addEventListener("play", function () {
        if (!listeningStartTime) {
            listeningStartTime = Date.now();
            console.log("ğŸ§ ì²­ì·¨ ì‹œì‘:", new Date(listeningStartTime).toLocaleTimeString());
        }
    });

    // ì¼ì‹œì •ì§€ ì‹œ ì²­ì·¨ ì‹œê°„ ëˆ„ì 
    audioPlayer.addEventListener("pause", function () {
        if (listeningStartTime) {
            const elapsed = (Date.now() - listeningStartTime) / 1000;
            totalListenedSeconds += elapsed;
            listeningStartTime = null;
            console.log(`â¸ï¸ ì²­ì·¨ ì¼ì‹œì •ì§€: ${elapsed.toFixed(1)}ì´ˆ ê²½ê³¼, ì´ ${totalListenedSeconds.toFixed(1)}ì´ˆ`);
        }
    });

    // ì˜¤ë””ì˜¤ ì¬ìƒ ì™„ë£Œ ì‹œ ì €ì¥
    audioPlayer.addEventListener("ended", function () {
        if (listeningStartTime) {
            totalListenedSeconds += (Date.now() - listeningStartTime) / 1000;
            listeningStartTime = null;
        }

        // ëê¹Œì§€ ë“¤ì—ˆìœ¼ë¯€ë¡œ ì €ì¥
        console.log("âœ… ì˜¤ë””ì˜¤ ì¬ìƒ ì™„ë£Œ - ì €ì¥");
        saveListeningHistory(totalListenedSeconds);
            {% if next_content %}
            // ë‹¤ìŒ í™” ì´ë™ ì‹œ ìë™ ì¬ìƒ í”Œë˜ê·¸ ì„¤ì •
            sessionStorage.setItem("autoplayNext", "true");
            window.location.href = "{% url 'book:content_detail' next_content.id %}";
            {% endif %}
    });

    audioPlayer.play().catch(() => {
        console.log("ìë™ ì¬ìƒ ì‹¤íŒ¨: ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í•„ìš”");
    });

    // ì´ì–´ë“£ê¸° ìœ„ì¹˜ í™•ì¸ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
    const resumePosition = sessionStorage.getItem("resumePosition");
    let shouldResume = false;
    let resumeTime = 0;

    if (resumePosition) {
        const position = parseFloat(resumePosition);
        if (!isNaN(position) && position > 0) {
            shouldResume = true;
            resumeTime = position;
            console.log(`ğŸ§ ì´ì–´ë“£ê¸° ëª¨ë“œ: ${position}ì´ˆ ìœ„ì¹˜ë¡œ ì´ë™ ì˜ˆì •`);
        }
        // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì œê±°
        sessionStorage.removeItem("resumePosition");
    }

    audioPlayer.addEventListener("loadedmetadata", function () {
        totalTimeDisplay.textContent = formatTime(audioPlayer.duration);
        progressSlider.max = audioPlayer.duration;
    });

    // canplay ì´ë²¤íŠ¸ì—ì„œ ì¬ìƒ ìœ„ì¹˜ ì„¤ì • (ë” ì•ˆì •ì )
    audioPlayer.addEventListener("canplay", function () {
        if (shouldResume && resumeTime > 0) {
            audioPlayer.currentTime = resumeTime;
            progressSlider.value = resumeTime;
            progressFill.style.width = (resumeTime / audioPlayer.duration) * 100 + "%";
            currentTimeDisplay.textContent = formatTime(resumeTime);

            // ì•Œë¦¼ í‘œì‹œ
            showResumeNotification(resumeTime);

            shouldResume = false; // í•œ ë²ˆë§Œ ì‹¤í–‰
            console.log(`âœ… ì´ì–´ë“£ê¸°: ${resumeTime}ì´ˆ ìœ„ì¹˜ì—ì„œ ì¬ìƒ ì‹œì‘`);
        }
    }, { once: true }); // í•œ ë²ˆë§Œ ì‹¤í–‰

    audioPlayer.addEventListener("timeupdate", function () {
        const cur = audioPlayer.currentTime;
        const dur = audioPlayer.duration;

        currentTimeDisplay.textContent = formatTime(cur);
        progressSlider.value = cur;
        progressFill.style.width = (cur / dur) * 100 + "%";
    });

    progressSlider.addEventListener("input", function () {
        audioPlayer.currentTime = progressSlider.value;
    });

    volumeSlider.addEventListener("input", function () {
        audioPlayer.volume = volumeSlider.value / 100;
    });

    volumeBtn.addEventListener("click", function () {
        if (audioPlayer.volume > 0) {
            audioPlayer.volume = 0;
            volumeSlider.value = 0;
        } else {
            audioPlayer.volume = 1;
            volumeSlider.value = 100;
        }
    });

    /* -----------------------------
       ì²­ì·¨ì‹œê°„ ê¸°ë¡
    ----------------------------- */
    let listeningStartTime = null;
    let totalListenedSeconds = 0;
    let isSending = false;

    async function saveListeningHistory(seconds) {
        if (isSending) return;
        isSending = true;

        try {
            const res = await fetch("{% url 'book:save_listening_history' content.id %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    listened_seconds: Math.floor(seconds),
                    last_position: audioPlayer.currentTime || 0
                })
            });

            const data = await res.json();
            if (data.success) totalListenedSeconds = 0;
        } finally {
            isSending = false;
        }
    }

    audioPlayer.addEventListener("play", () => {
        listeningStartTime = Date.now();
    });

    audioPlayer.addEventListener("pause", () => {
        if (!listeningStartTime) return;
        totalListenedSeconds += (Date.now() - listeningStartTime) / 1000;
        listeningStartTime = null;
    });

    audioPlayer.addEventListener("ended", () => {
        if (listeningStartTime)
            totalListenedSeconds += (Date.now() - listeningStartTime) / 1000;
        listeningStartTime = null;

        saveListeningHistory(totalListenedSeconds);
    });

    setInterval(() => {
        if (!listeningStartTime) return;

        const elapsed = (Date.now() - listeningStartTime) / 1000;
        const total = totalListenedSeconds + elapsed;

        if (total >= 30) {
            totalListenedSeconds = total;
            listeningStartTime = Date.now();
            saveListeningHistory(totalListenedSeconds);
        }
    }, 30000);

    // í˜ì´ì§€ ë²—ì–´ë‚  ë•Œ ë¬´ì¡°ê±´ ì €ì¥ (beforeunload)
    function saveOnExit() {
        // ì²­ì·¨ ì¤‘ì´ë©´ ì‹œê°„ ëˆ„ì 
        if (listeningStartTime) {
            totalListenedSeconds += (Date.now() - listeningStartTime) / 1000;
        }

        const currentPos = audioPlayer.currentTime || 0;

        // ì¬ìƒ ìœ„ì¹˜ê°€ 1ì´ˆ ì´ìƒì´ë©´ ë¬´ì¡°ê±´ ì €ì¥
        if (currentPos >= 1) {
            console.log(`ğŸ’¾ í˜ì´ì§€ ì¢…ë£Œ - ìœ„ì¹˜ ì €ì¥: ${currentPos.toFixed(1)}ì´ˆ, ì²­ì·¨ ì‹œê°„: ${totalListenedSeconds.toFixed(1)}ì´ˆ`);

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'book:save_listening_history' content.id %}", false);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.send(
                JSON.stringify({
                    listened_seconds: Math.floor(totalListenedSeconds),
                    last_position: currentPos
                })
            );
        }
    }

    // beforeunload: PC ë¸Œë¼ìš°ì €ìš©
    window.addEventListener("beforeunload", saveOnExit);

    // pagehide: ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ìš© (ë” ì•ˆì •ì )
    window.addEventListener("pagehide", saveOnExit);

    /* -----------------------------
       ëŒ€ì‚¬ í•˜ì´ë¼ì´íŠ¸ ê¸°ëŠ¥ (ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ ì œì™¸)
    ----------------------------- */
    const timestampsData = document.getElementById('audio-timestamps-data');
    if (timestampsData) {
        const audioTimestamps = JSON.parse(timestampsData.textContent || '[]');

        // í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ëŒ€ì‚¬ë§Œ í•„í„°ë§ (ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ ì œì™¸)
        const dialogues = audioTimestamps.filter(ts => ts.text && ts.text.trim());

        if (dialogues.length > 0) {
            const dialogueList = document.getElementById('dialogueList');
            const prevDialogueBtn = document.getElementById('prevDialogueBtn');
            const nextDialogueBtn = document.getElementById('nextDialogueBtn');
            const dialogueCounter = document.getElementById('dialogueCounter');

            let currentDialogueIndex = -1;

            // ëŒ€ì‚¬ ëª©ë¡ ë Œë”ë§ ë° í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            function renderDialogues() {
                if (!dialogueList) return;

                dialogueList.innerHTML = '';
                dialogues.forEach((dialogue, index) => {
                    const dialogueItem = document.createElement('div');
                    dialogueItem.className = 'dialogue-item';
                    if (index === currentDialogueIndex) {
                        dialogueItem.classList.add('active');
                    }
                    dialogueItem.innerHTML = `
                        <div class="dialogue-number">ëŒ€ì‚¬ ${index + 1}</div>
                        <div class="dialogue-text">${escapeHtml(dialogue.text)}</div>
                    `;

                    // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    dialogueItem.addEventListener('click', () => {
                        jumpToDialogue(index);
                    });

                    dialogueList.appendChild(dialogueItem);
                });

                // ì¹´ìš´í„° ì—…ë°ì´íŠ¸
                updateCounter();
            }

            // ëŒ€ì‚¬ë¡œ ì´ë™ (startTime ì‚¬ìš©)
            function jumpToDialogue(index) {
                if (index >= 0 && index < dialogues.length) {
                    const dialogue = dialogues[index];
                    // startTimeì„ ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ì—¬ ì´ë™
                    audioPlayer.currentTime = dialogue.startTime / 1000;
                    highlightDialogue(index);
                    console.log(`ğŸ¯ ëŒ€ì‚¬ ${index + 1}ë¡œ ì´ë™: ${dialogue.startTime}ms`);
                }
            }

            // ëŒ€ì‚¬ í•˜ì´ë¼ì´íŠ¸
            function highlightDialogue(index) {
                currentDialogueIndex = index;
                renderDialogues();
            }

            // ì¹´ìš´í„° ì—…ë°ì´íŠ¸
            function updateCounter() {
                if (currentDialogueIndex >= 0) {
                    dialogueCounter.textContent = `${currentDialogueIndex + 1}/${dialogues.length}`;
                } else {
                    dialogueCounter.textContent = `-/${dialogues.length}`;
                }
            }

            // ìë™ í•˜ì´ë¼ì´íŠ¸ (ì¬ìƒ ì¤‘ í˜„ì¬ ëŒ€ì‚¬ í‘œì‹œ)
            audioPlayer.addEventListener('timeupdate', () => {
                const currentMs = audioPlayer.currentTime * 1000;

                for (let i = 0; i < dialogues.length; i++) {
                    const dialogue = dialogues[i];
                    // startTimeê³¼ endTime ì‚¬ì´ì— ìˆìœ¼ë©´ í•´ë‹¹ ëŒ€ì‚¬ í•˜ì´ë¼ì´íŠ¸
                    if (currentMs >= dialogue.startTime && currentMs < dialogue.endTime) {
                        if (currentDialogueIndex !== i) {
                            highlightDialogue(i);
                        }
                        break;
                    }
                }
            });

            // ì´ì „ ëŒ€ì‚¬ ë²„íŠ¼
            prevDialogueBtn.addEventListener('click', () => {
                if (currentDialogueIndex > 0) {
                    jumpToDialogue(currentDialogueIndex - 1);
                }
            });

            // ë‹¤ìŒ ëŒ€ì‚¬ ë²„íŠ¼
            nextDialogueBtn.addEventListener('click', () => {
                if (currentDialogueIndex < dialogues.length - 1) {
                    jumpToDialogue(currentDialogueIndex + 1);
                }
            });

            // ì´ˆê¸° ë Œë”ë§
            renderDialogues();
            console.log(`ğŸ“ ëŒ€ì‚¬ë³„ ë“£ê¸° í™œì„±í™”: ${dialogues.length}ê°œ ëŒ€ì‚¬`);
        } else {
            // ëŒ€ì‚¬ê°€ ì—†ìœ¼ë©´ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const highlightSection = document.querySelector('.dialogue-highlight-section');
            if (highlightSection) {
                highlightSection.style.display = 'none';
            }
        }
    }
});

// ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë³€í™˜
function convertMarkdownToHTML(text) {
    if (!text) return text;

    // **bold** â†’ <strong>bold</strong>
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

    // *italic* â†’ <em>italic</em>
    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');

    // __underline__ â†’ <u>underline</u>
    text = text.replace(/__(.+?)__/g, '<u>$1</u>');

    // ++bigger++ â†’ <big>bigger</big>
    text = text.replace(/\+\+(.+?)\+\+/g, '<span style="font-size: 1.2em;">$1</span>');

    // --smaller-- â†’ <small>smaller</small>
    text = text.replace(/--(.+?)--/g, '<small>$1</small>');

    // ~~strikethrough~~ â†’ <s>strikethrough</s>
    text = text.replace(/~~(.+?)~~/g, '<s>$1</s>');

    // ==highlight== â†’ <mark>highlight</mark>
    text = text.replace(/==(.+?)==/g, '<mark style="background-color: #ffff00; padding: 2px 4px;">$1</mark>');

    return text;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ í…ìŠ¤íŠ¸ ë³€í™˜
document.addEventListener('DOMContentLoaded', function() {
    const contentTextElement = document.getElementById('contentText');
    if (contentTextElement) {
        const originalHTML = contentTextElement.innerHTML;
        const convertedHTML = convertMarkdownToHTML(originalHTML);
        contentTextElement.innerHTML = convertedHTML;
    }
});

</script>

{% endblock %}
