{% extends 'base.html' %}
{% load static %}

{% block title %}ë¯¸ë¦¬ë“£ê¸° - {{ book.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/preview.css' %}">

{% endblock %}

{% block content %}
<div class="preview-container">
    <!-- í—¤ë” -->
    <div class="preview-header">
        <!-- ì—í”¼ì†Œë“œ ì´ë¯¸ì§€ -->
        <input type="file" name="episode-image" id="episodeImageInput" accept="image/*" style="display: none;">

        <div class="preview-image-area" onclick="document.getElementById('episodeImageInput').click()">
            <div class="image-placeholder">ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
        </div>

        <div class="preview-title">ğŸ§ ë¯¸ë¦¬ë“£ê¸°</div>
        <div class="preview-subtitle" id="episodeTitle">ì—í”¼ì†Œë“œ ì œëª©</div>
        <div class="preview-info">
            <span>ğŸ“š {{ book.name }}</span>
            <span>â€¢</span>
            <span>âœï¸ {{ book.user.nickname }}</span>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
    <div class="audio-player-section">
        <div class="player-header">
            <div class="player-icon">ğŸµ</div>
            <div class="player-info">
                <h3>ìµœì¢… ì˜¤ë””ì˜¤ ë¯¸ë¦¬ë“£ê¸°</h3>
                <p>ëŒ€ì‚¬, ì‚¬ìš´ë“œ ì´íŒ©íŠ¸, ë°°ê²½ìŒì´ ëª¨ë‘ í¬í•¨ëœ ì™„ì„±ë³¸ì…ë‹ˆë‹¤</p>
            </div>
        </div>

        <audio id="previewAudio" style="display: none;"></audio>

        <div class="audio-controls">
            <button id="playBtn" class="play-btn" data-login-required>
                <svg id="playIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <svg id="pauseIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                </svg>
            </button>

            <div class="progress-container">
                <div class="time-display" id="currentTime">0:00</div>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display" id="totalTime">0:00</div>
            </div>

            <div class="volume-control">
                <button id="volumeBtn" class="volume-btn" data-login-required>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                    </svg>
                </button>
                <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="100">
            </div>
        </div>
    </div>

    <!-- ì •ë³´ ì¹´ë“œ -->
    <div class="info-card">
        <h4>ğŸ“Š ì—í”¼ì†Œë“œ ì •ë³´</h4>
        <ul class="info-list">
            <li>
                <span class="info-label">ëŒ€ì‚¬ ê°œìˆ˜</span>
                <span class="info-value" id="dialogueCount">-</span>
            </li>
            <li>
                <span class="info-label">ë°°ê²½ìŒ</span>
                <span class="info-value" id="bgMusicCount">-</span>
            </li>
            <li>
                <span class="info-label">ì˜ˆìƒ ì¬ìƒì‹œê°„</span>
                <span class="info-value" id="estimatedDuration">-</span>
            </li>
        </ul>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="goBack()" data-login-required>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            ìˆ˜ì •í•˜ê¸°
        </button>
        <button class="btn btn-primary" onclick="publishEpisode()" data-login-required>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
            ë°œí–‰í•˜ê¸°
        </button>
    </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text">ì˜¤ë””ì˜¤ ìƒì„± ì¤‘...</div>
        <div class="loading-subtext">ìµœì¢… ì˜¤ë””ì˜¤ë¥¼ í•©ì¹˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
const bookId = "{{ book.public_uuid }}";
let previewAudioUrl = null;
let db = null; // IndexedDB ì „ì—­ ë³€ìˆ˜
let isPublishing = false;

// ================================
// IndexedDB ì´ˆê¸°í™”
// ================================
function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('VoxliberDrafts', 1);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);

        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('drafts')) {
                db.createObjectStore('drafts', { keyPath: 'bookId' });
            }
        };
    });
}

// ================================
// í˜ì´ì§€ ë¡œë“œ ì‹œ ë¯¸ë¦¬ë“£ê¸° ìƒì„±
// ================================
document.addEventListener('DOMContentLoaded', async function() {
    db = await initIndexedDB();
    await generatePreviewAudio();
    initAudioPlayer();
});

// ================================
// ë¯¸ë¦¬ë“£ê¸° ì˜¤ë””ì˜¤ ìƒì„±
// ================================
async function generatePreviewAudio() {
    try {
        console.log('ğŸ” ë¯¸ë¦¬ë“£ê¸° ì˜¤ë””ì˜¤ ìƒì„± ì‹œì‘, bookId:', bookId);

        // IndexedDBì—ì„œ draft ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const draftData = await new Promise((resolve, reject) => {
            const transaction = db.transaction(['drafts'], 'readonly');
            const store = transaction.objectStore('drafts');
            const request = store.get(bookId);

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });

        if (!draftData) {
            alert('ì„ì‹œì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            window.location.href = `/book/book/serialization/?public_uuid=${bookId}`;
            return;
        }

        console.log('âœ… ë°ì´í„° ë¡œë“œ ì„±ê³µ:', draftData);

        // ì œëª© í‘œì‹œ
        document.getElementById('episodeTitle').textContent = draftData.episodeTitle || 'ì œëª© ì—†ìŒ';

        // ì •ë³´ í‘œì‹œ
        const dialogueCount = draftData.pages.filter(p => !p.isSoundEffect).length;
        const bgMusicCount = draftData.backgroundTracks ? draftData.backgroundTracks.length : 0;
        document.getElementById('dialogueCount').textContent = `${dialogueCount}ê°œ`;
        document.getElementById('bgMusicCount').textContent = bgMusicCount > 0 ? `${bgMusicCount}ê°œ` : 'ì—†ìŒ';

        if (dialogueCount > 200) {
            alert('ë¯¸ë¦¬ë“£ê¸°ëŠ” ìµœëŒ€ 200ê°œ ëŒ€ì‚¬ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\ní˜„ì¬: ' + dialogueCount + 'ê°œ');
            return;
        }

        // ì„œë²„ì— ì„ì‹œ ì˜¤ë””ì˜¤ ìƒì„± ìš”ì²­
        const formData = new FormData();
        formData.append('book_id', bookId);

        draftData.pages.forEach((page, index) => {
            if (page.audioBlob) {
                const audioFile = new File([page.audioBlob], `audio_${index}.mp3`, { type: 'audio/mp3' });
                formData.append(`audio_${index}`, audioFile);
            }
            formData.append(`page_text_${index}`, page.isSoundEffect ? '' : (page.content || ''));
        });

        if (bgMusicCount > 0) {
            draftData.backgroundTracks.forEach((track, index) => {
                if (track.audioBlob) {
                    formData.append(`background_audio_${index}`, new File([track.audioBlob], `bg_${index}.mp3`, { type: 'audio/mp3' }));
                    formData.append(`background_start_${index}`, track.startPage);
                    formData.append(`background_end_${index}`, track.endPage);
                    formData.append(`background_name_${index}`, track.musicName);
                    formData.append(`background_volume_${index}`, track.volume ?? 1);
                }
            });
            formData.append('background_tracks_count', bgMusicCount);
        } else {
            formData.append('background_tracks_count', 0);
        }

        const response = await fetch('/book/preview/generate-async/', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: formData
        });

        const data = await response.json();
        if (data.success && data.task_id) {
            await pollTaskStatus(data.task_id);
        } else {
            alert('ì˜¤ë””ì˜¤ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            window.location.href = `/book/book/serialization/?public_uuid=${bookId}`;
        }

    } catch (error) {
        console.error('ë¯¸ë¦¬ë“£ê¸° ì˜¤ë””ì˜¤ ìƒì„± ì˜¤ë¥˜:', error);
        alert('ì˜¤ë””ì˜¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        window.location.href = `/book/book/serialization/?public_uuid=${bookId}`;
    }
}

// ================================
// Task ìƒíƒœ í´ë§
// ================================
async function pollTaskStatus(taskId) {
    const pollInterval = 5000;
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = loadingOverlay.querySelector('.loading-subtext');

    while (true) {
        const response = await fetch(`/book/preview/task-status/${taskId}/`);
        const data = await response.json();

        if (data.progress !== undefined) {
            loadingText.innerHTML = `${data.status}<br><span style="font-size: 14px; color: #4CAF50;">${data.progress}%</span>`;
        } else {
            loadingText.textContent = data.status || 'ì˜¤ë””ì˜¤ ìƒì„± ì¤‘...';
        }

        if (data.state === 'SUCCESS' && data.audio_data) {
            const audioBytes = Uint8Array.from(atob(data.audio_data), c => c.charCodeAt(0));
            const blob = new Blob([audioBytes], { type: 'audio/mpeg' });
            previewAudioUrl = URL.createObjectURL(blob);

            const audio = document.getElementById('previewAudio');
            audio.src = previewAudioUrl;

            // IndexedDBì— mergeAudio + timestamps ì €ì¥
            const tx = db.transaction(['drafts'], 'readwrite');
            const store = tx.objectStore('drafts');
            const getRequest = store.get(bookId);
            getRequest.onsuccess = () => {
                const draftData = getRequest.result;
                if (draftData) {
                    draftData.mergedAudioBlob = blob;
                    draftData.mergedAudioTimestamp = new Date().toISOString();
                    draftData.mergedAudioTimestamps = data.timestamps || [];
                    store.put(draftData);
                }
            };

            loadingOverlay.style.display = 'none';
            return;

        } else if (data.state === 'FAILURE') {
            alert('ì˜¤ë””ì˜¤ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            window.location.href = `/book/book/serialization/?public_uuid=${bookId}`;
            return;
        }

        await new Promise(resolve => setTimeout(resolve, pollInterval));
    }
}

// ================================
// ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì´ˆê¸°í™”
// ================================
function initAudioPlayer() {
    const audio = document.getElementById('previewAudio');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const currentTimeDisplay = document.getElementById('currentTime');
    const totalTimeDisplay = document.getElementById('totalTime');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeBtn = document.getElementById('volumeBtn');

    const formatTime = (s) => `${Math.floor(s / 60)}:${Math.floor(s % 60).toString().padStart(2,'0')}`;

    playBtn.addEventListener('click', () => {
        if (audio.paused) { audio.play(); playIcon.style.display='none'; pauseIcon.style.display='block'; }
        else { audio.pause(); playIcon.style.display='block'; pauseIcon.style.display='none'; }
    });

    audio.addEventListener('loadedmetadata', () => {
        totalTimeDisplay.textContent = formatTime(audio.duration);
        document.getElementById('estimatedDuration').textContent = formatTime(audio.duration);
    });

    audio.addEventListener('timeupdate', () => {
        const progress = (audio.currentTime / audio.duration) * 100;
        progressFill.style.width = progress + '%';
        currentTimeDisplay.textContent = formatTime(audio.currentTime);
    });

    progressBar.addEventListener('click', (e) => {
        const rect = progressBar.getBoundingClientRect();
        audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
    });

    volumeSlider.addEventListener('input', () => audio.volume = volumeSlider.value / 100);

    volumeBtn.addEventListener('click', () => {
        if (audio.volume > 0) { audio.volume = 0; volumeSlider.value = 0; }
        else { audio.volume = 1; volumeSlider.value = 100; }
    });

    audio.addEventListener('ended', () => { playIcon.style.display='block'; pauseIcon.style.display='none'; });
}

// ================================
// ë’¤ë¡œê°€ê¸°
// ================================
function goBack() {
    if (confirm('ìˆ˜ì • í˜ì´ì§€ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) history.back();
}

// ================================
// ë°œí–‰í•˜ê¸°
// ================================
async function publishEpisode() {
    if (isPublishing) return;
    isPublishing = true;

    try {
        if (!confirm('ì—í”¼ì†Œë“œë¥¼ ë°œí–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në°œí–‰ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            isPublishing = false;
            return;
        }

        document.getElementById('loadingOverlay').style.display = 'flex';
        document.querySelector('.loading-text').textContent = 'ì—í”¼ì†Œë“œ ë°œí–‰ ì¤‘...';
        document.querySelector('.loading-subtext').textContent = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';

        const transaction = db.transaction(['drafts'], 'readonly');
        const store = transaction.objectStore('drafts');
        const request = store.get(bookId);

        request.onsuccess = async () => {
            let draftData = request.result || { episodeTitle:'ì œëª© ì—†ìŒ', pages:[], mergedAudioBlob:null, backgroundTracks:[], selectedVoiceId:'', selectedLanguage:'ko', episodeImageBlob:null, episodeImageName:'' };
            const formData = new FormData();

            formData.append('public_uuid', bookId);
            formData.append('book_id', bookId);
            formData.append('content_number', {{ latest_episode_number|default:0 }} + 1);
            formData.append('content_title', draftData.episodeTitle);
            formData.append('content_text', draftData.pages.map(p=>p.content).join('\n\n'));
            formData.append('voice_id', draftData.selectedVoiceId||'');
            formData.append('language_code', draftData.selectedLanguage||'ko');

            if (draftData.episodeImageBlob) formData.append('episode_image', draftData.episodeImageBlob, draftData.episodeImageName);

            if (draftData.mergedAudioBlob) {
                formData.append('merged_audio', new File([draftData.mergedAudioBlob], 'merged_final_audio.mp3', {type:'audio/mp3'}));
                draftData.pages.forEach((page,index)=>formData.append(`page_text_${index}`, page.isSoundEffect?'':(page.content||'')));
                // ë¯¸ë¦¬ë“£ê¸°ì—ì„œ ìƒì„±ëœ ì •í™•í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì „ì†¡
                if (draftData.mergedAudioTimestamps && draftData.mergedAudioTimestamps.length > 0) {
                    formData.append('merged_timestamps', JSON.stringify(draftData.mergedAudioTimestamps));
                }
            } else {
                draftData.pages.forEach((page,index)=>{
                    if (page.audioBlob) formData.append(`audio_${index}`, new File([page.audioBlob], `audio_${index}.mp3`, {type:'audio/mp3'}));
                    formData.append(`page_text_${index}`, page.isSoundEffect?'':(page.content||''));
                });

                if (draftData.backgroundTracks.length>0) {
                    draftData.backgroundTracks.forEach((track,index)=>{
                        if(track.audioBlob) {
                            formData.append(`background_audio_${index}`, new File([track.audioBlob], `bg_${index}.mp3`, {type:'audio/mp3'}));
                            formData.append(`background_start_${index}`, track.startPage);
                            formData.append(`background_end_${index}`, track.endPage);
                            formData.append(`background_name_${index}`, track.musicName);
                            formData.append(`background_volume_${index}`, track.volume ?? 1);
                        }
                    });
                    formData.append('background_tracks_count', draftData.backgroundTracks.length);
                } else formData.append('background_tracks_count',0);
            }

            const response = await fetch('/book/book/serialization/', { method:'POST', headers:{'X-CSRFToken':getCookie('csrftoken')}, body:formData });
            const data = await response.json();

            if (data.success) {
                const deleteTx = db.transaction(['drafts'],'readwrite');
                deleteTx.objectStore('drafts').delete(bookId);
                alert('âœ… ì—í”¼ì†Œë“œ ë°œí–‰ ì„±ê³µ!');
                window.location.href = data.redirect_url || `/book/detail/${bookId}/`;
            } else {
                alert('âŒ ë°œí–‰ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                document.getElementById('loadingOverlay').style.display='none';
            }
        };

        request.onerror = () => { alert('âŒ IndexedDBì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); isPublishing=false; document.getElementById('loadingOverlay').style.display='none'; };

    } catch(error) {
        console.error('ë°œí–‰ ì˜¤ë¥˜:', error);
        alert('âŒ ë°œí–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        isPublishing=false;
        document.getElementById('loadingOverlay').style.display='none';
    }
}

// ================================
// CSRF Helper
// ================================
function getCookie(name) {
    let cookieValue = null;
    if(document.cookie && document.cookie!=='') {
        const cookies = document.cookie.split(';');
        for(let i=0;i<cookies.length;i++){
            const cookie = cookies[i].trim();
            if(cookie.substring(0,name.length+1) === (name+'=')) { cookieValue = decodeURIComponent(cookie.substring(name.length+1)); break; }
        }
    }
    return cookieValue;
}

// ================================
// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
// ================================
document.getElementById("episodeImageInput").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(event){
        document.querySelector('.preview-image-area').innerHTML = `<img src="${event.target.result}" class="episode-image">`;
    };
    reader.readAsDataURL(file);

    const tx = db.transaction(['drafts'],'readwrite');
    const store = tx.objectStore('drafts');
    const getRequest = store.get(bookId);
    getRequest.onsuccess = ()=>{
        const draftData = getRequest.result;
        if(draftData){
            draftData.episodeImageBlob = file;
            draftData.episodeImageName = file.name;
            store.put(draftData);
        }
    };
});

</script>
{% endblock %}
