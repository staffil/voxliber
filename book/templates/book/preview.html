{% extends 'base.html' %}
{% load static %}

{% block title %}ë¯¸ë¦¬ë“£ê¸° - {{ book.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/preview.css' %}">

{% endblock %}

{% block content %}
<div class="preview-container">
    <!-- í—¤ë” -->
    <div class="preview-header">
        <!-- ì—í”¼ì†Œë“œ ì´ë¯¸ì§€ -->
        <input type="file" name="episode-image" id="episodeImageInput" accept="image/*" style="display: none;">

        <div class="preview-image-area" onclick="document.getElementById('episodeImageInput').click()">
            <div class="image-placeholder">ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
        </div>

        <div class="preview-title">ğŸ§ ë¯¸ë¦¬ë“£ê¸°</div>
        <div class="preview-subtitle" id="episodeTitle">ì—í”¼ì†Œë“œ ì œëª©</div>
        <div class="preview-info">
            <span>ğŸ“š {{ book.name }}</span>
            <span>â€¢</span>
            <span>âœï¸ {{ book.user.nickname }}</span>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
    <div class="audio-player-section">
        <div class="player-header">
            <div class="player-icon">ğŸµ</div>
            <div class="player-info">
                <h3>ìµœì¢… ì˜¤ë””ì˜¤ ë¯¸ë¦¬ë“£ê¸°</h3>
                <p>ëŒ€ì‚¬, ì‚¬ìš´ë“œ ì´íŒ©íŠ¸, ë°°ê²½ìŒì´ ëª¨ë‘ í¬í•¨ëœ ì™„ì„±ë³¸ì…ë‹ˆë‹¤</p>
            </div>
        </div>

        <audio id="previewAudio" style="display: none;"></audio>

        <div class="audio-controls">
            <button id="playBtn" class="play-btn">
                <svg id="playIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <svg id="pauseIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                </svg>
            </button>

            <div class="progress-container">
                <div class="time-display" id="currentTime">0:00</div>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display" id="totalTime">0:00</div>
            </div>

            <div class="volume-control">
                <button id="volumeBtn" class="volume-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                    </svg>
                </button>
                <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="100">
            </div>
        </div>
    </div>

    <!-- ì •ë³´ ì¹´ë“œ -->
    <div class="info-card">
        <h4>ğŸ“Š ì—í”¼ì†Œë“œ ì •ë³´</h4>
        <ul class="info-list">
            <li>
                <span class="info-label">ëŒ€ì‚¬ ê°œìˆ˜</span>
                <span class="info-value" id="dialogueCount">-</span>
            </li>
            <li>
                <span class="info-label">ë°°ê²½ìŒ</span>
                <span class="info-value" id="bgMusicCount">-</span>
            </li>
            <li>
                <span class="info-label">ì˜ˆìƒ ì¬ìƒì‹œê°„</span>
                <span class="info-value" id="estimatedDuration">-</span>
            </li>
        </ul>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="goBack()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            ìˆ˜ì •í•˜ê¸°
        </button>
        <button class="btn btn-primary" onclick="publishEpisode()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
            ë°œí–‰í•˜ê¸°
        </button>
    </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text">ì˜¤ë””ì˜¤ ìƒì„± ì¤‘...</div>
        <div class="loading-subtext">ìµœì¢… ì˜¤ë””ì˜¤ë¥¼ í•©ì¹˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
const bookId = Number({{ book.id }});
let previewAudioUrl = null;

// IndexedDB ì´ˆê¸°í™”
function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('VoxliberDrafts', 1);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            resolve(request.result);
        };

        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('drafts')) {
                db.createObjectStore('drafts', { keyPath: 'bookId' });
            }
        };
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì„ì‹œ ì˜¤ë””ì˜¤ ìƒì„±
document.addEventListener('DOMContentLoaded', async function() {
    await generatePreviewAudio();
});

// ë¯¸ë¦¬ë“£ê¸°ìš© ì„ì‹œ ì˜¤ë””ì˜¤ ìƒì„±
async function generatePreviewAudio() {
    try {
        console.log('ğŸ” ë¯¸ë¦¬ë“£ê¸° ì˜¤ë””ì˜¤ ìƒì„± ì‹œì‘, bookId:', bookId, 'type:', typeof bookId);

        // IndexedDBì—ì„œ ì„ì‹œì €ì¥ ë°ì´í„° ë¡œë“œ
        const db = await initIndexedDB();
        console.log('âœ… IndexedDB ì´ˆê¸°í™” ì™„ë£Œ');

        // ğŸ” ë””ë²„ê¹…: IndexedDBì— ì €ì¥ëœ ëª¨ë“  í‚¤ í™•ì¸
        const allKeys = await new Promise((resolve, reject) => {
            const transaction = db.transaction(['drafts'], 'readonly');
            const store = transaction.objectStore('drafts');
            const request = store.getAllKeys();

            request.onsuccess = () => {
                console.log('ğŸ—‚ï¸ IndexedDBì— ì €ì¥ëœ ëª¨ë“  í‚¤:', request.result);
                resolve(request.result);
            };

            request.onerror = () => reject(request.error);
        });

        // Wrap the get request in a Promise to properly await it
        const draftData = await new Promise((resolve, reject) => {
            const transaction = db.transaction(['drafts'], 'readonly');
            const store = transaction.objectStore('drafts');

            // ìˆ«ìì™€ ë¬¸ìì—´ ë‘˜ ë‹¤ ì‹œë„
            console.log('ğŸ” ì¡°íšŒ ì‹œë„ - bookId:', bookId, 'type:', typeof bookId);
            const request = store.get(bookId);

            request.onsuccess = () => {
                console.log('ğŸ“¦ IndexedDBì—ì„œ ë¡œë“œí•œ ë°ì´í„°:', request.result);

            
            };

            request.onerror = () => {
                console.error('âŒ IndexedDB ì¡°íšŒ ì˜¤ë¥˜:', request.error);
                reject(request.error);
            };
        });

        if (!draftData) {
            console.error('âŒ ì„ì‹œì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. bookId:', bookId);
            alert('ì„ì‹œì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            window.location.href = `/book/book_serialization/?book_id=${bookId}`;
            return;
        }

        console.log('âœ… ë°ì´í„° ë¡œë“œ ì„±ê³µ:', {
            episodeTitle: draftData.episodeTitle,
            pagesCount: draftData.pages?.length,
            backgroundTracksCount: draftData.backgroundTracks?.length
        });

        // ì œëª© í‘œì‹œ
        document.getElementById('episodeTitle').textContent = draftData.episodeTitle || 'ì œëª© ì—†ìŒ';

        // ì •ë³´ í‘œì‹œ
        if (!Array.isArray(draftData.pages)) {
                throw new Error('draftData.pagesê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤');
            }

        const dialogueCount = draftData.pages.filter(p => !p.isSoundEffect).length;
        const bgMusicCount = draftData.backgroundTracks ? draftData.backgroundTracks.length : 0;

        document.getElementById('dialogueCount').textContent = `${dialogueCount}ê°œ`;
        document.getElementById('bgMusicCount').textContent = bgMusicCount > 0 ? `${bgMusicCount}ê°œ` : 'ì—†ìŒ';

        // ì„œë²„ì— ì„ì‹œ ì˜¤ë””ì˜¤ ìƒì„± ìš”ì²­
        const formData = new FormData();
        formData.append('book_id', bookId);

        // ëŒ€ì‚¬ ì˜¤ë””ì˜¤ íŒŒì¼ ì¶”ê°€
        draftData.pages.forEach((page, index) => {
            if (page.audioBlob) {
                const audioFile = new File([page.audioBlob], `audio_${index}.mp3`, { type: 'audio/mp3' });
                formData.append(`audio_${index}`, audioFile);
            }
        });

        // ë°°ê²½ìŒ ì •ë³´ ì¶”ê°€
        if (draftData.backgroundTracks && draftData.backgroundTracks.length > 0) {
            formData.append('background_tracks_count', draftData.backgroundTracks.length);

            draftData.backgroundTracks.forEach((track, index) => {
                if (track.audioBlob) {
                    const bgFile = new File([track.audioBlob], `bg_${index}.mp3`, { type: 'audio/mp3' });
                    formData.append(`background_audio_${index}`, bgFile);
                    formData.append(`background_start_${index}`, track.startPage);
                    formData.append(`background_end_${index}`, track.endPage);
                    formData.append(`background_name_${index}`, track.musicName);
                    formData.append(`background_volume_${index}`, track.volume ?? 1);

                }
            });
        } else {
            formData.append('background_tracks_count', 0);
        }

        // ë¹„ë™ê¸° ì˜¤ë””ì˜¤ ë³‘í•© ì‹œì‘ (Celery ì‚¬ìš©)
        const response = await fetch('/book/preview/generate-async/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: formData
        });

        const data = await response.json();

        if (data.success && data.task_id) {
            console.log('âœ… ì˜¤ë””ì˜¤ ë³‘í•© íƒœìŠ¤í¬ ì‹œì‘:', data.task_id);

            // íƒœìŠ¤í¬ ìƒíƒœ í´ë§
            await pollTaskStatus(data.task_id, db, bookId);
        } else {
            alert('ì˜¤ë””ì˜¤ ìƒì„± ì‹œì‘ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            window.location.href = `/book/book_serialization/?book_id=${bookId}`;
        }
    } catch (error) {
        console.error('ë¯¸ë¦¬ë“£ê¸° ì˜¤ë””ì˜¤ ìƒì„± ì˜¤ë¥˜:', error);
        alert('ì˜¤ë””ì˜¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        window.location.href = `/book/book_serialization/?book_id=${bookId}`;
    }
}

// íƒœìŠ¤í¬ ìƒíƒœ í´ë§
async function pollTaskStatus(taskId, db, bookId) {
    const maxAttempts = 240; // ìµœëŒ€ 20ë¶„ (5ì´ˆ * 240)
    let attempts = 0;

    while (attempts < maxAttempts) {
        try {
            const response = await fetch(`/book/preview/status/${taskId}/`);
            const status = await response.json();

            console.log('ğŸ“Š íƒœìŠ¤í¬ ìƒíƒœ:', status);

            // ë¡œë”© í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const loadingText = document.querySelector('.loading-text');
            const loadingSubtext = document.querySelector('.loading-subtext');

            if (status.state === 'PROGRESS') {
                loadingText.textContent = status.status || 'ì˜¤ë””ì˜¤ ë³‘í•© ì¤‘...';
                loadingSubtext.textContent = `ì§„í–‰ë¥ : ${status.progress || 0}%`;
            } else if (status.state === 'SUCCESS') {
                console.log('âœ… ì˜¤ë””ì˜¤ ë³‘í•© ì™„ë£Œ!');
                loadingText.textContent = 'ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì¤‘...';
                loadingSubtext.textContent = 'ì™„ì„±ëœ ì˜¤ë””ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.';

                // ì˜¤ë””ì˜¤ URL ê°€ì ¸ì˜¤ê¸°
                const audioUrl = status.audio_url;
                if (audioUrl) {
                    // ì˜¤ë””ì˜¤ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    const audioResponse = await fetch(audioUrl);
                    const blob = await audioResponse.blob();

                    previewAudioUrl = URL.createObjectURL(blob);
                    const audio = document.getElementById('previewAudio');
                    audio.src = previewAudioUrl;
                    initAudioPlayer();

                    // IndexedDBì— ì €ì¥
                    try {
                        const updateTransaction = db.transaction(['drafts'], 'readwrite');
                        const updateStore = updateTransaction.objectStore('drafts');

                        const getRequest = updateStore.get(bookId);
                        getRequest.onsuccess = () => {
                            const existingData = getRequest.result;
                            if (existingData) {
                                existingData.mergedAudioBlob = blob;
                                existingData.mergedAudioTimestamp = new Date().toISOString();
                                updateStore.put(existingData);
                                console.log('âœ… ìµœì¢… mergeëœ ì˜¤ë””ì˜¤ IndexedDB ì €ì¥ ì™„ë£Œ');
                            }
                        };
                    } catch (error) {
                        console.error('âŒ mergeëœ ì˜¤ë””ì˜¤ ì €ì¥ ì‹¤íŒ¨:', error);
                    }

                    // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
                    document.getElementById('loadingOverlay').style.display = 'none';
                    console.log('âœ… ë¯¸ë¦¬ë“£ê¸° ì˜¤ë””ì˜¤ ìƒì„± ì™„ë£Œ');
                    return;
                } else {
                    throw new Error('ì˜¤ë””ì˜¤ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else if (status.state === 'FAILURE') {
                console.error('âŒ íƒœìŠ¤í¬ ì‹¤íŒ¨:', status.error);
                alert('ì˜¤ë””ì˜¤ ë³‘í•© ì‹¤íŒ¨: ' + (status.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                window.location.href = `/book/book_serialization/?book_id=${bookId}`;
                return;
            }

            // 5ì´ˆ ëŒ€ê¸°
            await new Promise(resolve => setTimeout(resolve, 5000));
            attempts++;

        } catch (error) {
            console.error('âŒ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            attempts++;
            await new Promise(resolve => setTimeout(resolve, 5000));
        }
    }

    // íƒ€ì„ì•„ì›ƒ
    alert('ì˜¤ë””ì˜¤ ìƒì„± ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    window.location.href = `/book/book_serialization/?book_id=${bookId}`;
}

// ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì´ˆê¸°í™”
function initAudioPlayer() {
    const audio = document.getElementById('previewAudio');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const currentTimeDisplay = document.getElementById('currentTime');
    const totalTimeDisplay = document.getElementById('totalTime');
    const volumeBtn = document.getElementById('volumeBtn');
    const volumeSlider = document.getElementById('volumeSlider');

    // ì‹œê°„ í¬ë§·íŒ…
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // ì¬ìƒ/ì¼ì‹œì •ì§€
    playBtn.addEventListener('click', function() {
        if (audio.paused) {
            audio.play();
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';
        } else {
            audio.pause();
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
        }
    });

    // ë©”íƒ€ë°ì´í„° ë¡œë“œ
    audio.addEventListener('loadedmetadata', function() {
        totalTimeDisplay.textContent = formatTime(audio.duration);
        document.getElementById('estimatedDuration').textContent = formatTime(audio.duration);
    });

    // ì¬ìƒ ì¤‘ ì§„í–‰
    audio.addEventListener('timeupdate', function() {
        const progress = (audio.currentTime / audio.duration) * 100;
        progressFill.style.width = progress + '%';
        currentTimeDisplay.textContent = formatTime(audio.currentTime);
    });

    // ì§„í–‰ ë°” í´ë¦­
    progressBar.addEventListener('click', function(e) {
        const rect = progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        audio.currentTime = percent * audio.duration;
    });

    // ë³¼ë¥¨ ì¡°ì ˆ
    volumeSlider.addEventListener('input', function() {
        audio.volume = volumeSlider.value / 100;
    });

    volumeBtn.addEventListener('click', function() {
        if (audio.volume > 0) {
            audio.volume = 0;
            volumeSlider.value = 0;
        } else {
            audio.volume = 1;
            volumeSlider.value = 100;
        }
    });

    // ì¬ìƒ ì¢…ë£Œ
    audio.addEventListener('ended', function() {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
    });
}

let isPublishing = false;


// ë’¤ë¡œê°€ê¸°
function goBack() {
    if (confirm('ìˆ˜ì • í˜ì´ì§€ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    history.back();
    }
}

// ë°œí–‰í•˜ê¸°
async function publishEpisode() {
    if (isPublishing) return;  // ì´ë¯¸ ë°œí–‰ ì¤‘ì´ë©´ ë¬´ì‹œ
    isPublishing = true;
    try {
        if (!confirm('ì—í”¼ì†Œë“œë¥¼ ë°œí–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në°œí–‰ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            isPublishing = false;
            return;
        }
        // ë¡œë”© í‘œì‹œ
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.querySelector('.loading-text').textContent = 'ì—í”¼ì†Œë“œ ë°œí–‰ ì¤‘...';
        document.querySelector('.loading-subtext').textContent = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';

        // IndexedDBì—ì„œ ë°ì´í„° ë¡œë“œ
        const db = await initIndexedDB();
        const transaction = db.transaction(['drafts'], 'readonly');
        const store = transaction.objectStore('drafts');
        const request = store.get(bookId);

        request.onsuccess = async () => {
            const draftData = request.result;

            const formData = new FormData();
            formData.append('book_id', bookId);
            formData.append('content_number', {{ latest_episode_number|default:0 }} + 1);
            formData.append('content_title', draftData.episodeTitle);
            formData.append('content_text', draftData.pages.map(p => p.content).join('\n\n'));
            formData.append('voice_id', draftData.selectedVoiceId || '');
            formData.append('language_code', draftData.selectedLanguage || 'ko');

            // ğŸ”¥ ì—í”¼ì†Œë“œ ì´ë¯¸ì§€ ì¶”ê°€
            if (draftData.episodeImageBlob) {
                console.log('âœ… ì—í”¼ì†Œë“œ ì´ë¯¸ì§€ ì „ì†¡:', draftData.episodeImageName);
                formData.append('episode_image', draftData.episodeImageBlob, draftData.episodeImageName);
            }

            // ğŸ”¥ ë¯¸ë¦¬ë“£ê¸°ì—ì„œ ìƒì„±ëœ ìµœì¢… mergeëœ ì˜¤ë””ì˜¤ ì‚¬ìš©
            if (draftData.mergedAudioBlob) {
                console.log('âœ… ë¯¸ë¦¬ë“£ê¸°ì—ì„œ ìƒì„±ëœ ìµœì¢… merge ì˜¤ë””ì˜¤ ì‚¬ìš© (ë°°ê²½ìŒ í¬í•¨)');
                const mergedAudioFile = new File([draftData.mergedAudioBlob], 'merged_final_audio.mp3', { type: 'audio/mp3' });
                formData.append('merged_audio', mergedAudioFile);

                // í˜ì´ì§€ í…ìŠ¤íŠ¸ ì •ë³´ (íƒ€ì„ìŠ¤íƒ¬í”„ ë§¤í•‘ìš©)
                draftData.pages.forEach((page, index) => {
                    formData.append(`page_text_${index}`, page.isSoundEffect ? '' : (page.content || ''));
                });
            } else {
                // ë¯¸ë¦¬ë“£ê¸°ë¥¼ í•˜ì§€ ì•Šì€ ê²½ìš° - ê°œë³„ ì˜¤ë””ì˜¤ íŒŒì¼ë“¤ ì „ì†¡ (ê¸°ì¡´ ë°©ì‹)
                console.log('âš ï¸ ë¯¸ë¦¬ë“£ê¸° ì˜¤ë””ì˜¤ê°€ ì—†ìŒ - ê°œë³„ íŒŒì¼ ì „ì†¡');

                // ëŒ€ì‚¬ ì˜¤ë””ì˜¤ íŒŒì¼ ì¶”ê°€
                draftData.pages.forEach((page, index) => {
                    if (page.audioBlob) {
                        const audioFile = new File([page.audioBlob], `audio_${index}.mp3`, { type: 'audio/mp3' });
                        formData.append(`audio_${index}`, audioFile);
                    }
                    formData.append(`page_text_${index}`, page.isSoundEffect ? '' : (page.content || ''));
                });

                // ë°°ê²½ìŒ ì •ë³´ ì¶”ê°€
                if (draftData.backgroundTracks && draftData.backgroundTracks.length > 0) {
                    formData.append('background_tracks_count', draftData.backgroundTracks.length);

                    draftData.backgroundTracks.forEach((track, index) => {
                        if (track.audioBlob) {
                            const bgFile = new File([track.audioBlob], `bg_${index}.mp3`, { type: 'audio/mp3' });
                            formData.append(`background_audio_${index}`, bgFile);
                            formData.append(`background_start_${index}`, track.startPage);
                            formData.append(`background_end_${index}`, track.endPage);
                            formData.append(`background_name_${index}`, track.musicName);
                            formData.append(`background_volume_${index}`, track.volume ?? 1);
                        }
                    });
                } else {
                    formData.append('background_tracks_count', 0);
                }
            }

            const response = await fetch('/book/book_serialization/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // ì„ì‹œì €ì¥ ì‚­ì œ
                const deleteTransaction = db.transaction(['drafts'], 'readwrite');
                const deleteStore = deleteTransaction.objectStore('drafts');
                const normalizedBookId = Number(bookId);
                await deleteStore.delete(normalizedBookId);

                alert('ì—í”¼ì†Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!');
                window.location.href = data.redirect_url || `/book/detail/${bookId}/`;
            } else {
                alert('ë°œí–‰ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        };
    } catch (error) {
        console.error('ë°œí–‰ ì˜¤ë¥˜:', error);
        alert('ë°œí–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
// ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ AJAXë¡œ ì²˜ë¦¬ (í˜ì´ì§€ ë¦¬ë¡œë“œ ë°©ì§€)
document.getElementById("episodeImageInput").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    const reader = new FileReader();
    reader.onload = function(event) {
        const imageArea = document.querySelector('.preview-image-area');
        imageArea.innerHTML = `<img src="${event.target.result}" class="episode-image">`;
    };
    reader.readAsDataURL(file);

    // IndexedDBì— ì´ë¯¸ì§€ ì €ì¥
    try {
        const db = await initIndexedDB();
        const transaction = db.transaction(['drafts'], 'readwrite');
        const store = transaction.objectStore('drafts');

        // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const getRequest = store.get(bookId);
        getRequest.onsuccess = () => {
            const draftData = getRequest.result;
            if (draftData) {
                // ì´ë¯¸ì§€ blob ì €ì¥
                draftData.episodeImageBlob = file;
                draftData.episodeImageName = file.name;
                store.put(draftData);
                console.log('âœ… ì—í”¼ì†Œë“œ ì´ë¯¸ì§€ IndexedDBì— ì €ì¥ ì™„ë£Œ');
            }
        };
    } catch (error) {
        console.error('âŒ ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:', error);
    }
});

</script>
{% endblock %}
