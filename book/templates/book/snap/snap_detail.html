
{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ snap.snap_title }} - VOXLIBER ì‡¼ì¸ </title>
<link rel="stylesheet" href="{% static 'css/book/snap/snap_detail.css' %}">
</head>
<body>
    <!-- ë©”ì¸ ì‡¼ì¸  ì»¨í…Œì´ë„ˆ -->
    <div class="shorts-container">
        <!-- ìƒë‹¨ í—¤ë” -->
        <div class="shorts-header">
            <div class="header-left">
                <a href="/" style="text-decoration: none;">
                    <div class="logo">VOXLIBER</div>
                </a>
                <div class="shorts-badge">SNAP</div>
            </div>
            <button class="close-btn" onclick="window.location.href='/'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>

        <!-- ë¹„ë””ì˜¤ ì˜ì—­ -->
        <div class="video-wrapper" id="videoWrapper">
            {% if snap.snap_video %}
                <video id="mainVideo" playsinline loop>
                    <source src="{{ snap.snap_video.url }}" type="video/mp4">
                </video>
                <div class="play-overlay visible" id="playOverlay">
                    <div class="play-icon">â–¶</div>
                </div>
                <div class="video-controls">
    <div class="time-display" id="timeDisplay">00:00 / 00:00</div>

    <div class="seekbar-container">
        <input type="range" id="seekBar" min="0" max="100" value="0" data-login-required>
    </div>
</div>
            {% elif snap.snap_image %}
                <img src="{{ snap.snap_image.url }}" alt="{{ snap.snap_title }}">
            {% elif snap.thumbnail %}
                <img src="{{ snap.thumbnail.url }}" alt="{{ snap.snap_title }}">
            {% else %}
                <div style="text-align: center; color: rgba(255,255,255,0.5);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“–</div>
                    <div>ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            {% endif %}
        </div>

<!-- ì˜¤ë¥¸ìª½ ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
<div class="actions-panel">
    <!-- ì¢‹ì•„ìš” -->
    <div class="action-btn" id="likeBtn" data-snap-id="{{ snap.id }}" data-login-required>
        <div class="action-icon" id="likeIcon">
            {% if user in snap.booksnap_like.all %}
                â¤ï¸
            {% else %}
                ğŸ¤
            {% endif %}
        </div>
<div class="action-count" id="likeCount">{{ snap.booksnap_like.count }}</div>
    </div>

    <!-- ëŒ“ê¸€ -->
    <div class="action-btn" id="commentBtn" data-snap-id="{{ snap.id }}" data-login-required>
        <div class="action-icon">ğŸ’¬</div>
        <div class="action-count">{{ comments.count }}</div>
    </div>

    <!-- ê³µìœ  -->
    <div class="action-btn" id="shareBtn" data-login-required>
        <div class="action-icon">ğŸ”—</div>
        <div class="action-count">ê³µìœ </div>
    </div>

    <!-- ì¡°íšŒìˆ˜ -->
    <div class="action-btn" id="viewBtn" data-snap-id="{{ snap.id }}" data-login-required>
        <div class="action-icon">ğŸ‘ï¸</div>
        <div class="action-count" id="viewCount">{{ snap.views|default:0 }}</div>
    </div>
</div>


        <!-- í•˜ë‹¨ ì •ë³´ ì˜ì—­ -->
        <div class="info-panel">
            <div class="author-info">
                <div class="author-avatar">
                    {% if snap.user.user_img %}
                        <img src="{{ snap.user.user_img.url }}" alt="{{ snap.user.nickname }}">
                    {% else %}
                        {{ snap.user.nickname|slice:":1"|upper }}
                    {% endif %}
                </div>
                <div class="author-name">{{ snap.user.nickname }}</div>

            </div>
            <div class="snap-title">{{ snap.snap_title }}</div>
            <div class="snap-description">{{ snap.book_comment }}</div>
<a href="{{ snap.book_link }}" class="arrow-link" data-login-required>ì±… ë³´ëŸ¬ ê°€ê¸°</a>
        </div>


    </div>

    <!-- ëŒ“ê¸€ íŒ¨ë„ -->
    <div class="comments-panel" id="commentsPanel">
        <div class="comments-header">
            <div class="comments-title">ëŒ“ê¸€ {{ comments.count }}ê°œ</div>
            <button class="close-btn" onclick="toggleComments()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="comments-list" id="commentsList">
            {% for comment in comments %}
                <div class="comment-item">
                    <div class="comment-author">{{ comment.user.nickname }}</div>
                    <div class="comment-text">{{ comment.content }}</div>
                    <div class="comment-time">{{ comment.created_at|timesince }} ì „</div>
                </div>
            {% empty %}
                <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px 20px;">
                    ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
                </div>
            {% endfor %}
        </div>
        {% if user.is_authenticated %}
            <div class="comment-input-wrapper">
                <input type="text" class="comment-input" id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleCommentKeyPress(event)" data-login-required>
            </div>
        {% endif %}
    </div>
<script>
const snapId = '{{ snap.public_uuid }}';
const prevSnapId = '{{ prev_snap_uuid|default:"null" }}';
const nextSnapId = '{{ next_snap_uuid|default:"null" }}';
const video = document.getElementById('mainVideo');
const playOverlay = document.getElementById('playOverlay');
const videoWrapper = document.getElementById('videoWrapper');
const closeCommentsBtn = document.querySelector('#commentsPanel .close-btn');
const likeBtn = document.getElementById('likeBtn');
const viewBtn = document.getElementById('viewBtn');
const seekBar = document.getElementById("seekBar");
const timeDisplay = document.getElementById("timeDisplay");

// ===================== ì¡°íšŒìˆ˜ ì¦ê°€ (ì¤‘ë³µ ë°©ì§€) =====================
fetch(`/book/book/snap/${snapId}/view/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': getCookie('csrftoken') }
})
.then(res => res.json())
.then(data => {
    document.getElementById('viewCount').textContent = data.views;
})
.catch(err => console.error(err));

// ===================== ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ =====================
if (video) {
    videoWrapper.addEventListener('click', function(e) {
        if (e.target === video || e.target === playOverlay || e.target.closest('.play-overlay')) {
            if (video.paused) {
                video.play();
                playOverlay.classList.remove('visible');
            } else {
                video.pause();
                playOverlay.classList.add('visible');
            }
        }
    });

    video.addEventListener('play', () => playOverlay.classList.remove('visible'));
    video.addEventListener('pause', () => playOverlay.classList.add('visible'));

    video.play().catch(() => playOverlay.classList.add('visible'));
}

// ===================== ì¢‹ì•„ìš” í† ê¸€ =====================
likeBtn.addEventListener('click', function() {
    fetch(`/book/book/snap/${snapId}/like/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById('likeCount').textContent = data.likes;
        document.getElementById('likeIcon').textContent = data.liked ? 'â¤ï¸' : 'ğŸ¤';
    })
    .catch(err => console.error(err));
});

// ===================== ëŒ“ê¸€ í† ê¸€ =====================
document.getElementById('commentBtn').addEventListener('click', function() {
    document.getElementById('commentsPanel').classList.toggle('open');
});

closeCommentsBtn.addEventListener('click', function() {
    commentsPanel.classList.remove('open'); // ë‹«ê¸°
});

// ===================== ëŒ“ê¸€ ì‘ì„± =====================
function toggleComments(event) {
    if (event.key !== 'Enter') return;
    const content = event.target.value.trim();
    if (!content) return;

    fetch(`/book/book/snap/${snapId}/comment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `content=${encodeURIComponent(content)}`
    })
    .then(res => res.json())
    .then(data => {
        const commentsList = document.getElementById('commentsList');
        const commentHTML = `
            <div class="comment-item">
                <div class="comment-author">${data.user}</div>
                <div class="comment-text">${data.content}</div>
                <div class="comment-time">ë°©ê¸ˆ ì „</div>
            </div>
        `;
        commentsList.insertAdjacentHTML('afterbegin', commentHTML);
        event.target.value = '';
    })
    .catch(err => console.error(err));
}

// ===================== ê³µìœ  =====================
document.getElementById('shareBtn').addEventListener('click', function() {
    const url = window.location.href;
    if (navigator.share) {
        navigator.share({ title: '{{ snap.snap_title }}', url });
    } else {
        navigator.clipboard.writeText(url);
        alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
});

// ===================== ìŠ¤ëƒ… ë„¤ë¹„ê²Œì´ì…˜ =====================
function navigateSnap(snapId) {
    window.location.href = `/book/book/snap/${snapId}/`;
}

// ===================== ë“œë˜ê·¸/ìŠ¤ì™€ì´í”„/íœ /í‚¤ë³´ë“œ =====================
let startY = 0, startX = 0, isDragging = false, startTime = 0;

function startDrag(e) {
    if (e.target.closest('button, a, input, .action-btn')) return;
    startY = e.touches ? e.touches[0].clientY : e.clientY;
    startX = e.touches ? e.touches[0].clientX : e.clientX;
    startTime = Date.now();
    isDragging = true;
}

function endDrag(e, isTouch) {
    if (!isDragging) return;
    const endY = isTouch ? e.changedTouches[0].clientY : e.clientY;
    const endX = isTouch ? e.changedTouches[0].clientX : e.clientX;
    const deltaY = startY - endY;
    const deltaX = Math.abs(startX - endX);
    const deltaTime = Date.now() - startTime;

    if (Math.abs(deltaY) > deltaX && Math.abs(deltaY) > (isTouch ? 50 : 80) && deltaTime < (isTouch ? 500 : 800)) {
        if (deltaY > 0 && nextSnapId) navigateSnap(nextSnapId);
        else if (deltaY < 0 && prevSnapId) navigateSnap(prevSnapId);
    }
    isDragging = false;
}

// í„°ì¹˜ ì´ë²¤íŠ¸
document.addEventListener('touchstart', startDrag, { passive: true });
document.addEventListener('touchend', e => endDrag(e, true), { passive: true });

// ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
document.addEventListener('mousedown', startDrag);
document.addEventListener('mouseup', e => endDrag(e, false));
document.addEventListener('mouseleave', () => isDragging = false);

// íœ  ìŠ¤í¬ë¡¤ ë„¤ë¹„ê²Œì´ì…˜
let wheelTimeout, lastWheelTime = 0;
document.addEventListener('wheel', function(e) {
    const now = Date.now();
    if (now - lastWheelTime < 500) return;

    clearTimeout(wheelTimeout);
    wheelTimeout = setTimeout(() => {
        if (e.deltaY > 0 && nextSnapId) navigateSnap(nextSnapId);
        else if (e.deltaY < 0 && prevSnapId) navigateSnap(prevSnapId);
        lastWheelTime = Date.now();
    }, 50);
}, { passive: true });

// í‚¤ë³´ë“œ
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowUp' && prevSnapId) navigateSnap(prevSnapId);
    else if (e.key === 'ArrowDown' && nextSnapId) navigateSnap(nextSnapId);
});


function handleCommentKeyPress(event) {
    if (event.key !== 'Enter') return;
    const content = event.target.value.trim();
    if (!content) return;

    fetch(`/book/book/snap/${snapId}/comment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `content=${encodeURIComponent(content)}`
    })
    .then(res => res.json())
    .then(data => {
        const commentsList = document.getElementById('commentsList');
        const commentHTML = `
            <div class="comment-item">
                <div class="comment-author">${data.user}</div>
                <div class="comment-text">${data.content}</div>
                <div class="comment-time">ë°©ê¸ˆ ì „</div>
            </div>
        `;
        commentsList.insertAdjacentHTML('afterbegin', commentHTML);
        event.target.value = '';
    })
    .catch(err => console.error(err));
}

// ===================== CSRF =====================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function formatTime(t) {
    const m = Math.floor(t / 60);
    const s = Math.floor(t % 60);
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

video.addEventListener("loadedmetadata", () => {
    timeDisplay.textContent = `00:00 / ${formatTime(video.duration)}`;
});

video.addEventListener("timeupdate", () => {
    const progress = (video.currentTime / video.duration) * 100;
    seekBar.value = progress;
    timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
});

seekBar.addEventListener("input", (e) => {
    e.stopPropagation();
});
seekBar.addEventListener("mousedown", (e) => {
    e.stopPropagation();
});
seekBar.addEventListener("touchstart", (e) => {
    e.stopPropagation();
});
</script>

</body>
</html>
