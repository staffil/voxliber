{% extends "base.html" %}
{% load static %}

{% block title %}ê´‘ê³  - VOXLIBER{% endblock %}

{% block extra_css %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c26;
    --accent: #c8f542;
    --accent2: #7b5ea7;
    --text: #f0f0f0;
    --muted: #666680;
    --border: rgba(255,255,255,0.06);
    --glow: 0 0 40px rgba(200, 245, 66, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: #000;
    overflow: hidden;
    color: var(--text);
  }

  /* â”€â”€ ë©”ì¸ ì»¨í…Œì´ë„ˆ â”€â”€ */
  .shorts-container {
    width: 100vw;
    height: 100vh;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #000;
  }

  /* â”€â”€ ë¹„ë””ì˜¤ ë˜í¼ â”€â”€ */
  .video-wrapper {
    position: relative;
    width: min(calc(100vh * 9 / 16), 100vw);
    height: 100vh;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .video-wrapper video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #000;
  }

  /* â”€â”€ ì‹œí¬ë°” â”€â”€ */
  .video-controls {
    position: absolute;
    bottom: 20px;
    width: 90%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    z-index: 10;
    pointer-events: auto;
  }

  .time-display {
    margin-bottom: 6px;
    opacity: 0.6;
    font-size: 11px;
    color: var(--text);
  }

  .seekbar-container {
    width: 100%;
    height: 3px;
    background: rgba(255,255,255,0.2);
    border-radius: 5px;
    cursor: pointer;
    position: relative;
  }

  .seekbar-progress {
    height: 100%;
    background: var(--accent);
    border-radius: 5px;
    width: 0%;
    transition: width 0.1s linear;
    box-shadow: 0 0 6px var(--accent);
  }

  /* â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€ */
  .shorts-header {
    position: absolute;
    top: 0; left: 0; right: 0;
    padding: 20px 24px;
    background: linear-gradient(180deg, rgba(0,0,0,0.75) 0%, transparent 100%);
    z-index: 10;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 26px;
    letter-spacing: 0.05em;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-decoration: none;
  }

  .shorts-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    background: rgba(255,255,255,0.08);
    border: 1px solid var(--border);
    padding: 5px 12px;
    border-radius: 20px;
  }

  .shorts-badge::before {
    content: '';
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 6px var(--accent);
    animation: blink 2s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .close-btn {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .close-btn:hover {
    background: rgba(255,255,255,0.2);
    color: var(--text);
    transform: scale(1.05);
  }

  /* â”€â”€ ì˜¤ë¥¸ìª½ ì•¡ì…˜ íŒ¨ë„ â”€â”€ */
  .actions-panel {
    position: absolute;
    right: 16px;
    bottom: 120px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 24px;
    align-items: center;
  }

  .action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .action-btn:hover { transform: scale(1.1); }

  .action-icon {
    width: 48px; height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.3s;
  }

  .action-btn:hover .action-icon {
    background: rgba(255,255,255,0.22);
    border-color: rgba(255,255,255,0.2);
  }

  .action-count {
    font-size: 11px;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }

  /* ìŠ¤í‚µ ë²„íŠ¼ â€” ë¹„í™œì„± */
  .skip-btn {
    opacity: 0.35;
    pointer-events: none;
    transition: opacity 0.4s, transform 0.2s;
  }

  .skip-btn.active {
    opacity: 1;
    pointer-events: auto;
  }

  .skip-btn.active .action-icon {
    border-color: var(--accent);
    box-shadow: 0 0 16px rgba(200,245,66,0.25);
  }

  .skip-btn.active .action-count {
    color: var(--accent);
  }

  /* â”€â”€ í•˜ë‹¨ ì •ë³´ â”€â”€ */
  .info-panel {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    padding: 28px 24px 80px;
    background: linear-gradient(0deg, rgba(0,0,0,0.85) 0%, transparent 100%);
    z-index: 10;
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .author-avatar {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    flex-shrink: 0;
  }

  .author-name {
    font-size: 14px;
    font-weight: 600;
    flex: 1;
    color: var(--text);
  }

  .ad-badge-inline {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.6);
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
    padding: 4px 10px;
    border-radius: 20px;
  }

  .snap-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 26px;
    letter-spacing: 0.03em;
    margin-bottom: 8px;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .snap-description {
    font-size: 13px;
    color: rgba(255,255,255,0.65);
    line-height: 1.5;
    margin-bottom: 12px;
  }

  .arrow-link {
    color: var(--accent);
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.05em;
    transition: opacity 0.2s;
  }

  .arrow-link::after { content: " â†’"; }
  .arrow-link:hover { opacity: 0.8; }

  /* â”€â”€ í”Œë ˆì´ ì˜¤ë²„ë ˆì´ â”€â”€ */
  .play-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.3);
    cursor: pointer;
    z-index: 5;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .play-overlay.visible { opacity: 1; }

  .play-icon {
    width: 76px; height: 76px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(8px);
    border: 2px solid rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: #fff;
    transition: transform 0.15s;
  }

  .play-icon:hover { transform: scale(1.1); }

  /* â”€â”€ íœ  íŒíŠ¸ â”€â”€ */
  .scroll-hint {
    position: absolute;
    bottom: 14px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: rgba(255,255,255,0.3);
    letter-spacing: 0.08em;
    z-index: 10;
    animation: fadeHint 3s ease forwards;
    white-space: nowrap;
  }

  @keyframes fadeHint {
    0%   { opacity: 0; }
    20%  { opacity: 1; }
    80%  { opacity: 1; }
    100% { opacity: 0; }
  }

  @media (max-width: 768px) {
    .actions-panel { right: 12px; bottom: 100px; gap: 18px; }
    .action-icon { width: 44px; height: 44px; font-size: 20px; }
    .info-panel { padding: 20px 16px 70px; }
  }
</style>
{% endblock %}

{% block content %}
<div class="shorts-container">

  <!-- ìƒë‹¨ í—¤ë” -->
  <div class="shorts-header">
    <div class="header-left">
      <a href="/" style="text-decoration:none;">
        <div class="logo">VOXLIBER</div>
      </a>
      <div class="shorts-badge">AD</div>
    </div>
    <button class="close-btn" onclick="history.back()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>

  <!-- ë¹„ë””ì˜¤ ì˜ì—­ -->
  <div class="video-wrapper" id="videoWrapper" onclick="togglePlay()">
    <video id="adVideo" src="{{ ad.video.url }}" playsinline
      {% if ad.thumbnail %}poster="{{ ad.thumbnail.url }}"{% endif %}></video>

    <div class="play-overlay" id="playOverlay">
      <div class="play-icon">â–¶</div>
    </div>

    <div class="video-controls" onclick="event.stopPropagation()">
      <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
      <div class="seekbar-container" id="seekbarContainer">
        <div class="seekbar-progress" id="seekbarProgress"></div>
      </div>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½ ì•¡ì…˜ íŒ¨ë„ -->
  <div class="actions-panel">

    {% if ad.link_url %}
    <div class="action-btn" onclick="recordClick(); window.open('{{ ad.link_url }}', '_blank');">
      <div class="action-icon">ğŸ”—</div>
      <div class="action-count">ë°”ë¡œê°€ê¸°</div>
    </div>
    {% endif %}

    <!-- ìŠ¤í‚µ -->
    <div class="action-btn skip-btn" id="skipBtn" onclick="skipAd()">
      <div class="action-icon">â­</div>
      <div class="action-count" id="skipLabel">5ì´ˆ</div>
    </div>

  </div>

  <!-- í•˜ë‹¨ ì •ë³´ -->
  <div class="info-panel">
    <div class="author-info">
      <div class="author-avatar">ğŸ“¢</div>
      <div class="author-name">{{ ad.title }}</div>
      <div class="ad-badge-inline">ê´‘ê³ </div>
    </div>
    <div class="snap-title">{{ ad.title }}</div>
    <div class="snap-description">ì ì‹œ í›„ ì½˜í…ì¸ ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤</div>
    {% if ad.link_url %}
      <a href="{{ ad.link_url }}" class="arrow-link" target="_blank" onclick="recordClick()">ë” ì•Œì•„ë³´ê¸°</a>
    {% endif %}
  </div>

  <div class="scroll-hint" id="scrollHint">â†“ ìŠ¤í¬ë¡¤í•˜ì—¬ ë‹¤ìŒìœ¼ë¡œ</div>

</div>
{% endblock %}

{% block extra_js %}
<script>
  const video          = document.getElementById('adVideo');
  const playOverlay    = document.getElementById('playOverlay');
  const seekbarProgress = document.getElementById('seekbarProgress');
  const timeDisplay    = document.getElementById('timeDisplay');
  const skipBtn        = document.getElementById('skipBtn');
  const skipLabel      = document.getElementById('skipLabel');

  let skipReady = false;
  let skipTimer = 5;
  let navigating = false;

  /* â”€â”€ ë‹¤ìŒ URL â”€â”€ */
  {% if next_snap %}
    const NEXT_URL = "{% url 'book:book_snap_detail' next_snap.public_uuid %}?skip_ad=1";
  {% elif next_content %}
    const NEXT_URL = "{% url 'book:content_detail' next_content.public_uuid %}?skip_count=1";
  {% else %}
    const NEXT_URL = null;
  {% endif %}

  function fmt(s) {
    const m = Math.floor(s / 60);
    return `${m}:${String(Math.floor(s % 60)).padStart(2, '0')}`;
  }

  /* â”€â”€ ìë™ì¬ìƒ â”€â”€ */
  window.addEventListener('DOMContentLoaded', () => {
    video.play().then(() => setPlaying(true)).catch(() => setPlaying(false));
    startSkipTimer();
  });

  function setPlaying(state) {
    playOverlay.classList.toggle('visible', !state);
  }

  function togglePlay() {
    if (video.paused) { video.play(); setPlaying(true); }
    else              { video.pause(); setPlaying(false); }
  }

  video.addEventListener('loadedmetadata', () => {
    timeDisplay.textContent = `0:00 / ${fmt(video.duration)}`;
  });

  video.addEventListener('timeupdate', () => {
    if (!video.duration) return;
    seekbarProgress.style.width = (video.currentTime / video.duration * 100) + '%';
    timeDisplay.textContent = `${fmt(video.currentTime)} / ${fmt(video.duration)}`;
  });

  document.getElementById('seekbarContainer').addEventListener('click', function(e) {
    e.stopPropagation();
    video.currentTime = ((e.clientX - this.getBoundingClientRect().left) / this.offsetWidth) * video.duration;
  });

  /* â”€â”€ ì¬ìƒ ì¢…ë£Œ â†’ ìë™ ì´ë™ â”€â”€ */
  video.addEventListener('ended', () => {
    setPlaying(false);
    seekbarProgress.style.width = '100%';
    if (NEXT_URL) {
      skipLabel.textContent = 'ì´ë™ ì¤‘';
      setTimeout(() => goNext(), 1500);
    }
  });

  /* â”€â”€ ìŠ¤í‚µ íƒ€ì´ë¨¸ â”€â”€ */
  function startSkipTimer() {
    const interval = setInterval(() => {
      skipTimer--;
      if (skipTimer <= 0) {
        clearInterval(interval);
        skipReady = true;
        skipBtn.classList.add('active');
        skipLabel.textContent = 'ìŠ¤í‚µ';
      } else {
        skipLabel.textContent = `${skipTimer}ì´ˆ`;
      }
    }, 1000);
  }

  /* â”€â”€ ìŠ¤í‚µ í´ë¦­ â”€â”€ */
  function skipAd() {
    if (!skipReady) return;
    fetch("{% url 'book:ad_skip' ad.public_uuid %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      body: JSON.stringify({ watched_seconds: Math.floor(video.currentTime) })
    }).finally(() => goNext());
  }

  /* â”€â”€ íœ  ìŠ¤í¬ë¡¤ë¡œ ë‹¤ìŒ ì´ë™ â”€â”€ */
  let wheelLock = false;
  window.addEventListener('wheel', (e) => {
    if (!skipReady || wheelLock) return;
    if (e.deltaY > 30) {   // ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
      wheelLock = true;
      goNext();
    }
  }, { passive: true });

  /* ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ */
  let touchStartY = 0;
  window.addEventListener('touchstart', (e) => { touchStartY = e.touches[0].clientY; }, { passive: true });
  window.addEventListener('touchend', (e) => {
    if (!skipReady) return;
    const dy = touchStartY - e.changedTouches[0].clientY;
    if (dy > 50) goNext();   // ìœ„ë¡œ ìŠ¤ì™€ì´í”„ â†’ ë‹¤ìŒ
  }, { passive: true });

  function goNext() {
    if (navigating) return;
    navigating = true;
    if (NEXT_URL) {
      window.location.href = NEXT_URL;
    } else {
      history.back();
    }
  }

  function recordClick() {
    fetch("{% url 'book:ad_click' ad.public_uuid %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    });
  }
</script>
{% endblock %}