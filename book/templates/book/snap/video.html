{% extends "base.html" %}
{% load static %}

{% block title %}ê´‘ê³  - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/advertisment/video.css' %}">

{% endblock %}

{% block content %}
<div class="shorts-container">

  <!-- ìƒë‹¨ í—¤ë” -->
  <div class="shorts-header">
    <div class="header-left">
      <a href="/" style="text-decoration:none;">
        <div class="logo">VOXLIBER</div>
      </a>
      <div class="shorts-badge">AD</div>
    </div>
    <button class="close-btn" onclick="history.back()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>

  <!-- ë¹„ë””ì˜¤ ì˜ì—­ -->
  <div class="video-wrapper" id="videoWrapper" onclick="togglePlay()">
    <video id="adVideo" src="{{ ad.video.url }}" playsinline
      {% if ad.thumbnail %}poster="{{ ad.thumbnail.url }}"{% endif %}></video>

    <div class="play-overlay" id="playOverlay">
      <div class="play-icon">â–¶</div>
    </div>

    <div class="video-controls" onclick="event.stopPropagation()">
      <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
      <div class="seekbar-container" id="seekbarContainer">
        <div class="seekbar-progress" id="seekbarProgress"></div>
      </div>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½ ì•¡ì…˜ íŒ¨ë„ -->
  <div class="actions-panel">

    {% if ad.link_url %}
    <div class="action-btn" onclick="recordClick(); window.open('{{ ad.link_url }}', '_blank');">
      <div class="action-icon">ğŸ”—</div>
      <div class="action-count">ë°”ë¡œê°€ê¸°</div>
    </div>
    {% endif %}

    <!-- ìŠ¤í‚µ -->
    <div class="action-btn skip-btn" id="skipBtn" onclick="skipAd()">
      <div class="action-icon">â­</div>
      <div class="action-count" id="skipLabel">5ì´ˆ</div>
    </div>

  </div>

  <!-- í•˜ë‹¨ ì •ë³´ -->
  <div class="info-panel">
    <div class="author-info">
      <div class="author-avatar">ğŸ“¢</div>
      <div class="author-name">{{ ad.title }}</div>
      <div class="ad-badge-inline">ê´‘ê³ </div>
    </div>
    <div class="snap-title">{{ ad.title }}</div>
    <div class="snap-description">ì ì‹œ í›„ ì½˜í…ì¸ ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤</div>
    {% if ad.link_url %}
      <a href="{{ ad.link_url }}" class="arrow-link" target="_blank" onclick="recordClick()">ë” ì•Œì•„ë³´ê¸°</a>
    {% endif %}
  </div>

  <div class="scroll-hint" id="scrollHint">â†“ ìŠ¤í¬ë¡¤í•˜ì—¬ ë‹¤ìŒìœ¼ë¡œ</div>

</div>
{% endblock %}

{% block extra_js %}
<script>
  const video          = document.getElementById('adVideo');
  const playOverlay    = document.getElementById('playOverlay');
  const seekbarProgress = document.getElementById('seekbarProgress');
  const timeDisplay    = document.getElementById('timeDisplay');
  const skipBtn        = document.getElementById('skipBtn');
  const skipLabel      = document.getElementById('skipLabel');

  let skipReady = false;
  let skipTimer = 5;
  let navigating = false;

  /* â”€â”€ ë‹¤ìŒ URL â”€â”€ */
  {% if next_snap %}
    const NEXT_URL = "{% url 'book:book_snap_detail' next_snap.public_uuid %}?skip_ad=1";
  {% elif next_content %}
    const NEXT_URL = "{% url 'book:content_detail' next_content.public_uuid %}?skip_count=1";
  {% else %}
    const NEXT_URL = null;
  {% endif %}

  function fmt(s) {
    const m = Math.floor(s / 60);
    return `${m}:${String(Math.floor(s % 60)).padStart(2, '0')}`;
  }

  /* â”€â”€ ìë™ì¬ìƒ â”€â”€ */
  window.addEventListener('DOMContentLoaded', () => {
    video.play().then(() => setPlaying(true)).catch(() => setPlaying(false));
    startSkipTimer();
  });

  function setPlaying(state) {
    playOverlay.classList.toggle('visible', !state);
  }

  function togglePlay() {
    if (video.paused) { video.play(); setPlaying(true); }
    else              { video.pause(); setPlaying(false); }
  }

  video.addEventListener('loadedmetadata', () => {
    timeDisplay.textContent = `0:00 / ${fmt(video.duration)}`;
  });

  video.addEventListener('timeupdate', () => {
    if (!video.duration) return;
    seekbarProgress.style.width = (video.currentTime / video.duration * 100) + '%';
    timeDisplay.textContent = `${fmt(video.currentTime)} / ${fmt(video.duration)}`;
  });

  document.getElementById('seekbarContainer').addEventListener('click', function(e) {
    e.stopPropagation();
    video.currentTime = ((e.clientX - this.getBoundingClientRect().left) / this.offsetWidth) * video.duration;
  });

  /* â”€â”€ ì¬ìƒ ì¢…ë£Œ â†’ ìë™ ì´ë™ â”€â”€ */
  video.addEventListener('ended', () => {
    setPlaying(false);
    seekbarProgress.style.width = '100%';
    if (NEXT_URL) {
      skipLabel.textContent = 'ì´ë™ ì¤‘';
      setTimeout(() => goNext(), 1500);
    }
  });

  /* â”€â”€ ìŠ¤í‚µ íƒ€ì´ë¨¸ â”€â”€ */
  function startSkipTimer() {
    const interval = setInterval(() => {
      skipTimer--;
      if (skipTimer <= 0) {
        clearInterval(interval);
        skipReady = true;
        skipBtn.classList.add('active');
        skipLabel.textContent = 'ìŠ¤í‚µ';
      } else {
        skipLabel.textContent = `${skipTimer}ì´ˆ`;
      }
    }, 1000);
  }

  /* â”€â”€ ìŠ¤í‚µ í´ë¦­ â”€â”€ */
  function skipAd() {
    if (!skipReady) return;
    fetch("{% url 'book:ad_skip' ad.public_uuid %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      body: JSON.stringify({ watched_seconds: Math.floor(video.currentTime) })
    }).finally(() => goNext());
  }

  /* â”€â”€ íœ  ìŠ¤í¬ë¡¤ë¡œ ë‹¤ìŒ ì´ë™ â”€â”€ */
  let wheelLock = false;
  window.addEventListener('wheel', (e) => {
    if (!skipReady || wheelLock) return;
    if (e.deltaY > 30) {   // ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
      wheelLock = true;
      goNext();
    }
  }, { passive: true });

  /* ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ */
  let touchStartY = 0;
  window.addEventListener('touchstart', (e) => { touchStartY = e.touches[0].clientY; }, { passive: true });
  window.addEventListener('touchend', (e) => {
    if (!skipReady) return;
    const dy = touchStartY - e.changedTouches[0].clientY;
    if (dy > 50) goNext();   // ìœ„ë¡œ ìŠ¤ì™€ì´í”„ â†’ ë‹¤ìŒ
  }, { passive: true });

  function goNext() {
    if (navigating) return;
    navigating = true;
    if (NEXT_URL) {
      window.location.href = NEXT_URL;
    } else {
      history.back();
    }
  }

  function recordClick() {
    fetch("{% url 'book:ad_click' ad.public_uuid %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    });
  }
</script>
{% endblock %}