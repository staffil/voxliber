{% extends "base.html" %}
{% load static %}

{% block title %}VOXLIBER - ì†Œì„¤ ì§‘í•„{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/book_serialization.css' %}">
<link rel="stylesheet" href="{% static 'css/book/book_serilizaion.css' %}">
{% endblock %}

{% block content %}

{% if request.user_agent.is_mobile %}
    <script>
        window.location.href = '/';
    </script>
    <div style="padding: 40px; text-align: center; color: white;">
        ğŸ“µ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¤‘...
    </div>
{% else %}


<div class="writing-wrapper">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="book-title-small">{{ book.name }}</div>
            <div class="episode-info">
                <input type="text" id="episodeTitle" placeholder="ì—í”¼ì†Œë“œ ì œëª©"
                       style="width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); margin-top: 10px;">
            </div>
            <div id="draftStatus" style="margin-top: 8px; font-size: 12px; color: var(--text-secondary); text-align: center; display: none;">
                ğŸ’¾ ì„ì‹œì €ì¥ë¨
            </div>
        </div>

        <div style="padding: 0 15px;">
            <button type="button" class="add-page-btn" onclick="addPage()">
                + ìƒˆ ëŒ€ì‚¬ ì¶”ê°€
            </button>
            <button type="button" class="add-page-btn" onclick="openSoundEffectModal()" style="margin-top: 8px; background: #8b5cf6;">
                ğŸµ ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ ë„£ê¸°
            </button>
            <button type="button" class="add-page-btn" onclick="openBackgroundMusicModal()" style="margin-top: 8px; background: #ec4899;">
                ğŸ¼ ë°°ê²½ìŒ ë„£ê¸°
            </button>
            <button type="button" class="add-page-btn" onclick="loadDraft()" id="loadDraftBtn" style="margin-top: 8px; background: #059669; display: none;">
                ğŸ“‚ ì„ì‹œì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
        </div>

        <!-- ë°°ê²½ìŒ íŠ¸ë™ -->
        <div style="padding: 10px 15px; border-bottom: 1px solid #333;">
            <div style="color: #ec4899; font-size: 12px; font-weight: 600; margin-bottom: 8px;">ğŸ¼ ë°°ê²½ìŒ íŠ¸ë™</div>
            <div id="backgroundTracksList" style="max-height: 120px; overflow-y: auto;">
                <!-- ë°°ê²½ìŒ íŠ¸ë™ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                <div style="color: #666; font-size: 11px; text-align: center; padding: 10px;">ë°°ê²½ìŒì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        </div>

        <!-- ëŒ€ì‚¬/ì´íŒ©íŠ¸ ëª©ë¡ -->
        <div style="padding: 10px 15px 0; color: #888; font-size: 12px; font-weight: 600;">ğŸ“ ëŒ€ì‚¬ & ì´íŒ©íŠ¸</div>
        <div class="pages-list" id="pagesList" style="padding: 5px 10px;">
            <!-- ëŒ€ì‚¬ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ë©”ì¸ ì—ë””í„° -->
    <div class="editor-main">
        <div class="editor-header">
            <div class="current-page-info">
                <h2 id="currentPageTitle">ëŒ€ì‚¬ 1 / 10</h2>
                <div class="page-meta">ìµœëŒ€ 200ì ê¶Œì¥</div>
            </div>

            <div class="header-actions">

                <button type="button" class="btn btn-danger" onclick="destroyPage()" id="deletePageBtn">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18" />
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
                    <path d="M10 11l4 4" />
                    <path d="M14 11l-4 4" />
                    <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" />
                    </svg>

                    ì „ì²´ ì‚­ì œ
                </button>
                <button type="button" class="btn btn-danger" onclick="deletePage()" id="deletePageBtn">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    ì‚­ì œ
                </button>


                <!-- ì˜¤ë””ì˜¤ë¶ ê°€ì´ë“œ -->
                <button type="button" class="btn btn-primary" onclick="audioBookGuide()" id="deletePageBtn">ì˜¤ë””ì˜¤ë¶ ê°€ì´ë“œ</button>

                <button class="btn btn-primary" onclick="emotionFunc()" id="deletePageBtn">ê°ì • ë¦¬ìŠ¤íŠ¸</button>
                <button type="button" class="btn btn-secondary" onclick="saveDraft()" id="deletePageBtn">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    ì„ì‹œì €ì¥
                </button>
                <a href="{% url 'book:book_profile' %}?book_id={{ book.id }}" class="btn btn-secondary" id="deletePageBtn">ë’¤ë¡œê°€ê¸°</a>
                <button type="button" class="btn btn-primary" onclick="goToPreview()" id="deletePageBtn">ë¯¸ë¦¬ë“£ê¸°</button>
            </div>
        </div>

        <div class="editor-container">
                    <div id="audioBookGuideView" style="display:none;">
                        <!-- ì—¬ê¸°ì— ê°€ì´ë“œ ë‚´ìš© -->
                    </div>
        <div class="editor-wrapper">

            <!-- ì™¼ìª½: ëŒ€ì‚¬/ì˜¤ë””ì˜¤ í¸ì§‘ -->
            <div id="editorArea" class="panel-left"></div>

            <!-- ì˜¤ë¥¸ìª½: ì†Œì„¤ ë¯¸ë¦¬ì ê¸° -->
            <div id="writeArea" class="panel-right"></div>

        </div>

  
            <div id="webaudioediter">

            </div>
        </div>
    </div>

<!-- ê°ì • ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
<div id="emotionViewContainer"></div>

    <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” - ë‚˜ë ˆì´ì…˜ ì„ íƒ -->
    <div class="voice-sidebar">
        <div class="voice-sidebar-header">
            <h3>ğŸ™ï¸ ë‚˜ë ˆì´ì…˜ ì„ íƒ</h3>
        </div>
                <a href="/voice/voice_list/" class="voice-list-btn">
    ë‚˜ë ˆì´ì…˜ ë¦¬ìŠ¤íŠ¸
</a>
        <div class="voice-list">
 {% for voice in voice_list %}
    <div class="voice-item active" data-voice-id="{{ voice.voice.voice_id }}" onclick="selectVoice(this)">
        <div class="voice-item-content">
            <div class="voice-name">{{ voice.alias_name }}</div>
        </div>

        {% if voice.voice.sample_audio %}
        <button class="voice-play-btn" onclick="toggleVoicePlay(event, '{{ voice.voice.sample_audio.url }}')" title="ìƒ˜í”Œ ë“£ê¸°">
            ...
        </button>
        {% endif %}
    </div>
{% empty %}
    <div class="voice-item empty-voice-box" style="
        padding: 20px;
        background: #1a1f2e;
        border: 1px solid #2a3144;
        border-radius: 10px;
        text-align: center;
        color: #bbb;
        margin-bottom: 12px;
    ">
        <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">
            ë‚˜ë ˆì´ì…˜ì„ ì¶”ê°€í•˜ê³  ì±…ì— ë§ëŠ” ëª©ì†Œë¦¬ë¥´ ì§€ì •í•´ë³´ì„¸ìš”!
            <br>
            <br>
<a href="/voice/voice_list/" class="voice-list-btn">
    ë‚˜ë ˆì´ì…˜ ë¦¬ìŠ¤íŠ¸
</a>
        </div>

    </div>
{% endfor %}




        </div>
        
        <!-- ìˆ¨ê²¨ì§„ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
        <audio id="voiceSamplePlayer" style="display: none;" loading="lazy"></audio>


        <div class="voice-settings">
            <h4>ğŸ”Š ìŒì„± ì„¤ì •</h4>

            <div class="setting-item">
                <label>ì–¸ì–´ ì„ íƒ</label>
                <select id="languageSelect" onchange="updateLanguage(this.value)">
                    <option value="ko">í•œêµ­ì–´ (Korean)</option>
                    <option value="en">ì˜ì–´ (English)</option>
                    <option value="ja">ì¼ë³¸ì–´ (Japanese)</option>
                    <option value="zh">ì¤‘êµ­ì–´ (Chinese)</option>
                    <option value="es">ìŠ¤í˜ì¸ì–´ (Spanish)</option>
                    <option value="fr">í”„ë‘ìŠ¤ì–´ (French)</option>
                    <option value="de">ë…ì¼ì–´ (German)</option>
                </select>
            </div>

            <div class="setting-item">
                <label>ì†ë„ <small style="color: #888;">(0.5x ~ 2.0x)</small></label>
                <input type="range" id="speedSlider" min="0" max="100" value="33" oninput="updateSpeed(this.value)">
                <span id="speedValue" style="min-width: 40px; display: inline-block;">1.0x</span>
            </div>
        </div>
    </div>
</div>

<!-- ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ ëª¨ë‹¬ -->
<div id="soundEffectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-bg); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: var(--bg-secondary); padding: 30px; border-radius: 16px; max-width: 900px; width: 90%; box-shadow: 0 10px 40px var(--shadow-color); margin: 20px auto; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--text-primary); margin: 0;">ğŸµ ì‚¬ìš´ë“œ ì´íŒ©íŠ¸</h3>
            <button onclick="closeSoundEffectModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>

        <!-- íƒ­ -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color);">
            <button id="effectNewTab" onclick="showEffectTab('new')" style="padding: 10px 20px; background: none; border: none; color: var(--secondary); font-weight: 600; cursor: pointer; border-bottom: 2px solid var(--secondary);">ìƒˆë¡œ ìƒì„±</button>
            <button id="effectLibraryTab" onclick="showEffectTab('library')" style="padding: 10px 20px; background: none; border: none; color: var(--text-secondary); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent;">ë¼ì´ë¸ŒëŸ¬ë¦¬</button>
            <button id="uploadLibraryTab" onclick="showEffectTab('upload')" style="padding: 10px 20px; background: none; border: none; color: var(--text-secondary); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent;">ì˜¤ë””ì˜¤ ì˜¬ë¦¬ê¸°</button>
            
        </div>

        <!-- ìƒˆë¡œ ìƒì„± íƒ­ -->
        <div id="effectNewContent">
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">ì´íŒ©íŠ¸ ì´ë¦„</label>
                <input type="text" id="effectName" placeholder="ì˜ˆ: í­ë°œìŒ" style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">ì´íŒ©íŠ¸ ì„¤ëª…</label>
                <textarea id="effectDescription" placeholder="ì˜ˆ: door knok sound ,í•´ë‹¹ ì‚¬ìš´ë“œ ì´í™íŠ¸ëŠ” ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”." style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">ê¸¸ì´ (ì´ˆ)</label>
                <input type="number" id="effectDuration" value="5" min="1" max="22" style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 5px;">ğŸ’¡ ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ëŠ” 1-22ì´ˆ ì‚¬ì´ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="closeSoundEffectModal()" class="btn btn-secondary" style="flex: 1;">ì·¨ì†Œ</button>
                <button onclick="generateSoundEffect()" class="btn btn-primary" style="flex: 1;">ìƒì„±í•˜ê¸°</button>
            </div>
        </div>

        <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒ­ -->
        <div id="effectLibraryContent" style="display: none;">
            <div id="effectLibraryList" style="max-height: 400px; overflow-y: auto;">
                <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì—…ë¡œë“œ íƒ­ -->
        <div id="uploadLibraryContent" style="display: none;">
            <div id="uploadEffectContainer" style="max-height: 400px; overflow-y: auto;">
                <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>  
    </div>
</div>

<!-- ë°°ê²½ìŒ ëª¨ë‹¬ -->
<div id="backgroundMusicModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-bg); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: var(--bg-secondary); padding: 30px; border-radius: 16px; max-width: 900px; width: 90%; box-shadow: 0 10px 40px var(--shadow-color); margin: 20px auto; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--text-primary); margin: 0;">ğŸ¼ ë°°ê²½ìŒ</h3>
            <button onclick="closeBackgroundMusicModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>

        <!-- íƒ­ -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color);">
            <button id="musicNewTab" onclick="showMusicTab('new')" style="padding: 10px 20px; background: none; border: none; color: var(--accent); font-weight: 600; cursor: pointer; border-bottom: 2px solid var(--accent);">ìƒˆë¡œ ìƒì„±</button>
            <button id="musicLibraryTab" onclick="showMusicTab('library')" style="padding: 10px 20px; background: none; border: none; color: var(--text-secondary); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent;">ë¼ì´ë¸ŒëŸ¬ë¦¬</button>
            <button id="musicUploadTab" onclick="showMusicTab('upload')" style="padding: 10px 20px; background: none; border: none; color: var(--text-secondary); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent;">ì˜¤ë””ì˜¤ ì˜¬ë¦¬ê¸°</button>
        </div>

        <!-- ìƒˆë¡œ ìƒì„± íƒ­ -->
        <div id="musicNewContent">
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">ë°°ê²½ìŒ ì´ë¦„</label>
                <input type="text" id="musicName" placeholder="ì˜ˆ: ê¸´ì¥ê° ìˆëŠ” ë°°ê²½ìŒ" style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">ë°°ê²½ìŒ ì„¤ëª…</label>
                <textarea id="musicDescription" placeholder="ì˜ˆ: ì„œìŠ¤íœìŠ¤ ì¥ë©´ì„ ìœ„í•œ ê¸´ì¥ê° ìˆëŠ” ì˜¤ì¼€ìŠ¤íŠ¸ë¼ ë°°ê²½ìŒ" style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">ê¸¸ì´ (ì´ˆ)</label>
                <input type="number" id="musicDuration" value="30" min="10" max="120" style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="closeBackgroundMusicModal()" class="btn btn-secondary" style="flex: 1;">ì·¨ì†Œ</button>
                <button onclick="generateBackgroundMusic()" class="btn btn-primary" style="flex: 1;">ìƒì„±í•˜ê¸°</button>
            </div>
        </div>

        <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒ­ -->
        <div id="musicLibraryContent" style="display: none;">
            <div id="musicLibraryList" style="max-height: 400px; overflow-y: auto;">
                <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <div id="musicUploadContent" style="display: none;">
            <div id="uploadMusicContainer" style="max-height: 400px; overflow-y: auto;">
                
            </div>
        </div>

    </div>
</div>

{% endif %}

<script src="{% static 'js/register/login.js' %}"></script>
<script src="{% static 'js/csrf.js' %}"></script>
<script src="{% static 'book/js/preview.js' %}"></script>
<script src="{% static 'book/js/sound-effects.js' %}"></script>
<script src="{% static 'book/js/background-music.js' %}"></script>
<script src="{% static 'book/js/draft-manager.js' %}"></script>
<script src="{% static 'book/js/emotion-effects.js' %}"></script>
<script src="{% static 'js/book/webaudio-effects.js' %}"></script>

<script>
const bookId = {{ book.id }};
let pages = []; // ëŒ€ì‚¬ì™€ ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ë§Œ í¬í•¨
let backgroundTracks = []; // ë°°ê²½ìŒ ë³„ë„ ê´€ë¦¬ [{startPage: 0, endPage: 3, audioFile, audioUrl, musicName}]
let currentPageIndex = 0;
let globalNovelDraft = ''; // ì „ì²´ ì—í”¼ì†Œë“œì— ëŒ€í•œ ì†Œì„¤ ë¯¸ë¦¬ì“°ê¸° (í˜ì´ì§€ë³„ êµ¬ë¶„ ì—†ì´ í•˜ë‚˜)

// ë‚˜ë ˆì´ì…˜ ì„¤ì •
let selectedVoiceId = '2EiwWnXFnvU5JabPnv8n'; // ê¸°ë³¸ê°’: í´ë¡œì´
let selectedLanguage = 'ko'; // ê¸°ë³¸ê°’: í•œêµ­ì–´
let voiceStability = 0.5;
let voiceSimilarity = 0.5;
let voiceSpeed = 0.5;

// ìŒì„± ìƒ˜í”Œ ì¬ìƒ
let currentPlayingBtn = null;
const samplePlayer = document.getElementById('voiceSamplePlayer');

function toggleVoicePlay(event, audioUrl) {
    event.stopPropagation(); // voice-item í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€

    const btn = event.currentTarget;
    const playIcon = btn.querySelector('.play-icon');
    const pauseIcon = btn.querySelector('.pause-icon');

    // ë‹¤ë¥¸ ë²„íŠ¼ì´ ì¬ìƒ ì¤‘ì´ë©´ ë©ˆì¶¤
    if (currentPlayingBtn && currentPlayingBtn !== btn) {
        const otherPlayIcon = currentPlayingBtn.querySelector('.play-icon');
        const otherPauseIcon = currentPlayingBtn.querySelector('.pause-icon');
        otherPlayIcon.style.display = 'block';
        otherPauseIcon.style.display = 'none';
        currentPlayingBtn.classList.remove('playing');
    }

    // í˜„ì¬ ë²„íŠ¼ í† ê¸€
    if (samplePlayer.paused || samplePlayer.src !== window.location.origin + audioUrl) {
        samplePlayer.src = audioUrl;
        samplePlayer.play();
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
        btn.classList.add('playing');
        currentPlayingBtn = btn;
    } else {
        samplePlayer.pause();
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        btn.classList.remove('playing');
        currentPlayingBtn = null;
    }
}

// ì˜¤ë””ì˜¤ ì¢…ë£Œ ì‹œ ì•„ì´ì½˜ ì›ë˜ëŒ€ë¡œ
if (samplePlayer) {
    samplePlayer.addEventListener('ended', function() {
        if (currentPlayingBtn) {
            const playIcon = currentPlayingBtn.querySelector('.play-icon');
            const pauseIcon = currentPlayingBtn.querySelector('.pause-icon');
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
            currentPlayingBtn.classList.remove('playing');
            currentPlayingBtn = null;
        }
    });
}


// ë§ì¶¤ë²• ê²€ì‚¬
const text = document.getElementById('writeArea').innerText;



// ë‚˜ë ˆì´ì…˜ ì„ íƒ
function selectVoice(element) {
    // ëª¨ë“  voice-itemì—ì„œ active ì œê±°
    document.querySelectorAll('.voice-item').forEach(item => {
        item.classList.remove('active');
    });

    // ì„ íƒëœ í•­ëª©ì— active ì¶”ê°€
    element.classList.add('active');
    selectedVoiceId = element.getAttribute('data-voice-id');

    console.log('ì„ íƒëœ ëª©ì†Œë¦¬ ID:', selectedVoiceId);
}

// ì–¸ì–´ ì—…ë°ì´íŠ¸
function updateLanguage(value) {
    selectedLanguage = value;
    console.log('ì„ íƒëœ ì–¸ì–´:', selectedLanguage);
}


// ì†ë„ ì—…ë°ì´íŠ¸
    function updateSpeed(value) {
        // value 0~100 â†’ 0.5 ~ 2.0 ë§¤í•‘ (0.5=ëŠë¦¬ê²Œ, 1.0=ë³´í†µ, 2.0=ë¹ ë¥´ê²Œ)
        const speed = (0.5 + (2.0 - 0.5) * (value / 100)).toFixed(2);
        voiceSpeed = parseFloat(speed);  // ì „ì—­ ë³€ìˆ˜ë„ ì—…ë°ì´íŠ¸!
        document.getElementById("speedValue").innerText = speed + 'x';
        console.log('ğŸšï¸ ì†ë„ ì„¤ì •:', speed);
    }

    // ì´ˆê¸° í‘œì‹œê°’ ì„¤ì • (value=33ì´ë©´ speed=1.0)
    updateSpeed(33);

// ëŒ€ì‚¬ ë°ì´í„° êµ¬ì¡°
function createPage(content = '', audioFile = null, isSoundEffect = false) {
    return {
        id: Date.now() + Math.random(),
        content: content,
        charCount: content.length,
        audioFile: audioFile,
        audioUrl: null,
        isSoundEffect: isSoundEffect,  // ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ ì—¬ë¶€
        effectName: '',  // ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ ì´ë¦„
        novelDraft: ''  // ì†Œì„¤ ë¯¸ë¦¬ì“°ê¸° ë‚´ìš©
    };
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(event) {
    const soundModal = document.getElementById('soundEffectModal');
    const musicModal = document.getElementById('backgroundMusicModal');
    if (event.target === soundModal) {
        closeSoundEffectModal();
    }
    if (event.target === musicModal) {
        closeBackgroundMusicModal();
    }
});



// IndexedDB ì´ˆê¸°í™”
let db = null;


// ì´ˆê¸° ëŒ€ì‚¬ 10ê°œ ìƒì„±
async function initPages() {
    // IndexedDB ì´ˆê¸°í™”
    try {
        await initIndexedDB();
    } catch (error) {
        console.error('IndexedDB ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    }

    if (pages.length === 0) {
        for (let i = 0; i < 10; i++) {
            pages.push(createPage());
        }
    }
    renderPagesList();
    loadPage(0);

    // ì„ì‹œì €ì¥ ì¡´ì¬ ì—¬ë¶€ ì²´í¬
    await checkDraftExists();
}



// ëŒ€ì‚¬ ëª©ë¡ ë Œë”ë§
function renderPagesList() {
    const pagesList = document.getElementById('pagesList');
    pagesList.innerHTML = '';

    pages.forEach((page, index) => {
        const pageItem = document.createElement('div');
        pageItem.className = `page-item ${index === currentPageIndex ? 'active' : ''}`;
        pageItem.setAttribute('draggable', 'true');
        pageItem.setAttribute('data-index', index);
        pageItem.onclick = () => loadPage(index);

        // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        pageItem.addEventListener('dragstart', handleDragStart);
        pageItem.addEventListener('dragover', handleDragOver);
        pageItem.addEventListener('drop', handleDrop);
        pageItem.addEventListener('dragend', handleDragEnd);
        pageItem.addEventListener('dragenter', handleDragEnter);
        pageItem.addEventListener('dragleave', handleDragLeave);

        // ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ ì¹´ë“œì¸ ê²½ìš°
        if (page.isSoundEffect) {
            pageItem.style.background = '#2d1b4e'; // ë³´ë¼ìƒ‰ ë°°ê²½
            pageItem.style.borderLeft = '4px solid #8b5cf6';

            pageItem.innerHTML =
                '<div class="page-item-header">' +
                    '<span class="page-number" style="color: #c4b5fd;">ğŸµ ì‚¬ìš´ë“œ ì´íŒ©íŠ¸</span>' +
                '</div>' +
                '<div class="page-preview" style="color: #c4b5fd; font-weight: 600;">' + page.effectName + '</div>' +
                '<div style="font-size: 11px; color: #a78bfa; margin-top: 4px;">ì˜¤ë””ì˜¤ ì¤€ë¹„ë¨</div>';
        } else {
            // ì¼ë°˜ ëŒ€ì‚¬ ì¹´ë“œ
            const preview = page.content.substring(0, 30) || 'ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”';
            const previewClass = page.content ? '' : 'empty';
            const hasAudio = page.audioFile || page.audioUrl;

            pageItem.innerHTML =
                '<div class="page-item-header">' +
                    '<span class="page-number">ëŒ€ì‚¬ ' + (index + 1) + '</span>' +
                    '<span class="char-count-small">' + page.charCount + 'ì</span>' +
                '</div>' +
                '<div class="page-preview ' + previewClass + '">' + preview + '</div>' +
                (hasAudio ? '<div style="font-size: 11px; color: #6366f1; margin-top: 4px;">ğŸµ ì˜¤ë””ì˜¤ ìˆìŒ</div>' : '');
        }

        pagesList.appendChild(pageItem);
    });
}

// ë“œë˜ê·¸ ì‹œì‘
function handleDragStart(e) {
    draggedIndex = parseInt(e.currentTarget.getAttribute('data-index'));
    e.currentTarget.style.opacity = '0.5';
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', e.currentTarget.innerHTML);
}

// ë“œë˜ê·¸ ì˜¤ë²„
function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

// ë“œë˜ê·¸ ì§„ì…
function handleDragEnter(e) {
    const targetIndex = parseInt(e.currentTarget.getAttribute('data-index'));
    if (draggedIndex !== targetIndex) {
        e.currentTarget.style.borderTop = '3px solid #6366f1';
    }
}

// ë“œë˜ê·¸ ì´íƒˆ
function handleDragLeave(e) {
    e.currentTarget.style.borderTop = '';
}

// ë“œë¡­
function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    e.preventDefault();

    const targetIndex = parseInt(e.currentTarget.getAttribute('data-index'));

    if (draggedIndex !== null && draggedIndex !== targetIndex) {
        // ë°°ì—´ì—ì„œ í•­ëª© ì´ë™
        const draggedItem = pages[draggedIndex];
        pages.splice(draggedIndex, 1);
        pages.splice(targetIndex, 0, draggedItem);

        // currentPageIndex ì—…ë°ì´íŠ¸
        if (currentPageIndex === draggedIndex) {
            currentPageIndex = targetIndex;
        } else if (draggedIndex < currentPageIndex && targetIndex >= currentPageIndex) {
            currentPageIndex--;
        } else if (draggedIndex > currentPageIndex && targetIndex <= currentPageIndex) {
            currentPageIndex++;
        }

        // UI ì—…ë°ì´íŠ¸
        renderPagesList();
        loadPage(currentPageIndex, true); // skipSave = true
    }

    e.currentTarget.style.borderTop = '';
    return false;
}

// ë“œë˜ê·¸ ì¢…ë£Œ
function handleDragEnd(e) {
    e.currentTarget.style.opacity = '1';
    e.currentTarget.style.borderTop = '';

    // ëª¨ë“  ì¹´ë“œì˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
    document.querySelectorAll('.page-item').forEach(item => {
        item.style.borderTop = '';
    });
}


// í˜„ì¬ í˜ì´ì§€ ì €ì¥
function saveCurrentPage() {
    const textarea = document.getElementById('pageContent');
    const novelTextarea = document.getElementById('novelDraft');

    if (textarea && pages[currentPageIndex]) {
        const content = textarea.value;
        pages[currentPageIndex].content = content;
        pages[currentPageIndex].charCount = content.length;
        console.log('ğŸ’¾ saveCurrentPage() í˜¸ì¶œ - í˜ì´ì§€', currentPageIndex + 1, 'ì €ì¥ë¨, í…ìŠ¤íŠ¸ ê¸¸ì´:', content.length, 'ì');
    } else {
        console.warn('âš ï¸ saveCurrentPage() - textarea ë˜ëŠ” í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
    }

    // ì†Œì„¤ ë¯¸ë¦¬ì“°ê¸° ë‚´ìš©ë„ ì €ì¥ (ì „ì—­, í˜ì´ì§€ë³„ êµ¬ë¶„ ì—†ìŒ)
    if (novelTextarea) {
        const novelContent = novelTextarea.value;
        // ë¹ˆ ê°’ìœ¼ë¡œ ë®ì–´ì“°ì§€ ì•Šë„ë¡ ë³´í˜¸: textareaê°€ ë¹„ì–´ìˆê³  globalNovelDraftì— ê°’ì´ ìˆë‹¤ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ
        if (novelContent || !globalNovelDraft) {
            globalNovelDraft = novelContent;
            // localStorageì—ë„ ë°±ì—… ì €ì¥ (í˜ì´ì§€ ì¸ë±ìŠ¤ ì—†ì´)
            localStorage.setItem(`novelDraft_${bookId}`, novelContent);
            console.log('ğŸ“– ì†Œì„¤ ë¯¸ë¦¬ì“°ê¸° ì €ì¥ë¨, ê¸¸ì´:', novelContent.length, 'ì');
        } else {
            console.log('âš ï¸ ì†Œì„¤ ë¯¸ë¦¬ì“°ê¸° textareaê°€ ë¹„ì–´ìˆì§€ë§Œ globalNovelDraftì— ê°’ì´ ìˆì–´ ì €ì¥ ê±´ë„ˆëœ€ (ë®ì–´ì“°ê¸° ë°©ì§€)');
        }
    }
}


// í˜ì´ì§€ ë¡œë“œ
function loadPage(index, skipSave = false) {
    // ì´ì „ í˜ì´ì§€ ì €ì¥ (skipSaveê°€ falseì¼ ë•Œë§Œ)
    if (!skipSave && currentPageIndex !== index) {
        saveCurrentPage();
    }

    currentPageIndex = index;
    const page = pages[index];

    const editorArea = document.getElementById('editorArea');
    const writeArea = document.getElementById('writeArea');

    // ì €ì¥ëœ ì†Œì„¤ ë¯¸ë¦¬ì“°ê¸° ë¯¸ë¦¬ ê°€ì ¸ì˜¤ê¸° (DOM ìƒì„± ì „)
    const savedNovelDraft = globalNovelDraft || localStorage.getItem(`novelDraft_${bookId}`) || '';

    writeArea.innerHTML = `
        <div class="write-panel-header">
            ğŸ“˜ ì†Œì„¤ ë¯¸ë¦¬ ì‘ì„±
            <span id="novelDraftStatus" style="font-size: 11px; color: #888; margin-left: 10px;"></span>
        </div>
        <textarea id="novelDraft" placeholder="ì—¬ê¸°ì— ì†Œì„¤ ë‚´ìš©ì„ ë¯¸ë¦¬ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
    `;

    // ì†Œì„¤ ë¯¸ë¦¬ì“°ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ë° ìë™ì €ì¥ ì„¤ì • (ì¦‰ì‹œ ì‹¤í–‰, setTimeout ì œê±°)
    const novelTextarea = document.getElementById('novelDraft');
    const novelDraftStatus = document.getElementById('novelDraftStatus');

    if (novelTextarea) {
        // ì €ì¥ëœ ì†Œì„¤ ë¯¸ë¦¬ì“°ê¸° ë¶ˆëŸ¬ì˜¤ê¸° (ì „ì—­, í˜ì´ì§€ë³„ êµ¬ë¶„ ì—†ìŒ)
        novelTextarea.value = savedNovelDraft;

        console.log(`ğŸ“– ì†Œì„¤ ë¯¸ë¦¬ì“°ê¸° ë¶ˆëŸ¬ì˜¤ê¸° (ì „ì²´ ì—í”¼ì†Œë“œ):`, {
            'globalNovelDraft ìˆìŒ': !!globalNovelDraft,
            'localStorage ìˆìŒ': !!localStorage.getItem(`novelDraft_${bookId}`),
            'ë¶ˆëŸ¬ì˜¨ ê¸¸ì´': savedNovelDraft.length,
            'ë¯¸ë¦¬ë³´ê¸°': savedNovelDraft.substring(0, 50)
        });

        if (savedNovelDraft) {
            globalNovelDraft = savedNovelDraft;
            novelDraftStatus.textContent = 'âœ“ ì €ì¥ëœ ë‚´ìš© ë¶ˆëŸ¬ì˜´';
            novelDraftStatus.style.color = '#10b981';
            setTimeout(() => {
                novelDraftStatus.textContent = '';
            }, 3000);
        }

        // ìë™ ì €ì¥ (ë””ë°”ìš´ì‹±)
        let novelDraftTimeout;
        novelTextarea.addEventListener('input', function() {
            clearTimeout(novelDraftTimeout);
            novelDraftStatus.textContent = 'ì…ë ¥ ì¤‘...';
            novelDraftStatus.style.color = '#fbbf24';

            novelDraftTimeout = setTimeout(() => {
                const draftContent = novelTextarea.value;

                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (í˜ì´ì§€ë³„ êµ¬ë¶„ ì—†ìŒ)
                globalNovelDraft = draftContent;

                // localStorageì—ë„ ë°±ì—… ì €ì¥ (í˜ì´ì§€ ì¸ë±ìŠ¤ ì—†ì´)
                localStorage.setItem(`novelDraft_${bookId}`, draftContent);

                novelDraftStatus.textContent = 'âœ“ ìë™ ì €ì¥ë¨';
                novelDraftStatus.style.color = '#10b981';

                console.log(`ğŸ’¾ ì†Œì„¤ ë¯¸ë¦¬ì“°ê¸° ìë™ ì €ì¥ë¨ (ì „ì²´ ì—í”¼ì†Œë“œ), ê¸¸ì´: ${draftContent.length}ì`);

                // 3ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¹€
                setTimeout(() => {
                    novelDraftStatus.textContent = '';
                }, 3000);
            }, 1000); // 1ì´ˆ ëŒ€ê¸° í›„ ì €ì¥
        });
    } else {
        console.error('âŒ novelDraft textareaë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }


    // ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ ì¹´ë“œì¸ ê²½ìš° - íŠ¹ë³„í•œ UI í‘œì‹œ
    if (page.isSoundEffect) {
        document.getElementById('currentPageTitle').textContent = 'ğŸµ ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ / ' + pages.length;

        editorArea.innerHTML =
            '<div class="editor-toolbar" style="background: #2d1b4e; border-bottom: 1px solid #8b5cf6;">' +
                '<span style="color: #c4b5fd; font-size: 14px;">ğŸµ ì‚¬ìš´ë“œ ì´íŒ©íŠ¸</span>' +
            '</div>' +
            '<div class="page-editor" style="background: #1a1a2e; text-align: center; padding: 60px 30px;">' +
                '<div style="margin-bottom: 30px;">' +
                    '<div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px;">ğŸµ</div>' +
                    '<h3 style="color: #fff; font-size: 24px; margin-bottom: 10px;">' + page.effectName + '</h3>' +
                    '<p style="color: #888; font-size: 14px;">ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ ì¹´ë“œ</p>' +
                '</div>' +
                '<div style="max-width: 500px; margin: 0 auto; background: #16213e; padding: 20px; border-radius: 12px;">' +
                    '<audio controls style="width: 100%; margin-bottom: 15px;" id="pageAudioPlayer" loading="lazy">' +
                        '<source src="' + page.audioUrl + '" type="audio/mp3">' +
                    '</audio>' +
                    '<div style="font-size: 13px; color: #6366f1;">âœ“ ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤</div>' +
                '</div>' +
            '</div>' +
            '<div class="editor-footer">' +
                '<div class="footer-info" style="color: #888;">' +
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                        '<circle cx="12" cy="12" r="10"/>' +
                        '<path d="M12 6v6l4 2"/>' +
                    '</svg>' +
                    ' ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ëŠ” ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤' +
                '</div>' +
                '<div class="pagination-controls">' +
                    '<button class="btn btn-secondary" onclick="prevPage()" ' + (index === 0 ? 'disabled' : '') + '>â† ì´ì „</button>' +
                    '<button class="btn btn-secondary" onclick="nextPage()" ' + (index === pages.length - 1 ? 'disabled' : '') + '>ë‹¤ìŒ â†’</button>' +
                '</div>' +
            '</div>';
    } else {
        // ì¼ë°˜ ëŒ€ì‚¬ ì¹´ë“œ UI
        document.getElementById('currentPageTitle').textContent = 'ëŒ€ì‚¬ ' + (index + 1) + ' / ' + pages.length;

        const hasAudio = page.audioFile || page.audioUrl;

        let audioSection = '';
        if (hasAudio) {
            audioSection = `
                <div style="background: linear-gradient(135deg, #1e2a3a 0%, #2d1b4e 100%); padding: 20px; border-radius: 16px; margin-bottom: 15px; border: 1px solid rgba(138, 99, 210, 0.3); box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
                    <audio id="pageAudioPlayer" style="display: none;">
                        <source src="${page.audioUrl}" type="audio/mp3">
                    </audio>

                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <button id="playPauseBtn" onclick="togglePlayPause()" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #8a63d2 0%, #b794f6 100%); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(138, 99, 210, 0.4); transition: all 0.3s ease;">
                            <svg id="playIcon" width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <svg id="pauseIcon" width="20" height="20" viewBox="0 0 24 24" fill="white" style="display: none;">
                                <rect x="6" y="4" width="4" height="16"/>
                                <rect x="14" y="4" width="4" height="16"/>
                            </svg>
                        </button>

                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span id="currentTime" style="color: #b794f6; font-size: 13px; font-weight: 600;">0:00</span>
                                <span id="totalTime" style="color: #888; font-size: 13px;">0:00</span>
                            </div>
                            <div id="progressBarContainer" onclick="seekAudio(event)" style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; cursor: pointer; position: relative; overflow: hidden;">
                                <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, #8a63d2 0%, #b794f6 100%); border-radius: 3px; width: 0%; transition: width 0.1s linear; position: relative;">
                                    <div style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 15px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#b794f6" stroke-width="2">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            </svg>
                            <input type="range" id="volumeSlider" min="0" max="100" value="100" oninput="changeVolume(this.value)" style="flex: 1; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.1); outline: none; -webkit-appearance: none;">
                        </div>

                        <select id="speedSelect" onchange="changeSpeed(this.value)" style="padding: 6px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 12px; cursor: pointer; outline: none;">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>

                        <button onclick="downloadAudio('${page.audioUrl}')" style="padding: 6px 12px; background: rgba(138, 99, 210, 0.2); border: 1px solid rgba(138, 99, 210, 0.4); border-radius: 8px; color: #b794f6; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(138, 99, 210, 0.3)'" onmouseout="this.style.background='rgba(138, 99, 210, 0.2)'">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>

                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 15px; padding: 12px; background: rgba(138, 99, 210, 0.1); border-radius: 10px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <span style="font-size: 13px; color: #10b981; font-weight: 500;">ì˜¤ë””ì˜¤ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤</span>
                    </div>
                </div>
            `;
        } else {
            audioSection = '<div style="font-size: 14px; color: #888; margin-bottom: 12px;">ì´ í˜ì´ì§€ì— ë°°ê²½ìŒì•…ì´ë‚˜ ë‚˜ë ˆì´ì…˜ì„ ì¶”ê°€í•˜ì„¸ìš”</div>';
        }

        let audioRemoveBtn = hasAudio ? '<button class="btn btn-danger" style="padding: 6px 12px; font-size: 13px;" onclick="removeAudio()">ì˜¤ë””ì˜¤ ì œê±°</button>' : '';

        editorArea.innerHTML =
            '<div class="editor-toolbar">' +
                '<span style="color: #888; font-size: 14px;">ğŸ¶ ëŒ€ì‚¬ ' + (index + 1) + '</span>' +
                '<span class="char-count-display">' +
                    '<span id="currentCharCount">' + page.charCount + '</span> / 200ì' +
                    '<span id="charWarning" style="display: none;" class="char-limit-warning">(ê¶Œì¥ ê¸€ì ìˆ˜ ì´ˆê³¼)</span>' +
                '</span>' +
            '</div>' +
            '<div class="page-editor">' +
                '<div style="display: flex; gap: 6px; padding: 8px; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.05); border-radius: 8px 8px 0 0; flex-wrap: wrap;">' +
                    '<button type="button" class="format-btn" onclick="formatText(\'bold\')" title="êµµê²Œ (Ctrl+B)">' +
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">' +
                            '<path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>' +
                            '<path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>' +
                        '</svg>' +
                    '</button>' +
                    '<button type="button" class="format-btn" onclick="formatText(\'italic\')" title="ê¸°ìš¸ì„ (Ctrl+I)">' +
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">' +
                            '<path d="M19 4h-9l-3 18h9l3-18z"/>' +
                        '</svg>' +
                    '</button>' +
                    '<button type="button" class="format-btn" onclick="formatText(\'underline\')" title="ë°‘ì¤„ (Ctrl+U)">' +
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                            '<path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"/>' +
                            '<line x1="4" y1="21" x2="20" y2="21"/>' +
                        '</svg>' +
                    '</button>' +
                    '<div style="width: 1px; height: 20px; background: rgba(255,255,255,0.1); margin: 0 2px;"></div>' +
                    '<button type="button" class="format-btn" onclick="formatText(\'bigger\')" title="ê¸€ì”¨ í¬ê²Œ (Shift + =)">' +
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                            '<text x="12" y="18" font-size="18" font-weight="bold" text-anchor="middle" fill="currentColor">A</text>' +
                            '<path d="M16 8l2-2 2 2" stroke-width="1.5"/>' +
                        '</svg>' +
                    '</button>' +
                    '<button type="button" class="format-btn" onclick="formatText(\'smaller\')" title="ê¸€ì”¨ ì‘ê²Œ (Shift + -)">' +
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                            '<text x="12" y="16" font-size="12" text-anchor="middle" fill="currentColor">A</text>' +
                            '<path d="M16 18l2 2 2-2" stroke-width="1.5"/>' +
                        '</svg>' +
                    '</button>' +
                    '<div style="width: 1px; height: 20px; background: rgba(255,255,255,0.1); margin: 0 2px;"></div>' +
                    '<button type="button" class="format-btn" onclick="formatText(\'strikethrough\')" title="ì·¨ì†Œì„  (Shift+S)">' +
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                            '<line x1="4" y1="12" x2="20" y2="12"/>' +
                            '<path d="M9 5h6M9 19h6"/>' +
                        '</svg>' +
                    '</button>' +
                    '<button type="button" class="format-btn" onclick="formatText(\'highlight\')" title="í•˜ì´ë¼ì´íŠ¸ (Shift+H)">' +
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                            '<rect x="6" y="8" width="12" height="8" fill="rgba(255,255,0,0.3)" stroke="none"/>' +
                            '<path d="M8 14l-2 6h12l-2-6"/>' +
                        '</svg>' +
                    '</button>' +
                    '<span style="color: #666; font-size: 11px; margin-left: auto; align-self: center;">í…ìŠ¤íŠ¸ ì„ íƒ í›„ ë²„íŠ¼ í´ë¦­ ë˜ëŠ” ë‹¨ì¶•í‚¤ ì‚¬ìš©</span>' +
                '</div>' +
                '<textarea id="pageContent" placeholder="ì´ í˜ì´ì§€ì˜ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”...&#10;&#10;íŒ:&#10;- í•œ í˜ì´ì§€ì— í•œ ì¥ë©´ì´ë‚˜ í•œ ë‹¨ë½ì„ ì‘ì„±í•˜ì„¸ìš”&#10;- 200ì ì´ë‚´ë¡œ ì‘ì„±í•˜ë©´ ì½ê¸° í¸í•©ë‹ˆë‹¤&#10;- **êµµê²Œ**, *ê¸°ìš¸ì„*, __ë°‘ì¤„__, ++í¬ê²Œ++, --ì‘ê²Œ--, ~~ì·¨ì†Œì„ ~~, ==í•˜ì´ë¼ì´íŠ¸== ì‚¬ìš© ê°€ëŠ¥" oninput="updateCharCount()"></textarea>' +
            '</div>' +
            '<div style="background: #16213e; padding: 20px; border-radius: 12px; margin-top: 20px;">' +
                '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">' +
                    '<h4 style="color: #fff; font-size: 16px; margin: 0;">ğŸµ í˜ì´ì§€ ì˜¤ë””ì˜¤</h4>' +
                    audioRemoveBtn +
                '</div>' +
                '<div style="display: flex; gap: 10px; margin-bottom: 10px;">' +
                    '<input type="file" id="audioFileInput" accept="audio/*" style="display: none;" onchange="handleAudioUpload(event)">' +
                    '<button class="btn btn-secondary" style="flex: 1;" onclick="generatePageTTS(event)">'+
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">'+
                            '<polygon points="5 3 19 12 5 21 5 3"/>'+
                        '</svg>'+
                        'ì „ì²´ TTS ìƒì„±'+
                    '</button>' +
                '</div>' +
audioSection + getFilter()

                '<div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">' +
                    'ğŸ’¡ í…ìŠ¤íŠ¸ë¥¼ ë“œë˜ê·¸ë¡œ ì„ íƒí•œ í›„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”' +
                '</div>' +
            '</div>' +
            '<div class="editor-footer">' +
                '<div class="footer-info">' +
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                        '<circle cx="12" cy="12" r="10"/>' +
                        '<path d="M12 6v6l4 2"/>' +
                    '</svg>' +
                    ' ìë™ ì €ì¥ë¨' +
                '</div>' +
                '<div class="pagination-controls">' +
                    '<button class="btn btn-secondary" onclick="prevPage()" ' + (index === 0 ? 'disabled' : '') + '>â† ì´ì „</button>' +
                    '<button class="btn btn-secondary" onclick="nextPage()" ' + (index === pages.length - 1 ? 'disabled' : '') + '>ë‹¤ìŒ â†’</button>' +
                '</div>' +
            '</div>';

        // textareaì˜ valueë¥¼ JavaScriptë¡œ ì§ì ‘ ì„¤ì • (HTML ì´ìŠ¤ì¼€ì´í•‘ ë¬¸ì œ ë°©ì§€)
        setTimeout(() => {
            const textarea = document.getElementById('pageContent');
                initAudioFilters();
            if (textarea) {
                textarea.value = page.content;
                console.log('âœ… loadPage() - textareaì— í…ìŠ¤íŠ¸ ì„¤ì •:', page.content.length, 'ì');
            }
            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì´ˆê¸°í™”
            initAudioPlayer();
        }, 50);
    }

    renderPagesList();
}

function updateCharCount() {
    const textarea = document.getElementById('pageContent');
    let charCount = textarea.value.length;

    // 200ì ì´ìƒì´ë©´ ìë¥´ê¸°
    if (charCount > 200) {
        textarea.value = textarea.value.substring(0, 200);
        charCount = 200; // ì˜ë¼ë‚¸ í›„ ê¸€ì ìˆ˜ ì¬ì„¤ì •
    }

    document.getElementById('currentCharCount').textContent = charCount;

    const warning = document.getElementById('charWarning');
    if (charCount >= 200) {
        warning.style.display = 'inline';
    } else {
        warning.style.display = 'none';
    }

    // ì‹¤ì‹œê°„ ì €ì¥
    pages[currentPageIndex].content = textarea.value;
    pages[currentPageIndex].charCount = charCount;

    // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
    renderPagesList();
}




// ========= Web Audio í•„í„° UI (=ë²„íŠ¼+í•„í„° ì„¤ì • ëª¨ìŒ) =========
function getFilter() {
    return `
        <div id="webaudioUI" style="margin-top:15px; padding:10px; background:#252836; border-radius:8px; color:#fff;">
            <h5 style="margin-bottom:8px;">ğŸ§ ëª©ì†Œë¦¬ íš¨ê³¼</h5>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                <button class="btn btn-secondary voice-btn" data-voice="normal">ê¸°ë³¸</button>
                <button class="btn btn-secondary voice-btn" data-voice="phone">ì „í™”</button>
                <button class="btn btn-secondary voice-btn" data-voice="cave">ë™êµ´</button>
                <button class="btn btn-secondary voice-btn" data-voice="underwater">ë¬¼ì†</button>
                <button class="btn btn-secondary voice-btn" data-voice="robot">ë¡œë´‡</button>
                <button class="btn btn-secondary voice-btn" data-voice="ghost">ìœ ë ¹</button>
                <button class="btn btn-secondary voice-btn" data-voice="old">ë…¸ì¸</button>
                <button class="btn btn-secondary voice-btn" data-voice="whisper">ì†ì‚­ì„</button>
                <button class="btn btn-secondary voice-btn" data-voice="radio">ë¼ë””ì˜¤</button>
                <button class="btn btn-secondary voice-btn" data-voice="megaphone">í™•ì„±ê¸°</button>
                <button class="btn btn-secondary voice-btn" data-voice="protoss">ì‹ ì„±í•œ ëª©ì†Œë¦¬</button>
                <button class="btn btn-secondary voice-btn" data-voice="demon">ì•…ë§ˆ</button>
                <button class="btn btn-secondary voice-btn" data-voice="vader">ë‹¤ìŠ¤ë² ì´ë”</button>
                <button class="btn btn-secondary voice-btn" data-voice="giant">ì‘ì€ ë©”ë¦¬ì•„</button>
                <button class="btn btn-secondary voice-btn" data-voice="possessed">ë¹™ì˜</button>
                <button class="btn btn-secondary voice-btn" data-voice="horror">í˜¸ëŸ¬</button>
                <button class="btn btn-secondary voice-btn" data-voice="helium">í—¬ë¥¨</button>
                <button class="btn btn-secondary voice-btn" data-voice="timewarp">ë©”ì•„ë¦¬</button>
                <button class="btn  btn-secondary voice-btn" data-voice="glitch">ê¸€ë¦¬ì¹˜ AI</button>
                <button class="btn  btn-secondary    voice-btn" data-voice="hyperpop">Hyperpop</button>
                <button class="btn  btn-secondary voice-btn" data-voice="vaporwave">Vaporwave</button>
                <button class="btn  btn-secondary   voice-btn" data-voice="bitcrush-voice">Bitcrush</button>
            </div>

            <h5>í•„í„° ì„ íƒ</h5>
            <label>í•„í„°:
                <select id="filterType">
                    <option value="allpass">All-pass</option>
                    <option value="lowpass">Low-pass</option>
                    <option value="highpass">High-pass</option>
                    <option value="bandpass">Band-pass</option>
                    <option value="notch">Notch</option>
                </select>
            </label>

            <div style="margin-top:5px;">
                <label>Freq: <input type="number" id="filterFrequency" value="1000"></label>
                <label style="margin-left:10px;">Q: <input type="number" id="filterQ" value="1"></label>
                <label style="margin-left:10px;">Gain: <input type="number" id="filterGain" value="0"></label>
            </div>

            <div style="margin-top:10px;">
                <label style="color:#fff;">ğŸ”Š ë³¼ë¥¨:
                    <input type="range" id="masterVolume" min="0" max="2" step="0.01" value="1" style="width:200px;">
                </label>
            </div>

            <button onclick="saveFilteredAudio()" class="btn btn-purple" style="margin-top:10px;">
                ğŸ§ í˜„ì¬ íš¨ê³¼ë¡œ ì˜¤ë””ì˜¤ ì €ì¥
            </button>
        </div>
    `;
}


// í˜ì´ì§€ ì¶”ê°€
function addPage() {
    saveCurrentPage();
    const newPage = createPage();

    // í˜„ì¬ í˜ì´ì§€ ë°”ë¡œ ë’¤ì— ì¶”ê°€
    pages.splice(currentPageIndex + 1, 0, newPage);

    // í˜„ì¬ í˜ì´ì§€ ì¸ë±ìŠ¤ë¥¼ ìƒˆë¡œ ì¶”ê°€í•œ í˜ì´ì§€ë¡œ ì´ë™
    currentPageIndex = currentPageIndex + 1;

    renderPagesList();
    loadPage(currentPageIndex);
}

// í˜ì´ì§€ ì‚­ì œ
function deletePage() {
    if (pages.length <= 1) {
        alert('ìµœì†Œ 1ê°œì˜ í˜ì´ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }

    if (!confirm(`í˜ì´ì§€ ${currentPageIndex + 1}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    pages.splice(currentPageIndex, 1);

    if (currentPageIndex >= pages.length) {
        currentPageIndex = pages.length - 1;
    }

    loadPage(currentPageIndex);
    console.log("pages:", pages);
console.log("currentPageIndex:", currentPageIndex);
}

function destroyPage() {
        location.reload();

}

// ì´ì „/ë‹¤ìŒ í˜ì´ì§€
function prevPage() {
    if (currentPageIndex > 0) {
        loadPage(currentPageIndex - 1);
    }
}

function nextPage() {
    if (currentPageIndex < pages.length - 1) {
        loadPage(currentPageIndex + 1);
    }
}

// ì—í”¼ì†Œë“œ ì €ì¥
async function saveEpisode() {
    console.log("ğŸ¬ saveEpisode í•¨ìˆ˜ í˜¸ì¶œë¨");
    saveCurrentPage();

    const episodeTitle = document.getElementById('episodeTitle').value.trim();
    console.log("ğŸ“ ì—í”¼ì†Œë“œ ì œëª©:", episodeTitle);

    if (!episodeTitle) {
        alert('ì—í”¼ì†Œë“œ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ëª¨ë“  í˜ì´ì§€ ë‚´ìš©ì„ í•©ì¹¨
    const fullContent = pages.map(page => page.content).join('\n\n---\n\n');

    if (!fullContent.trim()) {
        alert('ìµœì†Œ í•˜ë‚˜ì˜ í˜ì´ì§€ì— ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë§ˆì§€ë§‰ ì—í”¼ì†Œë“œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    const contentNumber = {{ latest_episode_number|default:0 }} + 1;

    // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
    const saveBtn = document.querySelector('.publish-btn');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ì €ì¥ ì¤‘...';
    }

    try {
        // FormDataë¡œ ì˜¤ë””ì˜¤ íŒŒì¼ë“¤ê³¼ í•¨ê»˜ ì „ì†¡
        const formData = new FormData();
        formData.append('book_id', bookId);
        formData.append('content_number', contentNumber);
        formData.append('content_title', episodeTitle);
        formData.append('content_text', fullContent);
        formData.append('voice_id', selectedVoiceId);
        formData.append('language_code', selectedLanguage);
        formData.append('speed_value', voiceSpeed);  // ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© (ìˆ«ìë¡œ ì „ì†¡)  


        // ê° ëŒ€ì‚¬ì˜ ì˜¤ë””ì˜¤ íŒŒì¼ê³¼ í…ìŠ¤íŠ¸ ì¶”ê°€
        pages.forEach((page, index) => {
            if (page.audioFile) {
                formData.append(`audio_${index}`, page.audioFile);
                console.log(`ğŸ“ ëŒ€ì‚¬ ${index + 1}ì˜ ì˜¤ë””ì˜¤ íŒŒì¼ ì¶”ê°€ë¨`);
            }
            // í˜ì´ì§€ í…ìŠ¤íŠ¸ë„ í•¨ê»˜ ì „ì†¡ (íƒ€ì„ìŠ¤íƒ¬í”„ ë§¤í•‘ìš©) - ì‚¬ìš´ë“œ ì´íŒ©íŠ¸ëŠ” ë¹ˆ ë¬¸ìì—´ë¡œ ì „ì†¡
            formData.append(`page_text_${index}`, page.isSoundEffect ? '' : (page.content || ''));
        });

        // ë°°ê²½ìŒ ì •ë³´ ì¶”ê°€
        if (backgroundTracks && backgroundTracks.length > 0) {
            // ë°°ê²½ìŒ íŠ¸ë™ ê°œìˆ˜
            formData.append('background_tracks_count', backgroundTracks.length);

            // ê° ë°°ê²½ìŒ íŒŒì¼ê³¼ ì •ë³´ ì¶”ê°€
            backgroundTracks.forEach((track, index) => {
                if (track.audioFile) {
                    formData.append(`background_audio_${index}`, track.audioFile);
                    formData.append(`background_start_${index}`, track.startPage);
                    formData.append(`background_end_${index}`, track.endPage);
                    formData.append(`background_name_${index}`, track.musicName);
                    formData.append(`background_volume_${index}`, track.volume ?? 1);
                    console.log(`ğŸ¼ ë°°ê²½ìŒ ${index + 1}: ${track.musicName} (ëŒ€ì‚¬ ${track.startPage + 1} ~ ${track.endPage + 1}), ë³¼ë¥¨: ${(track.volume ?? 1) * 100}%`);
                }
            });
        } else {
            formData.append('background_tracks_count', 0);
        }

        const response = await fetch('{% url "book:book_serialization" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // ë°œí–‰ ì„±ê³µ ì‹œ ì„ì‹œì €ì¥ ì‚­ì œ
            clearDraft();

            alert(data.message || 'ì—í”¼ì†Œë“œê°€ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!');
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                window.location.href = `{% url 'book:book_profile' %}?book_id=${bookId}`;
            }
        } else {
            alert(data.error || 'ì—í”¼ì†Œë“œ ë°œí–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ“¤ ì—í”¼ì†Œë“œ ë°œí–‰';
            }
        }
    } catch (error) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì—í”¼ì†Œë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ğŸ“¤ ì—í”¼ì†Œë“œ ë°œí–‰';
        }
    }
}


// ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
function handleAudioUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('audio/')) {
        alert('ì˜¤ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB ì œí•œ)
    if (file.size > 10 * 1024 * 1024) {
        alert('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }

    // íŒŒì¼ì„ URLë¡œ ë³€í™˜
    const audioUrl = URL.createObjectURL(file);
    pages[currentPageIndex].audioFile = file;
    pages[currentPageIndex].audioUrl = audioUrl;

    // í˜ì´ì§€ ë‹¤ì‹œ ë¡œë“œ
    loadPage(currentPageIndex);
}



// ì „ì²´ í˜ì´ì§€ TTSë¡œ ì˜¤ë””ì˜¤ ìƒì„±
async function generatePageTTS(event) {
    event.preventDefault(); // í˜¹ì‹œ form ì•ˆì— ìˆìœ¼ë©´ ê¸°ë³¸ ë™ì‘ ë§‰ê¸°
    const btn = event.target.closest('button'); // í´ë¦­í•œ ë²„íŠ¼ ì°¾ê¸°
    const textarea = document.getElementById('pageContent');

    if (!textarea) {
        alert('í˜ì´ì§€ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const pageContent = textarea.value.trim();

    if (!pageContent) {
        alert('í˜ì´ì§€ì— ë‚´ìš©ì„ ë¨¼ì € ì‘ì„±í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'ğŸ”„ ìƒì„± ì¤‘...';

    try {
        const response = await fetch('/book/tts/generate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                text: pageContent,
                voice_id: selectedVoiceId,
                language_code: selectedLanguage,
                speed_value: voiceSpeed  // ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© (ìˆ«ìë¡œ ì „ì†¡)
            })
        });

        if (!response.ok) {
            throw new Error('TTS ìƒì„± ì‹¤íŒ¨');
        }

        const blob = await response.blob();
        const audioUrl = URL.createObjectURL(blob);
        const audioFile = new File([blob], `page_${currentPageIndex + 1}_tts.mp3`, { type: 'audio/mp3' });

        // í˜„ì¬ í˜ì´ì§€ì— ì €ì¥
        pages[currentPageIndex].audioFile = audioFile;
        pages[currentPageIndex].audioUrl = audioUrl;

        // í˜ì´ì§€ ë‹¤ì‹œ ë Œë”ë§
        loadPage(currentPageIndex);

    } catch (err) {
        console.error(err);
        alert(err.message);
    } finally {
        // ë²„íŠ¼ ì›ë˜ ìƒíƒœ ë³µì›
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}


// ì˜¤ë””ì˜¤ ì œê±°
function removeAudio() {
    if (!confirm('ì´ í˜ì´ì§€ì˜ ì˜¤ë””ì˜¤ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    if (pages[currentPageIndex].audioUrl) {
        URL.revokeObjectURL(pages[currentPageIndex].audioUrl);
    }

    pages[currentPageIndex].audioFile = null;
    pages[currentPageIndex].audioUrl = null;

    loadPage(currentPageIndex);
}

// ìë™ ì„ì‹œì €ì¥ (30ì´ˆë§ˆë‹¤)
let autoSaveInterval = null;


// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initPages();
    startAutoSave(); // ìë™ ì €ì¥ ì‹œì‘
});

// í˜ì´ì§€ ë– ë‚  ë•Œ ê²½ê³  ë° ìë™ ì €ì¥
window.addEventListener('beforeunload', function(e) {
    const hasContent = pages.some(page => page.content.trim() !== '');
    if (hasContent) {
        // ë– ë‚˜ê¸° ì „ ë§ˆì§€ë§‰ ìë™ ì €ì¥
        saveDraft();

        e.preventDefault();
        e.returnValue = '';
    }
});


const audioBookGuideData = {{ guide_list|safe }};


// ì¹´í…Œê³ ë¦¬ ëª©ë¡ (ëª¨ë¸ì˜ choices ê¸°ë°˜)
const guideCategories = [
    {key: "voiceChoice", label: "ë³´ì´ìŠ¤ ì„ íƒí•˜ê¸°"},
    {key: "page", label: "ëŒ€ì‚¬"},
    {key: "emotionList", label: "ê°ì • ë¦¬ìŠ¤íŠ¸"},
    {key: "soundEffect", label: "ì‚¬ìš´ë“œ ì´í™íŠ¸"},
    {key: "musicSound", label: "ë°°ê²½ìŒ"},
    {key: "pageAudio", label: "í˜ì´ì§€ ì˜¤ë””ì˜¤"},
    {key: "voiceSetting", label: "ìŒì„± ì„¤ì •"},
    {key: "save", label: "ì„ì‹œì €ì¥"},
    {key: "preview", label: "ë¯¸ë¦¬ë“£ê¸°"},
    {key: "etc", label: "ê¸°íƒ€"},
];


function audioBookGuide(selectedCategory) {
    const view = document.getElementById("audioBookGuideView");

    // ì˜¤ë²„ë ˆì´ ì¹´ë“œ ìŠ¤íƒ€ì¼ ì ìš©
    view.style.display = "flex";
    view.style.position = "fixed";
    view.style.top = 0;
    view.style.left = 0;
    view.style.width = "100%";
    view.style.height = "100%";
    view.style.background = "rgba(0,0,0,0.55)";
    view.style.backdropFilter = "blur(6px)";
    view.style.zIndex = 30;
    view.style.justifyContent = "center";
    view.style.alignItems = "center";
    view.style.padding = "20px";

    // serialize
    let guides = audioBookGuideData.map(g => ({
        id: g.pk,
        ...g.fields
    }));

    // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ìë™ ì„ íƒ
    if (!selectedCategory) selectedCategory = guideCategories[0].key;
    guides = guides.filter(g => g.category === selectedCategory);

    // ì¹´í…Œê³ ë¦¬ íƒ­ HTML
    let categoryTabsHTML = `
        <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
            ${guideCategories.map(cat => `
                <button 
                    onclick="audioBookGuide('${cat.key}')"
                    style="
                        padding: 8px 14px;
                        border-radius: 20px;
                        border: 1px solid rgba(255,255,255,0.15);
                        background: ${selectedCategory === cat.key ? 'white' : 'rgba(255,255,255,0.1)'};
                        color: ${selectedCategory === cat.key ? '#111' : 'white'};
                        cursor:pointer;
                        transition: .2s;
                    "
                >${cat.label}</button>
            `).join("")}
        </div>
    `;

    // ë¦¬ìŠ¤íŠ¸ HTML
    let guideListHTML = guides.length ? `
        <div style="
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 60vh;
            overflow-y: auto;
        ">
            ${guides.map(g => `
                <div style="
                    background: rgba(255,255,255,0.03);
                    border-radius: 10px;
                    overflow: hidden;
                    border: 1px solid rgba(255,255,255,0.05);
                ">
                    ${g.guide_video ? `
                        <div style="width:100%; background:#000;">
                            <video
                                controls
                                style="width:100%; max-height:300px; display:block;"
                                preload="metadata"
                            >
                                <source src="${g.guide_video}" type="video/mp4">
                                ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                            </video>
                        </div>
                    `: ''}

                    <div style="padding:15px;">
                        <div style="font-size:18px; font-weight:700; color:#fff; margin-bottom:8px;">
                            ${g.title}
                        </div>

                <div style="
                    opacity:0.8;
                    font-size:14px;
                    line-height:1.6;
                    color:#ccc;
                max-height: 120px;
                overflow-y: auto;
                +  padding-right: 6px;
                ">                            ${ g.description || ''}
                        </div>

                        ${g.video_url ? `
  
                        ` : ''}
                    </div>
                </div>
            `).join("")}
        </div>
    ` : `
        <div style="padding:40px; text-align:center; opacity:0.5;">
            ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
    `;

    // ìµœì¢… ë Œë”ë§ (ì¤‘ì•™ ì¹´ë“œ ë°•ìŠ¤)
    view.innerHTML = `
        <div style="
            position: relative;
            width: 600px;
            max-width: 95%;
            background: rgba(20,20,20,0.85);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        ">
            <h2 style="margin-bottom:15px; font-size:20px;">ì˜¤ë””ì˜¤ë¶ ê°€ì´ë“œ</h2>

            <!-- ë‹«ê¸° ë²„íŠ¼ -->
            <button 
                onclick="document.getElementById('audioBookGuideView').style.display='none'"
                style="
                    position:absolute;
                    top:12px;
                    right:12px;
                    background:rgba(255,255,255,0.15);
                    border:none;
                    color:white;
                    font-size:18px;
                    width:32px;
                    height:32px;
                    border-radius:50%;
                    cursor:pointer;
                "
            >Ã—</button>

            ${categoryTabsHTML}
            ${guideListHTML}
        </div>
    `;
}

// í…ìŠ¤íŠ¸ í¬ë§·íŒ… í•¨ìˆ˜
function formatText(type) {
    const textarea = document.getElementById('pageContent');
    if (!textarea) return;

    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    if (!selectedText) {
        alert('ë¨¼ì € í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    let formattedText = '';

    switch(type) {
        case 'bold':
            formattedText = `**${selectedText}**`;
            break;
        case 'italic':
            formattedText = `*${selectedText}*`;
            break;
        case 'underline':
            formattedText = `__${selectedText}__`;
            break;
        case 'bigger':
            formattedText = `++${selectedText}++`;
            break;
        case 'smaller':
            formattedText = `--${selectedText}--`;
            break;
        case 'strikethrough':
            formattedText = `~~${selectedText}~~`;
            break;
        case 'highlight':
            formattedText = `==${selectedText}==`;
            break;
    }

    // ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ í¬ë§·íŒ…ëœ í…ìŠ¤íŠ¸ë¡œ êµì²´
    const newValue = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    textarea.value = newValue;

    // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
    const newCursorPos = start + formattedText.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();

    // ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
    updateCharCount();
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì§€ì›
document.addEventListener('keydown', function(e) {
    const textarea = document.getElementById('pageContent');
    if (!textarea || document.activeElement !== textarea) return;

    // Ctrl/Cmd + í‚¤ ì¡°í•©
    if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
            case 'b':
                e.preventDefault();
                formatText('bold');
                break;
            case 'i':
                e.preventDefault();
                formatText('italic');
                break;
            case 'u':
                e.preventDefault();
                formatText('underline');
                break;
        }
    }

    // Shift + í‚¤ ì¡°í•©
    if (e.shiftKey && !e.ctrlKey && !e.metaKey) {
        switch(e.key) {
            case '+':
            case '=':  // = í‚¤ (Shift ì—†ì´)
                e.preventDefault();
                formatText('bigger');
                break;
            case '_':
            case '-':  // - í‚¤ (Shift ì—†ì´)
                e.preventDefault();
                formatText('smaller');
                break;
            case 'S':
                e.preventDefault();
                formatText('strikethrough');
                break;
            case 'H':
                e.preventDefault();
                formatText('highlight');
                break;
        }
    }
});

// ========= ì»¤ìŠ¤í…€ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤ =========

// ì¬ìƒ/ì¼ì‹œì •ì§€ í† ê¸€
function togglePlayPause() {
    const audio = document.getElementById('pageAudioPlayer');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const playPauseBtn = document.getElementById('playPauseBtn');

    if (!audio) return;

    if (audio.paused) {
        audio.play();
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
        playPauseBtn.style.transform = 'scale(1.05)';
    } else {
        audio.pause();
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        playPauseBtn.style.transform = 'scale(1)';
    }
}

// ì‹œê°„ í¬ë§·íŒ… (ì´ˆ â†’ ë¶„:ì´ˆ)
function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// í”„ë¡œê·¸ë ˆìŠ¤ ë°” í´ë¦­ìœ¼ë¡œ íƒìƒ‰
function seekAudio(event) {
    const audio = document.getElementById('pageAudioPlayer');
    const progressBarContainer = document.getElementById('progressBarContainer');

    if (!audio || !progressBarContainer) return;

    const rect = progressBarContainer.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;

    audio.currentTime = percentage * audio.duration;
}

// ë³¼ë¥¨ ì¡°ì ˆ
function changeVolume(value) {
    const audio = document.getElementById('pageAudioPlayer');
    if (!audio) return;

    audio.volume = value / 100;
}

// ì¬ìƒ ì†ë„ ì¡°ì ˆ
function changeSpeed(value) {
    const audio = document.getElementById('pageAudioPlayer');
    if (!audio) return;

    audio.playbackRate = parseFloat(value);
}

// ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
function downloadAudio(url) {
    const a = document.createElement('a');
    a.href = url;
    a.download = 'audio_' + Date.now() + '.mp3';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// ì˜¤ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í˜¸ì¶œ)
function initAudioPlayer() {
    const audio = document.getElementById('pageAudioPlayer');
    if (!audio) return;

    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');

    // ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹œ ì´ ì‹œê°„ ì„¤ì •
    audio.addEventListener('loadedmetadata', () => {
        if (totalTimeEl) {
            totalTimeEl.textContent = formatTime(audio.duration);
        }
    });

    // ì¬ìƒ ì¤‘ ì‹œê°„ ì—…ë°ì´íŠ¸
    audio.addEventListener('timeupdate', () => {
        if (currentTimeEl) {
            currentTimeEl.textContent = formatTime(audio.currentTime);
        }

        if (progressBar && audio.duration) {
            const percentage = (audio.currentTime / audio.duration) * 100;
            progressBar.style.width = percentage + '%';
        }
    });

    // ì¬ìƒ ì¢…ë£Œ ì‹œ ì•„ì´ì½˜ ë¦¬ì…‹
    audio.addEventListener('ended', () => {
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const playPauseBtn = document.getElementById('playPauseBtn');

        if (playIcon && pauseIcon && playPauseBtn) {
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
            playPauseBtn.style.transform = 'scale(1)';
        }
    });

    console.log('ğŸµ ì»¤ìŠ¤í…€ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì´ˆê¸°í™” ì™„ë£Œ');
}

// í˜ì´ì§€ ë¡œë“œ ì‹œë§ˆë‹¤ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì´ˆê¸°í™” (loadPage í•¨ìˆ˜ ë‚´ì—ì„œë„ í˜¸ì¶œë¨)
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initAudioPlayer, 100);
});

</script>



{% endblock %}
