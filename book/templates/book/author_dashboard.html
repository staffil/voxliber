{% extends "base.html" %}
{% load static %}

{% block title %}ì‘ê°€ ì„¼í„° - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/author_dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <div class="dashboard-header">
        <h1>ğŸ“Š ì‘ê°€ ì„¼í„°</h1>
        <p>ì‘í’ˆì˜ í†µê³„ì™€ ë…ì ë¶„ì„ì„ í™•ì¸í•˜ì„¸ìš”</p>
    </div>

    {% if total_books > 0 %}
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-header"><div class="stat-icon primary">ğŸ“š</div></div>
            <div class="stat-card-value">{{ total_books }}</div>
            <div class="stat-card-title">ì´ ì‘í’ˆ ìˆ˜</div>
            <div class="stat-card-subtitle">{{ total_contents }}ê°œ ì—í”¼ì†Œë“œ</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header"><div class="stat-icon success">ğŸ‘¥</div></div>
            <div class="stat-card-value">{{ total_readers }}</div>
            <div class="stat-card-title">ì´ ë…ì ìˆ˜</div>
            <div class="stat-card-subtitle">ìµœê·¼ 30ì¼: {{ recent_readers }}ëª…</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header"><div class="stat-icon warning">ğŸ§</div></div>
            <div class="stat-card-value">{{ total_audio_duration }}</div>
            <div class="stat-card-title">ì´ ì˜¤ë””ì˜¤ ê¸¸ì´</div>
            <div class="stat-card-subtitle">ì „ì²´ ì‘í’ˆ í•©ê³„</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header"><div class="stat-icon info">â­</div></div>
            <div class="stat-card-value">{{ book_stats|length }}</div>
            <div class="stat-card-title">í™œì„± ì‘í’ˆ</div>
            <div class="stat-card-subtitle">ë…ìê°€ ìˆëŠ” ì‘í’ˆ</div>
        </div>
    </div>

    <div class="book-stats-section">
        <h2 class="section-title">ì‘í’ˆë³„ í†µê³„</h2>

        <div class="book-stats-grid">
            {% for stat in book_stats %}
            <div class="book-stat-card">

                <div class="book-stat-header">
                    <div class="book-cover-mini">
                        {% if stat.book.cover_img %}
                        <img src="{{ stat.book.cover_img.url }}" alt="{{ stat.book.name }}" loading="lazy">
                        {% else %}
                        <div class="book-cover-placeholder">ğŸ“–</div>
                        {% endif %}
                    </div>

                    <div class="book-stat-info">
                        <h3>{{ stat.book.name }}</h3>
                        <div class="meta">
                            <span>ğŸ‘¥ {{ stat.reader_count }}ëª…</span>
                            <span>ğŸ§ ì´ ê¸¸ì´: {{ stat.book_duration }}</span>
                            <span>â±ï¸ ì´ ì²­ì·¨: {{ stat.total_listening_formatted }}</span>
                            <span>ğŸ“Š ì§„í–‰ë¥ : {{ stat.avg_progress_percent }}%</span>
                        </div>
                    </div>


                </div>
<div class="status-buttons" data-book-id="{{ stat.book.id }}">
    <button class="status-btn" data-status="ongoing"
        {% if stat.book.status == "ongoing" %}disabled{% endif %}>ì—°ì¬ ì¤‘</button>
    <button class="status-btn" data-status="paused"
        {% if stat.book.status == "paused" %}disabled{% endif %}>íœ´ì¬</button>
    <button class="status-btn" data-status="ended"
        {% if stat.book.status == "ended" %}disabled{% endif %}>ì—°ì¬ ì¢…ë£Œ</button>
</div>



                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">ì„±ë³„ ë¶„í¬</div>
                        <canvas id="genderChart{{ forloop.counter }}"></canvas>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">ì—°ë ¹ëŒ€ ë¶„í¬</div>
                        <canvas id="ageChart{{ forloop.counter }}"></canvas>
                    </div>
                </div>

            </div>
            {% endfor %}
        </div>
    </div>

    <!-- JSON ë°ì´í„° ì „ë‹¬ -->
    <script id="book-stats-data" type="application/json">
        {{ book_stats_json|safe }}
    </script>

    {% else %}
    <div class="empty-state">
        <svg width="120" height="120" viewBox="0 0 24 24">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
        </svg>
        <h2>ì•„ì§ ì‘ì„±í•œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</h2>
        <p>ìƒˆë¡œìš´ ì‘í’ˆì„ ë“±ë¡í•˜ê³  ë…ìë“¤ê³¼ ì†Œí†µí•˜ì„¸ìš”!</p>
        <a href="{% url 'book:book_profile' %}" class="btn-primary">
            <svg width="20" height="20" viewBox="0 0 24 24">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            ì²« ì‘í’ˆ ë“±ë¡í•˜ê¸°
        </a>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const dataEl = document.getElementById("book-stats-data");
    const stats = dataEl ? JSON.parse(dataEl.textContent) : [];

    if (!stats.length) return;

    stats.forEach((stat, i) => {
        const id = i + 1;

        /* --------------------------
           ì„±ë³„ ì°¨íŠ¸
        --------------------------- */
        const genderCtx = document.getElementById(`genderChart${id}`);
        if (genderCtx) {
            new Chart(genderCtx, {
                type: "doughnut",
                data: {
                    labels: ["ë‚¨ì„±", "ì—¬ì„±", "ê¸°íƒ€"],
                    datasets: [{
                        data: [
                            stat.gender_data.M || 0,
                            stat.gender_data.F || 0,
                            stat.gender_data.O || 0
                        ],
                        backgroundColor: ["#3b82f6", "#ec4899", "#8b5cf6"],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: "bottom" }
                    }
                }
            });
        }

        /* --------------------------
           ì—°ë ¹ëŒ€ ì°¨íŠ¸
        --------------------------- */
        const ageCtx = document.getElementById(`ageChart${id}`);
        if (ageCtx) {
            new Chart(ageCtx, {
                type: "bar",
                data: {
                    labels: ["ì–´ë¦°ì´", "10ëŒ€", "20ëŒ€", "30ëŒ€", "40ëŒ€", "50ëŒ€+"],
                    datasets: [{
                        data: [
                            stat.age_data["ì–´ë¦°ì´"] || 0,
                            stat.age_data["10ëŒ€"] || 0,
                            stat.age_data["20ëŒ€"] || 0,
                            stat.age_data["30ëŒ€"] || 0,
                            stat.age_data["40ëŒ€"] || 0,
                            stat.age_data["50ëŒ€ ì´ìƒ"] || 0
                        ],
                        backgroundColor: "rgba(99, 102, 241, 0.8)",
                        borderColor: "#6366f1",
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0; i<cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.querySelectorAll('.status-buttons').forEach(container => {
    const bookId = container.dataset.bookId;
    container.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const newStatus = btn.dataset.status;
            fetch(`/book/${bookId}/toggle_status/`, {
                method: "POST",
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({status: newStatus})
            })
            .then(res => res.json())
            .then(data => {
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                container.querySelectorAll('.status-btn').forEach(b => b.disabled = false);
                btn.disabled = true;
            })
            .catch(err => console.error(err));
        });
    });
});



</script>
{% endblock %}
