{% extends "base.html" %}
{% load static %}

{% block title %}ì˜¤ë””ì˜¤ë¶ ìƒì„±ê¸° | VoxLiber{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/book_serialization_fast.css' %}">
<style>
/* ğŸ”¥ ì—í”¼ì†Œë“œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
.episode-image-upload {
    margin-top: 15px;
}
.image-upload-box {
    width: 100%;
    height: 180px;
    border: 2px dashed #ddd;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    background: #fafafa;
    transition: all 0.3s;
}
.image-upload-box:hover {
    border-color: #667eea;
    background: #f5f7ff;
}
.image-placeholder {
    text-align: center;
    color: #999;
}
.image-placeholder svg {
    width: 40px;
    height: 40px;
    margin-bottom: 8px;
}
.preview-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
}
.preview-img.show {
    display: block;
}
.delete-img-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.image-upload-box:hover .delete-img-btn {
    display: flex;
    align-items: center;
    justify-content: center;
}
.delete-img-btn:hover {
    background: white;
}
</style>
{% endblock %}

{% block content %}

<div class="container">
    <!-- í—¤ë” -->
    <div class="header-section">
        <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;">
            <div>
                <h1>ì˜¤ë””ì˜¤ë¶ ìƒì„±ê¸°</h1>
                <p>ë²ˆí˜¸ë¡œ ìºë¦­í„°ë¥¼ ì§€ì •í•˜ê³ , ì†Œì„¤ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</p>
            </div>
            <div style="display:flex; gap:8px; flex-shrink:0;">
                <a href="/voice/voice/list/" class="btn-header-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    ë³´ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬
                </a>
                {% if guides %}
                <button class="btn-header-guide" onclick="document.getElementById('guideModal').classList.add('active')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    ì§‘í•„ ê°€ì´ë“œ
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ëª¨ë°”ì¼ JSON ë³´ê¸° ë²„íŠ¼ -->
    <button class="mobile-json-toggle" id="mobileJsonToggle" onclick="toggleMobileJSON()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
        </svg>
        JSON
    </button>

    <!-- ë©”ì¸ ê·¸ë¦¬ë“œ -->
    <div class="main-grid">

        <!-- ì™¼ìª½: ì…ë ¥ ì˜ì—­ -->
        <div class="left-panel">

            <!-- ì—í”¼ì†Œë“œ ì •ë³´ -->
            <div class="panel">
                <div class="panel-header">
                    <h3>ì—í”¼ì†Œë“œ ì •ë³´</h3>
                    <span class="episode-number-badge">EP {{ next_episode_number }}</span>
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <label>ì—í”¼ì†Œë“œ ì œëª©</label>
                        <input type="text" id="episodeTitle" class="form-input" placeholder="ì˜ˆ: 1í™” - ìš´ëª…ì˜ ë§Œë‚¨">
                    </div>

                    <!-- ğŸ”¥ ì—í”¼ì†Œë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                    <div class="form-group episode-image-upload">
                        <label>ì—í”¼ì†Œë“œ ì¸ë„¤ì¼ (ì„ íƒ)</label>
                        <input type="file" id="episodeImageInput" accept="image/*" style="display:none" name="episode_image">
                        <div class="image-upload-box" onclick="document.getElementById('episodeImageInput').click()">
                            <div class="image-placeholder" id="imagePlaceholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                                <div style="font-size:13px">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                            </div>
                            <img id="imagePreview" class="preview-img">
                            <button class="delete-img-btn" onclick="deleteImage(event)">âœ•</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìºë¦­í„° & ëª©ì†Œë¦¬ -->
            <div class="panel">
                <div class="panel-header">
                    <h3>ìºë¦­í„° & ëª©ì†Œë¦¬</h3>
                    <button class="btn-add-small" onclick="addCharacter()">+ ì¶”ê°€</button>
                </div>
                <div class="panel-body">
                    <p class="form-hint" style="margin-bottom: 12px;">ë²ˆí˜¸ = ì†Œì„¤ í…ìŠ¤íŠ¸ ì•ì— ì“¸ ë²ˆí˜¸. 0ì€ ë‚˜ë ˆì´ì…˜ ì „ìš©.</p>
                    <div id="characterList" class="character-list">
                        <!-- ë‚˜ë ˆì´ì…˜ (ê¸°ë³¸) -->
                        <div class="character-item" data-number="0">
                            <div class="character-number-badge narrator">0</div>
                            <div class="character-content">
                                <input type="text" class="character-name" value="ë‚˜ë ˆì´ì…˜" readonly>
                                <select class="voice-select" data-number="0">
                                    <option value="">ëª©ì†Œë¦¬ ì„ íƒ</option>
                                    {% for voice in voice_list %}
                                    <option value="{{ voice.voice.voice_id }}">{{ voice.alias_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- ìºë¦­í„° 1 (ê¸°ë³¸) -->
                        <div class="character-item" data-number="1">
                            <div class="character-number-badge">1</div>
                            <div class="character-content">
                                <input type="text" class="character-name" placeholder="ìºë¦­í„° ì´ë¦„ (ì˜ˆ: ë¯¼ìˆ˜)" data-number="1">
                                <select class="voice-select" data-number="1">
                                    <option value="">ëª©ì†Œë¦¬ ì„ íƒ</option>
                                    {% for voice in voice_list %}
                                    <option value="{{ voice.voice.voice_id }}">{{ voice.alias_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button class="btn-remove-char" onclick="removeCharacter(1)">ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì†Œì„¤ í…ìŠ¤íŠ¸ -->
            <div class="panel">
                <div class="panel-header">
                    <h3>ì†Œì„¤ í…ìŠ¤íŠ¸</h3>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button onclick="aiAssignSpeakers()" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9); color:white; border:none; padding:5px 14px; border-radius:6px; font-size:12px; cursor:pointer; font-weight:600; white-space:nowrap;">
                            AI í™”ì ë¶„ë¥˜
                        </button>
                        <span class="char-count"><span id="charCount">0</span> ê¸€ì</span>
                    </div>
                </div>
                <div class="panel-body">
                    <textarea id="novelText" class="novel-textarea" placeholder="ë°©ë²• 1: ìì—°ì–´ë¡œ ì†Œì„¤ì„ ë¶™ì—¬ë„£ê³  [AI í™”ì ë¶„ë¥˜] í´ë¦­
ë°©ë²• 2: ì§ì ‘ ë²ˆí˜¸ë¥¼ ë§¤ê²¨ì„œ ì…ë ¥

--- ìì—°ì–´ ì˜ˆì‹œ (AI í™”ì ë¶„ë¥˜ìš©) ---
ë¹„ ì˜¤ëŠ” ë°¤ì´ì—ˆë‹¤. ë¯¼ìˆ˜ëŠ” ê³¨ëª©ê¸¸ì„ ê±¸ì—ˆë‹¤.
&quot;ì—¬ê¸°ê°€ ì–´ë””ì§€...&quot; ë¯¼ìˆ˜ê°€ ì¤‘ì–¼ê±°ë ¸ë‹¤.
ê·¸ë•Œ, ë’¤ì—ì„œ ë°œì†Œë¦¬ê°€ ë“¤ë ¸ë‹¤.
&quot;ê±°ê¸° ì„œ!&quot; ì§€ì˜ì´ ì†Œë¦¬ì³¤ë‹¤.

--- ë²ˆí˜¸ í˜•ì‹ ì˜ˆì‹œ (ì§ì ‘ ì…ë ¥) ---
0: ì–´ë‘ìš´ ë°¤ì´ì—ˆë‹¤.
1: &quot;ì—¬ê¸°ê°€ ì–´ë””ì§€...&quot;
0: ê·¸ë•Œ, ë’¤ì—ì„œ ë°œì†Œë¦¬ê°€ ë“¤ë ¸ë‹¤.
2: &quot;ê±°ê¸° ì„œ!&quot;

â€» 0=ë‚˜ë ˆì´ì…˜, 1,2,3...=ìºë¦­í„° ë²ˆí˜¸
â€» ê°™ì€ ë²ˆí˜¸ ì—°ì† â†’ ìë™ í•©ì¹¨ (300ì ì´í•˜)"></textarea>
                </div>
            </div>

        </div>

        <!-- ì˜¤ë¥¸ìª½: JSON í¸ì§‘ & ì•¡ì…˜ -->
        <div class="right-panel" id="rightPanel">

            <!-- ëª¨ë°”ì¼ ë‹«ê¸° ë²„íŠ¼ -->
            <button class="mobile-json-close" onclick="toggleMobileJSON()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>

            <!-- JSON í¸ì§‘ ì˜ì—­ -->
            <div class="panel preview-panel">
                <div class="panel-header">
                    <h3>JSON í¸ì§‘</h3>
                    <span class="form-hint">ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥</span>
                </div>
                <div class="panel-body">
                    <textarea id="jsonEditor" class="json-editor" placeholder="ë¯¸ë¦¬ë³´ê¸°ë¥¼ í´ë¦­í•˜ë©´ JSONì´ ìƒì„±ë©ë‹ˆë‹¤.
ìƒì„±ëœ JSONì„ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
                </div>
            </div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="action-panel">
                <button class="btn btn-secondary" onclick="generateJSONPreview()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    ë¯¸ë¦¬ë³´ê¸°
                </button>

                <button class="btn btn-warning" onclick="downloadJSON()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    ë‹¤ìš´ë¡œë“œ
                </button>

                <button class="btn btn-ai" onclick="aiGenerate()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    AI ìƒì„±
                </button>

                <button class="btn btn-primary" onclick="executeJSON()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polygon points="10 8 16 12 10 16 10 8"/>
                    </svg>
                    ì‹¤í–‰
                </button>
            </div>

            <div id="statusMessage" class="status-message"></div>

        </div>

    </div>
</div>

<!-- ëª¨ë°”ì¼ JSON ì˜¤ë²„ë ˆì´ ë°°ê²½ -->
<div class="mobile-json-overlay" id="mobileJsonOverlay" onclick="toggleMobileJSON()"></div>

<!-- ì‚¬ìš© ê°€ì´ë“œ ëª¨ë‹¬ -->
{% if guides %}
<div class="modal-overlay" id="guideModal">
    <div class="modal-content" style="max-width:700px;">
        <div class="modal-header">
            <h3>ì§‘í•„ ê°€ì´ë“œ</h3>
            <button class="modal-close" onclick="document.getElementById('guideModal').classList.remove('active')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="guide-list">
                {% for guide in guides %}
                <div class="guide-item" onclick="toggleGuideDetail(this)">
                    <div class="guide-item-header">
                        {% if guide.thumbnail %}
                        <img src="{{ guide.thumbnail.url }}" class="guide-thumb" alt="">
                        {% endif %}
                        <div class="guide-item-info">
                            <h4>{{ guide.title }}</h4>
                            {% if guide.short_description %}
                            <p>{{ guide.short_description }}</p>
                            {% endif %}
                        </div>
                        <svg class="guide-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div class="guide-detail">
                        {% if guide.description %}
                        <div class="guide-description">{{ guide.description|linebreaksbr }}</div>
                        {% endif %}
                        {% if guide.guide_video %}
                        <video class="guide-video" controls preload="none">
                            <source src="{{ guide.guide_video.url }}" type="video/mp4">
                        </video>
                        {% elif guide.video_url %}
                        <div class="guide-video-wrap">
                            <iframe src="{{ guide.video_url }}" frameborder="0" allowfullscreen></iframe>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">ì²˜ë¦¬ ì¤‘...</div>
        <div class="loading-detail" id="loadingDetail">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>
</div>

<script src="{% static 'js/csrf.js' %}"></script>
<script>
const voiceList = [
    {% for voice in voice_list %}
    {
        id: "{{ voice.voice.voice_id }}",
        name: "{{ voice.alias_name }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

const bookId = "{{ book.public_uuid }}";
const nextEpisodeNumber = {{ next_episode_number }};
const savedVoiceConfig = {{ voice_config_json|safe }};
const savedDraftText = {{ draft_text_json|safe }};
const savedDraftTitle = {{ draft_episode_title_json|safe }};

// ì´ë¯¸ì§€ ê´€ë ¨ ë¡œì§ì€ book_serialization_fast.jsì—ì„œ ì²˜ë¦¬

// ê°€ì´ë“œ ì•„ì½”ë””ì–¸ í† ê¸€
function toggleGuideDetail(el) {
    el.classList.toggle('open');
}
</script>
<script src="{% static 'js/book/book_serialization_fast.js' %}"></script>

{% endblock %}