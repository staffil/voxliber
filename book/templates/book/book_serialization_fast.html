{% extends "base.html" %}
{% load static %}

{% block title %}오디오북 생성기 | VoxLiber{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book/book_serialization_fast.css' %}">
<link rel="stylesheet" href="{% static 'css/book/onboarding.css' %}">
<style>
/* 🔥 에피소드 이미지 스타일 */
.episode-image-upload {
    margin-top: 15px;
}
.image-upload-box {
    width: 100%;
    height: 180px;
    border: 2px dashed #ddd;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    background: #fafafa;
    transition: all 0.3s;
}
.image-upload-box:hover {
    border-color: #667eea;
    background: #f5f7ff;
}
.image-placeholder {
    text-align: center;
    color: #999;
}
.image-placeholder svg {
    width: 40px;
    height: 40px;
    margin-bottom: 8px;
}
.preview-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
}
.preview-img.show {
    display: block;
}
.delete-img-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.image-upload-box:hover .delete-img-btn {
    display: flex;
    align-items: center;
    justify-content: center;
}
.delete-img-btn:hover {
    background: white;
}
</style>
{% endblock %}

{% block content %}

<div class="container">
    <!-- 헤더 -->
    <div class="header-section">
        <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;">
            <div>
                <h1>오디오북 생성기</h1>
                <p>번호로 캐릭터를 지정하고, 소설 텍스트를 붙여넣으세요</p>
            </div>
            <div style="display:flex; gap:8px; flex-shrink:0; flex-wrap:wrap; justify-content:flex-end;">
                <a href="/voice/voice/list/" class="btn-header-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    보이스 라이브러리
                </a>
                <button class="btn-header-guide" onclick="document.getElementById('guideModal').classList.add('active')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    집필 가이드
                </button>
                <a href="https://youtu.be/chzMUrp6jR0" target="_blank" rel="noopener noreferrer" class="btn-header-link btn-yt-guide">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                    </svg>
                    <span class="yt-label-full">초보자 집필 가이드 통합본</span>
                    <span class="yt-label-short">집필 가이드</span>
                </a>
            </div>
        </div>
    </div>

    <!-- 모바일 JSON 보기 버튼 -->
    <button class="mobile-json-toggle" id="mobileJsonToggle" onclick="toggleMobileJSON()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
        </svg>
        JSON
    </button>

    <!-- 메인 그리드 -->
    <div class="main-grid">

        <!-- 왼쪽: 입력 영역 -->
        <div class="left-panel">

            <!-- 에피소드 정보 -->
            <div class="panel" id="episodeInfoPanel">
                <div class="panel-header">
                    <h3>에피소드 정보</h3>
                    <span class="episode-number-badge">EP {{ next_episode_number }}</span>
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <label>에피소드 제목</label>
                        <input type="text" id="episodeTitle" class="form-input" placeholder="예: 1화 - 운명의 만남">
                    </div>

                    <!-- 🔥 에피소드 이미지 업로드 -->
                    <div class="form-group episode-image-upload">
                        <label>에피소드 썸네일 (선택)</label>
                        <input type="file" id="episodeImageInput" accept="image/*" style="display:none" name="episode_image">
                        <div class="image-upload-box" onclick="document.getElementById('episodeImageInput').click()">
                            <div class="image-placeholder" id="imagePlaceholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                                <div style="font-size:13px">클릭하여 이미지 업로드</div>
                            </div>
                            <img id="imagePreview" class="preview-img">
                            <button class="delete-img-btn" onclick="deleteImage(event)">✕</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 캐릭터 & 목소리 -->
            <div class="panel" id="characterPanel">
                <div class="panel-header">
                    <h3>캐릭터 & 목소리</h3>
                    <button class="btn-add-small" onclick="addCharacter()">+ 추가</button>
                </div>
                <div class="panel-body">
                    <p class="form-hint" style="margin-bottom: 12px;">번호 = 소설 텍스트 앞에 쓸 번호. 0은 나레이션 전용.</p>
                    <div id="characterList" class="character-list">
                        <!-- 나레이션 (기본) -->
                        <div class="character-item" data-number="0">
                            <div class="character-number-badge narrator">0</div>
                            <div class="character-content">
                                <input type="text" class="character-name" value="나레이션" readonly>
                                <select class="voice-select" data-number="0">
                                    <option value="">목소리 선택</option>
                                    {% for voice in voice_list %}
                                    <option value="{{ voice.voice.voice_id }}">{{ voice.alias_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- 캐릭터 1 (기본) -->
                        <div class="character-item" data-number="1">
                            <div class="character-number-badge">1</div>
                            <div class="character-content">
                                <input type="text" class="character-name" placeholder="캐릭터 이름 (예: 민수)" data-number="1">
                                <select class="voice-select" data-number="1">
                                    <option value="">목소리 선택</option>
                                    {% for voice in voice_list %}
                                    <option value="{{ voice.voice.voice_id }}">{{ voice.alias_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button class="btn-remove-char" onclick="removeCharacter(1)">삭제</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 소설 텍스트 -->
            <div class="panel">
                <div class="panel-header">
                    <h3>소설 텍스트</h3>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button id="btnAISpeaker" onclick="aiAssignSpeakers()" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9); color:white; border:none; padding:5px 14px; border-radius:6px; font-size:12px; cursor:pointer; font-weight:600; white-space:nowrap;">
                            AI 화자 분류
                        </button>
                        <span class="char-count"><span id="charCount">0</span> 글자</span>
                    </div>
                </div>
                <div class="panel-body">
                    <textarea id="novelText" class="novel-textarea" placeholder="방법 1: 자연어로 소설을 붙여넣고 [AI 화자 분류] 클릭
방법 2: 직접 번호를 매겨서 입력

--- 자연어 예시 (AI 화자 분류용) ---
비 오는 밤이었다. 민수는 골목길을 걸었다.
&quot;여기가 어디지...&quot; 민수가 중얼거렸다.
그때, 뒤에서 발소리가 들렸다.
&quot;거기 서!&quot; 지영이 소리쳤다.

--- 번호 형식 예시 (직접 입력) ---
0: 어두운 밤이었다.
1: &quot;여기가 어디지...&quot;
0: 그때, 뒤에서 발소리가 들렸다.
2: &quot;거기 서!&quot;
1,2: &quot;우리는 하나다!&quot;

※ 0=나레이션, 1,2,3...=캐릭터 번호
※ 같은 번호 연속 → 자동 합침 (300자 이하)
※ 1,2: 형식 → 두 캐릭터 동시 재생 (overlap)"></textarea>
                </div>
            </div>

        </div>

        <!-- 오른쪽: JSON 편집 & 액션 -->
        <div class="right-panel" id="rightPanel">

            <!-- 모바일 닫기 버튼 -->
            <button class="mobile-json-close" onclick="toggleMobileJSON()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>

            <!-- 탭 패널 (블록 편집 / JSON) -->
            <div class="panel preview-panel right-tab-panel">
                <!-- 탭 헤더 -->
                <div class="right-tabs">
                    <button class="right-tab active" id="tabBtnBlocks" onclick="switchRightTab('blocks')">블록 편집</button>
                    <button class="right-tab" id="tabBtnJson" onclick="switchRightTab('json')">JSON</button>
                    <label id="labelJsonUpload" class="json-upload-btn" title="JSON 파일 업로드">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        JSON 업로드
                        <input type="file" id="jsonFileInput" accept=".json" style="display:none" onchange="loadJSONFile(this)">
                    </label>
                </div>

                <!-- 블록 편집 탭 (기본) -->
                <div id="tabBlocks" class="tab-content-panel">
                    <!-- TTS / SFX 블록 목록 -->
                    <div id="blockList" class="block-list">
                        <div class="block-empty">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.3">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18M9 21V9"/>
                            </svg>
                            <p>미리보기 또는 JSON 업로드로<br>블록을 생성하세요</p>
                        </div>
                    </div>
                    <!-- 배경음악 구간 설정 -->
                    <div id="bgmSection" class="bgm-edit-section" style="display:none">
                        <div class="bgm-edit-header">
                            <span>배경음악 구간</span>
                            <button class="btn-add-bgm" onclick="addBgmTrack()">+ BGM 추가</button>
                        </div>
                        <div id="bgmTrackList" class="bgm-track-list"></div>
                    </div>
                </div>

                <!-- JSON 탭 -->
                <div id="tabJson" class="tab-content-panel" style="display:none">
                    <textarea id="jsonEditor" class="json-editor" placeholder="미리보기를 클릭하면 JSON이 생성됩니다.
생성된 JSON을 직접 수정할 수 있습니다."></textarea>
                </div>
            </div>

            <!-- WebAudio 패널 (블록 클릭 시 표시) -->
            <div id="webAudioPanel" class="webaudio-panel" style="display:none">
                <div class="webaudio-header">
                    <span id="webAudioTitle">페이지 효과음</span>
                    <button class="webaudio-close" onclick="closeWebAudio()">×</button>
                </div>
                <div class="webaudio-effects" id="webAudioEffects">
                    <!-- JS로 렌더링 -->
                </div>
            </div>

            <!-- 액션 버튼 -->
            <div class="action-panel">
                <button id="btnPreview" class="btn btn-secondary" onclick="generateJSONPreview()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    미리보기
                </button>

                <button id="btnDownloadJSON" class="btn btn-warning" onclick="downloadJSON()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    다운로드
                </button>

                <button id="btnAI" class="btn btn-ai" onclick="aiGenerate()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    AI 생성
                </button>

                <button id="btnExecute" class="btn btn-primary" onclick="executeJSON()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polygon points="10 8 16 12 10 16 10 8"/>
                    </svg>
                    실행
                </button>
            </div>

            <div id="statusMessage" class="status-message"></div>

        </div>

    </div>
</div>

<!-- 모바일 JSON 오버레이 배경 -->
<div class="mobile-json-overlay" id="mobileJsonOverlay" onclick="toggleMobileJSON()"></div>

<!-- 사용 가이드 모달 -->
<div class="modal-overlay" id="guideModal">
    <div class="modal-content" style="max-width:700px;">
        <div class="modal-header">
            <h3>집필 가이드</h3>
            <button class="modal-close" onclick="document.getElementById('guideModal').classList.remove('active')">&times;</button>
        </div>
        <div class="modal-body">

            <!-- UI 투어 단계 -->
            <div class="ui-tour-section">
                <div class="ui-tour-label">✨ UI 투어 — 단계를 클릭하면 해당 위치를 안내합니다 (다음 버튼으로 순서대로 이동)</div>
                <div class="ui-tour-steps">
                    <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_FAST_STEPS, 0)">
                        <span class="ui-tour-step-num">1</span>
                        <span class="ui-tour-step-text">에피소드 제목 &amp; 썸네일</span>
                        <span class="ui-tour-step-arrow">›</span>
                    </button>
                    <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_FAST_STEPS, 1)">
                        <span class="ui-tour-step-num">2</span>
                        <span class="ui-tour-step-text">캐릭터 목소리 설정</span>
                        <span class="ui-tour-step-arrow">›</span>
                    </button>
                    <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_FAST_STEPS, 2)">
                        <span class="ui-tour-step-num">3</span>
                        <span class="ui-tour-step-text">소설 텍스트 작성법</span>
                        <span class="ui-tour-step-arrow">›</span>
                    </button>
                    <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_FAST_STEPS, 3)">
                        <span class="ui-tour-step-num">4</span>
                        <span class="ui-tour-step-text">미리보기</span>
                        <span class="ui-tour-step-arrow">›</span>
                    </button>
                    <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_FAST_STEPS, 4)">
                        <span class="ui-tour-step-num">5</span>
                        <span class="ui-tour-step-text">AI 생성</span>
                        <span class="ui-tour-step-arrow">›</span>
                    </button>
                    <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_FAST_STEPS, 5)">
                        <span class="ui-tour-step-num">6</span>
                        <span class="ui-tour-step-text">실행</span>
                        <span class="ui-tour-step-arrow">›</span>
                    </button>
                    <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_FAST_STEPS, 6)">
                        <span class="ui-tour-step-num">7</span>
                        <span class="ui-tour-step-text">AI 화자 분류</span>
                        <span class="ui-tour-step-arrow">›</span>
                    </button>
                    <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_FAST_STEPS, 7)">
                        <span class="ui-tour-step-num">8</span>
                        <span class="ui-tour-step-text">JSON 다운로드</span>
                        <span class="ui-tour-step-arrow">›</span>
                    </button>
                    <button class="ui-tour-step-btn" onclick="VoxTour.startTour(VOX_FAST_STEPS, 8)">
                        <span class="ui-tour-step-num">9</span>
                        <span class="ui-tour-step-text">JSON 업로드 (복원)</span>
                        <span class="ui-tour-step-arrow">›</span>
                    </button>
                </div>
            </div>

            {% if guides %}
            <div class="guide-list">
                {% for guide in guides %}
                <div class="guide-item" onclick="toggleGuideDetail(this)">
                    <div class="guide-item-header">
                        {% if guide.thumbnail %}
                        <img src="{{ guide.thumbnail.url }}" class="guide-thumb" alt="">
                        {% endif %}
                        <div class="guide-item-info">
                            <h4>{{ guide.title }}</h4>
                            {% if guide.short_description %}
                            <p>{{ guide.short_description }}</p>
                            {% endif %}
                        </div>
                        <svg class="guide-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div class="guide-detail">
                        {% if guide.description %}
                        <div class="guide-description">{{ guide.description|linebreaksbr }}</div>
                        {% endif %}
                        {% if guide.guide_video %}
                        <video class="guide-video" controls preload="none">
                            <source src="{{ guide.guide_video.url }}" type="video/mp4">
                        </video>
                        {% elif guide.video_url %}
                        <div class="guide-video-wrap">
                            <iframe src="{{ guide.video_url }}" frameborder="0" allowfullscreen></iframe>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

        </div>
    </div>
</div>

<!-- 로딩 오버레이 -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">처리 중...</div>
        <div class="loading-detail" id="loadingDetail">잠시만 기다려주세요</div>
    </div>
</div>

<script src="{% static 'js/csrf.js' %}"></script>
<script src="{% static 'js/book/onboarding.js' %}"></script>
<script>
/* ── 첫 방문 시 자동 가이드 열기 ── */
document.addEventListener('DOMContentLoaded', function () {
    if (!localStorage.getItem('vox_guide_seen_fast')) {
        document.getElementById('guideModal').classList.add('active');
        localStorage.setItem('vox_guide_seen_fast', '1');
    }
});

/* ── 초보자 집필 투어 단계 ── */
var VOX_FAST_STEPS = [
    {
        sel: '#episodeInfoPanel',
        title: '에피소드 제목 & 썸네일',
        desc: '에피소드의 제목과 에피소드 썸네일(선택 사항)을 업로드합니다.<br><br>썸네일은 플랫폼에 표시되는 커버 이미지입니다.'
    },
    {
        sel: '#characterPanel',
        title: '캐릭터 목소리 설정',
        desc: '캐릭터 목소리 번호를 먼저 정합니다.<br><br><b>0번</b>은 나레이션 전용으로, 별도 조작 없이 지정된 목소리로 재생됩니다.<br><b>1번</b>부터는 등록된 보이스를 매칭해 캐릭터 목소리를 지정합니다.<br><br>목소리 번호를 정한 뒤에 소설 텍스트를 붙여넣으세요.'
    },
    {
        sel: '#novelText',
        title: '소설 텍스트 작성법',
        desc: '소설 텍스트는 아래 형식으로 작성합니다.<br><br><code style="background:rgba(99,102,241,0.15);padding:2px 6px;border-radius:4px;">0: 나레이션 텍스트</code><br><code style="background:rgba(99,102,241,0.15);padding:2px 6px;border-radius:4px;">1: "캐릭터 대사"</code><br><br>숫자 뒤의 콜론(:)이 화자를 구분합니다. 여러 줄을 붙여넣으면 자동으로 블록이 생성됩니다.'
    },
    {
        sel: '#btnPreview',
        title: '미리보기',
        desc: '미리보기 버튼을 클릭하면 소설 텍스트가 오른쪽 블록 목록으로 변환됩니다.<br><br>변환된 블록을 확인하고 수정이 필요한 부분을 직접 편집할 수 있습니다.'
    },
    {
        sel: '#btnAI',
        title: 'AI 생성',
        desc: 'AI 생성 버튼을 클릭하면 배경음과 효과음이 각 장면에 맞게 자동으로 배치됩니다.<br><br>배경음은 전체 에피소드에 매칭되고, 효과음은 상황에 맞게 자동 배치됩니다.<br>실행 전에 미리보기를 먼저 완료하세요.'
    },
    {
        sel: '#btnExecute',
        title: '실행',
        desc: '실행 버튼을 누르면 오디오북 파일이 생성됩니다.<br><br>페이지 수에 따라 수 분에서 10분 이상 소요될 수 있으며, <b>실행 중에는 페이지를 닫지 마세요.</b>'
    },
    {
        sel: '#btnAISpeaker',
        title: 'AI 화자 분류',
        desc: '자연어 소설을 그대로 붙여넣은 뒤 <b>AI 화자 분류</b> 버튼을 클릭하면, AI가 나레이션과 각 캐릭터의 대사를 자동으로 구분해 화자 번호를 붙여줍니다.<br><br>예) 직접 번호를 매기지 않아도:<br><code style="background:rgba(99,102,241,0.15);padding:2px 6px;border-radius:4px;">비 오는 밤이었다.</code><br><code style="background:rgba(99,102,241,0.15);padding:2px 6px;border-radius:4px;">"여기가 어디지..."</code><br><br>→ AI가 자동으로 화자 번호를 붙인 뒤 텍스트 영역에 채워줍니다. 이후 미리보기를 눌러 확인하세요.'
    },
    {
        sel: '#btnDownloadJSON',
        title: 'JSON 다운로드',
        desc: '현재 편집 중인 에피소드 전체를 <b>JSON 파일로 저장</b>합니다.<br><br>· 블록 구성, 목소리 설정, 배경음 구간 등 모든 정보가 포함됩니다.<br>· 작업을 중단해야 할 때 JSON으로 저장해 두면, 나중에 그대로 복원할 수 있습니다.<br>· 백업용으로 보관하거나 다른 에피소드 작업에 참고할 수도 있습니다.'
    },
    {
        sel: '#labelJsonUpload',
        title: 'JSON 업로드 (복원)',
        desc: '이전에 다운로드한 JSON 파일을 업로드하면 <b>작업 내용이 그대로 복원</b>됩니다.<br><br>· 저장해 둔 JSON 파일을 선택하면 블록 목록과 설정이 자동으로 불러와집니다.<br>· 실수로 페이지를 닫거나 세션이 종료되어도 JSON만 있으면 처음부터 다시 하지 않아도 됩니다.<br>· 업로드 후 확인이 필요한 항목만 수정하고 바로 실행할 수 있습니다.'
    }
];
</script>
<script>
const voiceList = [
    {% for voice in voice_list %}
    {
        id: "{{ voice.voice.voice_id }}",
        name: "{{ voice.alias_name }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

const bookId = "{{ book.public_uuid }}";
const nextEpisodeNumber = {{ next_episode_number }};
const savedVoiceConfig = {{ voice_config_json|safe }};
const savedDraftText = {{ draft_text_json|safe }};
const savedDraftTitle = {{ draft_episode_title_json|safe }};

// 이미지 관련 로직은 book_serialization_fast.js에서 처리

// 가이드 아코디언 토글
function toggleGuideDetail(el) {
    el.classList.toggle('open');
}
</script>
<script src="{% static 'js/book/book_serialization_fast.js' %}"></script>

{% endblock %}