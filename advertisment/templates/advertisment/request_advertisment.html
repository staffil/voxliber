{% extends "base.html" %}
{% load static %}

{% block title %}광고 신청 - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/advertisment/request_advertisment.css' %}">

{% endblock %}

{% block content %}
<br>
<div class="wrap">

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('form', this)">광고 신청</button>
        <button class="tab-btn" onclick="switchTab('list', this)">
            내 신청 목록{% if my_ads %} <span style="color:#888;font-weight:400;">({{ my_ads.count }})</span>{% endif %}
        </button>
    </div>

    <!-- 신청 폼 탭 -->
    <div class="tab-content active" id="tab-form">

        <!-- 광고 단가 기준 안내 -->
        <div class="pricing-info-box">
            <div class="pricing-info-title">📊 광고 과금 기준 안내</div>
            <div class="pricing-info-desc">단가는 검토 후 담당자가 개별 안내드립니다.</div>
            <div class="pricing-cards">
                <div class="pricing-card">
                    <div class="pricing-icon">🖼️</div>
                    <div class="pricing-type-name">이미지 광고</div>
                    <div class="pricing-method">CPM <span class="pricing-badge">1,000 노출당</span></div>
                    <ul class="pricing-rules">
                        <li>화면에 노출되는 순간 카운트</li>
                        <li>클릭 시 추가 과금 가능 (옵션)</li>
                    </ul>
                </div>
                <div class="pricing-card">
                    <div class="pricing-icon">🎬</div>
                    <div class="pricing-type-name">영상 광고</div>
                    <div class="pricing-method">CPV <span class="pricing-badge">완시청당</span></div>
                    <ul class="pricing-rules">
                        <li>15초 이상 시청 시 카운트</li>
                        <li>5초간 스킵 불가 (이후 스킵 가능)</li>
                        <li>스킵 시 카운트 안 됨</li>
                    </ul>
                </div>
                <div class="pricing-card">
                    <div class="pricing-icon">🎵</div>
                    <div class="pricing-type-name">오디오 광고</div>
                    <div class="pricing-method">CPV <span class="pricing-badge">완청당</span></div>
                    <ul class="pricing-rules">
                        <li>10초 이상 청취 시 카운트</li>
                        <li>스킵 시 카운트 안 됨</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="form-card">
            <form id="adForm">
                {% csrf_token %}

                <div class="section-label">광고주 정보</div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">회사명 <span>*</span></label>
                        <input type="text" class="form-input" name="company_name" placeholder="(주)예시컴퍼니" maxlength="200">
                    </div>
                    <div class="form-group">
                        <label class="form-label">담당자명 <span>*</span></label>
                        <input type="text" class="form-input" name="contact_name" placeholder="홍길동" maxlength="100">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">이메일 <span>*</span></label>
                        <input type="email" class="form-input" name="email" placeholder="example@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">연락처</label>
                        <input type="text" class="form-input" name="phone" placeholder="010-0000-0000">
                    </div>
                </div>

                <div class="section-label">광고 정보</div>

                <div class="type-grid">
                    <label class="type-card selected">
                        <input type="radio" name="ad_type" value="image" checked>
                        <div class="type-icon">🖼️</div>
                        <div class="type-name">이미지</div>
                        <div class="type-desc">JPG · PNG · WEBP</div>
                    </label>
                    <label class="type-card">
                        <input type="radio" name="ad_type" value="video">
                        <div class="type-icon">🎬</div>
                        <div class="type-name">영상</div>
                        <div class="type-desc">MP4 · MOV</div>
                    </label>
                    <label class="type-card">
                        <input type="radio" name="ad_type" value="audio">
                        <div class="type-icon">🎵</div>
                        <div class="type-name">오디오</div>
                        <div class="type-desc">MP3 · WAV</div>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">노출 위치 <span>*</span></label>
                    <select class="form-select" name="placement" id="placementSelect">
                        <option value="chat">채팅 중간</option>
                        <option value="tts">TTS 재생 후</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">광고 제목 <span>*</span></label>
                    <input type="text" class="form-input" name="title" placeholder="광고 제목" maxlength="200">
                </div>

                <div class="form-group">
                    <label class="form-label">광고 설명</label>
                    <textarea class="form-textarea" name="description" placeholder="간단한 설명 (선택)"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">랜딩 URL</label>
                    <input type="url" class="form-input" name="link_url" placeholder="https://example.com">
                </div>

                <div class="section-label">미디어 파일</div>

                <div class="file-upload-area" id="uploadArea">
                    <input type="file" id="mediaFile" name="media_file" accept="image/*">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">클릭하거나 파일을 드래그하세요</div>
                    <div class="upload-hint" id="uploadHint">JPG, PNG, WEBP</div>
                    <div class="upload-filename" id="uploadFilename"></div>
                </div>
                <div class="media-preview" id="mediaPreview"></div>

                <button type="submit" class="submit-btn" id="submitBtn">광고 신청하기</button>
            </form>
        </div>
    </div>

    <!-- 내 목록 탭 -->
    <div class="tab-content" id="tab-list">
        <div class="ad-list">
            {% for ad in my_ads %}
            <div class="ad-item">
                <div class="ad-thumb">
                    {% if ad.image %}<img src="{{ ad.image.url }}" alt="{{ ad.title }}">
                    {% elif ad.ad_type == 'video' %}🎬
                    {% elif ad.ad_type == 'audio' %}🎵
                    {% else %}🖼️{% endif %}
                </div>

                <div class="ad-info">
                    <div class="ad-title">{{ ad.title }}</div>
                    <div class="ad-meta">
                        <span class="type-tag">
                            {% if ad.ad_type == 'image' %}이미지
                            {% elif ad.ad_type == 'video' %}영상
                            {% elif ad.ad_type == 'audio' %}오디오{% endif %}
                        </span>
                        <span>{{ ad.get_placement_display }}</span>
                        <span>{{ ad.created_at|date:"Y.m.d" }}</span>
                    </div>
                </div>

                <div class="ad-actions">
                    {% if ad.status == 'pending' %}
                    <button class="edit-btn" onclick="openEditModal(
                        {{ ad.id }},
                        '{{ ad.company_name|escapejs }}',
                        '{{ ad.contact_name|escapejs }}',
                        '{{ ad.email|escapejs }}',
                        '{{ ad.phone|default:""| escapejs }}',
                        '{{ ad.title|escapejs }}',
                        '{{ ad.description|default:""|escapejs }}',
                        '{{ ad.link_url|default:""|escapejs }}'
                    )">수정</button>
                    {% endif %}
                    <div class="ad-badge
                        {% if ad.status == 'pending' %}badge-pending
                        {% elif ad.status == 'approved' %}badge-approved
                        {% elif ad.status == 'rejected' %}badge-rejected
                        {% else %}badge-completed{% endif %}">
                        {{ ad.get_status_display }}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-icon">📭</div>
                <div class="empty-text">아직 신청한 광고가 없습니다</div>
                <span class="empty-link" onclick="switchTab('form', document.querySelector('.tab-btn'))">첫 광고 신청하기</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 수정 모달 -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">광고 신청 수정</div>
            <button class="modal-close" onclick="closeEditModal()">×</button>
        </div>

        <form id="editForm">
            {% csrf_token %}
            <input type="hidden" id="editReqId">

            <div class="section-label">광고주 정보</div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">회사명 <span>*</span></label>
                    <input type="text" class="form-input" id="edit_company_name" name="company_name" maxlength="200">
                </div>
                <div class="form-group">
                    <label class="form-label">담당자명 <span>*</span></label>
                    <input type="text" class="form-input" id="edit_contact_name" name="contact_name" maxlength="100">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">이메일 <span>*</span></label>
                    <input type="email" class="form-input" id="edit_email" name="email">
                </div>
                <div class="form-group">
                    <label class="form-label">연락처</label>
                    <input type="text" class="form-input" id="edit_phone" name="phone">
                </div>
            </div>

            <div class="section-label">광고 내용</div>

            <div class="form-group">
                <label class="form-label">광고 제목 <span>*</span></label>
                <input type="text" class="form-input" id="edit_title" name="title" maxlength="200">
            </div>

            <div class="form-group">
                <label class="form-label">광고 설명</label>
                <textarea class="form-textarea" id="edit_description" name="description"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">랜딩 URL</label>
                <input type="url" class="form-input" id="edit_link_url" name="link_url" placeholder="https://example.com">
            </div>

            <div class="section-label">미디어 파일 교체 (선택)</div>

            <div class="file-upload-area" id="editUploadArea">
                <input type="file" id="editMediaFile" name="media_file" accept="image/*,video/*,audio/*">
                <div class="upload-icon">📁</div>
                <div class="upload-text">새 파일로 교체하려면 클릭하세요</div>
                <div class="upload-hint">비워두면 기존 파일 유지</div>
                <div class="upload-filename" id="editUploadFilename"></div>
            </div>

            <button type="submit" class="submit-btn" id="editSubmitBtn">수정 저장</button>
        </form>
    </div>
</div>

<div class="toast" id="toast"></div>
{% endblock %}

{% block extra_js %}
<script>
const CSRF = '{{ csrf_token }}';

function switchTab(name, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
}

const placementOptions = {
    image: [{ value: 'chat', label: '채팅 중간' }, { value: 'tts', label: 'TTS 재생 후' }],
    video: [{ value: 'snap', label: '스냅 피드' }],
    audio: [{ value: 'episode', label: '오디오북' }],
};

function updatePlacement(type) {
    const select = document.getElementById('placementSelect');
    select.innerHTML = '';
    placementOptions[type].forEach(opt => {
        const el = document.createElement('option');
        el.value = opt.value;
        el.textContent = opt.label;
        select.appendChild(el);
    });
}

document.querySelectorAll('.type-card').forEach(card => {
    card.addEventListener('click', () => {
        document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        const type = card.querySelector('input').value;
        const hints = { image: 'JPG, PNG, WEBP', video: 'MP4, MOV', audio: 'MP3, WAV' };
        document.getElementById('mediaFile').accept = type === 'image' ? 'image/*' : type === 'video' ? 'video/*' : 'audio/*';
        document.getElementById('uploadHint').textContent = hints[type];
        updatePlacement(type);
        document.getElementById('mediaPreview').style.display = 'none';
        document.getElementById('mediaPreview').innerHTML = '';
        document.getElementById('uploadFilename').textContent = '';
        document.getElementById('uploadArea').classList.remove('has-file');
    });
});

function handleFilePreview(input, filenameEl, uploadAreaEl, previewEl) {
    const file = input.files[0];
    if (!file) return;
    uploadAreaEl.classList.add('has-file');
    filenameEl.textContent = file.name;
    if (previewEl) {
        previewEl.innerHTML = '';
        const url = URL.createObjectURL(file);
        let el;
        if (file.type.startsWith('image/'))      { el = document.createElement('img');   el.src = url; }
        else if (file.type.startsWith('video/')) { el = document.createElement('video'); el.src = url; el.controls = true; }
        else if (file.type.startsWith('audio/')) { el = document.createElement('audio'); el.src = url; el.controls = true; }
        if (el) { previewEl.appendChild(el); previewEl.style.display = 'block'; }
    }
}

document.getElementById('mediaFile').addEventListener('change', function() {
    handleFilePreview(this, document.getElementById('uploadFilename'), document.getElementById('uploadArea'), document.getElementById('mediaPreview'));
});

document.getElementById('editMediaFile').addEventListener('change', function() {
    handleFilePreview(this, document.getElementById('editUploadFilename'), document.getElementById('editUploadArea'), null);
});

// 신청
document.getElementById('adForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.textContent = '신청 중...';
    try {
        const res  = await fetch('', { method: 'POST', headers: { 'X-CSRFToken': CSRF }, body: new FormData(this) });
        const data = await res.json();
        if (data.success) {
            showToast('✅ ' + data.message, 'success');
            setTimeout(() => location.reload(), 1800);
        } else {
            showToast('❌ ' + data.error, 'error');
            btn.disabled = false; btn.textContent = '광고 신청하기';
        }
    } catch {
        showToast('❌ 오류가 발생했습니다.', 'error');
        btn.disabled = false; btn.textContent = '광고 신청하기';
    }
});

// 수정 모달
function openEditModal(id, company, contact, email, phone, title, desc, linkUrl) {
    document.getElementById('editReqId').value         = id;
    document.getElementById('edit_company_name').value = company;
    document.getElementById('edit_contact_name').value = contact;
    document.getElementById('edit_email').value        = email;
    document.getElementById('edit_phone').value        = phone;
    document.getElementById('edit_title').value        = title;
    document.getElementById('edit_description').value  = desc;
    document.getElementById('edit_link_url').value     = linkUrl;
    document.getElementById('editUploadFilename').textContent = '';
    document.getElementById('editUploadArea').classList.remove('has-file');
    document.getElementById('editModal').classList.add('show');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}

document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) closeEditModal();
});

document.getElementById('editForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('editSubmitBtn');
    const id  = document.getElementById('editReqId').value;
    btn.disabled = true; btn.textContent = '저장 중...';
    try {
        const res  = await fetch(`/advertisement/request/${id}/edit/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF },
            body: new FormData(this),
        });
        const data = await res.json();
        if (data.success) {
            showToast('✅ ' + data.message, 'success');
            closeEditModal();
            setTimeout(() => location.reload(), 1200);
        } else {
            showToast('❌ ' + data.error, 'error');
            btn.disabled = false; btn.textContent = '수정 저장';
        }
    } catch {
        showToast('❌ 오류가 발생했습니다.', 'error');
        btn.disabled = false; btn.textContent = '수정 저장';
    }
});

function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type} show`;
    setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
{% endblock %}