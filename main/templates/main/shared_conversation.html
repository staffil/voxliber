{% extends "base.html" %}
{% load static %}

{% block title %}{{ novel.title }} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mypage/novel_result.css' %}?v=3">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ ìˆœì°¨ ì¬ìƒ í”Œë¡œíŒ… ë°” â”€â”€ */
#seq-player-bar {
    display: none;
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(20, 20, 35, 0.96);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(167,139,250,0.3);
    border-radius: 40px;
    padding: 10px 20px;
    gap: 12px;
    align-items: center;
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    min-width: 280px;
    max-width: 90vw;
}
#seq-player-bar.active { display: flex; }
#seq-play-btn {
    background: rgba(167,139,250,0.15);
    border: 1px solid rgba(167,139,250,0.4);
    border-radius: 50%;
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: #a78bfa; font-size: 14px;
    flex-shrink: 0; transition: all 0.2s;
}
#seq-play-btn:hover { background: rgba(167,139,250,0.3); }
#seq-progress-wrap {
    flex: 1; display: flex; flex-direction: column; gap: 3px; min-width: 0;
}
#seq-label {
    color: #c4b5fd; font-size: 11px; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis;
}
#seq-progress {
    width: 100%; height: 3px; background: rgba(255,255,255,0.1);
    border-radius: 2px; overflow: hidden;
}
#seq-progress-fill {
    height: 100%; background: #a78bfa; width: 0%;
    transition: width 0.1s linear; border-radius: 2px;
}
#seq-stop-btn {
    background: none; border: none; color: #888;
    cursor: pointer; font-size: 18px; line-height: 1;
    flex-shrink: 0; padding: 0 2px;
}
#seq-stop-btn:hover { color: #fff; }
.dialogue-block.seq-playing {
    background: rgba(167,139,250,0.08) !important;
    border-left: 3px solid #a78bfa;
    padding-left: 10px;
    transition: background 0.3s;
}

/* â”€â”€ ìˆœì°¨ ì¬ìƒ ì‹œì‘ ë²„íŠ¼ â”€â”€ */
#start-seq-btn {
    display: block;
    margin: 16px auto 0;
    padding: 10px 24px;
    background: rgba(167,139,250,0.1);
    border: 1px solid rgba(167,139,250,0.3);
    border-radius: 20px;
    color: #a78bfa;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}
#start-seq-btn:hover { background: rgba(167,139,250,0.2); }

/* â”€â”€ ë¨¸ì§€ ì˜¤ë””ì˜¤ ì¹´ë“œ â”€â”€ */
#merged-audio-card {
    margin: 32px auto 0;
    max-width: 480px;
    background: rgba(20,20,35,0.85);
    border: 1px solid rgba(167,139,250,0.25);
    border-radius: 16px;
    padding: 18px 20px 14px;
    backdrop-filter: blur(10px);
}
.mac-title-row {
    display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
}
.mac-icon {
    font-size: 22px; flex-shrink: 0;
}
.mac-label {
    font-size: 10px; color: #a78bfa; letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 2px;
}
.mac-name {
    font-size: 14px; color: #e9d5ff; font-weight: 500;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 320px;
}
.mac-progress-wrap { margin-bottom: 10px; cursor: pointer; }
.mac-progress-track {
    width: 100%; height: 4px; background: rgba(255,255,255,0.12);
    border-radius: 2px; overflow: hidden; margin-bottom: 4px;
}
.mac-progress-fill {
    height: 100%; background: linear-gradient(90deg,#a78bfa,#818cf8); width: 0%;
    border-radius: 2px; transition: width 0.1s linear;
}
.mac-time-row {
    display: flex; justify-content: space-between; font-size: 10px; color: #888;
}
.mac-controls {
    display: flex; align-items: center; justify-content: center; gap: 16px;
}
.mac-btn-play {
    width: 40px; height: 40px; border-radius: 50%;
    background: rgba(167,139,250,0.2); border: 1px solid rgba(167,139,250,0.4);
    color: #a78bfa; font-size: 15px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.mac-btn-play:hover { background: rgba(167,139,250,0.35); }
.mac-btn-skip {
    background: none; border: none; color: #888; font-size: 12px;
    cursor: pointer; padding: 6px; transition: color 0.2s;
}
.mac-btn-skip:hover { color: #c4b5fd; }
</style>
{% endblock %}

{% block content %}
<br><br><br>

<div class="novel-container">

    <!-- ì œëª© -->
    <h1 class="novel-title">{{ novel.title }}</h1>

    <!-- í”„ë¡¤ë¡œê·¸ -->
    {% if novel.prologue %}
    <p class="novel-prologue">{{ novel.prologue|safe }}</p>
    {% endif %}

    <!-- AI ìºë¦­í„°ì™€ ëŒ€í™”í•˜ê¸° ë§í¬ -->
    {% if llm %}
    <div style="text-align: center;">
        <a href="{% url 'character:ai_intro' llm.public_uuid %}" class="ai-chat-link">
            {{ llm.name }}ì™€(ê³¼) ëŒ€í™”í•˜ê¸°
        </a>
    </div>
    {% endif %}

    <!-- ìˆœì°¨ ì¬ìƒ ì‹œì‘ ë²„íŠ¼ -->
    <button id="start-seq-btn">&#9654; ìˆœì„œëŒ€ë¡œ ë“£ê¸°</button>

    <!-- ì±•í„° ëª©ë¡ -->
    {% for chapter in novel.chapters %}
    <section class="chapter">

        <!-- ì±•í„° ì´ë¯¸ì§€ ë° í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ -->
        {% if chapter.image and chapter.image.image %}
        <div class="chapter-image">
            <img src="{{ chapter.image.image.url }}" alt="{{ chapter.image.title|default:'ì±•í„° ì´ë¯¸ì§€' }}">

            <div class="episode-text-overlay">
                <h2 class="chapter-title">
                    {{ chapter.title }}
                    {% if chapter.hp_range %}
                    <span class="hp-range">
                        HP {{ chapter.hp_range.0 }}{% if chapter.hp_range.1 %} ~ {{ chapter.hp_range.1 }}{% endif %}
                    </span>
                    {% endif %}
                </h2>
                {% if chapter.image.title %}
                <p class="chapter-image-title">{{ chapter.image.title }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- ëŒ€í™” ë‚´ìš© -->
        <div class="chapter-content">
            {% for msg in chapter.messages %}
            <div class="dialogue-block {% if msg.role == 'assistant' %}assistant{% else %}user{% endif %}">
                <p class="dialogue-text" data-role="{{ msg.role }}" data-speaker="{{ msg.speaker }}">
                    {% if msg.role == 'user' %}
                    <strong>{{ msg.speaker }}:</strong>
                    {% endif %}
                    <span class="content-text">{{ msg.content|safe }}</span>
                </p>

                {% if msg.audio %}
                <div class="audio-controls">
                    <button class="tts-btn" data-audio-id="audio-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                        <span class="btn-icon">&#9654;</span>
                        <span class="btn-text">ìŒì„± ë“£ê¸°</span>
                    </button>
                    <audio id="audio-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" src="{{ msg.audio }}" preload="none" class="seq-audio"></audio>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

    </section>
    {% empty %}
    <div class="no-chapters">
        <p>ì•„ì§ ì´ì•¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endfor %}

    <!-- ë§ˆì§€ë§‰ ë§ (HP 100 ë‹¬ì„± ì‹œ) -->
    {% if last_wards %}
    <section class="last-wards-section">
        <div class="last-wards-divider">
            <span class="divider-text">â€” HP 100 ë‹¬ì„± â€”</span>
        </div>

        {% for ward in last_wards %}
        <div class="last-ward-card">
            {% if ward.image %}
            <div class="last-ward-image">
                <img src="{{ ward.image.url }}" alt="ë§ˆì§€ë§‰ ì¥ë©´" loading="lazy">
                <div class="last-ward-overlay">
                    {% if ward.ward %}
                    <div class="last-ward-quote">
                        <div class="quote-mark">"</div>
                        <p class="ward-text">{{ ward.ward }}</p>
                        <div class="quote-mark closing">"</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if ward.description %}
            <div class="last-ward-description">
                <p>{{ ward.description|safe }}</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </section>
    {% endif %}

    <!-- ì—í•„ë¡œê·¸ -->
    {% if novel.epilogue %}
    <footer class="novel-epilogue">
        {{ novel.epilogue|safe }}
    </footer>
    {% endif %}

    <!-- ë¨¸ì§€ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ (ìƒì„±ëœ ê²½ìš°ì—ë§Œ) -->
    {% if conversation.merged_audio %}
    <div id="merged-audio-card">
        <div class="mac-title-row">
            <div class="mac-icon">ğŸ™</div>
            <div class="mac-title-text">
                <div class="mac-label">ëŒ€í™” ì˜¤ë””ì˜¤</div>
                <div class="mac-name">{{ conversation.merged_audio_title|default:"ëŒ€í™” ì˜¤ë””ì˜¤" }}</div>
            </div>
        </div>
        <div class="mac-progress-wrap" id="mac-progress-wrap">
            <div class="mac-progress-track"><div class="mac-progress-fill" id="mac-fill"></div></div>
            <div class="mac-time-row"><span id="mac-cur">0:00</span><span id="mac-dur">--:--</span></div>
        </div>
        <div class="mac-controls">
            <button class="mac-btn-skip" id="mac-back">&#9664;&#9664;</button>
            <button class="mac-btn-play" id="mac-play">&#9654;</button>
            <button class="mac-btn-skip" id="mac-fwd">&#9654;&#9654;</button>
        </div>
        <audio id="mac-audio" src="{{ conversation.merged_audio.url }}" preload="metadata"></audio>
    </div>
    {% endif %}

    <!-- ê³µìœ  ì•ˆë‚´ (ê³µìœ  ëª¨ë“œì¼ ë•Œë§Œ) -->
    {% if is_shared %}
    <div class="shared-info-box">
        <div class="shared-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                <polyline points="16 6 12 2 8 6"/>
                <line x1="12" y1="2" x2="12" y2="15"/>
            </svg>
        </div>
        <p class="shared-text">
            ì´ ì´ì•¼ê¸°ëŠ” <strong>{{ conversation.user.nickname|default:conversation.user.username }}</strong>ë‹˜ì´ ê³µìœ í•œ ì†Œì„¤ì…ë‹ˆë‹¤.
        </p>
        {% if llm %}
        <a href="{% url 'character:ai_intro' llm.public_uuid %}" class="shared-start-btn">
            ë‚˜ë„ {{ llm.name }}ì™€ ëŒ€í™” ì‹œì‘í•˜ê¸°
        </a>
        {% endif %}
    </div>
    {% endif %}

</div>

<!-- ìˆœì°¨ ì¬ìƒ í”Œë¡œíŒ… ë°” -->
<div id="seq-player-bar">
    <button id="seq-play-btn">&#9654;</button>
    <div id="seq-progress-wrap">
        <div id="seq-label">ì¬ìƒ ì¤€ë¹„ ì¤‘...</div>
        <div id="seq-progress"><div id="seq-progress-fill"></div></div>
    </div>
    <button id="seq-stop-btn">&#10005;</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // â”€â”€ ë‚˜ë ˆì´ì…˜/ëŒ€ì‚¬ í¬ë§·íŒ… â”€â”€
    document.querySelectorAll('.dialogue-block.assistant .content-text').forEach(el => {
        let html = el.innerHTML;
        html = html.replace(/"([^"]+)"/g, '<q>$1</q>');
        html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
        html = html.replace(/\[([^\]]+)\]/g, '<span style="color:#a78bfa;font-size:0.85em;">[$1]</span>');
        el.innerHTML = html;
    });

    // â”€â”€ ê°œë³„ TTS ë²„íŠ¼ â”€â”€
    let currentAudio = null;
    let currentBtn = null;

    document.querySelectorAll('.tts-btn').forEach(button => {
        button.addEventListener('click', function() {
            const audioId = this.getAttribute('data-audio-id');
            const audio = document.getElementById(audioId);
            const btnText = this.querySelector('.btn-text');
            const btnIcon = this.querySelector('.btn-icon');
            if (!audio) return;

            if (currentAudio && currentAudio !== audio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                if (currentBtn) {
                    currentBtn.classList.remove('playing');
                    currentBtn.querySelector('.btn-text').textContent = 'ìŒì„± ë“£ê¸°';
                    currentBtn.querySelector('.btn-icon').innerHTML = '&#9654;';
                }
            }
            if (audio.paused) {
                audio.play();
                this.classList.add('playing');
                btnText.textContent = 'ì¼ì‹œì •ì§€';
                btnIcon.innerHTML = '&#10074;&#10074;';
                currentAudio = audio;
                currentBtn = this;
            } else {
                audio.pause();
                this.classList.remove('playing');
                btnText.textContent = 'ìŒì„± ë“£ê¸°';
                btnIcon.innerHTML = '&#9654;';
                currentAudio = null;
                currentBtn = null;
            }
        });
    });

    document.querySelectorAll('audio').forEach(audio => {
        audio.addEventListener('ended', function() {
            const btn = document.querySelector(`[data-audio-id="${audio.id}"]`);
            if (btn) {
                btn.classList.remove('playing');
                btn.querySelector('.btn-text').textContent = 'ìŒì„± ë“£ê¸°';
                btn.querySelector('.btn-icon').innerHTML = '&#9654;';
            }
            currentAudio = null;
            currentBtn = null;
        });
    });

    // â”€â”€ ìˆœì°¨ ì¬ìƒ â”€â”€
    const seqAudios = Array.from(document.querySelectorAll('audio.seq-audio'));
    const seqBar    = document.getElementById('seq-player-bar');
    const seqPlayBtn = document.getElementById('seq-play-btn');
    const seqStopBtn = document.getElementById('seq-stop-btn');
    const seqLabel  = document.getElementById('seq-label');
    const seqFill   = document.getElementById('seq-progress-fill');
    const startSeqBtn = document.getElementById('start-seq-btn');

    let seqIdx = 0;
    let seqPlaying = false;
    let seqPaused = false;

    function clearHighlight() {
        document.querySelectorAll('.dialogue-block.seq-playing').forEach(b => b.classList.remove('seq-playing'));
    }

    function updateProgress(audio) {
        if (!audio.duration) return;
        const pct = (audio.currentTime / audio.duration) * 100;
        seqFill.style.width = pct + '%';
    }

    function playSeqAt(idx) {
        if (idx >= seqAudios.length) {
            stopSeq();
            return;
        }
        clearHighlight();
        seqIdx = idx;
        const audio = seqAudios[idx];
        const block = audio.closest('.dialogue-block');
        if (block) {
            block.classList.add('seq-playing');
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const textEl = block.querySelector('.content-text');
            seqLabel.textContent = textEl ? textEl.textContent.slice(0, 40) : `${idx + 1} / ${seqAudios.length}`;
        }
        seqFill.style.width = '0%';
        audio.currentTime = 0;
        audio.play().catch(() => playSeqAt(idx + 1));
    }

    function stopSeq() {
        seqPlaying = false;
        seqPaused = false;
        clearHighlight();
        seqBar.classList.remove('active');
        seqPlayBtn.innerHTML = '&#9654;';
        seqLabel.textContent = 'ì¬ìƒ ì¤€ë¹„ ì¤‘...';
        seqFill.style.width = '0%';
        seqAudios.forEach(a => { a.pause(); a.currentTime = 0; });
        seqIdx = 0;
    }

    seqAudios.forEach((audio, idx) => {
        audio.addEventListener('timeupdate', () => { if (seqIdx === idx) updateProgress(audio); });
        audio.addEventListener('ended', () => {
            if (seqPlaying && !seqPaused) playSeqAt(idx + 1);
        });
    });

    if (startSeqBtn) {
        startSeqBtn.addEventListener('click', function() {
            if (seqAudios.length === 0) return;
            seqPlaying = true;
            seqPaused = false;
            seqBar.classList.add('active');
            seqPlayBtn.innerHTML = '&#10074;&#10074;';
            playSeqAt(0);
        });
    }

    seqPlayBtn.addEventListener('click', function() {
        if (!seqPlaying) return;
        const audio = seqAudios[seqIdx];
        if (!audio) return;
        if (seqPaused) {
            seqPaused = false;
            audio.play();
            seqPlayBtn.innerHTML = '&#10074;&#10074;';
        } else {
            seqPaused = true;
            audio.pause();
            seqPlayBtn.innerHTML = '&#9654;';
        }
    });

    seqStopBtn.addEventListener('click', stopSeq);

    // â”€â”€ ë¨¸ì§€ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ â”€â”€
    const macAudio = document.getElementById('mac-audio');
    if (macAudio) {
        const macPlay = document.getElementById('mac-play');
        const macBack = document.getElementById('mac-back');
        const macFwd  = document.getElementById('mac-fwd');
        const macFill = document.getElementById('mac-fill');
        const macCur  = document.getElementById('mac-cur');
        const macDur  = document.getElementById('mac-dur');
        const macWrap = document.getElementById('mac-progress-wrap');

        function fmtTime(s) {
            if (!isFinite(s)) return '--:--';
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return m + ':' + String(sec).padStart(2, '0');
        }

        macAudio.addEventListener('loadedmetadata', () => { macDur.textContent = fmtTime(macAudio.duration); });
        macAudio.addEventListener('timeupdate', () => {
            if (macAudio.duration) {
                macFill.style.width = (macAudio.currentTime / macAudio.duration * 100) + '%';
            }
            macCur.textContent = fmtTime(macAudio.currentTime);
        });
        macAudio.addEventListener('ended', () => {
            macPlay.innerHTML = '&#9654;';
            macFill.style.width = '0%';
            macAudio.currentTime = 0;
        });

        macPlay.addEventListener('click', () => {
            if (macAudio.paused) {
                macAudio.play();
                macPlay.innerHTML = '&#10074;&#10074;';
            } else {
                macAudio.pause();
                macPlay.innerHTML = '&#9654;';
            }
        });

        macBack.addEventListener('click', () => { macAudio.currentTime = Math.max(0, macAudio.currentTime - 10); });
        macFwd.addEventListener('click',  () => { macAudio.currentTime = Math.min(macAudio.duration || 0, macAudio.currentTime + 10); });

        macWrap.addEventListener('click', e => {
            if (!macAudio.duration) return;
            const rect = macWrap.getBoundingClientRect();
            const ratio = (e.clientX - rect.left) / rect.width;
            macAudio.currentTime = ratio * macAudio.duration;
        });
    }
});
</script>
{% endblock %}
