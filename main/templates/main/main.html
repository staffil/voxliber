{% extends "base.html" %}
{% load static %}

{% block title %}VOXLIBER - ëª©ì†Œë¦¬ë¡œ ë“£ëŠ” ì´ì•¼ê¸°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home/main/audio.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/banner.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/common.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/main.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/poem.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/ranking.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/recent.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/resume.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/snap.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/snippet.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/spotlight.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/genres.css' %}">

{% endblock %}


{% block content %}
<div class="main-container">
  <div class="main-content-wrapper">

    <!-- =====================================================
         í”„ë¡œëª¨ ë°°ë„ˆ ìŠ¬ë¼ì´ë”
         ===================================================== -->
    <div class="promo-container-wrapper">
      <div class="promo-container">
        {% for advertisment in advertisment_list %}
        <div class="promo-banner">
          <a href="{{ advertisment.link }}">
            <img src="{{ advertisment.advertisment_img.url }}" alt="ì´ë²¤íŠ¸" loading="lazy">
          </a>
        </div>
        {% endfor %}
      </div>

      <button class="promo-nav promo-nav-prev" id="promoPrev" title="ì´ì „ ê´‘ê³ ">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </button>
      <button class="promo-nav promo-nav-next" id="promoNext" title="ë‹¤ìŒ ê´‘ê³ ">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
      </button>

      <div class="promo-controls">
        <div class="promo-counter">
          <span id="currentSlide">1</span> / <span id="totalSlides">{{ advertisment_list|length }}</span>
        </div>
        <button class="promo-play-pause" id="promoPlayPause" title="ì¼ì‹œì •ì§€">
          <svg id="pauseIcon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>
          <svg id="playIcon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none;"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <div class="promo-indicators">
          {% for advertisment in advertisment_list %}<span class="indicator"></span>{% endfor %}
        </div>
      </div>
    </div>

    <br><br><br>

    <!-- =====================================================
         ë©”ì¸ íƒ­ ë„¤ë¹„ê²Œì´ì…˜
         ===================================================== -->
    <div class="main-tab-wrapper">
      <div class="main-tab-buttons">
        <div class="main-tab-btn active" data-main-tab="audiobook-tab">ì˜¤ë””ì˜¤ë¶</div>
        <div class="main-tab-btn" data-main-tab="ai-novel-tab">AI ì†Œì„¤</div>
      </div>
    </div>


    <!-- =====================================================
         ì˜¤ë””ì˜¤ë¶ íƒ­
         ===================================================== -->
    <div id="audiobook-tab" class="main-tab-panel active">

      <!-- ìµœê·¼ ë³¸ ì‘í’ˆ (ë¡œê·¸ì¸ ìœ ì €) -->
      {% if request.user.is_authenticated %}
      <section class="content-section recent-section">
        <div class="section-header">
          <h2 class="section-title"><span class="title-icon"></span>ìµœê·¼ ë³¸ ì‘í’ˆ</h2>
        </div>
        <div class="recent-books-carousel">
          {% for progress in recent_books %}
          <div class="recent-book-card-wrapper">
            <a href="{% if progress.current_content %}{% url 'book:content_detail' progress.current_content.public_uuid %}{% else %}{% url 'book:book_detail' progress.book.public_uuid %}{% endif %}" class="recent-book-card">
              <div class="recent-cover">
                {% if progress.book.cover_img %}
                  <img src="{{ progress.book.cover_img.url }}" alt="{{ progress.book.name }}" loading="lazy">
                {% else %}
                  <div class="recent-placeholder">ğŸ“–</div>
                {% endif %}
              </div>
              <div class="recent-info">
                <h4>{{ progress.book.name }}</h4>
                <p>{{ progress.last_read_content_number }}í™” / {{ progress.book.contents.count }}í™”</p>
              </div>
            </a>
          </div>
          {% empty %}
          <div class="empty-state">ìµœê·¼ ë³¸ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- ì´ì–´ë“£ê¸° (ë¡œê·¸ì¸ + ê¸°ë¡ ìˆëŠ” ê²½ìš°) -->
      {% if request.user.is_authenticated and recent_listening %}
      <section class="content-section continue-listening-section">
        <div class="section-header">
          <h2 class="section-title"><span class="title-icon"></span>ì´ì–´ë“£ê¸°</h2>
        </div>
        <div class="continue-listening-grid">
          {% for history in recent_listening %}
          <div class="continue-item">
            <a href="{% url 'book:content_detail' history.content.public_uuid %}"
               class="continue-cover"
               data-position="{{ history.last_position }}"
               data-login-required>
              {% if history.book.cover_img %}
                <img src="{{ history.book.cover_img.url }}" alt="{{ history.book.name }}" loading="lazy">
              {% else %}
                <div class="continue-placeholder">ğŸ§</div>
              {% endif %}
            </a>
            <div class="continue-info">
              <div class="continue-info-header">
                <h3 class="continue-book-title">{{ history.book.name }}</h3>
                <div class="continue-menu">
                  <button class="continue-menu-btn" type="button">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                      <circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/>
                    </svg>
                  </button>
                  <div class="continue-menu-dropdown">
                    <a href="{% url 'book:content_detail' history.content.public_uuid %}" class="continue-menu-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                      </svg>
                      ìƒì„¸ë³´ê¸°
                    </a>
                    <a class="continue-menu-item continue-delete-btn"
                       href="{% url 'main:delete_listening_history' history.book.public_uuid %}"
                       data-history-id="{{ history.id }}"
                       onclick="return confirm('ì²­ì·¨ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                      </svg>
                      ê¸°ë¡ ì‚­ì œ
                    </a>
                  </div>
                </div>
              </div>
              <p class="continue-episode">{{ history.content.number }}í™” Â· {{ history.content.title }}</p>
              <span class="continue-time">{{ history.last_position|floatformat:0 }}ì´ˆ</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- íˆì–´ë¡œ ë°°ë„ˆ -->
      <section class="hero-section">
        <div class="hero-background">
          {% for news in news_list %}
            {% if news.news_img %}
              <img src="{{ news.news_img.url }}" alt="VOXLIBER" loading="lazy">
            {% else %}
              <img src="{% static 'images/default-banner.jpg' %}" alt="VOXLIBER" loading="lazy">
            {% endif %}
          {% empty %}
            <img src="{% static 'images/default-banner.jpg' %}" alt="VOXLIBER" loading="lazy">
          {% endfor %}
        </div>
        <div class="hero-overlay" style="border-radius:15px;"></div>
        <div class="hero-content">
          <h1 class="hero-title">ëª©ì†Œë¦¬ë¡œ ë“£ëŠ” ì´ì•¼ê¸°</h1>
          <p class="hero-subtitle">AIê°€ ë§Œë“œëŠ” ì˜¤ë””ì˜¤ë¶ìœ¼ë¡œ ìƒˆë¡œìš´ ë…ì„œ ê²½í—˜ì„ ì‹œì‘í•˜ì„¸ìš”</p>
          {% if user.is_authenticated %}
            <a href="{% url 'book:book_tos' %}" class="hero-cta" data-login-required>
              <span>ì‘í’ˆ ë§Œë“¤ê¸°</span><span>â†’</span>
            </a>
          {% else %}
            <a href="book/book_tos/" class="hero-cta" onclick="openLogin(); return false;">
              <span>ì‘í’ˆ ë§Œë“¤ê¸°</span><span>â†’</span>
            </a>
          {% endif %}
        </div>
      </section>

      <!-- ë¶ìŠ¤ëƒ… ë¯¸ë¦¬ë³´ê¸° -->
      <div class="snap-reels-section">
        <h3 class="snap-reels-title">ë¶ìŠ¤ëƒ… ë¯¸ë¦¬ë³´ê¸°</h3>
        <div class="snap-reels-wrapper">
          {% for snap in snap_list %}
          <div class="snap-reels-item">
            <a href="{% url 'book:book_snap_detail' snap.public_uuid %}" data-login-required>
              <div class="snap-reels-media" style="position:relative; overflow:hidden;">
                {% if snap.thumbnail %}
                  <img class="snap-thumbnail lazy-img" data-src="{{ snap.thumbnail.url }}"
                       alt="{{ snap.snap_title }}" loading="lazy" style="width:100%; display:block;">
                {% else %}
                  <img class="snap-thumbnail lazy-img" data-src="{% static 'images/book_snap_placeholder.png' %}"
                       alt="{{ snap.snap_title }}" loading="lazy" style="width:100%; display:block;">
                {% endif %}
                {% if snap.snap_video %}
                  <video class="hover-preview-video" muted playsinline preload="none"
                         data-src="{{ snap.snap_video.url }}"
                         style="position:absolute; top:0; left:0; width:100%; height:100%; display:none;"></video>
                {% endif %}
                <div class="snap-reels-overlay">{{ snap.snap_title|default:"ì œëª© ì—†ìŒ" }}</div>
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- ì˜¤ëŠ˜ì˜ ì¶”ì²œ + ì¸ê¸° ìˆœìœ„ -->
      <section class="content-section spotlight-section">
        <div class="section-header">
          <h2 class="section-title">ì˜¤ëŠ˜ì˜ ì¶”ì²œ</h2>
        </div>
        <div class="scroll-container">
          <div class="spotlight-grid">
            {% for book in new_books|slice:":8" %}
            <div class="spotlight-card">
              <a href="{% url 'book:book_detail' book.public_uuid %}" class="spotlight-link">
                <div class="spotlight-thumb">
                  {% if book.cover_img %}
                    <img src="{{ book.cover_img.url }}" alt="{{ book.name }}" loading="lazy">
                  {% else %}
                    <div class="spotlight-placeholder">ğŸ“š</div>
                  {% endif %}
                </div>
                <div class="spotlight-info">
                  <h3 class="spotlight-name">{{ book.name }}</h3>
                  <p class="spotlight-writer">{{ book.user.nickname }}</p>
                </div>
              </a>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="section-header" style="margin-top:5rem;">
          <h2 class="section-title">ì˜¤ëŠ˜ì˜ ì¸ê¸° ì˜¤ë””ì˜¤ë¶</h2>
        </div>
        <div class="ranking-container">
          {% for book in popular_books|slice:":12" %}
          <a href="{% url 'book:book_detail' book.public_uuid %}" class="rank-card">
            <div class="rank-badge">{{ forloop.counter }}</div>
            <div class="rank-thumb">
              {% if book.cover_img %}
                <img src="{{ book.cover_img.url }}" alt="{{ book.name }}" loading="lazy">
              {% else %}
                <div class="rank-placeholder">ğŸ“–</div>
              {% endif %}
            </div>
            <div class="rank-details">
              <h4 class="rank-title">{{ book.name }}</h4>
              <p class="rank-author">{{ book.user.nickname }}</p>
            </div>
            <div class="rank-meta">
              <span class="play-count">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" opacity="0.5">
                  <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
                {{ book.view_count|default:"0" }}
              </span>
            </div>
          </a>
          {% endfor %}
        </div>
      </section>

      <!-- ì‹¤ì‹œê°„ ì¸ê¸° ì°¨íŠ¸ -->
      <section class="content-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="title-icon"></span>ì‹¤ì‹œê°„ ì¸ê¸° ì°¨íŠ¸
            <span class="live-indicator">LIVE</span>
          </h2>
        </div>
        <div class="ranking-list">
          {% for book in popular_books|slice:":5" %}
          <div class="ranking-item-wrapper">
            <a href="{% url 'book:book_detail' book.public_uuid %}" class="ranking-item">
              <div class="rank-number rank-{{ forloop.counter }}">{{ forloop.counter }}</div>
              <div class="rank-cover">
                {% if book.cover_img %}
                  <img src="{{ book.cover_img.url }}" alt="{{ book.name }}" loading="lazy">
                {% else %}
                  <div class="rank-placeholder">ğŸ“–</div>
                {% endif %}
              </div>
              <div class="rank-info">
                <h4 style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ book.name }}</h4>
                <p class="rank-meta">{{ book.user.nickname }} â€¢ {{ book.genres.all.0.name }}</p>
                {% if book.tags.exists %}
                <p style="margin-top:2px; font-size:0.3em; color:#6366f1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                  {% for tag in book.tags.all|slice:":5" %}#{{ tag.name }}{% if not forloop.last %} {% endif %}{% endfor %}
                </p>
                {% endif %}
              </div>
              <div class="rank-stats">
                <span class="rank-score">â­ {{ book.book_score|default:"0.0" }}</span>
                <span class="rank-change {% if forloop.counter <= 3 %}up{% else %}down{% endif %}">
                  {% if forloop.counter <= 3 %}â–²{% else %}â–¼{% endif %}
                </span>
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
      </section>





      <!-- =====================================================
           ğŸµ ì¥ë¥´ë³„ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸
           ===================================================== -->
      <section class="content-section genre-playlist-section">
        <div class="playlist-section-header">
          <h2 class="playlist-section-title">
            ì¥ë¥´ë³„ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸
            <span class="title-label">NEW</span>
          </h2>
          <div class="playlist-type-tabs" id="playlistTypeTabs">
            <div class="playlist-type-tab active" data-ptype="popular">ğŸ”¥ ì¸ê¸°</div>
            <div class="playlist-type-tab" data-ptype="new">ğŸ†• ì‹ ì‘</div>
            <div class="playlist-type-tab" data-ptype="short">âš¡ ì§§ê²Œ</div>
            <div class="playlist-type-tab" data-ptype="rated">â­ ê³ í‰ì </div>
          </div>
        </div>

        <div class="playlist-cards-grid" id="playlistCardsGrid">
          {% for playlist in popular_genres %}
          <div class="playlist-card" data-ptype="{{ playlist.playlist_type }}">

            <div class="playlist-card-art">
              <div class="art-collage">
                {% for item in playlist.items.all|slice:":3" %}
                <div class="art-cell">
                  {% if item.content.book.cover_img %}
                    <img src="{{ item.content.book.cover_img.url }}" alt="{{ item.content.book.name }}" loading="lazy">
                  {% else %}
                    <div class="placeholder">ğŸ§</div>
                  {% endif %}
                </div>
                {% empty %}
                  <div class="art-cell placeholder">ğŸµ</div>
                  <div class="art-cell placeholder">ğŸµ</div>
                  <div class="art-cell placeholder">ğŸµ</div>
                {% endfor %}
              </div>
              <div class="playlist-card-art-overlay"></div>
              <div class="playlist-genre-badge">{{ playlist.genre.name }}</div>
              <div class="playlist-play-overlay">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
              </div>
            </div>

            <div class="playlist-card-body">
              <div class="playlist-card-title">{{ playlist.title }}</div>
              {% if playlist.description %}
              <div class="playlist-card-desc">{{ playlist.description }}</div>
              {% endif %}

              <div class="playlist-card-meta">
                <span class="playlist-meta-item">
                  <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
                  </svg>
                  {{ playlist.items.count }}í™”
                </span>
                <span class="playlist-meta-item">
                  <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z"/>
                  </svg>
                  ëª¨ì•„ë“£ê¸°
                </span>
                <span class="playlist-meta-item">
                  <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                  </svg>
                  {{ playlist.get_playlist_type_display }}
                </span>
              </div>

              <div class="playlist-episode-preview">
                {% for item in playlist.items.all|slice:":3" %}
                <a href="{% url 'book:content_detail' item.content.public_uuid %}"
                   class="playlist-ep-row" data-login-required>
                  <span class="ep-num">{{ forloop.counter }}</span>
                  <div class="ep-thumb">
                    {% if item.content.book.cover_img %}
                      <img src="{{ item.content.book.cover_img.url }}" alt="" loading="lazy">
                    {% else %}
                      <div class="ep-thumb-placeholder">ğŸ§</div>
                    {% endif %}
                  </div>
                  <div class="ep-info">
                    <div class="ep-title">{{ item.content.title }}</div>
                    <div class="ep-book">{{ item.content.book.name }}</div>
                  </div>
                  <span class="ep-duration">{{ item.content.get_duration_formatted }}</span>
                </a>
                {% empty %}
                <div style="font-size:0.72rem; color:rgba(255,255,255,0.3); text-align:center; padding:8px 0;">
                  ì—í”¼ì†Œë“œê°€ ì—†ìŠµë‹ˆë‹¤
                </div>
                {% endfor %}

                {% if playlist.items.count > 3 %}
                <div class="playlist-more-row">
                  + {{ playlist.items.count|add:"-3" }}ê°œ ë” ë³´ê¸°
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% empty %}
          <div class="playlist-empty-card" style="grid-column:1/-1;">
            <span style="font-size:2rem;">ğŸµ</span>
            <p>ì¥ë¥´ë³„ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ì¤€ë¹„ ì¤‘ì´ì—ìš”</p>
            <p style="font-size:0.65rem; opacity:0.6;">
              ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì¶”ê°€í•˜ê±°ë‚˜<br>
              <code>python manage.py refresh_playlists</code>ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”
            </p>
          </div>
          {% endfor %}
        </div>
      </section>

      <!-- ì¥ë¥´ë³„ íë ˆì´ì…˜ -->
      {% for item in genres_with_books %}
      <section class="content-section genre-curation-section">
        <div class="section-header">
          <h2 class="section-title"><span class="title-icon"></span>{{ item.genre.name }} ì¸ê¸°ì‘</h2>
          <a href="{% url 'main:genres_books' item.genre.id %}" class="view-more-link">ë”ë³´ê¸° â†’</a>
        </div>
        <div class="genre-carousel">
          {% for book in item.books %}
          <div class="genre-book-card">
            <a href="{% url 'book:book_detail' book.public_uuid %}" class="genre-book-link">
              <div class="genre-book-cover">
                {% if book.cover_img %}
                  <img src="{{ book.cover_img.url }}" alt="{{ book.name }}" loading="lazy">
                {% else %}
                  <div class="book-placeholder">{{ book.name|slice:":2"|upper }}</div>
                {% endif %}
              </div>
              <div class="genre-book-info">
                <h4 style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ book.name }}</h4>
                <p class="genre-book-author">{{ book.user.nickname }}</p>
                <div class="genre-book-stats"><span>â­ {{ book.book_score|default:"0.0" }}</span></div>
                {% if book.tags.exists %}
                <div class="card-genres">
                  {% for genre in book.genres.all %}
                    <span class="genre-tag" style="background-color:{{ genre.genres_color|default:'#6366f1' }};">{{ genre.name }}</span>
                  {% endfor %}
                </div>
                <div class="card-tags">
                  {% for tag in book.tags.all %}<span class="tag-item">#{{ tag.name }}</span>{% endfor %}
                </div>
                {% endif %}
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endfor %}

      <!-- ì¥ë¥´ë³„ ì¸ê¸° ì±… (í•„í„°) -->
      <section class="content-section">
        <div class="section-header">
          <h2 class="section-title">ì¥ë¥´ë³„ ì¸ê¸° ì±…</h2>
        </div>
        <div class="genre-filters">
          <button class="genre-filter-btn active" data-genre-id="">ì „ì²´</button>
          {% for genre in genres_list %}
          <button class="genre-filter-btn" data-genre-id="{{ genre.id }}">{{ genre.name }}</button>
          {% endfor %}
        </div>
        <div class="books-grid" id="genreBooks" data-filter-url="{% url 'main:filter_books' %}">
          {% for book in popular_books %}
          <div class="book-item-wrapper">
            <a href="{% url 'book:book_detail' book.public_uuid %}" class="book-item">
              <div class="book-cover-wrapper">
                {% if book.cover_img %}
                  <img src="{{ book.cover_img.url }}" alt="{{ book.name }}" loading="lazy">
                {% else %}
                  <div class="book-placeholder">{{ book.name|slice:":2"|upper }}</div>
                {% endif %}
              </div>
              <div class="book-details">
                <h3 style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ book.name }}</h3>
                <div class="card-genres">
                  {% for genre in book.genres.all %}
                    <span class="genre-tag" style="background-color:{{ genre.genres_color|default:'#6366f1' }};">{{ genre.name }}</span>
                  {% endfor %}
                </div>
                <div class="card-tags">
                  {% for tag in book.tags.all %}<span class="tag-item">#{{ tag.name }}</span>{% endfor %}
                </div>
              </div>
            </a>
          </div>
          {% empty %}
          <div class="empty-state">ì•„ì§ ë“±ë¡ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>
          {% endfor %}
        </div>
      </section>

    </div><!-- /audiobook-tab -->



      <!-- ì§€ê¸ˆ ëœ¨ëŠ” ì‘í’ˆ -->
      {% if trending_books %}
      <section class="content-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="title-icon"></span>ì§€ê¸ˆ ëœ¨ëŠ” ì‘í’ˆ
            <span class="trending-badge">HOT</span>
          </h2>
        </div>
        <div class="books-grid">
          {% for book in trending_books %}
          <div class="book-item-wrapper">
            <a href="{% url 'book:book_detail' book.public_uuid %}" class="book-item">
              <div class="book-cover-wrapper">
                {% if book.cover_img %}
                  <img src="{{ book.cover_img.url }}" alt="{{ book.name }}" loading="lazy">
                {% else %}
                  <div class="book-placeholder">{{ book.name|slice:":2"|upper }}</div>
                {% endif %}
                <div class="book-badge trending">ë² ìŠ¤íŠ¸ì…€ëŸ¬</div>
              </div>
              <div class="book-details">
                <h3 style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ book.name }}</h3>
                <p class="book-meta">{{ book.user.nickname }}</p>
                <div class="card-genres">
                  {% for genre in book.genres.all %}
                    <span class="genre-tag" style="background-color:{{ genre.genres_color|default:'#6366f1' }};">{{ genre.name }}</span>
                  {% endfor %}
                </div>
                <div class="card-tags">
                  {% for tag in book.tags.all %}
                    <span class="tag-item">#{{ tag.name }}</span>
                  {% endfor %}
                </div>
                <p class="book-stats">â­ {{ book.book_score|default:"0.0" }}</p>
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- AI ê´‘ê³  ë°°ë„ˆ -->
      <!-- {% with ann=ai_advertismemt_img.0 %}
      {% if ann %}
      <a href="{{ ann.link }}" class="hero-announce-link">
        <section class="hero-section hero-announce">
          <div class="hero-background">
            {% if ann.advertisment_img %}
              <img src="{{ ann.advertisment_img.url }}" alt="{{ ann.title }}">
            {% else %}
              <img src="{% static 'images/default-banner.jpg' %}" alt="VOXLIBER">
            {% endif %}
          </div>
          <div class="hero-overlay" style="border-radius:15px;"></div>
          <div class="hero-content">
            <p class="hero-announce-label">ğŸ“£ ìƒˆë¡œìš´ ì†Œì‹</p>
            <h2 class="hero-announce-title">{{ ann.title }}</h2>
            <span class="hero-announce-cta">ìì„¸íˆ ë³´ê¸° â†’</span>
          </div>
        </section>
      </a>
      {% endif %}
      {% endwith %} -->

      <!-- ì´ë‹¬ì˜ ì‘ê°€ -->
      <section class="content-section">
        <div class="section-header">
          <h2 class="section-title"><span class="title-icon"></span>ì´ë‹¬ì˜ ì‘ê°€</h2>
        </div>
        <div class="featured-authors">
          {% for author in popular_authors %}
          <a href="{% url 'main:user_info' author.public_uuid %}">
            <div class="author-item">
              <div class="author-rank rank-{{ forloop.counter }}">{{ forloop.counter }}</div>
              <div class="author-photo">
                {% if author.user_img %}
                  <img src="{{ author.user_img.url }}" alt="{{ author.nickname }}" loading="lazy">
                {% else %}
                  <div class="author-placeholder">{{ author.nickname|slice:":1"|upper }}</div>
                {% endif %}
              </div>
              <div class="author-info">
                <h3>{{ author.nickname }}</h3>
                <p>ì‘í’ˆ {{ author.book_count }}ê°œ</p>
              </div>
            </div>
          </a>
          {% empty %}
          <div class="empty-state">ì•„ì§ ë“±ë¡ëœ ì‘ê°€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          {% endfor %}
        </div>
      </section>

      <!-- ì¥ë¥´ ê¸°ë°˜ ì¶”ì²œ (ë¡œê·¸ì¸ ìœ ì €) -->
      {% if user.is_authenticated and recommended_books %}
      <section class="content-section recommended-section">
        <div class="section-header">
          <h2 class="section-title"><span class="title-icon"></span>{{ user.nickname }}ë‹˜ì„ ìœ„í•œ ì¥ë¥´ ì¶”ì²œ</h2>
          <p class="section-subtitle">ë‹¹ì‹ ì´ ì¢‹ì•„í•  ë§Œí•œ ì‘í’ˆë“¤ì´ì—ìš”</p>
        </div>
        <div class="books-grid">
          {% for book in recommended_books %}
          <div class="book-item-wrapper">
            <a href="{% url 'book:book_detail' book.public_uuid %}" class="book-item">
              <div class="book-cover-wrapper">
                {% if book.cover_img %}
                  <img src="{{ book.cover_img.url }}" alt="{{ book.name }}" loading="lazy">
                {% else %}
                  <div class="book-placeholder">{{ book.name|slice:":2"|upper }}</div>
                {% endif %}
                <div class="book-badge recommended">ì¶”ì²œ</div>
              </div>
              <div class="book-details">
                <h3 style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ book.name }}</h3>
                <div class="card-genres">
                  {% for genre in book.genres.all %}
                    <span class="genre-tag" style="background-color:{{ genre.genres_color|default:'#6366f1' }};">{{ genre.name }}</span>
                  {% endfor %}
                </div>
                <div class="card-tags">
                  {% for tag in book.tags.all %}<span class="tag-item">#{{ tag.name }}</span>{% endfor %}
                </div>
                <p class="book-stats">â­ {{ book.book_score|default:"0.0" }}</p>
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- AI ì¶”ì²œ (ë¡œê·¸ì¸ ìœ ì €) -->
      {% if user.is_authenticated and ai_recommended_books %}
      <section class="content-section recommended-section">
        <div class="section-header">
          <h2 class="section-title"><span class="title-icon"></span>AIê°€ ì¶”ì²œí•˜ëŠ” ì±…</h2>
          <p class="section-subtitle">ë‹¹ì‹ ì´ ì¢‹ì•„í•  ë§Œí•œ ì‘í’ˆë“¤ì´ì—ìš”</p>
        </div>
        <div class="books-grid">
          {% for book in ai_recommended_books %}
          <div class="book-item-wrapper">
            <a href="{% url 'book:book_detail' book.public_uuid %}" class="book-item">
              <div class="book-cover-wrapper">
                {% if book.cover_img %}
                  <img src="{{ book.cover_img.url }}" alt="{{ book.name }}" loading="lazy">
                {% else %}
                  <div class="book-placeholder">{{ book.name|slice:":2"|upper }}</div>
                {% endif %}
                <div class="book-badge recommended">ì¶”ì²œ</div>
              </div>
              <div class="book-details">
                <h3 style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ book.name }}</h3>
                <div class="card-genres">
                  {% for genre in book.genres.all %}
                    <span class="genre-tag" style="background-color:{{ genre.genres_color|default:'#6366f1' }};">{{ genre.name }}</span>
                  {% endfor %}
                </div>
                <div class="card-tags">
                  {% for tag in book.tags.all %}<span class="tag-item">#{{ tag.name }}</span>{% endfor %}
                </div>
                <p class="book-stats">â­ {{ book.book_score|default:"0.0" }}</p>
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
      </section>
      <section class="ai-recommend-section">
        <a class="ai-recommend-btn" href="ai_recommended/">âœ¨ ì¶”ì²œí•œ ì´ìœ  ë³´ê¸°</a>
      </section>
      {% endif %}



    <!-- =====================================================
         AI ì†Œì„¤ íƒ­
         ===================================================== -->
    <div id="ai-novel-tab" class="main-tab-panel">
      <div class="ai-novel-tab-content">
        <div class="ai-sub-tab-buttons">
          <div class="ai-sub-tab-btn active" data-ai-tab="ai-stories-panel">AI Story</div>
          <div class="ai-sub-tab-btn" data-ai-tab="shared-stories-panel">ê³µìœ í•œ AI</div>
        </div>

        <!-- AI Story -->
        <div id="ai-stories-panel" class="ai-sub-panel active">
          <div class="ai-story-grid">
            {% for story in ai_stories|slice:":30" %}
              {% if story.public_uuid %}
              <div class="ai-story-card">
                <a href="{% url 'character:story_intro' story.public_uuid %}" class="card-link">
                  <div class="card-image-box">
                    {% if story.story_desc_video %}
                      <video class="card-image lazy-video" autoplay loop muted playsinline preload="none"
                             data-src="{{ story.story_desc_video.url }}">
                        <source src="{{ story.story_desc_video.url }}" type="video/mp4">
                      </video>
                    {% elif story.cover_image %}
                      <img src="{{ story.cover_image.url }}" alt="{{ story.title }}" class="card-image" loading="lazy">
                    {% else %}
                      <div class="card-placeholder"><span class="placeholder-icon">ğŸŒ™</span></div>
                    {% endif %}
                    <div class="card-gradient-overlay"></div>
                    <div class="card-content">
                      <h3 class="card-title">{{ story.title }}</h3>
                      {% if story.description %}
                      <p class="card-desc">{{ story.description|truncatewords:20 }}</p>
                      {% endif %}
                    </div>
                  </div>
                </a>
              </div>
              {% endif %}
            {% empty %}
            <div style="grid-column:1/-1; text-align:center; padding:60px 20px; color:rgba(255,255,255,0.5);">
              <p>ì•„ì§ ë“±ë¡ëœ AI ì†Œì„¤ì´ ì—†ìŠµë‹ˆë‹¤</p>
              <a href="{% url 'character:make_ai_story' %}" style="display:inline-block; margin-top:16px; padding:12px 28px; background:linear-gradient(135deg,#9f7aea,#7f5af0); color:white; border-radius:50px; text-decoration:none; font-weight:600;">ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°</a>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- ê³µìœ í•œ AI -->
        <div id="shared-stories-panel" class="ai-sub-panel">
          <div class="ai-story-grid">
            {% for conv in user_share_list %}
            <div class="ai-story-card">
              <a href="{% url 'main:shared_novel' conv.id %}" class="card-link">
                <div class="card-image-box">
                  {% if conv.llm.llm_image %}
                    <img src="{{ conv.llm.llm_image.url }}" alt="{{ conv.llm.name }}" class="card-image" loading="lazy">
                  {% else %}
                    <div class="card-placeholder"><span class="placeholder-icon">ğŸ“–</span></div>
                  {% endif %}
                  <div class="card-gradient-overlay">
                    <div class="user-nickname" style="padding:8px;">
                      {% if conv.user.user_img %}
                        <img src="{{ conv.user.user_img.url }}" alt="{{ conv.user.nickname }}">
                      {% else %}
                        {{ conv.user.nickname|slice:":1"|upper }}
                      {% endif %}
                      <span>{{ conv.user.nickname }}</span>
                    </div>
                  </div>
                  <div class="card-content">
                    <h3 class="card-title">{{ conv.merged_audio_title|default:conv.llm.name }}</h3>
                    {% if conv.messages.exists %}
                      <p class="card-desc">{{ conv.messages.first.content|truncatechars:40|safe }}</p>
                    {% else %}
                      <p class="card-desc">ì•„ì§ ëŒ€í™”ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ì–´ìš”</p>
                    {% endif %}
                  </div>
                </div>
              </a>
              <div class="card-meta">ê³µìœ ì: {{ conv.user.nickname|default:'ìµëª…' }} | {{ conv.shared_at|date:"m.d H:i" }}</div>
            </div>
            {% empty %}
            <div style="grid-column:1/-1; text-align:center; padding:60px 20px; color:rgba(255,255,255,0.5);">
              <p>ì•„ì§ ê³µê°œëœ AI ëŒ€í™”ê°€ ì—†ì–´ìš”</p>
              <a href="{% url 'character:make_ai_story' %}" style="display:inline-block; margin-top:16px; padding:12px 28px; background:linear-gradient(135deg,#9f7aea,#7f5af0); color:white; border-radius:50px; text-decoration:none; font-weight:600;">ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°</a>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div><!-- /ai-novel-tab -->

  </div>
</div>


<!-- =====================================================
     í‘¸í„°
     ===================================================== -->
<footer class="main-footer">
  <div class="footer-container">
    <div class="footer-grid">
      <div class="footer-brand">
        <h2>VOXLIBER</h2>
        <p>AI ê¸°ìˆ ë¡œ ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ìƒìƒí•œ ì˜¤ë””ì˜¤ë¶ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. ìƒˆë¡œìš´ ë…ì„œ ê²½í—˜ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
      </div>
      <div class="footer-links">
        <h3>ì„œë¹„ìŠ¤</h3>
        <ul>
          <li><a href="/book/book-snap/" data-login-required>SNAP</a></li>
          <li><a href="/book/author-dashboard/" data-login-required>ì‘ê°€ ì„¼í„°</a></li>
          <!-- <li><a href="/advertisment/request/list/" data-login-required>ê´‘ê³  ìš”ì²­</a></li> -->
          <li><a href="#">ìš”ê¸ˆì œ</a></li>
        </ul>
      </div>
      <div class="footer-links">
        <h3>ê³ ê° ì§€ì›</h3>
        <ul>
          <li><a href="faq/">FAQ</a></li>
          <li><a href="notice/">ê³µì§€ì‚¬í•­</a></li>
          <li><a href="contact/" data-login-required>ë¬¸ì˜í•˜ê¸°</a></li>
        </ul>
      </div>
      <div class="footer-links">
        <h3>ë²•ì  ì •ë³´</h3>
        <ul>
          <li><a href="terms/of/service/">ì´ìš©ì•½ê´€</a></li>
          <li><a href="privacy/policy/">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a></li>
          <li><a href="copyright/policy/">ì €ì‘ê¶Œ ì •ì±…</a></li>
          <li><a href="youth/protection/">ì²­ì†Œë…„ ë³´í˜¸ì •ì±…</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
{% endblock %}


{% block extra_js %}
<script src="{% static 'js/home/main.js' %}"></script>
<script src="{% static 'js/common/login_btn.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // =====================================================
  // ë©”ì¸ íƒ­ ì „í™˜
  // =====================================================
  var mainTabBtns = document.querySelectorAll('.main-tab-btn');
  var mainTabPanels = document.querySelectorAll('.main-tab-panel');

  mainTabBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      mainTabBtns.forEach(function(b) { b.classList.remove('active'); });
      mainTabPanels.forEach(function(p) { p.classList.remove('active'); });
      btn.classList.add('active');
      var panel = document.getElementById(btn.getAttribute('data-main-tab'));
      if (panel) panel.classList.add('active');
    });
  });

  // =====================================================
  // AI ì„œë¸Œ íƒ­
  // =====================================================
  var aiSubBtns = document.querySelectorAll('.ai-sub-tab-btn');
  var aiSubPanels = document.querySelectorAll('.ai-sub-panel');

  aiSubBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      aiSubBtns.forEach(function(b) { b.classList.remove('active'); });
      aiSubPanels.forEach(function(p) { p.classList.remove('active'); });
      btn.classList.add('active');
      var panel = document.getElementById(btn.getAttribute('data-ai-tab'));
      if (panel) panel.classList.add('active');
    });
  });

  // =====================================================
  // AI ì†Œì„¤ ì¹´ë“œ Lazy Video
  // =====================================================
  var lazyVids = document.querySelectorAll('.ai-story-card .lazy-video');
  if (lazyVids.length > 0) {
    var vidObs = new IntersectionObserver(function(entries, o) {
      entries.forEach(function(e) {
        if (e.isIntersecting) {
          var v = e.target;
          if (v.dataset.src) {
            v.innerHTML = '<source src="' + v.dataset.src + '" type="video/mp4">';
            v.load();
          }
          o.unobserve(v);
        }
      });
    }, { rootMargin: '200px' });
    lazyVids.forEach(function(v) { vidObs.observe(v); });
  }

  // =====================================================
  // ì´ì–´ë“£ê¸° ë©”ë‰´ í† ê¸€
  // =====================================================
  var menuButtons = document.querySelectorAll('.continue-menu-btn');
  menuButtons.forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      var menu = this.closest('.continue-menu');
      var isActive = menu.classList.contains('active');
      document.querySelectorAll('.continue-menu.active').forEach(function(m) {
        m.classList.remove('active');
      });
      if (!isActive) menu.classList.add('active');
    });
  });
  document.addEventListener('click', function() {
    document.querySelectorAll('.continue-menu.active').forEach(function(m) {
      m.classList.remove('active');
    });
  });

  // =====================================================
  // ë¶ìŠ¤ëƒ… Lazy Load + Hover ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°
  // =====================================================
  var lazyVideos = document.querySelectorAll('video.hover-preview-video');
  var lazyImages = document.querySelectorAll('img.lazy-img');
  var mediaObs = new IntersectionObserver(function(entries, obs) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        var el = entry.target;
        if (el.tagName === 'VIDEO' || el.tagName === 'IMG') {
          el.src = el.dataset.src;
        }
        obs.unobserve(el);
      }
    });
  }, { threshold: 0.2 });
  lazyVideos.forEach(function(v) { mediaObs.observe(v); });
  lazyImages.forEach(function(i) { mediaObs.observe(i); });

  lazyVideos.forEach(function(video) {
    var container = video.parentElement;
    var thumbnail = container.querySelector('.snap-thumbnail');
    var hoverTimeout;
    container.addEventListener('mouseenter', function() {
      if (!video.src) video.src = video.dataset.src;
      thumbnail.style.display = 'none';
      video.style.display = 'block';
      video.currentTime = 0;
      video.play();
      hoverTimeout = setTimeout(function() {
        video.pause();
        video.style.display = 'none';
        thumbnail.style.display = 'block';
      }, 10000);
    });
    container.addEventListener('mouseleave', function() {
      clearTimeout(hoverTimeout);
      video.pause();
      video.style.display = 'none';
      thumbnail.style.display = 'block';
    });
  });

  // =====================================================
  // ì´ì–´ë“£ê¸° ì¬ìƒ ìœ„ì¹˜ í¬ë§·
  // =====================================================
  document.querySelectorAll('.resume-time').forEach(function(elem) {
    var seconds = parseFloat(elem.dataset.seconds);
    if (seconds && !isNaN(seconds)) {
      elem.textContent = Math.floor(seconds / 60) + 'ë¶„ ' + Math.floor(seconds % 60) + 'ì´ˆ';
    }
  });

  document.querySelectorAll('.resume-play-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      var contentUrl = this.dataset.contentUrl;
      var position = parseFloat(this.dataset.position);
      if (contentUrl && position) {
        sessionStorage.setItem('resumePosition', position);
        window.location.href = contentUrl;
      }
    });
  });

  // =====================================================
  // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìœ í˜• íƒ­ í•„í„°
  // =====================================================
  var plTabs = document.querySelectorAll('#playlistTypeTabs .playlist-type-tab');
  var plCards = document.querySelectorAll('#playlistCardsGrid .playlist-card');

  plTabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      var ptype = this.dataset.ptype;

      plTabs.forEach(function(t) { t.classList.remove('active'); });
      this.classList.add('active');

      var hasVisible = false;
      plCards.forEach(function(card) {
        var match = card.dataset.ptype === ptype;
        if (match) {
          card.style.display = '';
          card.style.opacity = '1';
          card.style.transform = '';
          hasVisible = true;
        } else {
          card.style.opacity = '0';
          card.style.transform = 'scale(0.97)';
          setTimeout(function() { card.style.display = 'none'; }, 180);
        }
      });

      var emptyMsg = document.getElementById('plEmptyMsg');
      if (!hasVisible) {
        if (!emptyMsg) {
          var msg = document.createElement('div');
          msg.id = 'plEmptyMsg';
          msg.style.cssText = 'grid-column:1/-1; text-align:center; padding:32px; color:rgba(255,255,255,0.35); font-size:0.85rem;';
          msg.textContent = 'ì•„ì§ í•´ë‹¹ ìœ í˜•ì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ì—†ì–´ìš”';
          document.getElementById('playlistCardsGrid').appendChild(msg);
        } else {
          emptyMsg.style.display = '';
        }
      } else if (emptyMsg) {
        emptyMsg.style.display = 'none';
      }
    });
  });

});
</script>
{% endblock %}