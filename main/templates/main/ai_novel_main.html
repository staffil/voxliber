{% extends "base.html" %}
{% load static %}

{% block title %}VOXLIBER - ëª©ì†Œë¦¬ë¡œ ë“£ëŠ” ì´ì•¼ê¸°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home/main/common.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/ai_novel_main.css' %}">
<link rel="stylesheet" href="{% static 'css/home/main/genres.css' %}">
<style>
  /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .tab-buttons-wrapper {
    position: sticky;
    top: 0;
      top: 80px;
    background-color: #393939;
    z-index: 100; /* ë‹¤ë¥¸ ì½˜í…ì¸ ë³´ë‹¤ ìœ„ë¡œ ì˜¬ë¼ì˜¤ê²Œ */
    padding: 10px 0;
    border-bottom: 1px solid #393939;
    border-radius: 10px;


  }

  .tab-buttons {
    display: flex;
    justify-content: start;
    gap: 10px;
    margin-top: 10px;
  }

  .tab-button {
    padding: 8px 16px;
    cursor: pointer;
    background-color: #2c2c2c;
    border-radius: 6px;
    font-weight: bold;
    transition: all 0.2s;
  }

  .tab-button:hover {
    background-color: #232323;
  }

  .tab-button.active {
    background-color: #f9f9f9;
    color: #000000;
    border-color: #ffffff;
  }

  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
  }
</style>
{% endblock %}

{% block content %}
<div class="app-wrapper">

  <!-- ê´‘ê³  ì„¹ì…˜ -->
  <section class="recommend-section">
    <div class="ad-banner-wrapper">
      <div class="ad-banner-carousel" id="ad-carousel">
        {% for advertisment in screen_list %}
          <div class="ad-slide {% if forloop.first %}active{% endif %}">
            <img src="{{ advertisment.advertisment_img.url }}" 
                 alt="{{ advertisment.title|default:'ì´ë²¤íŠ¸ ê´‘ê³ ' }}" 
                 class="ad-image" loading="lazy">
            <div class="ad-overlay">
              <div class="ad-gradient"></div>
              {% if advertisment.description %}
              <div class="ad-text">
                <h3>{{ advertisment.title|default:"ì˜¤ëŠ˜ì˜ íŠ¹ë³„ ì´ë²¤íŠ¸" }}</h3>
                <p>{{ advertisment.description|truncatewords:10 }}</p>
              </div>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="ad-slide active">
            <div class="ad-placeholder"><span>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</span></div>
          </div>
        {% endfor %}
      </div>
      {% if screen_list|length > 1 %}
        <button class="carousel-prev" onclick="prevSlide()">â€¹</button>
        <button class="carousel-next" onclick="nextSlide()">â€º</button>
      {% endif %}
    </div>

    <!-- íƒ­ ë²„íŠ¼ sticky -->
      <div class="tab-buttons">
        <div class="tab-button active" data-tab="ai-stories">AI Story</div>
        <div class="tab-button" data-tab="shared-stories">ê³µìœ í•œ AI</div>
      </div>

    <!-- AI Story íƒ­ -->
    <div id="ai-stories" class="tab-panel active">
      <div class="recommend-grid">
        {% for story in ai_stories|slice:":30" %}
          {% if story.public_uuid %}
          <div class="recommend-card">
            <a href="{% url 'character:story_intro' story.public_uuid %}" class="card-link">
              <div class="card-image-box">
                {% if story.story_desc_video %}
                <video class="card-image lazy-video" autoplay loop muted playsinline preload="none" data-src="{{ story.story_desc_video.url }}">
                  <source src="{{ story.story_desc_video.url }}" type="video/mp4">
                </video>
                {% elif story.cover_image %}
                <img src="{{ story.cover_image.url }}" alt="{{ story.title }}" class="card-image" loading="lazy">
                {% else %}
                <div class="card-placeholder"><span class="placeholder-icon">ğŸŒ™</span></div>
                {% endif %}
                <div class="card-gradient-overlay"></div>
                <div class="card-content">
                  <h3 class="card-title">{{ story.title }}</h3>
                  {% if story.description %}
                  <p class="card-desc">{{ story.description|truncatewords:20 }}</p>
                  {% endif %}
                </div>
              </div>
              <div class="card-hover-action"><i class="fas fa-arrow-right"></i></div>
            </a>
          </div>
          {% endif %}
        {% empty %}
        <div class="empty-card">
          <p>ì•„ì§ ì¶”ì²œí•  ìºë¦­í„°ê°€ ì—†ì–´ìš”â€¦</p>
          <a href="{% url 'character:make_ai_story' %}" class="empty-btn">ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°</a>
        </div>
        {% endfor %}
      </div>
    </div>

<!-- ê³µìœ í•œ AI íƒ­ -->
<div id="shared-stories" class="tab-panel">
  <div class="recommend-grid">
    {% for conv in user_share_list %}
      <div class="recommend-card">
        <!-- {% url 'main:shared_novel' conv.id %} -->
        <a href="{% url 'main:shared_novel' conv.id %}" class="card-link"   onclick="showAppInstallModal()">
          <div class="card-image-box">

            
            {% if conv.llm.llm_image %}
              <img src="{{ conv.llm.llm_image.url }}" alt="{{ conv.llm.name }}" class="card-image" loading="lazy">
            {% else %}
              <div class="card-placeholder"><span class="placeholder-icon">ğŸ“–</span></div>
            {% endif %}
            <div class="card-gradient-overlay">

                          <div class="user-nickname" style="padding: 10px 8px;">
                    {% if conv.user.user_img %}
                    <img src="{{ conv.user.user_img.url }}" alt="{{ target_user.nickname }}">
                    {% else %}
                    {{ conv.user.nickname|slice:":1"|upper }}
                    {% endif %}
                    <span>{{ conv.user.nickname }}</span>

            </div>
            </div>
            <div class="card-content">
              <h3 class="card-title">{{ conv.llm.name }}ê³¼ì˜ ì´ì•¼ê¸°</h3>
              {% if conv.messages.exists %}
                <p class="card-desc">
                  {{ conv.messages.first.content|truncatechars:40|safe }}...
                </p>
              {% else %}
                <p class="card-desc">ì•„ì§ ëŒ€í™”ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ì–´ìš”</p>
              {% endif %}
            </div>
          </div>
          <div class="card-hover-action"><i class="fas fa-arrow-right"></i></div>
        </a>
        <div class="card-meta">
          ê³µìœ ì: {{ conv.user.nickname|default:'ìµëª…' }} | 
          {{ conv.shared_at|date:"m.d H:i" }}
        </div>
      </div>
    {% empty %}
      <div class="empty-card">
        <p>ì•„ì§ ê³µê°œëœ AI ëŒ€í™”ê°€ ì—†ì–´ìš”â€¦</p>
        <p>ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ê³µìœ í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?</p>
        <a href="{% url 'character:make_ai_story' %}" class="empty-btn">ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°</a>
      </div>
    {% endfor %}
  </div>
</div>


  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Lazy video ë¡œë“œ
  const lazyVideos = document.querySelectorAll('.lazy-video');
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const video = entry.target;
        const src = video.dataset.src;
        if (src) {
          video.innerHTML = `<source src="${src}" type="video/mp4">`;
          video.load();
          obs.unobserve(video);
        }
      }
    });
  }, { rootMargin: '200px' });
  lazyVideos.forEach(v => observer.observe(v));

  // íƒ­ ê¸°ëŠ¥
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabPanels = document.querySelectorAll('.tab-panel');
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      tabPanels.forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });
</script>
{% endblock %}
