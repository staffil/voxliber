{% extends "base.html" %}
{% load static %}

{% block title %}ìŠ¤ë‹ˆí« ë¦¬ìŠ¤íŠ¸ | VoxLiber{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/snippet/snippet_list.css' %}">
{% endblock %}

{% block content %}
<section class="snippet-section">
  <h2>ğŸ“– ëœë¤ ë¶ ìŠ¤ë‹ˆí«</h2>
  <div class="snippet-grid">
    {% for snippet in snippet_list|slice:":10" %}
    <div class="snippet-card">
      {% if snippet.book.cover_img %}
      <img src="{{ snippet.book.cover_img.url }}" alt="{{ snippet.book.name }}" class="snippet-card-bg" loading="lazy">
      {% else %}
      <div class="snippet-card-bg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
      {% endif %}
      <div class="snippet-card-overlay"></div>

      <div class="snippet-card-content">
        <p class="snippet-meta">{{ snippet.book.name }}</p>
        <div class="snippet-text">{{ snippet.sentence }}</div>

        <div class="snippet-bottom">
          {% if snippet.audio_file %}
          <div class="snippet-audio-player">
            <button onclick="toggleSnippetAudio(this)">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </button>
            <audio src="{{ snippet.audio_file.url }}" preload="metadata"></audio>
          </div>
          {% endif %}
          <a href="{{ snippet.link }}" class="snippet-link">ì±… ë³´ëŸ¬ê°€ê¸° â†’</a>
        </div>
      </div>
    </div>
    {% empty %}
    <p style="padding: 0 2rem;">í˜„ì¬ ëœë¤ ìŠ¤ë‹ˆí«ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function toggleSnippetAudio(button) {
  const audioPlayer = button.closest('.snippet-audio-player');
  const audio = audioPlayer.querySelector('audio');

  // ëª¨ë“  ë‹¤ë¥¸ ì˜¤ë””ì˜¤ ì¼ì‹œì •ì§€
  document.querySelectorAll('.snippet-audio-player audio').forEach(a => {
    if (a !== audio && !a.paused) {
      a.pause();
      const btn = a.closest('.snippet-audio-player').querySelector('button');
      btn.classList.remove('playing');
      btn.innerHTML = '<svg width="32" height="32" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
    }
  });

  if (audio.paused) {
    audio.play();
    button.classList.add('playing');
    button.innerHTML = '<svg width="32" height="32" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>';
  } else {
    audio.pause();
    button.classList.remove('playing');
    button.innerHTML = '<svg width="32" height="32" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
  }

  audio.addEventListener('ended', () => {
    button.classList.remove('playing');
    button.innerHTML = '<svg width="32" height="32" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
  });
}
</script>
{% endblock %}
