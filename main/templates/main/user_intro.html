{% extends "base.html" %}
{% load static %}

{% block title %}{{ target_user.nickname }} - VOXLIBER{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home/main/user_intro.css' %}">

{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- í”„ë¡œí•„ í—¤ë” -->
    <div class="profile-header">


        <div class="profile-info-card">
            <div class="profile-main">
                <div class="profile-avatar">
                    {% if target_user.user_img %}
                    <img src="{{ target_user.user_img.url }}" alt="{{ target_user.nickname }}">
                    {% else %}
                    {{ target_user.nickname|slice:":1"|upper }}
                    {% endif %}
                </div>

                <div class="profile-details">
                    <h1 class="profile-name">{{ target_user.nickname }}</h1>
                    {% if target_user.bio %}
                    <p class="profile-bio">{{ target_user.bio }}</p>
                    {% endif %}

                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value">{{ book_list|length }}</div>
                            <div class="stat-label">ì‘í’ˆ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ story_list|length }}</div>
                            <div class="stat-label">AI ìŠ¤í† ë¦¬</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ snap_list|length }}</div>
                            <div class="stat-label">SNAP</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ follower_count }}</div>
                            <div class="stat-label">íŒ”ë¡œì›Œ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ following_count }}</div>
                            <div class="stat-label">íŒ”ë¡œì‰</div>
                        </div>
                    </div>
                </div>
            </div>

            {% if not is_own_profile %}
            <div class="profile-actions">
                {% if user.is_authenticated %}
                <button id="followBtn"
                        class="btn-follow {% if is_following %}following{% else %}follow{% endif %}"
                        data-user-id="{{ target_user.user_id }}">
                    {% if is_following %}íŒ”ë¡œì‰{% else %}íŒ”ë¡œìš°{% endif %}
                </button>
                
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="profile-tabs">
        <button class="profile-tab active" data-tab="books">
            ì‘í’ˆ
            <span class="tab-count">{{ book_list|length }}</span>
        </button>
        
        <button class="profile-tab" data-tab="stories">
            AI ìŠ¤í† ë¦¬
            <span class="tab-count">{{ story_list|length }}</span>
        </button>
        <button class="profile-tab" data-tab="sharedAI">
            ê³µìœ í•œ AI 
            <span class="tab-count">{{ user_share_list|length }}</span>
        </button>
        <button class="profile-tab" data-tab="snaps">
            SNAP
            <span class="tab-count">{{ snap_list|length }}</span>
        </button>
    </div>

    <!-- ì‘í’ˆ íƒ­ -->
    <div id="books-tab" class="tab-content active">
        {% if book_list %}
        <div class="works-grid">
            {% for book in book_list %}
            <a href="{% url 'book:book_detail' book.public_uuid %}" class="work-card">
                <div class="work-cover">
                    {% if book.cover_img %}
                    <img src="{{ book.cover_img.url }}" alt="{{ book.name }}" loading="lazy">
                    {% else %}
                    <div class="work-cover-placeholder">
                        {{ book.name|slice:":2"|upper }}
                    </div>
                    {% endif %}
                </div>
                <div class="work-info">
                    <div class="work-title">{{ book.name }}</div>
                    <div class="work-meta">{{ book.contents.count }}í™”</div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“š</div>
            <p class="empty-text">ì•„ì§ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
        {% endif %}
    </div>

    <!-- AI ìŠ¤í† ë¦¬ íƒ­ -->
    <div id="stories-tab" class="tab-content">
        {% if story_list %}
        <div class="works-grid">
            {% for story in story_list %}
            <a href="{% url 'character:story_intro' story.public_uuid %}" class="work-card ai-story">
    <div class="work-cover">
        {% if story.story_desc_video %}
            <video 
                autoplay 
                loop 
                muted 
                playsinline
                preload="metadata"
                poster="{% if story.cover_image %}{{ story.cover_image.url }}{% endif %}" 
                class="work-cover-video"
            >
                <source src="{{ story.story_desc_video.url }}" type="video/mp4">
                <!-- fallback ì´ë¯¸ì§€ -->
                {% if story.cover_image %}
                    <img src="{{ story.cover_image.url }}" alt="{{ story.title }}" loading="lazy">
                {% else %}
                    <div class="work-cover-placeholder" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        ğŸ¤–
                    </div>
                {% endif %}
            </video>
        {% elif story.cover_image %}
            <img src="{{ story.cover_image.url }}" alt="{{ story.title }}" loading="lazy">
        {% else %}
            <div class="work-cover-placeholder" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                ğŸ¤–
            </div>
        {% endif %}

        <!-- ì˜¤ë²„ë ˆì´: ì œëª©ê³¼ ìºë¦­í„° ìˆ˜ -->
        <div class="work-cover-overlay">
            <div class="overlay-title">{{ story.title }}</div>
            <div class="overlay-meta">ğŸ‘¥ {{ story.characters.count }}ëª…</div>
        </div>
    </div>
</a>

            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ¤–</div>
            <p class="empty-text">ì•„ì§ AI ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
        {% endif %}
    </div>


<!-- ê³µìœ í•œ AI íƒ­ -->
<div id="sharedAI-tab" class="tab-panel">
  <div class="recommend-grid">
    {% for conv in user_share_list %}
      <div class="recommend-card">
        <a href="{% url 'main:shared_novel' conv.id %}" class="card-link" onclick="showAppInstallModal()">
          <div class="card-image-box">
            
            <!-- ë°°ê²½ ì´ë¯¸ì§€ -->
            {% if conv.llm.llm_image %}
              <img src="{{ conv.llm.llm_image.url }}" alt="{{ conv.llm.name }}" class="card-image" loading="lazy">
            {% else %}
              <div class="card-placeholder"><span class="placeholder-icon">ğŸ¤–</span></div>
            {% endif %}

            <!-- ê·¸ë¼ë°ì´ì…˜ ì˜¤ë²„ë ˆì´ -->
            <div class="card-gradient-overlay">
              <!-- ì¹´ë“œ ë‚´ìš©: ì œëª© + ë©”ì‹œì§€ -->
              <div class="card-content">
                <h3 class="card-title">{{ conv.llm.name }}ê³¼ì˜ ì´ì•¼ê¸°</h3>
                {% if conv.messages.exists %}
                  <p class="card-desc">{{ conv.messages.first.content|truncatechars:40|safe }}...</p>
                {% else %}
                  <p class="card-desc">ì•„ì§ ëŒ€í™”ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ì–´ìš”</p>
                {% endif %}
              </div>

 
            </div>

          </div>

          <!-- hover ì•„ì´ì½˜ -->
          <div class="card-hover-action"><i class="fas fa-arrow-right"></i></div>
        </a>

        <!-- ì¹´ë“œ í•˜ë‹¨ ë©”íƒ€ -->
        <div class="card-meta">
          ê³µìœ ì: {{ conv.user.nickname|default:'ìµëª…' }} | {{ conv.shared_at|date:"m.d H:i" }}
        </div>
      </div>
    {% empty %}
      <div class="empty-card">
        <p>ì•„ì§ ê³µê°œëœ AI ëŒ€í™”ê°€ ì—†ì–´ìš”â€¦</p>
        <p>ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ê³µìœ í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?</p>
        <a href="{% url 'character:make_ai_story' %}" class="empty-btn">ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°</a>
      </div>
    {% endfor %}
  </div>
</div>



    <!-- SNAP íƒ­ -->
    <div id="snaps-tab" class="tab-content">
        {% if snap_list %}
        <div class="snap-grid">
            {% for snap in snap_list %}
            <div class="snap-grid-item">
                <a href="{% url 'book:book_snap_detail' snap.public_uuid %}" data-login-required>
                    <div class="snap-media-wrapper">
                        {% if snap.thumbnail %}
                        <img class="snap-thumbnail"
                             src="{{ snap.thumbnail.url }}"
                             alt="{{ snap.snap_title }}"
                             loading="lazy">
                        {% else %}
                        <img class="snap-thumbnail"
                             src="{% static 'images/book_snap_placeholder.png' %}"
                             alt="{{ snap.snap_title }}"
                             loading="lazy">
                        {% endif %}

                        {% if snap.snap_video %}
                        <video class="hover-video"
                               muted
                               loop
                               playsinline
                               preload="none"
                               data-src="{{ snap.snap_video.url }}">
                        </video>
                        {% endif %}

                        <div class="snap-overlay">
                            <h3>{{ snap.snap_title|default:"ì œëª© ì—†ìŒ" }}</h3>
                            <div class="snap-meta">
                                {% if snap.views %}
                                <span>ğŸ‘ {{ snap.views }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“¸</div>
            <p class="empty-text">ì•„ì§ SNAPì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // íƒ­ ì „í™˜
    const tabs = document.querySelectorAll('.profile-tab');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const target = this.dataset.tab;

            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(`${target}-tab`).classList.add('active');
        });
    });

    // íŒ”ë¡œìš° ë²„íŠ¼
    const followBtn = document.getElementById('followBtn');
    if (followBtn) {
        followBtn.addEventListener('click', function() {
            const userId = this.dataset.userId;

            fetch(`/book/follow/${userId}/toggle/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.is_following) {
                        this.textContent = 'íŒ”ë¡œì‰';
                        this.classList.remove('follow');
                        this.classList.add('following');
                    } else {
                        this.textContent = 'íŒ”ë¡œìš°';
                        this.classList.remove('following');
                        this.classList.add('follow');
                    }
                    // íŒ”ë¡œì›Œ ìˆ˜ ì—…ë°ì´íŠ¸
                    const followerStat = document.querySelector('.stat-item:nth-child(4) .stat-value');
                    if (followerStat) {
                        followerStat.textContent = data.follower_count;
                    }
                }
            })
            .catch(error => console.error('íŒ”ë¡œìš° ì˜¤ë¥˜:', error));
        });
    }

    // SNAP ë¹„ë””ì˜¤ í˜¸ë²„ ì¬ìƒ
    const snapItems = document.querySelectorAll('.snap-grid-item');
    snapItems.forEach(item => {
        const video = item.querySelector('.hover-video');
        if (!video) return;

        item.addEventListener('mouseenter', function() {
            if (!video.src && video.dataset.src) {
                video.src = video.dataset.src;
            }
            video.currentTime = 0;
            video.play().catch(() => {});
        });

        item.addEventListener('mouseleave', function() {
            video.pause();
            video.currentTime = 0;
        });
    });
});
</script>
{% endblock %}
